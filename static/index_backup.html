<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KNX Automation</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@7.2.96/css/materialdesignicons.min.css">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--bg:#0d1117;--sidebar:#161b22;--card:#21262d;--card-hover:#30363d;--border:#30363d;--text:#c9d1d9;--text-muted:#8b949e;--accent:#58a6ff;--success:#3fb950;--warning:#d29922;--danger:#f85149;--purple:#a371f7}
        
        /* Light Mode */
        :root.light{--bg:#f5f7fa;--sidebar:#ffffff;--card:#ffffff;--card-hover:#f0f3f6;--border:#d8dee4;--text:#24292f;--text-muted:#57606a;--accent:#0969da;--success:#1a7f37;--warning:#9a6700;--danger:#cf222e;--purple:#8250df}
        :root.light .sidebar{box-shadow:2px 0 8px rgba(0,0,0,0.05)}
        :root.light .widget{box-shadow:0 1px 3px rgba(0,0,0,0.08)}
        :root.light .eblock{box-shadow:0 2px 8px rgba(0,0,0,0.08)}
        :root.light .ve-switch,:root.light .ve-dimmer,:root.light .ve-value,:root.light .ve-shutter,:root.light .ve-scene,:root.light .ve-clock{background:linear-gradient(145deg,#ffffff,#f0f3f6);border-color:#d8dee4}
        :root.light .visu-canvas{background:linear-gradient(135deg,#e8ecf0 0%,#f5f7fa 100%)}
        :root.light .visu-container{background:#e1e5ea}
        
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:var(--text);display:flex;min-height:100vh;font-size:13px}
        
        .sidebar{width:260px;background:var(--sidebar);position:fixed;left:0;top:0;bottom:0;z-index:100;border-right:1px solid var(--border);display:flex;flex-direction:column;padding:20px}
        .sidebar-brand{display:flex;align-items:center;gap:12px;margin-bottom:40px}
        .sidebar-logo{font-size:28px;color:var(--accent)}
        .sidebar-title{color:var(--text);font-size:20px;font-weight:600;letter-spacing:-0.5px}
        .nav-section{padding:16px 0 8px;font-size:11px;text-transform:uppercase;letter-spacing:.5px;color:var(--text-muted)}
        .nav-item{display:flex;align-items:center;gap:12px;padding:12px;color:var(--text-muted);cursor:pointer;border-radius:8px;transition:all .15s;margin-bottom:8px}
        .nav-item:hover{background:var(--card-hover);color:var(--text)}
        .nav-item.active{background:var(--accent);color:#fff}
        .nav-item i{font-size:18px}
        .nav-badge{margin-left:auto;background:var(--card-hover);padding:2px 8px;border-radius:10px;font-size:11px}
        .nav-item.active .nav-badge{background:rgba(255,255,255,0.2)}
        .sidebar-footer{margin-top:auto;padding:12px 0;border-top:1px solid var(--border);font-size:11px;color:var(--text-muted);display:flex;justify-content:space-between;align-items:center}
        .theme-toggle{background:var(--card-hover);border:1px solid var(--border);border-radius:6px;padding:6px 10px;cursor:pointer;font-size:16px;color:var(--text-muted)}
        .theme-toggle:hover{background:var(--accent);color:#fff;border-color:var(--accent)}
        
        .main{flex:1;margin-left:260px;display:flex;flex-direction:column}
        .header{background:var(--sidebar);border-bottom:1px solid var(--border);padding:0 24px;height:56px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50}
        .header-title{font-size:18px;font-weight:600}
        .status-badge{display:flex;align-items:center;gap:6px;padding:6px 12px;border-radius:6px;font-size:12px}
        .status-badge.online{background:rgba(63,185,80,.15);color:var(--success)}
        .status-badge.offline{background:rgba(248,81,73,.15);color:var(--danger)}
        .status-dot{width:8px;height:8px;border-radius:50%;background:currentColor}
        
        .content{padding:30px;flex:1;overflow-y:auto}
        .page{display:none}.page.active{display:block}
        
        .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px}
        .stat-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:20px}
        .stat-label{font-size:12px;color:var(--text-muted);margin-bottom:8px}
        .stat-value{font-size:28px;font-weight:600}
        .stat-value.accent{color:var(--accent)}.stat-value.success{color:var(--success)}.stat-value.purple{color:var(--purple)}
        
        .card{background:var(--card);border:1px solid var(--border);border-radius:12px;margin-bottom:20px;overflow:hidden}
        .card-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px}
        .card-title{font-size:14px;font-weight:600;display:flex;align-items:center;gap:8px}
        .card-body{padding:20px}
        
        table{width:100%;border-collapse:collapse}
        th{text-align:left;padding:12px 16px;font-size:11px;text-transform:uppercase;letter-spacing:.5px;color:var(--text-muted);background:var(--sidebar);border-bottom:1px solid var(--border)}
        td{padding:12px 16px;border-bottom:1px solid var(--border)}
        tr:hover{background:var(--card-hover)}
        code{background:var(--sidebar);padding:3px 8px;border-radius:4px;font-family:'SF Mono',Consolas,monospace;font-size:12px}
        
        .form-group{margin-bottom:16px}
        .form-label{display:block;margin-bottom:6px;font-size:12px;color:var(--text-muted)}
        input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:6px;font-size:13px;font-family:inherit;background:var(--sidebar);color:var(--text);transition:border-color .15s}
        input:focus,select:focus,textarea:focus{outline:none;border-color:var(--accent)}
        textarea{font-family:'SF Mono',Consolas,monospace;resize:vertical}
        
        .btn{padding:8px 16px;border-radius:6px;font-size:13px;font-weight:500;cursor:pointer;border:1px solid transparent;transition:all .15s;display:inline-flex;align-items:center;gap:6px}
        .btn-primary{background:var(--accent);color:#fff}.btn-primary:hover{background:#4393e6}
        .btn-success{background:var(--success);color:#fff}
        .btn-danger{background:var(--danger);color:#fff}
        .btn-warning{background:var(--warning);color:#000}
        .btn-secondary{background:var(--card);color:var(--text);border-color:var(--border)}.btn-secondary:hover{background:var(--card-hover)}
        .btn-sm{padding:5px 10px;font-size:12px}
        
        .alert{padding:12px 16px;border-radius:8px;margin-bottom:16px;display:none;font-size:13px}
        .alert.show{display:flex;align-items:center;gap:8px}
        .alert.success{background:rgba(63,185,80,.15);color:var(--success);border:1px solid rgba(63,185,80,.3)}
        .alert.error{background:rgba(248,81,73,.15);color:var(--danger);border:1px solid rgba(248,81,73,.3)}
        .alert.info{background:rgba(88,166,255,.15);color:var(--accent);border:1px solid rgba(88,166,255,.3)}
        
        .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:200;align-items:center;justify-content:center;backdrop-filter:blur(4px)}
        .modal.show{display:flex}
        .modal-content{background:var(--card);border-radius:12px;width:500px;max-width:90%;max-height:85vh;overflow-y:auto;border:1px solid var(--border)}
        .modal-content.wide{width:800px}
        .modal-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
        .modal-title{font-weight:600;font-size:15px}
        .modal-close{background:none;border:none;font-size:20px;cursor:pointer;color:var(--text-muted);padding:4px}.modal-close:hover{color:var(--text)}
        .modal-body{padding:20px}
        .modal-footer{padding:16px 20px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px}
        .modal-error{background:rgba(248,81,73,.15);color:var(--danger);padding:10px;border-radius:6px;margin-bottom:12px;display:none;font-size:12px}
        
        .tabs{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap}
        .tab{padding:8px 16px;background:var(--sidebar);border:1px solid var(--border);border-radius:6px;cursor:pointer;font-size:12px;transition:all .15s}
        .tab:hover{background:var(--card-hover)}
        .tab.active{background:var(--accent);color:#fff;border-color:var(--accent)}
        .tab .delete-tab{margin-left:8px;opacity:.6}.tab .delete-tab:hover{opacity:1}
        
        .upload-zone{border:2px dashed var(--border);border-radius:8px;padding:32px;text-align:center;cursor:pointer;transition:all .15s}
        .upload-zone:hover{border-color:var(--accent);background:rgba(88,166,255,.05)}
        .upload-zone input{display:none}
        
        .logic-canvas{min-height:calc(100vh - 200px);padding:40px 60px;position:relative;background:#e0e0e0;overflow:auto;flex:1}
        :root:not(.light) .logic-canvas{background:#2a2a2a}
        
        .logic-wrapper{display:flex;height:calc(100vh - 200px)}
        .logic-main{flex:1;overflow:auto;position:relative}
        .logic-props{width:320px;background:var(--card);border-left:1px solid var(--border);overflow-y:auto;display:none}
        .logic-props.active{display:block}
        .logic-props-header{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
        .logic-props-header h3{font-size:14px;margin:0}
        .logic-props-body{padding:16px}
        .logic-props-section{margin-bottom:16px}
        .logic-props-section h4{font-size:11px;text-transform:uppercase;color:var(--text-muted);margin-bottom:8px;letter-spacing:0.5px}
        .logic-props-row{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border);font-size:12px}
        .logic-props-row:last-child{border-bottom:none}
        .logic-props-label{color:var(--text-muted)}
        .logic-props-value{color:var(--text);font-weight:500;max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
        
        /* ========== EDOMI EXACT STYLE ========== */
        .eblock{--block-color:#c0d700;position:absolute;width:420px;font-family:sans-serif;font-size:11px;box-shadow:4px 4px 12px rgba(0,0,0,0.2);border:1px solid #a0a0a0}
        .eblock.selected{outline:3px solid #58a6ff;outline-offset:2px}
        .eblock.error{--block-color:#ff4d4d}
        
        /* Header - DUNKEL */
        .eblock-header{background:#2d2d2d;color:#fff;padding:6px 10px;font-size:12px;font-weight:bold;cursor:move;user-select:none;display:flex;align-items:center;gap:8px}
        
        /* Body - GR√úN */
        .eblock-body{background:var(--block-color)}
        
        /* Tabelle */
        .eblock-table{width:100%;border-collapse:collapse}
        
        .eblock-row{border-bottom:1px solid rgba(0,0,0,0.1)}
        .eblock-row:last-child{border-bottom:none}
        
        /* Input-Seite (links) - mit Port und Wert */
        .eblock-input{width:50%;padding:4px 8px 4px 22px;background:rgba(255,255,255,0.2);border-right:1px solid #a0a0a0;vertical-align:middle;position:relative}
        .eblock-input-label{color:#444;font-size:10px;display:block}
        .eblock-input-num{color:#666;font-size:11px;font-weight:600;margin-right:5px}
        .eblock-input-value{background:#d8d8d8;color:#444;font-weight:bold;padding:4px 10px;font-size:12px;display:inline-block;cursor:pointer;max-width:130px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
        .eblock-input-value:hover{background:#c8c8c8}
        
        /* Output-Seite (rechts) - mit Port und Wert */
        .eblock-output{width:50%;padding:4px 22px 4px 8px;vertical-align:middle;position:relative}
        .eblock-output-label{color:#444;font-size:10px;display:block;text-align:right}
        .eblock-output-num{color:#666;font-size:11px;font-weight:600;margin-left:5px}
        .eblock-output-value{background:#d8d8d8;color:#444;font-weight:bold;padding:4px 10px;font-size:12px;display:inline-block;cursor:pointer;max-width:130px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
        .eblock-output-value:hover{background:#c8c8c8}
        
        /* Binding Label (rot) */
        .eblock-binding{background:#f85149;color:#fff;font-size:9px;padding:1px 5px;border-radius:3px;font-weight:500;max-width:100px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;cursor:help}
        
        /* Port (Verbindungspunkt) - ohne Striche */
        .eblock-port{position:absolute;top:50%;transform:translateY(-50%);width:10px;height:10px;background:#888;border-radius:50%;border:1px solid rgba(0,0,0,0.3);cursor:crosshair;z-index:5}
        .eblock-port:hover{background:#58a6ff;transform:translateY(-50%) scale(1.3);box-shadow:0 0 6px #58a6ff}
        .eblock-port.wired{background:#f85149;border-color:#c0392b}
        .eblock-port.wire-target{background:#3fb950;transform:translateY(-50%) scale(1.4);box-shadow:0 0 8px #3fb950}
        
        /* Port links f√ºr Inputs */
        .eblock-port.input{left:6px}
        /* Port rechts f√ºr Outputs */
        .eblock-port.output{right:6px}
        
        /* Status Box unten */
        .eblock-status{background:rgba(0,0,0,0.05);padding:5px 10px;font-size:10px;border-top:1px solid rgba(0,0,0,0.1);color:#333}
        
        /* Block Header Info */
        .eblock-header-info{font-size:9px;color:rgba(255,255,255,0.7);font-weight:normal;margin-left:6px}
        
        /* Wire SVG */
        .wire-svg{position:absolute;top:0;left:0;pointer-events:none;z-index:5;overflow:visible;width:100%;height:100%}
        .wire-path{fill:none;stroke:#555;stroke-width:2}
        .wire-path.active{stroke:#f0e068;stroke-width:2.5}
        .wire-temp{stroke:#58a6ff;stroke-width:2;stroke-dasharray:5,5}
        
        .log-entry{padding:6px 12px;font-family:'SF Mono',Consolas,monospace;font-size:11px;border-bottom:1px solid var(--border)}
        .log-time{color:var(--text-muted);margin-right:8px}
        .log-level{font-weight:600;margin-right:8px;padding:2px 6px;border-radius:3px;font-size:10px}
        .log-level.INFO{background:rgba(63,185,80,.2);color:var(--success)}
        .log-level.DEBUG{background:rgba(88,166,255,.2);color:var(--accent)}
        .log-level.WARNING{background:rgba(210,153,34,.2);color:var(--warning)}
        .log-level.ERROR{background:rgba(248,81,73,.2);color:var(--danger)}
        
        .empty{padding:40px;text-align:center;color:var(--text-muted)}
        .info-box{background:var(--sidebar);border:1px solid var(--border);border-radius:8px;padding:16px;margin-top:16px}
        .info-box h4{margin-bottom:8px;color:var(--text)}
        
        /* ========== MODERN DASHBOARD DESIGN ========== */
        .dashboard-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));grid-auto-rows:min-content;gap:20px}
        .widget{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:20px;display:flex;flex-direction:column;gap:15px;transition:all 0.2s}
        .widget:hover{border-color:var(--text-muted)}
        .widget-header{display:flex;justify-content:space-between;align-items:center}
        .widget-title{font-weight:600;font-size:14px;color:var(--text)}
        .widget-subtitle{font-size:11px;color:var(--text-muted)}
        .widget-actions{display:flex;gap:4px}
        .widget-actions button{background:none;border:none;color:var(--text-muted);cursor:pointer;padding:4px;font-size:16px;transition:color 0.2s}
        .widget-actions button:hover{color:var(--accent)}
        .widget-body{flex:1;overflow:auto}
        .widget-lg{grid-column:span 2}
        .widget-xl{grid-column:span 2;grid-row:span 2}
        
        /* Status Pill */
        .status-pill{font-size:10px;padding:3px 10px;border-radius:12px;font-weight:600;text-transform:uppercase}
        .status-pill.active{background:rgba(63,185,80,0.1);color:var(--success);border:1px solid var(--success)}
        .status-pill.error{background:rgba(248,81,73,0.1);color:var(--danger);border:1px solid var(--danger)}
        .status-pill.warning{background:rgba(210,153,34,0.1);color:var(--warning);border:1px solid var(--warning)}
        
        /* Energy/Value Display */
        .energy-value{font-size:28px;font-weight:700;text-align:center;margin:10px 0}
        .energy-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
        .energy-item{background:var(--bg);padding:12px;border-radius:10px;display:flex;flex-direction:column;gap:4px}
        .energy-label{font-size:10px;color:var(--text-muted);display:flex;align-items:center;gap:5px}
        .energy-val{font-weight:600;font-size:14px}
        
        /* Stat Widgets */
        .stat-widget{display:flex;flex-direction:column;height:100%}
        .stat-widget .stat-icon{font-size:20px;color:var(--text-muted)}
        .stat-widget .stat-number{font-size:28px;font-weight:700;color:var(--text);line-height:1}
        .stat-widget .stat-label{font-size:12px;color:var(--text-muted);margin-top:4px}
        
        /* Donut Widget */
        .donut-widget{display:flex;align-items:center;gap:16px;height:100%}
        .donut-svg{width:80px;height:80px;flex-shrink:0}
        .donut-legend{flex:1}
        .donut-item{display:flex;align-items:center;gap:8px;margin-bottom:6px;font-size:11px}
        .donut-color{width:10px;height:10px;border-radius:2px}
        
        /* OAuth Container */
        .oauth-container{display:flex;flex-direction:column;height:100%;gap:12px}
        .oauth-header{display:flex;justify-content:space-between;align-items:center}
        .oauth-status-dot{width:10px;height:10px;border-radius:50%;background:var(--text-muted);flex-shrink:0}
        .oauth-status-dot.active{background:var(--success);box-shadow:0 0 10px var(--success)}
        .oauth-status-dot.error{background:var(--danger);box-shadow:0 0 10px var(--danger)}
        .progress-box{height:6px;background:var(--bg);border-radius:3px;overflow:hidden}
        :root.light .progress-box{background:var(--border)}
        .progress-bar{height:100%;background:var(--accent);width:0%;transition:width 0.5s ease}
        .oauth-info{display:flex;justify-content:space-between;font-size:11px;color:var(--text-muted)}
        .oauth-error{font-size:10px;color:var(--danger);display:none}
        .oauth-error.show{display:block}
        .btn-oauth{background:var(--card-hover);border:1px solid var(--border);color:var(--text);padding:10px;border-radius:8px;cursor:pointer;font-size:12px;font-weight:600;display:flex;align-items:center;justify-content:center;gap:8px;text-decoration:none;transition:all 0.2s}
        .btn-oauth:hover{background:var(--border)}
        .btn-oauth.needed{background:var(--purple);color:white;border:none;animation:pulse 2s infinite}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.8}}
        
        /* Quick Values */
        .quick-values{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px}
        .quick-value-item{background:var(--bg);border-radius:10px;padding:12px;display:flex;flex-direction:column;gap:2px}
        :root.light .quick-value-item{background:var(--card-hover)}
        .quick-value-addr{font-size:10px;color:var(--accent);font-family:monospace}
        .quick-value-name{font-size:11px;color:var(--text-muted)}
        .quick-value-val{font-size:18px;font-weight:600}
        
        /* IKO Group Styles */
        .iko-group{border:1px solid var(--border);border-radius:8px;margin-bottom:8px;overflow:hidden}
        .iko-group-header{display:flex;align-items:center;gap:10px;padding:12px 16px;background:var(--sidebar);cursor:pointer;user-select:none}
        .iko-group-header:hover{background:var(--card-hover)}
        .iko-group-header i{transition:transform 0.2s}
        .iko-group.collapsed .iko-group-header i.mdi-chevron-down{transform:rotate(-90deg)}
        .iko-group-name{font-weight:600;font-size:14px;flex:1}
        .iko-group-count{font-size:11px;color:var(--text-muted);background:var(--card-hover);padding:3px 10px;border-radius:10px}
        .iko-group-body{display:block}
        .iko-group.collapsed .iko-group-body{display:none}
        .iko-row{display:flex;align-items:center;padding:10px 16px;border-top:1px solid var(--border);gap:16px;font-size:13px}
        .iko-row:hover{background:var(--card-hover)}
        .iko-row-addr{font-family:monospace;color:var(--purple);min-width:200px;font-weight:600;font-size:13px}
        .iko-row-name{flex:1;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;min-width:150px}
        .iko-row-dpt{color:var(--text-muted);min-width:80px;text-align:center}
        .iko-row-value{min-width:120px;font-weight:600;cursor:pointer;padding:6px 12px;background:var(--bg);border-radius:6px;text-align:center;font-size:14px}
        .iko-row-value:hover{background:var(--accent);color:#fff}
        .iko-row-initial{min-width:120px;font-size:11px;color:var(--text-muted)}
        .iko-row-actions{display:flex;gap:6px}
        .iko-row-actions button{padding:6px 10px;font-size:12px}
        :root.light .iko-group-header{background:var(--card-hover)}
        :root.light .iko-row-value{background:var(--border)}
        
        /* ========== EDOMI-STYLE VISU ========== */
        .visu-toolbar{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:var(--card);border:1px solid var(--border);border-radius:8px;margin-bottom:16px;flex-wrap:wrap;gap:12px}
        .visu-size-btns{display:flex;gap:4px}
        .visu-size-btns button.active{background:var(--accent);color:#fff}
        .visu-container{background:#1a1a2e;border:1px solid var(--border);border-radius:8px;overflow:auto;min-height:calc(100vh - 240px);display:flex;justify-content:center;align-items:flex-start;padding:20px}
        .visu-canvas{background:linear-gradient(135deg,#1a1a2e 0%,#16213e 100%);position:relative;border-radius:8px;box-shadow:0 0 30px rgba(0,0,0,0.5);transition:width 0.3s,height 0.3s;min-height:500px}
        .visu-canvas.fullsize{width:100%;min-height:calc(100vh - 280px)}
        .visu-canvas.phone{width:375px;height:667px}
        .visu-canvas.tablet{width:768px;height:1024px}
        .visu-canvas.desktop{width:1920px;height:1080px}
        
        .visu-element{position:absolute;cursor:pointer;user-select:none;transition:transform 0.1s}
        .visu-element:hover{z-index:100}
        .visu-element.editing{outline:2px dashed var(--accent);cursor:move}
        .visu-element .resize-handle{position:absolute;width:16px;height:16px;background:var(--accent);border-radius:3px;right:-8px;bottom:-8px;cursor:se-resize;display:none;opacity:0.8}
        .visu-element .resize-handle:hover{opacity:1;transform:scale(1.1)}
        .visu-element.editing .resize-handle{display:block}
        
        .ve-switch{width:80px;height:80px;background:linear-gradient(145deg,#2d2d44,#1a1a2e);border-radius:12px;display:flex;flex-direction:column;align-items:center;justify-content:center;border:2px solid #3d3d5c;box-shadow:0 4px 15px rgba(0,0,0,0.4)}
        .ve-switch.on{background:linear-gradient(145deg,#1e4d2b,#0d3318);border-color:var(--success);box-shadow:0 0 20px rgba(63,185,80,0.3)}
        .ve-switch .icon{font-size:28px}
        .ve-switch .label{font-size:10px;color:var(--text-muted);margin-top:4px}
        
        .ve-dimmer{width:100px;height:140px;background:linear-gradient(145deg,#2d2d44,#1a1a2e);border-radius:12px;padding:10px;display:flex;flex-direction:column;align-items:center;border:2px solid #3d3d5c}
        .ve-dimmer .icon{font-size:24px;margin-bottom:8px}
        .ve-dimmer .slider-v{width:20px;height:70px;background:#1a1a2e;border-radius:10px;position:relative}
        .ve-dimmer .slider-fill{position:absolute;bottom:0;width:100%;background:linear-gradient(to top,var(--warning),#ffd93d);border-radius:10px;transition:height 0.2s}
        .ve-dimmer .value{font-size:12px;font-weight:600;margin-top:8px}
        
        .ve-value{min-width:100px;height:60px;background:linear-gradient(145deg,#2d2d44,#1a1a2e);border-radius:10px;padding:8px 12px;display:flex;flex-direction:column;justify-content:center;border:2px solid #3d3d5c}
        .ve-value .label{font-size:10px;color:var(--text-muted)}
        .ve-value .number{font-size:22px;font-weight:700}
        .ve-value .unit{font-size:12px;color:var(--text-muted);margin-left:4px}
        .ve-value.temp .number{color:#ff7b54}
        .ve-value.hum .number{color:#00b4d8}
        .ve-value.power .number{color:#ffd93d}
        
        .ve-shutter{width:80px;height:120px;background:linear-gradient(145deg,#2d2d44,#1a1a2e);border-radius:12px;padding:8px;display:flex;flex-direction:column;align-items:center;border:2px solid #3d3d5c}
        .ve-shutter .preview{width:50px;height:50px;background:#0d1117;border:2px solid #3d3d5c;border-radius:4px;position:relative;overflow:hidden}
        .ve-shutter .slats{position:absolute;top:0;width:100%;background:repeating-linear-gradient(0deg,#6d6d8d 0px,#6d6d8d 3px,transparent 3px,transparent 6px);transition:height 0.3s}
        .ve-shutter .btns{display:flex;gap:4px;margin-top:6px}
        .ve-shutter .btns button{width:22px;height:22px;border:none;border-radius:4px;background:#3d3d5c;color:#fff;cursor:pointer;font-size:10px}
        .ve-shutter .btns button:hover{background:var(--accent)}
        .ve-shutter .label{font-size:9px;color:var(--text-muted);margin-top:4px}
        
        .ve-scene{width:90px;height:70px;background:linear-gradient(145deg,#2d2d44,#1a1a2e);border-radius:12px;display:flex;flex-direction:column;align-items:center;justify-content:center;border:2px solid #3d3d5c}
        .ve-scene:hover{border-color:var(--accent);box-shadow:0 0 15px rgba(88,166,255,0.3)}
        .ve-scene:active{transform:scale(0.95)}
        .ve-scene .icon{font-size:24px}
        .ve-scene .label{font-size:10px;color:var(--text-muted);margin-top:4px}
        
        .ve-clock{min-width:120px;height:50px;background:linear-gradient(145deg,#2d2d44,#1a1a2e);border-radius:10px;display:flex;align-items:center;justify-content:center;border:2px solid #3d3d5c;padding:0 15px}
        .ve-clock .time{font-size:26px;font-weight:300;font-family:'SF Mono',monospace}
        
        .ve-label{padding:4px 8px;color:var(--text);font-size:14px}
        
        /* VSE Grid */
        .vse-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:16px}
        .vse-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;cursor:pointer;transition:all 0.2s}
        .vse-card:hover{border-color:var(--accent);transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.3)}
        .vse-card .vse-preview{height:80px;background:#1a1a2e;border-radius:8px;margin-bottom:12px;display:flex;align-items:center;justify-content:center;overflow:hidden}
        .vse-card .vse-name{font-weight:600;margin-bottom:4px}
        .vse-card .vse-id{font-size:11px;color:var(--text-muted)}
        .vse-card .vse-size{font-size:11px;color:var(--accent)}
        .vse-card .vse-actions{display:flex;gap:8px;margin-top:12px}
        .btn-purple{background:var(--purple);color:#fff;border:none}
        .btn-purple:hover{background:#8b5cf6}
        .btn-accent{background:var(--accent);color:#fff;border:none}
        .btn-accent:hover{background:#1e88e5}
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-brand">
            <i class="mdi mdi-lightning-bolt sidebar-logo"></i>
            <span class="sidebar-title">KNX Automation</span>
        </div>
        <div class="nav-item active" onclick="showPage('dashboard')"><i class="mdi mdi-view-dashboard"></i> Dashboard</div>
        <div class="nav-item" onclick="showPage('visu')"><i class="mdi mdi-monitor"></i> Visualisierung</div>
        <div class="nav-item" onclick="showPage('vse')"><i class="mdi mdi-palette"></i> Widgets</div>
        <div class="nav-item" onclick="showPage('addresses')"><i class="mdi mdi-format-list-bulleted"></i> KNX Adressen <span class="nav-badge" id="addrCount">0</span></div>
        <div class="nav-item" onclick="showPage('internal')"><i class="mdi mdi-link-variant"></i> Interne (IKO) <span class="nav-badge" id="intCount">0</span></div>
        <div class="nav-item" onclick="showPage('logic')"><i class="mdi mdi-puzzle"></i> Logik-Editor <span class="nav-badge" id="blockCount">0</span></div>
        <div class="nav-item" onclick="showPage('blocks')"><i class="mdi mdi-package-variant"></i> Bausteintypen</div>
        <div class="nav-item" onclick="showPage('code')"><i class="mdi mdi-code-tags"></i> Code-Editor</div>
        <div class="nav-item" onclick="showPage('settings')" style="margin-top:auto"><i class="mdi mdi-cog"></i> Einstellungen</div>
        <div class="nav-item" onclick="showPage('import')"><i class="mdi mdi-swap-vertical"></i> Import/Export</div>
        <div class="nav-item" onclick="showPage('update')"><i class="mdi mdi-update"></i> System-Update</div>
        <div class="nav-item" onclick="showPage('logs')"><i class="mdi mdi-text-box-outline"></i> Logs</div>
        <div class="sidebar-footer"><span>v1.7.3</span><button class="theme-toggle" onclick="toggleTheme()" title="Theme wechseln"><i class="mdi mdi-theme-light-dark"></i></button></div>
    </div>
    
    <div class="main">
        <div class="header">
            <div class="header-title" id="pageTitle">Dashboard</div>
            <div class="status-badge" id="connStatus"><span class="status-dot"></span><span id="connText">...</span></div>
        </div>
        
        <div class="content">
            <div id="mainAlert" class="alert"></div>
            
            <div id="page-dashboard" class="page active">
                <div class="dashboard-grid" id="dashboardGrid">
                    <!-- OAuth2 Service Widget - immer sichtbar f√ºr Demo -->
                    <div class="widget widget-lg" id="oauthWidgetContainer">
                        <div class="widget-header">
                            <div>
                                <div style="font-weight:600">Netatmo Service</div>
                                <div class="widget-subtitle" id="oauth-source">Status: -</div>
                            </div>
                            <i class="mdi mdi-key-variant" id="oauth-status-icon" style="color:var(--text-muted);font-size:20px"></i>
                        </div>
                        <div class="progress-box">
                            <div class="progress-bar" id="oauth-progress" style="width:86%"></div>
                        </div>
                        <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--text-muted)">
                            <span id="oauth-expiry">0s verbleibend</span>
                            <span id="oauth-ready-text">Quelle: -</span>
                        </div>
                        <a href="#" id="oauth-auth-link" class="btn-oauth needed" style="display:none">
                            <i class="mdi mdi-login"></i> Neu Autorisieren
                        </a>
                        <button id="oauth-refresh-btn" class="btn-oauth" onclick="triggerOAuthRefresh()">
                            <i class="mdi mdi-refresh"></i> Token erneuern
                        </button>
                    </div>
                    
                    <!-- Temperatur Widget -->
                    <div class="widget" id="tempWidget">
                        <div style="display:flex;justify-content:space-between">
                            <i class="mdi mdi-thermometer" style="font-size:20px;color:var(--text-muted)"></i>
                            <span style="font-size:12px;color:var(--success)">+1.2%</span>
                        </div>
                        <div style="margin-top:auto">
                            <div style="font-size:28px;font-weight:600" id="tempValue">--¬∞C</div>
                            <div style="font-size:12px;color:var(--text-muted)">Au√üentemperatur</div>
                        </div>
                    </div>
                    
                    <!-- Statistik Widgets -->
                    <div class="widget">
                        <div style="display:flex;justify-content:space-between">
                            <i class="mdi mdi-format-list-bulleted" style="font-size:20px;color:var(--text-muted)"></i>
                        </div>
                        <div style="margin-top:auto">
                            <div style="font-size:28px;font-weight:600;color:var(--accent)" id="sAddr">0</div>
                            <div style="font-size:12px;color:var(--text-muted)">KNX Adressen</div>
                        </div>
                    </div>
                    
                    <div class="widget">
                        <div style="display:flex;justify-content:space-between">
                            <i class="mdi mdi-link-variant" style="font-size:20px;color:var(--text-muted)"></i>
                        </div>
                        <div style="margin-top:auto">
                            <div style="font-size:28px;font-weight:600;color:var(--purple)" id="sInt">0</div>
                            <div style="font-size:12px;color:var(--text-muted)">Interne (IKO)</div>
                        </div>
                    </div>
                    
                    <div class="widget">
                        <div style="display:flex;justify-content:space-between">
                            <i class="mdi mdi-puzzle" style="font-size:20px;color:var(--text-muted)"></i>
                        </div>
                        <div style="margin-top:auto">
                            <div style="font-size:28px;font-weight:600;color:var(--success)" id="sBlocks">0</div>
                            <div style="font-size:12px;color:var(--text-muted)">Logik-Bausteine</div>
                        </div>
                    </div>
                    
                    <!-- KNX Gateway Status -->
                    <div class="widget">
                        <div style="display:flex;justify-content:space-between">
                            <i class="mdi mdi-router-wireless" style="font-size:20px;color:var(--text-muted)"></i>
                        </div>
                        <div style="margin-top:auto">
                            <div style="font-size:18px;font-weight:600" id="gatewayStatus">‚óè</div>
                            <div style="font-size:12px;color:var(--text-muted)" id="sGateway">Verbinde...</div>
                        </div>
                    </div>
                    
                    <!-- System Control Widget -->
                    <div class="widget">
                        <div style="display:flex;justify-content:space-between;align-items:center">
                            <i class="mdi mdi-cog" style="font-size:20px;color:var(--text-muted)"></i>
                            <span style="font-size:10px;color:var(--text-muted)" id="systemUptime">--</span>
                        </div>
                        <div style="margin-top:auto">
                            <div style="font-size:12px;color:var(--text-muted);margin-bottom:8px">System</div>
                            <button class="btn btn-warning btn-sm" style="width:100%" onclick="restartSystem()">
                                <i class="mdi mdi-restart"></i> Neustart
                            </button>
                        </div>
                    </div>
                    
                    <!-- Status Donut -->
                    <div class="widget">
                        <div class="widget-header" style="margin-bottom:8px">
                            <span class="widget-title">Status</span>
                        </div>
                        <div class="donut-widget">
                            <svg class="donut-svg" viewBox="0 0 42 42" id="statusDonut">
                                <circle cx="21" cy="21" r="15.9" fill="transparent" stroke="var(--border)" stroke-width="5"/>
                                <circle cx="21" cy="21" r="15.9" fill="transparent" stroke="var(--success)" stroke-width="5" 
                                    stroke-dasharray="75 25" stroke-dashoffset="25" id="donutActive"/>
                            </svg>
                            <div class="donut-legend">
                                <div class="donut-item"><div class="donut-color" style="background:var(--success)"></div><span id="legendActive">Aktiv: 0</span></div>
                                <div class="donut-item"><div class="donut-color" style="background:var(--border)"></div><span id="legendInactive">Ohne: 0</span></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Schnellzugriff Werte -->
                    <div class="widget widget-lg">
                        <div class="widget-header">
                            <span class="widget-title"><i class="mdi mdi-chart-line" style="color:var(--text-muted)"></i> Aktuelle Werte</span>
                            <div class="widget-actions">
                                <button onclick="loadAddresses()" title="Aktualisieren"><i class="mdi mdi-refresh"></i></button>
                            </div>
                        </div>
                        <div class="widget-body" id="quickValues">
                            <div style="color:var(--text-muted);text-align:center;padding:20px">
                                Werte werden automatisch angezeigt wenn KNX-Adressen vorhanden sind
                            </div>
                        </div>
                    </div>
                    
                    <!-- Telegramme -->
                    <div class="widget widget-lg">
                        <div class="widget-header">
                            <span class="widget-title"><i class="mdi mdi-antenna" style="color:var(--text-muted)"></i> Letzte Telegramme</span>
                            <div class="widget-actions">
                                <button onclick="loadTelegrams()" title="Aktualisieren"><i class="mdi mdi-refresh"></i></button>
                            </div>
                        </div>
                        <div class="widget-body" style="padding:0;max-height:250px;overflow-y:auto">
                            <table style="margin:0"><thead><tr><th>Zeit</th><th>Von</th><th>Nach</th><th>Wert</th></tr></thead><tbody id="telegramTable"><tr><td colspan="4" class="empty">Keine Telegramme</td></tr></tbody></table>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="page-visu" class="page">
                <div class="visu-toolbar">
                    <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
                        <select id="visuPageSelect" onchange="loadVisuPage(this.value)">
                            <option value="default">Standard-Seite</option>
                        </select>
                        <button class="btn btn-secondary" onclick="showModal('visuPageModal')">+ Seite</button>
                        <button class="btn btn-secondary" onclick="showPageSettings()">‚öôÔ∏è</button>
                        <div class="visu-size-btns">
                            <button class="btn btn-sm" onclick="setVisuSize(375,667)" title="iPhone">üì±</button>
                            <button class="btn btn-sm" onclick="setVisuSize(768,1024)" title="Tablet">üì≤</button>
                            <button class="btn btn-sm" onclick="setVisuSize(1920,1080)" title="Desktop">üñ•Ô∏è</button>
                            <button class="btn btn-sm active" onclick="setVisuSize(0,0)" title="Voll">‚õ∂</button>
                        </div>
                    </div>
                    <div style="display:flex;gap:8px;flex-wrap:wrap">
                        <button class="btn btn-primary" onclick="showAddWidgetModal()">+ Widget</button>
                        <button class="btn btn-purple" onclick="showAddVSEModal()">+ VSE Element</button>
                        <button class="btn btn-secondary" onclick="toggleVisuEdit()">‚úèÔ∏è Bearbeiten</button>
                        <button class="btn btn-success" onclick="openVisuFullscreen()">‚õ∂ Vollbild</button>
                    </div>
                </div>
                <div class="visu-container" id="visuContainer">
                    <div class="visu-canvas" id="visuCanvas"></div>
                </div>
            </div>
            
            <div id="page-vse" class="page">
                <div class="widget" style="min-height:calc(100vh - 180px)">
                    <div class="widget-header">
                        <div>
                            <div style="font-weight:600;font-size:16px"><i class="mdi mdi-palette" style="color:var(--purple)"></i> Widget-Bibliothek</div>
                            <div class="widget-subtitle">Wiederverwendbare Widgets f√ºr die Visualisierung</div>
                        </div>
                        <div style="display:flex;gap:8px">
                            <input type="file" id="vseUploadInput" accept=".json,.yaml,.yml" style="display:none" onchange="uploadVSE(this.files[0])" multiple>
                            <button class="btn btn-secondary" onclick="showVseCreateModal()"><i class="mdi mdi-plus"></i> Neu erstellen</button>
                            <button class="btn btn-primary" onclick="document.getElementById('vseUploadInput').click()"><i class="mdi mdi-upload"></i> Hochladen</button>
                        </div>
                    </div>
                    
                    <!-- Stats & Filter -->
                    <div style="display:flex;gap:20px;padding:12px 0;border-bottom:1px solid var(--border);flex-wrap:wrap;align-items:center">
                        <div style="display:flex;align-items:center;gap:8px">
                            <i class="mdi mdi-widgets" style="color:var(--accent)"></i>
                            <span style="font-size:13px"><b id="vseCount">0</b> Widgets</span>
                        </div>
                        <div style="margin-left:auto;display:flex;gap:8px">
                            <input type="text" id="vseSearch" placeholder="üîç Suchen..." style="width:200px" oninput="filterVSE()">
                            <select id="vseFilter" onchange="filterVSE()" style="width:120px">
                                <option value="all">Alle</option>
                                <option value="sensor">Sensor</option>
                                <option value="switch">Schalter</option>
                                <option value="other">Sonstige</option>
                            </select>
                            <button class="btn btn-sm btn-secondary" onclick="loadVSEElements()"><i class="mdi mdi-refresh"></i></button>
                        </div>
                    </div>
                    
                    <!-- Info Box -->
                    <div style="background:var(--sidebar);border-radius:8px;padding:12px;margin:12px 0;font-size:12px">
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
                            <i class="mdi mdi-information" style="color:var(--accent)"></i>
                            <b>Widget-System</b>
                        </div>
                        <div style="color:var(--text-muted)">
                            Erstelle wiederverwendbare Sensor Card Widgets mit konfigurierbaren Variablen und bedingter Formatierung.
                            Widgets k√∂nnen als JSON-Dateien exportiert und importiert werden.
                        </div>
                    </div>
                    
                    <!-- VSE Grid -->
                    <div id="vseList" class="vse-grid" style="margin-top:12px"></div>
                </div>
            </div>
            
            <div id="page-addresses" class="page">
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">KNX Gruppenadressen</span>
                        <div style="display:flex;gap:8px;align-items:center">
                            <input type="text" id="searchAddr" placeholder="üîç Suchen..." style="width:200px" oninput="renderAddr()">
                            <button id="deleteSelectedBtn" class="btn btn-danger" style="display:none" onclick="deleteSelectedAddrs()">üóë Ausgew√§hlte l√∂schen</button>
                        </div>
                    </div>
                    <div class="card-body" style="padding:0"><table><thead><tr><th style="width:30px"><input type="checkbox" onchange="toggleAllAddrs(this.checked)" title="Alle ausw√§hlen"></th><th>Adresse</th><th>Name</th><th>DPT</th><th>Wert</th><th>Zuletzt</th><th>Aktionen</th></tr></thead><tbody id="addrTable"></tbody></table></div>
                </div>
            </div>
            
            <div id="page-internal" class="page">
                <div class="widget" style="min-height:calc(100vh - 180px)">
                    <div class="widget-header">
                        <div>
                            <div style="font-weight:600;font-size:16px">Interne Kommunikationsobjekte (IKO)</div>
                            <div class="widget-subtitle">Virtuelle Adressen f√ºr interne Logik-Verkn√ºpfungen</div>
                        </div>
                        <div style="display:flex;gap:8px">
                            <button class="btn btn-secondary" onclick="showIkoFromBlockModal()"><i class="mdi mdi-puzzle-plus"></i> Aus Baustein</button>
                            <button class="btn btn-primary" onclick="showModal('intModal')"><i class="mdi mdi-plus"></i> Neue IKO</button>
                        </div>
                    </div>
                    
                    <!-- Stats Row -->
                    <div style="display:flex;gap:20px;padding:12px 0;border-bottom:1px solid var(--border);flex-wrap:wrap">
                        <div style="display:flex;align-items:center;gap:8px">
                            <i class="mdi mdi-link-variant" style="color:var(--purple)"></i>
                            <span style="font-size:13px"><b id="ikoCount">0</b> IKOs gesamt</span>
                        </div>
                        <div style="display:flex;align-items:center;gap:8px">
                            <i class="mdi mdi-folder-multiple" style="color:var(--accent)"></i>
                            <span style="font-size:13px"><b id="ikoGroupCount">0</b> Gruppen</span>
                        </div>
                        <div style="display:flex;align-items:center;gap:8px">
                            <i class="mdi mdi-check-circle" style="color:var(--success)"></i>
                            <span style="font-size:13px"><b id="ikoWithValue">0</b> mit Wert</span>
                        </div>
                        <div style="margin-left:auto;display:flex;gap:4px;flex-wrap:wrap">
                            <button class="btn btn-sm btn-secondary" onclick="toggleAllGroups(true)"><i class="mdi mdi-unfold-more-horizontal"></i> Alle √∂ffnen</button>
                            <button class="btn btn-sm btn-secondary" onclick="toggleAllGroups(false)"><i class="mdi mdi-unfold-less-horizontal"></i> Alle schlie√üen</button>
                            <button class="btn btn-sm btn-secondary" onclick="loadInternal()"><i class="mdi mdi-refresh"></i></button>
                        </div>
                    </div>
                    
                    <!-- IKO Groups List -->
                    <div id="ikoGroupList" style="flex:1;overflow-y:auto;margin-top:12px">
                        <div style="color:var(--text-muted);text-align:center;padding:40px">
                            Keine IKOs vorhanden. Klicke auf "+ Neue IKO" oder "Aus Baustein" um welche anzulegen.
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="page-logic" class="page">
                <div class="card" style="display:flex;flex-direction:column;height:calc(100vh - 180px)">
                    <div class="card-header">
                        <span class="card-title">üß© Logik-Editor</span>
                        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
                            <select id="blockType" style="width:200px"></select>
                            <button class="btn btn-success" onclick="addBlock()">+ Baustein</button>
                            <button class="btn btn-secondary" onclick="showModal('pageModal')">üìÑ Seite</button>
                            <span style="color:var(--text-muted);font-size:11px;margin-left:8px">Ziehe am Header um zu verschieben</span>
                        </div>
                    </div>
                    <div class="tabs" id="pagesTabs" style="padding:0 16px"></div>
                    <div class="logic-wrapper">
                        <div class="logic-main logic-canvas logic-canvas-grid" id="logicBlocksContainer">
                            <svg id="wiresCanvas" class="wire-svg"></svg>
                        </div>
                        <div class="logic-props" id="logicPropsPanel">
                            <div class="logic-props-header">
                                <h3>√ó Eigenschaften</h3>
                                <button class="btn btn-sm" onclick="closePropsPanel()">√ó</button>
                            </div>
                            <div class="logic-props-body">
                                <div id="propsContent">
                                    <div style="color:var(--text-muted);text-align:center;padding:40px">
                                        Klicke auf einen Baustein um seine Eigenschaften anzuzeigen
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="page-blocks" class="page">
                <div class="card">
                    <div class="card-header"><span class="card-title">üì¶ Verf√ºgbare Bausteintypen</span></div>
                    <div class="card-body" style="padding:0"><table><thead><tr><th>ID</th><th>Name</th><th>Kategorie</th><th>Beschreibung</th><th>E/A</th></tr></thead><tbody id="blockTypeTable"></tbody></table></div>
                </div>
            </div>
            
            <div id="page-code" class="page">
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">üíª Eigene Bausteine</span>
                        <div style="display:flex;gap:8px">
                            <button class="btn btn-primary" onclick="document.getElementById('blockUpload').click()">üì§ Hochladen</button>
                            <button class="btn btn-success" onclick="newBlockFile()">+ Neuer Baustein</button>
                        </div>
                        <input type="file" id="blockUpload" accept=".py" style="display:none" onchange="uploadBlock()">
                    </div>
                    <div class="card-body" style="padding:0"><table><thead><tr><th>Datei</th><th>Aktionen</th></tr></thead><tbody id="filesTable"></tbody></table></div>
                </div>
            </div>
            
            <!-- SETTINGS PAGE -->
            <div id="page-settings" class="page">
                <div class="card">
                    <div class="card-header"><span class="card-title">‚öôÔ∏è KNX Gateway Einstellungen</span></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Gateway IP-Adresse</label>
                            <input type="text" id="settingsGatewayIp" placeholder="z.B. 192.168.1.10">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Gateway Port</label>
                            <input type="number" id="settingsGatewayPort" value="3671" placeholder="3671">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Verbindungsmodus</label>
                            <select id="settingsMode">
                                <option value="tunneling">Tunneling (Standard)</option>
                                <option value="routing">Routing (Multicast)</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="saveSettings()">üíæ Speichern & Verbinden</button>
                        <div class="info-box">
                            <h4>Hinweis</h4>
                            <p style="color:var(--text-muted)">Nach dem Speichern wird die Verbindung zum Gateway neu aufgebaut. Die aktuelle Gateway-IP wird oben im Dashboard angezeigt.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="page-import" class="page">
                <div class="card">
                    <div class="card-header"><span class="card-title">üì§ ESF / knxproj / CSV Import</span></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Projekt-Passwort (nur f√ºr verschl√ºsselte knxproj)</label>
                            <input type="password" id="importPassword" placeholder="Leer lassen wenn nicht verschl√ºsselt">
                        </div>
                        <div class="upload-zone" onclick="document.getElementById('esfFile').click()">
                            <input type="file" id="esfFile" accept=".esf,.knxproj,.csv" onchange="uploadEsf()">
                            <div style="font-size:32px;margin-bottom:12px">üìÅ</div>
                            <div>ESF, knxproj oder CSV Datei hochladen</div>
                            <div style="color:var(--text-muted);font-size:11px;margin-top:8px">Vorhandene Adressen werden aktualisiert (nicht dupliziert)</div>
                        </div>
                    </div>
                </div>
                
                <div class="card" style="margin-top:16px">
                    <div class="card-header"><span class="card-title">üíæ Backup & Restore</span></div>
                    <div class="card-body">
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
                            <div class="info-box">
                                <h4>üì• Backup erstellen</h4>
                                <p style="color:var(--text-muted);margin-bottom:12px">Speichert alle Adressen, Bausteine, Einstellungen und Bindings.</p>
                                <button class="btn btn-primary" onclick="downloadBackup()">üíæ Backup herunterladen</button>
                            </div>
                            <div class="info-box">
                                <h4>üì§ Backup wiederherstellen</h4>
                                <p style="color:var(--text-muted);margin-bottom:12px">Stellt alle Einstellungen aus einem Backup wieder her.</p>
                                <input type="file" id="backupFile" accept=".json" style="display:none" onchange="uploadBackup()">
                                <button class="btn btn-warning" onclick="document.getElementById('backupFile').click()">üì§ Backup laden</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="page-update" class="page">
                <div class="widget" style="max-width:800px">
                    <div class="widget-header">
                        <div>
                            <div style="font-weight:600;font-size:16px"><i class="mdi mdi-update" style="color:var(--accent)"></i> System-Update</div>
                            <div class="widget-subtitle">Aktualisiere das KNX Automation System</div>
                        </div>
                    </div>
                    
                    <div class="upload-zone" onclick="document.getElementById('updateFile').click()" style="margin:16px 0">
                        <input type="file" id="updateFile" accept=".tar.gz,.tgz" onchange="uploadUpdate()">
                        <i class="mdi mdi-cloud-upload" style="font-size:48px;color:var(--accent);margin-bottom:12px"></i>
                        <div style="font-size:14px;font-weight:600;margin-bottom:4px">Update-Paket hochladen</div>
                        <div style="font-size:12px;color:var(--text-muted)">.tar.gz Datei hierher ziehen oder klicken</div>
                    </div>
                    
                    <div id="updateProgress" style="display:none;margin:16px 0">
                        <div style="display:flex;justify-content:space-between;margin-bottom:6px">
                            <span style="font-size:12px">Upload l√§uft...</span>
                            <span style="font-size:12px" id="updatePercent">0%</span>
                        </div>
                        <div class="progress-box">
                            <div class="progress-bar" id="updateProgressBar" style="width:0%"></div>
                        </div>
                    </div>
                    
                    <div style="background:var(--bg);border-radius:8px;padding:16px;margin-top:16px">
                        <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
                            <i class="mdi mdi-information" style="font-size:20px;color:var(--accent)"></i>
                            <span style="font-weight:600">Hinweise</span>
                        </div>
                        <ul style="margin:0;padding-left:20px;font-size:13px;color:var(--text-muted);line-height:1.8">
                            <li>Das Update-Paket muss eine <code>.tar.gz</code> Datei sein</li>
                            <li>Nach dem Upload wird das System automatisch aktualisiert</li>
                            <li>Ein Neustart ist nach dem Update erforderlich</li>
                            <li>Bestehende Konfigurationen bleiben erhalten</li>
                        </ul>
                    </div>
                    
                    <div style="display:flex;gap:12px;margin-top:20px;padding-top:16px;border-top:1px solid var(--border)">
                        <button class="btn btn-warning" onclick="restartSystem()" style="flex:1">
                            <i class="mdi mdi-restart"></i> System neustarten
                        </button>
                        <button class="btn btn-secondary" onclick="checkVersion()" style="flex:1">
                            <i class="mdi mdi-information"></i> Version pr√ºfen
                        </button>
                    </div>
                    
                    <div id="versionInfo" style="margin-top:16px;padding:12px;background:var(--sidebar);border-radius:8px;display:none">
                        <div style="display:flex;justify-content:space-between;font-size:13px">
                            <span>Installierte Version:</span>
                            <span id="currentVersion" style="font-weight:600;color:var(--success)">--</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="page-logs" class="page">
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">üìú System Logs</span>
                        <div style="display:flex;gap:8px;align-items:center">
                            <select id="logLevel" style="width:100px" onchange="loadLogs()">
                                <option value="">Alle</option>
                                <option value="DEBUG">DEBUG</option>
                                <option value="INFO">INFO</option>
                                <option value="WARNING">WARNING</option>
                                <option value="ERROR">ERROR</option>
                            </select>
                            <button class="btn btn-sm btn-secondary" onclick="loadLogs()">üîÑ</button>
                        </div>
                    </div>
                    <div class="card-body" style="max-height:500px;overflow-y:auto;padding:0">
                        <div id="logContainer"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <div class="modal" id="intModal"><div class="modal-content"><div class="modal-header"><span class="modal-title">Neue IKO erstellen</span><button class="modal-close" onclick="hideModal('intModal')">√ó</button></div><div class="modal-body"><div class="form-group"><label class="form-label">Adresse</label><input id="intAddr" placeholder="z.B. INT/wetter/temp"></div><div class="form-group"><label class="form-label">Name</label><input id="intName" placeholder="Beschreibung"></div><div class="form-group"><label class="form-label">DPT (optional)</label><input id="intDpt" placeholder="z.B. 9.001"></div><div class="form-group"><label class="form-label">Initial-Wert (optional)</label><input id="intInitial" placeholder="Startwert beim Systemstart"></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="hideModal('intModal')">Abbrechen</button><button class="btn btn-primary" onclick="addInt()">Erstellen</button></div></div></div>
    
    <div class="modal" id="ikoValueModal"><div class="modal-content"><div class="modal-header"><span class="modal-title" id="ikoValueTitle">Wert setzen</span><button class="modal-close" onclick="hideModal('ikoValueModal')">√ó</button></div><div class="modal-body"><input type="hidden" id="ikoValueAddr"><div class="form-group"><label class="form-label">Neuer Wert</label><input id="ikoValueInput" placeholder="Wert eingeben" autofocus></div><div style="font-size:11px;color:var(--text-muted);margin-top:8px"><i class="mdi mdi-information"></i> Der Wert wird sofort an alle verbundenen Bausteine weitergeleitet.</div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="hideModal('ikoValueModal')">Abbrechen</button><button class="btn btn-primary" onclick="saveIkoValue()"><i class="mdi mdi-content-save"></i> Speichern</button></div></div></div>
    
    <div class="modal" id="ikoInitialModal"><div class="modal-content"><div class="modal-header"><span class="modal-title" id="ikoInitialTitle">Initial-Wert</span><button class="modal-close" onclick="hideModal('ikoInitialModal')">√ó</button></div><div class="modal-body"><input type="hidden" id="ikoInitialAddr"><div class="form-group"><label class="form-label">Initial-Wert</label><input id="ikoInitialInput" placeholder="Wert beim Systemstart"></div><div style="font-size:11px;color:var(--text-muted);margin-top:8px"><i class="mdi mdi-information"></i> Dieser Wert wird beim Neustart des Systems automatisch gesetzt. Leer lassen um keinen Initial-Wert zu verwenden.</div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="hideModal('ikoInitialModal')">Abbrechen</button><button class="btn btn-primary" onclick="saveIkoInitial()"><i class="mdi mdi-restart"></i> Speichern</button></div></div></div>
    
    <div class="modal" id="ikoFromBlockModal"><div class="modal-content"><div class="modal-header"><span class="modal-title"><i class="mdi mdi-puzzle-plus"></i> IKOs aus Baustein erstellen</span><button class="modal-close" onclick="hideModal('ikoFromBlockModal')">√ó</button></div><div class="modal-body">
        <div class="form-group"><label class="form-label">Bausteintyp ausw√§hlen</label><select id="ikoBlockType" onchange="previewBlockIkos()"><option value="">-- Baustein w√§hlen --</option></select></div>
        <div class="form-group"><label class="form-label">Gruppen-Name</label>
            <div style="display:flex;align-items:center;gap:4px">
                <span style="background:var(--sidebar);padding:8px 12px;border-radius:6px;font-family:monospace;color:var(--purple)">INT/</span>
                <input id="ikoGroupPrefix" placeholder="z.B. wetter" oninput="previewBlockIkos()" style="flex:1">
            </div>
            <div style="font-size:10px;color:var(--text-muted);margin-top:4px">Alle IKOs werden in einer Gruppe erstellt: INT/name/E1, INT/name/A1, ...</div>
        </div>
        <div class="form-group"><label class="form-label">Vorschau</label><div id="ikoBlockPreview" style="background:var(--bg);border-radius:8px;padding:12px;max-height:250px;overflow-y:auto;font-size:12px"><span style="color:var(--text-muted)">W√§hle einen Baustein und gib einen Gruppen-Namen ein</span></div></div>
        <div class="form-group"><label class="form-label" style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="ikoCreateInputs" checked style="width:auto"> Eing√§nge erstellen</label></div>
        <div class="form-group"><label class="form-label" style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="ikoCreateOutputs" checked style="width:auto"> Ausg√§nge erstellen</label></div>
    </div><div class="modal-footer"><button class="btn btn-secondary" onclick="hideModal('ikoFromBlockModal')">Abbrechen</button><button class="btn btn-primary" onclick="createIkosFromBlock()"><i class="mdi mdi-plus"></i> IKOs erstellen</button></div></div></div>
    
    <div class="modal" id="pageModal"><div class="modal-content"><div class="modal-header"><span class="modal-title">Neue Logik-Seite erstellen</span><button class="modal-close" onclick="hideModal('pageModal')">√ó</button></div><div class="modal-body"><div class="modal-error" id="pageModalError"></div><div class="form-group"><label class="form-label">Seitenname</label><input id="pageName" placeholder="z.B. Wetter, Heizung..."></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="hideModal('pageModal')">Abbrechen</button><button class="btn btn-primary" onclick="addPage()">Erstellen</button></div></div></div>
    
    <div class="modal" id="codeModal"><div class="modal-content wide"><div class="modal-header"><span class="modal-title">Code: <span id="codeFileName"></span></span><button class="modal-close" onclick="hideModal('codeModal')">√ó</button></div><div class="modal-body"><textarea id="codeEditor" rows="25"></textarea></div><div class="modal-footer"><button class="btn btn-secondary" onclick="hideModal('codeModal')">Abbrechen</button><button class="btn btn-success" onclick="saveCode()">üíæ Speichern</button></div></div></div>
    
    <div class="modal" id="debugModal"><div class="modal-content wide"><div class="modal-header"><span class="modal-title">üîç Debug Info</span><button class="modal-close" onclick="hideModal('debugModal')">√ó</button></div><div class="modal-body"><textarea id="debugContent" rows="20" readonly></textarea></div><div class="modal-footer"><button class="btn btn-secondary" onclick="hideModal('debugModal')">Schlie√üen</button></div></div></div>
    
    <div class="modal" id="bindModal"><div class="modal-content wide"><div class="modal-header"><span class="modal-title">üîó Verbindung bearbeiten</span><button class="modal-close" onclick="hideModal('bindModal')">√ó</button></div><div class="modal-body"><div class="modal-error" id="bindModalError"></div><div id="bindContent"></div></div></div></div>
    
    <div class="modal" id="editAddrModal"><div class="modal-content"><div class="modal-header"><span class="modal-title">‚úèÔ∏è Adresse bearbeiten</span><button class="modal-close" onclick="hideModal('editAddrModal')">√ó</button></div><div class="modal-body"><div class="modal-error" id="editAddrError"></div><input type="hidden" id="editAddrOrig"><div class="form-group"><label class="form-label">Adresse (nur lesen)</label><input id="editAddrAddr" readonly style="background:#333"></div><div class="form-group"><label class="form-label">Name</label><input id="editAddrName" placeholder="Beschreibung"></div><div class="form-group"><label class="form-label">DPT</label><input id="editAddrDpt" placeholder="z.B. 1.001, 9.001, 14.056"></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="hideModal('editAddrModal')">Abbrechen</button><button class="btn btn-primary" onclick="saveAddr()">üíæ Speichern</button></div></div></div>
    
    <div class="modal" id="valueModal"><div class="modal-content"><div class="modal-header"><span class="modal-title">üìã Wert Details</span><button class="modal-close" onclick="hideModal('valueModal')">√ó</button></div><div class="modal-body"><div class="form-group"><label class="form-label" id="valueModalLabel">E1: Name</label><textarea id="valueModalContent" rows="8" readonly style="font-family:monospace;font-size:12px;background:#1a1a2e;color:#fff;border:1px solid var(--border)"></textarea></div></div><div class="modal-footer"><button class="btn btn-primary" onclick="copyValueToClipboard()">üìã Kopieren</button><button class="btn btn-secondary" onclick="hideModal('valueModal')">Schlie√üen</button></div></div></div>
    
    <div class="modal" id="visuWidgetModal"><div class="modal-content"><div class="modal-header"><span class="modal-title">+ Widget hinzuf√ºgen</span><button class="modal-close" onclick="hideModal('visuWidgetModal')">√ó</button></div><div class="modal-body">
        <div class="form-group"><label class="form-label">Widget-Typ</label>
            <select id="visuWidgetType" onchange="updateVisuWidgetForm()">
                <option value="switch">üí° Schalter</option>
                <option value="dimmer">üîÜ Dimmer</option>
                <option value="value">üå°Ô∏è Wert-Anzeige</option>
                <option value="shutter">ü™ü Jalousie</option>
                <option value="scene">üé¨ Szene</option>
                <option value="clock">üïê Uhr</option>
                <option value="label">üìù Text/Label</option>
            </select>
        </div>
        <div class="form-group"><label class="form-label">Bezeichnung</label><input id="visuWidgetLabel" placeholder="z.B. Wohnzimmer Licht"></div>
        <div id="visuWidgetFields"></div>
    </div><div class="modal-footer"><button class="btn btn-secondary" onclick="hideModal('visuWidgetModal')">Abbrechen</button><button class="btn btn-primary" onclick="addVisuWidget()">Hinzuf√ºgen</button></div></div></div>
    
    <div class="modal" id="visuPageModal"><div class="modal-content"><div class="modal-header"><span class="modal-title">+ Visu-Seite erstellen</span><button class="modal-close" onclick="hideModal('visuPageModal')">√ó</button></div><div class="modal-body">
        <div class="form-group"><label class="form-label">Seitenname</label><input id="visuPageName" placeholder="z.B. Erdgeschoss"></div>
        <div class="form-group"><label class="form-label">Gr√∂√üe</label>
            <select id="visuPageSize">
                <option value="full">Volle Gr√∂√üe (responsiv)</option>
                <option value="phone">Smartphone (375√ó667)</option>
                <option value="tablet">Tablet (768√ó1024)</option>
                <option value="desktop">Desktop (1920√ó1080)</option>
            </select>
        </div>
    </div><div class="modal-footer"><button class="btn btn-secondary" onclick="hideModal('visuPageModal')">Abbrechen</button><button class="btn btn-primary" onclick="createVisuPage()">Erstellen</button></div></div></div>
    
    <div class="modal" id="visuEditModal"><div class="modal-content wide"><div class="modal-header"><span class="modal-title"><i class="mdi mdi-pencil"></i> Widget bearbeiten</span><button class="modal-close" onclick="hideModal('visuEditModal')">√ó</button></div><div class="modal-body"><div id="visuEditFields"></div></div><div class="modal-footer"><button class="btn btn-danger" onclick="deleteVisuWidget()" style="margin-right:auto"><i class="mdi mdi-delete"></i> L√∂schen</button><button class="btn btn-secondary" onclick="hideModal('visuEditModal')">Abbrechen</button><button class="btn btn-primary" onclick="saveVisuWidget()"><i class="mdi mdi-content-save"></i> Speichern</button></div></div></div>
    
    <div class="modal" id="visuPageSettingsModal"><div class="modal-content"><div class="modal-header"><span class="modal-title">‚öôÔ∏è Seiten-Einstellungen</span><button class="modal-close" onclick="hideModal('visuPageSettingsModal')">√ó</button></div><div class="modal-body">
        <div class="form-group"><label class="form-label">Seitenname</label><input id="pageSettingsName" placeholder="Seitenname"></div>
        <div class="form-group"><label class="form-label">Hintergrundfarbe</label>
            <div style="display:flex;gap:8px;align-items:center">
                <input type="color" id="pageSettingsBgColor" value="#1a1a2e" style="width:60px;height:36px;border:none;cursor:pointer">
                <input id="pageSettingsBgColorText" value="#1a1a2e" style="width:100px" oninput="document.getElementById('pageSettingsBgColor').value=this.value">
                <button class="btn btn-sm" onclick="document.getElementById('pageSettingsBgColor').value='#1a1a2e';document.getElementById('pageSettingsBgColorText').value='#1a1a2e'">Reset</button>
            </div>
        </div>
        <div class="form-group"><label class="form-label">Vordefinierte Farben</label>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
                <button class="btn btn-sm" style="background:#1a1a2e" onclick="setPageBgColor('#1a1a2e')">Dunkel</button>
                <button class="btn btn-sm" style="background:#0d1117" onclick="setPageBgColor('#0d1117')">GitHub</button>
                <button class="btn btn-sm" style="background:#1e1e1e" onclick="setPageBgColor('#1e1e1e')">VSCode</button>
                <button class="btn btn-sm" style="background:#2d2d2d" onclick="setPageBgColor('#2d2d2d')">Grau</button>
                <button class="btn btn-sm" style="background:#0a192f" onclick="setPageBgColor('#0a192f')">Navy</button>
                <button class="btn btn-sm" style="background:#1a1a1a" onclick="setPageBgColor('#1a1a1a')">EDOMI</button>
            </div>
        </div>
        <div class="form-group"><label class="form-label">Gr√∂√üe</label>
            <select id="pageSettingsSize" onchange="toggleCustomSize()">
                <option value="full">Volle Gr√∂√üe</option>
                <option value="phone">Smartphone (375√ó667)</option>
                <option value="tablet">Tablet (768√ó1024)</option>
                <option value="desktop">Desktop (1920√ó1080)</option>
                <option value="custom">Benutzerdefiniert</option>
            </select>
        </div>
        <div class="form-group" id="customSizeGroup" style="display:none">
            <label class="form-label">Benutzerdefinierte Gr√∂√üe (Pixel)</label>
            <div style="display:flex;gap:8px;align-items:center">
                <input type="number" id="pageSettingsWidth" placeholder="Breite" style="width:100px" value="1024">
                <span>√ó</span>
                <input type="number" id="pageSettingsHeight" placeholder="H√∂he" style="width:100px" value="768">
            </div>
        </div>
        <div class="form-group"><label class="form-label">Hintergrundbild (URL)</label>
            <input id="pageSettingsBgImage" placeholder="https://... oder /data/images/hintergrund.jpg">
            <div style="font-size:10px;color:var(--text-muted);margin-top:4px">Leer lassen f√ºr kein Bild. Unterst√ºtzt: URL oder lokaler Pfad</div>
        </div>
        <div class="form-group"><label class="form-label">Bild-Stil</label>
            <select id="pageSettingsBgSize">
                <option value="cover">Ausf√ºllen (cover)</option>
                <option value="contain">Einpassen (contain)</option>
                <option value="100% 100%">Strecken</option>
                <option value="repeat">Kacheln</option>
            </select>
        </div>
    </div><div class="modal-footer"><button class="btn btn-danger" onclick="deleteVisuPage()" style="margin-right:auto">üóë Seite l√∂schen</button><button class="btn btn-secondary" onclick="hideModal('visuPageSettingsModal')">Abbrechen</button><button class="btn btn-primary" onclick="savePageSettings()">Speichern</button></div></div></div>
    
    <div class="modal" id="visuVSEModal"><div class="modal-content wide"><div class="modal-header"><span class="modal-title">+ VSE Element hinzuf√ºgen</span><button class="modal-close" onclick="hideModal('visuVSEModal')">√ó</button></div><div class="modal-body">
        <div id="vseSelectGrid" class="vse-grid" style="max-height:400px;overflow-y:auto"></div>
        <div id="vseConfigPanel" style="display:none;margin-top:16px;padding-top:16px;border-top:1px solid var(--border)">
            <h4 style="margin-bottom:12px">Konfiguration: <span id="vseConfigName"></span></h4>
            <div class="form-group"><label class="form-label">Text/Label</label><input id="vseConfigText" placeholder="Beschriftung"></div>
            <div class="form-group"><label class="form-label">KO1 (Wert-Adresse)</label>
                <select id="vseConfigKO1"><option value="">-- Keine --</option></select>
            </div>
            <div id="vseConfigVars"></div>
        </div>
    </div><div class="modal-footer"><button class="btn btn-secondary" onclick="hideModal('visuVSEModal')">Abbrechen</button><button class="btn btn-primary" onclick="addVSEWidget()" id="vseAddBtn" disabled>Hinzuf√ºgen</button></div></div></div>
    
    <!-- VSE Create/Edit Modal -->
    <div class="modal" id="vseCreateModal"><div class="modal-content wide"><div class="modal-header"><span class="modal-title" id="vseModalTitle"><i class="mdi mdi-palette"></i> Widget erstellen</span><button class="modal-close" onclick="hideModal('vseCreateModal')">√ó</button></div><div class="modal-body">
        <input type="hidden" id="vseEditMode" value="">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
            <!-- Left Column: Basic Settings -->
            <div>
                <h4 style="margin:0 0 12px 0;color:var(--accent)"><i class="mdi mdi-information"></i> Grundeinstellungen</h4>
                <div class="form-group"><label class="form-label">Name *</label><input id="vseCreateName" placeholder="z.B. Temperatur Sensor"></div>
                <div class="form-group"><label class="form-label">ID (eindeutig) *</label><input id="vseCreateId" placeholder="z.B. temp_sensor_v1"></div>
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
                    <div class="form-group"><label class="form-label">Kategorie</label>
                        <select id="vseCreateCategory">
                            <option value="sensor">üå°Ô∏è Sensor</option>
                        </select>
                    </div>
                    <div class="form-group"><label class="form-label">Breite</label><input type="number" id="vseCreateWidth" value="200"></div>
                    <div class="form-group"><label class="form-label">H√∂he</label><input type="number" id="vseCreateHeight" value="100"></div>
                </div>
                <div class="form-group"><label class="form-label">Render-Typ</label>
                    <select id="vseCreateRender" onchange="updateVseRenderHelp()">
                        <option value="sensorCard">Sensor Card (Wert mit Icon)</option>
                    </select>
                    <div id="vseRenderHelp" style="font-size:10px;color:var(--text-muted);margin-top:4px"></div>
                </div>
                <div class="form-group"><label class="form-label">Beschreibung</label><textarea id="vseCreateDesc" rows="2" placeholder="Kurze Beschreibung des Widgets..."></textarea></div>
            </div>
            
            <!-- Right Column: Variables -->
            <div>
                <h4 style="margin:0 0 12px 0;color:var(--purple)"><i class="mdi mdi-variable"></i> Variablen <button class="btn btn-sm btn-secondary" onclick="addVseVariable()" style="float:right"><i class="mdi mdi-plus"></i> Hinzuf√ºgen</button></h4>
                <div id="vseVarList" style="max-height:280px;overflow-y:auto">
                    <!-- Variable rows will be added here -->
                </div>
                <div style="margin-top:12px;padding:10px;background:var(--sidebar);border-radius:8px;font-size:11px;color:var(--text-muted)">
                    <b>Verf√ºgbare Typen:</b> text, number, color, icon, bool, select<br>
                    <b>Spezielle Variablen:</b> {{value}} = aktueller KO-Wert
                </div>
            </div>
        </div>
        
        <!-- Conditions Section (for sensorCard) -->
        <div id="vseConditionsSection" style="margin-top:20px;display:none">
            <h4 style="margin:0 0 12px 0;color:var(--warning)"><i class="mdi mdi-code-braces"></i> Bedingte Formatierung</h4>
            <div id="vseCondList">
                <!-- Condition rows will be added here -->
            </div>
            <button class="btn btn-sm btn-secondary" onclick="addVseCondition()"><i class="mdi mdi-plus"></i> Bedingung hinzuf√ºgen</button>
        </div>
        
        <!-- Custom HTML/CSS Section -->
        <div id="vseCustomSection" style="margin-top:20px;display:none">
            <h4 style="margin:0 0 12px 0;color:var(--success)"><i class="mdi mdi-code-tags"></i> Custom Template</h4>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
                <div class="form-group"><label class="form-label">HTML</label>
                    <textarea id="vseCreateHtml" rows="8" style="font-family:monospace;font-size:12px" placeholder='<div class="widget">
  <i class="mdi mdi-{{icon}}"></i>
  <span class="label">{{label}}</span>
  <span class="value">{{value}} {{unit}}</span>
</div>'></textarea>
                </div>
                <div class="form-group"><label class="form-label">CSS</label>
                    <textarea id="vseCreateCss" rows="8" style="font-family:monospace;font-size:12px" placeholder='.widget { 
  display: flex; 
  align-items: center;
  gap: 12px;
  padding: 12px;
  background: rgba(255,255,255,0.06);
  border-radius: 12px;
}'></textarea>
                </div>
            </div>
        </div>
        
        <!-- Preview -->
        <div style="margin-top:20px">
            <h4 style="margin:0 0 12px 0;color:var(--text-muted)"><i class="mdi mdi-eye"></i> Vorschau</h4>
            <div id="vsePreview" style="background:var(--bg);border:1px solid var(--border);border-radius:12px;padding:20px;min-height:80px;display:flex;align-items:center;justify-content:center">
                <span style="color:var(--text-muted)">Vorschau wird nach Eingabe generiert...</span>
            </div>
        </div>
    </div><div class="modal-footer">
        <button class="btn btn-danger" id="vseDeleteBtn" onclick="deleteVSEElement()" style="margin-right:auto;display:none"><i class="mdi mdi-delete"></i> L√∂schen</button>
        <button class="btn btn-secondary" onclick="hideModal('vseCreateModal')">Abbrechen</button>
        <button class="btn btn-accent" onclick="previewVSEElement()"><i class="mdi mdi-eye"></i> Vorschau</button>
        <button class="btn btn-primary" onclick="saveVSEElement()"><i class="mdi mdi-content-save"></i> Speichern</button>
    </div></div></div>
    
    <datalist id="addr-list"></datalist>
    
<script>
// Theme handling - restore before page renders
(function(){
    const saved=localStorage.getItem('knx-theme');
    if(saved==='light')document.documentElement.classList.add('light');
})();

function toggleTheme(){
    const root=document.documentElement;
    const isLight=root.classList.toggle('light');
    localStorage.setItem('knx-theme',isLight?'light':'dark');
    document.querySelector('.theme-toggle').textContent=isLight?'üåô':'‚òÄÔ∏è';
}

const API='/api/v1';
let addresses=[],internalAddrs=[],allAddresses=[],blocks=[],availBlocks=[],pages=[],currentPage='default';
let blockPositions={};

// ========== VISU SYSTEM ==========
let visuPages={default:{id:'default',name:'Standard',size:'full',widgets:[]}};
let currentVisuPage='default';
let visuEditMode=false;
let visuDragEl=null,visuDragOff={x:0,y:0};
let currentEditWidget=null;
let selectedBlock=null;

function getErrMsg(e){
    if(!e)return'Unbekannter Fehler';
    if(typeof e==='string')return e;
    if(e instanceof Error)return e.message;
    if(e.detail){
        if(typeof e.detail==='string')return e.detail;
        if(Array.isArray(e.detail)&&e.detail[0]?.msg)return e.detail[0].loc?.join('.')+': '+e.detail[0].msg;
        if(e.detail.msg)return e.detail.msg;
        return JSON.stringify(e.detail);
    }
    if(e.message)return String(e.message);
    return JSON.stringify(e);
}

document.addEventListener('DOMContentLoaded',async()=>{
    // Set correct theme icon
    const isLight=document.documentElement.classList.contains('light');
    const btn=document.querySelector('.theme-toggle');
    if(btn)btn.textContent=isLight?'üåô':'‚òÄÔ∏è';
    
    await loadAll();
    setInterval(()=>{loadStatus();loadTelegrams();loadBlocks();loadAddresses();},2000);
});

async function loadAll(){
    loadStatus();
    loadAddresses();
    await loadBlockPositions();
    loadBlocks(true);
    loadAvail();
    loadPages();
    loadTelegrams();
    loadFiles();
    loadVisuConfig();
    loadVSEElements();
}

function showPage(id){
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
    document.getElementById('page-'+id)?.classList.add('active');
    document.querySelector(`[onclick="showPage('${id}')"]`)?.classList.add('active');
    const titles={dashboard:'Dashboard',visu:'Visualisierung',vse:'Widget-Bibliothek',addresses:'KNX Adressen',internal:'Interne (IKO)',logic:'Logik-Editor',blocks:'Bausteintypen',code:'Code-Editor',settings:'Einstellungen',import:'Import/Export',update:'System-Update',logs:'Logs'};
    document.getElementById('pageTitle').textContent=titles[id]||id;
    if(id==='logs')loadLogs();
    if(id==='settings')loadSettings();
    // Reload addresses and blocks when switching to logic or internal page
    if(id==='logic'||id==='internal'){loadAddresses();loadAvail();}
}

async function restartSystem(){
    if(!confirm('System wirklich neu starten?\n\nAlle laufenden Prozesse werden beendet und neu gestartet.'))return;
    showAlert('info','System wird neu gestartet...');
    try{
        const r=await fetch(`${API}/system/restart`,{method:'POST'});
        if(r.ok){
            showAlert('success','Neustart eingeleitet - Seite l√§dt in 5 Sekunden neu...');
            setTimeout(()=>location.reload(),5000);
        }else{
            showAlert('error','Neustart fehlgeschlagen');
        }
    }catch(e){
        // Server might be restarting, try reload anyway
        showAlert('info','Verbindung unterbrochen - Seite l√§dt neu...');
        setTimeout(()=>location.reload(),3000);
    }
}

function showModal(id){document.getElementById(id).classList.add('show');}
function hideModal(id){document.getElementById(id).classList.remove('show');}
function closeModal(id){hideModal(id);}
function showAlert(type,msg){const a=document.getElementById('mainAlert');a.className='alert show '+type;a.textContent=msg;setTimeout(()=>a.classList.remove('show'),4000);}

async function loadStatus(){
    try{
        const d=await(await fetch(`${API}/status`)).json();
        document.getElementById('connStatus').className='status-badge '+(d.knx_connected?'online':'offline');
        document.getElementById('connText').textContent=d.knx_connected?'Verbunden':'Getrennt';
        document.getElementById('sGateway').textContent=d.gateway_ip||'-';
        
        // Update gateway gauge
        const gauge=document.getElementById('gatewayGauge');
        const status=document.getElementById('gatewayStatus');
        if(gauge&&status){
            if(d.knx_connected){
                gauge.setAttribute('stroke','#3fb950');
                gauge.setAttribute('stroke-dashoffset','0');
                status.textContent='‚óè';
                status.style.color='#3fb950';
            }else{
                gauge.setAttribute('stroke','#f85149');
                gauge.setAttribute('stroke-dashoffset','63');
                status.textContent='‚óã';
                status.style.color='#f85149';
            }
        }
    }catch(e){}
}

function updateDashboard(){
    // Update donut chart
    const total=addresses.length+internalAddrs.length;
    const active=allAddresses.filter(a=>a.last_value!==null&&a.last_value!==undefined&&a.last_value!=='').length;
    const inactive=total-active;
    
    if(total>0){
        const activePercent=Math.round((active/total)*100);
        const inactivePercent=100-activePercent;
        
        const donutActive=document.getElementById('donutActive');
        if(donutActive){
            donutActive.setAttribute('stroke-dasharray',`${activePercent} ${inactivePercent}`);
            donutActive.setAttribute('stroke-dashoffset','25');
        }
    }
    
    const legendActive=document.getElementById('legendActive');
    const legendInactive=document.getElementById('legendInactive');
    if(legendActive)legendActive.textContent=`Aktiv: ${active}`;
    if(legendInactive)legendInactive.textContent=`Ohne: ${inactive}`;
    
    // Update temperature widget (find first temperature address)
    const tempAddr=allAddresses.find(a=>a.dpt&&a.dpt.startsWith('9')&&a.last_value!==null&&a.last_value!==undefined);
    const tempValueEl=document.getElementById('tempValue');
    if(tempValueEl){
        if(tempAddr){
            const val=parseFloat(tempAddr.last_value);
            tempValueEl.textContent=(!isNaN(val)?val.toFixed(1):'--')+'¬∞C';
        }else{
            tempValueEl.textContent='--¬∞C';
        }
    }
    
    // Update quick values - show with nice grid layout
    const withValues=allAddresses.filter(a=>a.last_value!==null&&a.last_value!==undefined&&a.last_value!=='').slice(0,8);
    const qv=document.getElementById('quickValues');
    if(qv){
        if(withValues.length>0){
            qv.innerHTML=`<div class="quick-values">
                ${withValues.map(a=>{
                    const val=a.last_value;
                    const numVal=parseFloat(val);
                    const isNum=!isNaN(numVal);
                    const display=isNum?(numVal%1===0?numVal:numVal.toFixed(1)):val;
                    const isTemp=a.dpt&&a.dpt.startsWith('9');
                    const isBool=val==='1'||val==='0'||val===true||val===false||val==='True'||val==='False';
                    const boolVal=val==='1'||val===true||val==='True';
                    return `<div class="quick-value-item">
                        <div class="quick-value-addr">${a.address}</div>
                        <div class="quick-value-name">${a.name||'-'}</div>
                        <div class="quick-value-val" style="color:${isTemp?'var(--warning)':isBool?(boolVal?'var(--success)':'var(--text-muted)'):'var(--accent)'}">${isBool?(boolVal?'ON':'OFF'):display}</div>
                    </div>`;
                }).join('')}
            </div>`;
        }else{
            qv.innerHTML='<div style="color:var(--text-muted);text-align:center;padding:20px">Keine aktuellen Werte vorhanden</div>';
        }
    }
    
    // Check for OAuth2 blocks and update widget
    updateOAuthWidgets();
}

// OAuth Widget Update Functions
function updateOAuthWidgets(){
    const oauthBlocks=blocks.filter(b=>b.block_id&&(b.block_id.includes('oauth')||b.block_id.includes('OAuth')||b.name?.toLowerCase().includes('oauth')||b.name?.toLowerCase().includes('netatmo')||b.name?.toLowerCase().includes('token')));
    
    if(oauthBlocks.length>0){
        const b=oauthBlocks[0];
        const outputs=b.output_values||{};
        
        // Map outputs to OAuth data
        const data={
            A2:parseInt(outputs.expires_in||outputs.A2||3200),
            A3:outputs.status||outputs.A3||1,
            A4:outputs.error||outputs.message||outputs.A4||'',
            A5:outputs.ready||outputs.A5||(outputs.status===1?1:0)||1,
            A7:outputs.auth_url||outputs.A7||'',
            A8:outputs.source||outputs.A8||b.name||'API-Refresh'
        };
        
        updateOAuthWidget(data, b.name||'Netatmo Service');
    }else{
        // Demo data when no OAuth blocks
        updateOAuthWidget({A2:3200,A3:1,A4:'',A5:1,A7:'',A8:'Demo'}, 'OAuth2 Service');
    }
}

function updateOAuthWidget(data, title){
    const statusIcon=document.getElementById('oauth-status-icon');
    const progressBar=document.getElementById('oauth-progress');
    const authLink=document.getElementById('oauth-auth-link');
    const refreshBtn=document.getElementById('oauth-refresh-btn');
    const readyText=document.getElementById('oauth-ready-text');
    const sourceEl=document.getElementById('oauth-source');
    const expiryEl=document.getElementById('oauth-expiry');
    
    if(!progressBar)return;
    
    // Status Logic - Icon color
    const isReady=data.A5===1||data.A5==='1'||data.A5===true;
    if(statusIcon){
        statusIcon.style.color=isReady?'var(--success)':'var(--danger)';
    }
    
    // Source text
    if(sourceEl)sourceEl.textContent='Status: '+(isReady?'Aktiv':'Inaktiv');
    if(readyText)readyText.textContent='Quelle: '+(data.A8||'-');
    
    // Progress bar
    const percent=Math.min(100,(data.A2/3600)*100);
    progressBar.style.width=percent+'%';
    if(percent<20)progressBar.style.background='var(--danger)';
    else if(percent<50)progressBar.style.background='var(--warning)';
    else progressBar.style.background='var(--accent)';
    
    if(expiryEl)expiryEl.textContent=data.A2>0?formatDuration(data.A2)+' verbleibend':'-';
    
    // Auth flow
    if(authLink&&refreshBtn){
        if(data.A7&&data.A7!==''){
            authLink.href=data.A7;
            authLink.style.display='flex';
            refreshBtn.style.display='none';
        }else{
            authLink.style.display='none';
            refreshBtn.style.display='flex';
        }
    }
}

function formatDuration(seconds){
    if(seconds>=3600)return Math.floor(seconds/3600)+'h '+Math.floor((seconds%3600)/60)+'m';
    if(seconds>=60)return Math.floor(seconds/60)+'m '+Math.floor(seconds%60)+'s';
    return seconds+'s';
}

function triggerOAuthRefresh(){
    // Find OAuth block and trigger refresh
    const oauthBlocks=blocks.filter(b=>b.block_id&&(b.block_id.includes('oauth')||b.block_id.includes('OAuth')));
    if(oauthBlocks.length>0){
        triggerBlock(oauthBlocks[0].instance_id);
        showAlert('info','Token-Refresh angefordert...');
    }else{
        showAlert('warning','Kein OAuth-Baustein gefunden');
    }
}

async function loadSettings(){
    try{
        const d=await(await fetch(`${API}/status`)).json();
        document.getElementById('settingsGatewayIp').value=d.gateway_ip||'';
        document.getElementById('settingsGatewayPort').value=d.gateway_port||3671;
    }catch(e){}
}

async function saveSettings(){
    const ip=document.getElementById('settingsGatewayIp').value.trim();
    const port=parseInt(document.getElementById('settingsGatewayPort').value)||3671;
    const mode=document.getElementById('settingsMode').value;
    
    if(!ip){showAlert('error','Bitte Gateway IP eingeben');return;}
    
    try{
        const r=await fetch(`${API}/settings/gateway?gateway_ip=${encodeURIComponent(ip)}&gateway_port=${port}&use_tunneling=${mode==='tunneling'}`,{method:'POST'});
        if(r.ok){
            showAlert('success','‚úì Einstellungen gespeichert, Verbindung wird aufgebaut...');
        }else{
            const d=await r.json();
            showAlert('error',getErrMsg(d));
        }
    }catch(e){showAlert('error','Fehler: '+getErrMsg(e));}
}

async function loadAddresses(){
    try{
        const all=await(await fetch(`${API}/group-addresses`)).json();
        allAddresses=all;
        addresses=all.filter(a=>!a.is_internal);
        internalAddrs=all.filter(a=>a.is_internal);
        document.getElementById('sAddr').textContent=addresses.length;
        document.getElementById('addrCount').textContent=addresses.length;
        document.getElementById('sInt').textContent=internalAddrs.length;
        document.getElementById('intCount').textContent=internalAddrs.length;
        renderAddr();renderInt();updateDatalist();updateDashboard();
    }catch(e){}
}

async function loadBlocks(forceRender=false){
    try{
        const newBlocks=await(await fetch(`${API}/logic/blocks`)).json();
        const changed=blocks.length!==newBlocks.length;
        blocks=newBlocks;
        document.getElementById('sBlocks').textContent=blocks.length;
        document.getElementById('blockCount').textContent=blocks.length;
        if(forceRender||changed){
            renderLogicBlocks();
        } else {
            updateBlockValues();
            // Redraw wires in case bindings changed
            if(document.getElementById('page-logic')?.classList.contains('active')){
                drawWires();
            }
        }
    }catch(e){console.error('loadBlocks:',e)}
}

async function loadAvail(){
    try{
        availBlocks=await(await fetch(`${API}/logic/blocks/available`)).json();
        document.getElementById('blockType').innerHTML=availBlocks.map(b=>`<option value="${b.type}">[${b.id}] ${b.name}</option>`).join('');
        renderBlockTypeTable();
    }catch(e){console.error('loadAvail:',e)}
}

async function loadPages(){
    try{
        pages=await(await fetch(`${API}/logic/pages`)).json();
        renderPageTabs();
    }catch(e){console.error('loadPages:',e);pages=[];renderPageTabs()}
}

async function loadFiles(){try{const files=await(await fetch(`${API}/logic/custom-blocks`)).json();document.getElementById('filesTable').innerHTML=files.length?files.map(f=>`<tr><td><code>${f.filename}</code></td><td><button class="btn btn-sm btn-secondary" onclick="editCode('${f.filename}')">‚úèÔ∏è</button> <button class="btn btn-sm btn-danger" onclick="delFile('${f.filename}')">üóë</button></td></tr>`).join(''):'<tr><td colspan="2" class="empty">Keine eigenen Bausteine</td></tr>';}catch(e){}}
async function loadTelegrams(){try{const t=await(await fetch(`${API}/knx/telegrams?count=10`)).json();const telegrams=t.telegrams||t||[];document.getElementById('telegramTable').innerHTML=telegrams.length?telegrams.map(x=>`<tr><td>${new Date(x.timestamp).toLocaleTimeString('de-DE')}</td><td><code>${x.source}</code></td><td><code>${x.destination}</code></td><td><b>${x.payload}</b></td></tr>`).join(''):'<tr><td colspan="4" class="empty">Keine Telegramme</td></tr>';}catch(e){console.error('loadTelegrams:',e);}}

function renderAddr(){
    const q=(document.getElementById('searchAddr')?.value||'').toLowerCase();
    const f=addresses.filter(a=>(a.name||'').toLowerCase().includes(q)||(a.address||'').includes(q));
    updateDeleteSelectedBtn();
    document.getElementById('addrTable').innerHTML=f.length?f.map(a=>`<tr><td><input type="checkbox" data-addr="${a.address}" ${selectedAddrs.has(a.address)?'checked':''} onchange="toggleAddrSelect('${a.address}',this.checked)"></td><td><code>${a.address}</code></td><td>${a.name||'-'}</td><td>${a.dpt||'-'}</td><td><b>${fmtVal(a.last_value,a.dpt)}</b></td><td>${a.last_updated?new Date(a.last_updated).toLocaleString('de-DE'):'-'}</td><td><button class="btn btn-sm btn-secondary" onclick="editAddr('${a.address}','${(a.name||'').replace(/'/g,"\\'")}','${a.dpt||''}')">‚úèÔ∏è</button><button class="btn btn-sm btn-danger" onclick="delAddr('${a.address}')">üóë</button></td></tr>`).join(''):'<tr><td colspan="7" class="empty">Keine Adressen</td></tr>';
}

function fmtVal(val,dpt){
    if(val===null||val===undefined||val==='')return'-';
    if(typeof val==='boolean')return val?'ON':'OFF';
    if(typeof val==='number')return val%1===0?String(val):val.toFixed(2);
    if(typeof val==='string'){
        if(/^[0-9a-f]{4}$/i.test(val)&&dpt&&dpt.startsWith('9')){
            const b=[parseInt(val.substr(0,2),16),parseInt(val.substr(2,2),16)];
            const s=(b[0]>>7)&1,e=(b[0]>>3)&0xF;let m=((b[0]&7)<<8)|b[1];if(s)m-=2048;
            return((0.01*m)*Math.pow(2,e)).toFixed(2);
        }
        return val.length>12?val.substring(0,11)+'‚Ä¶':val;
    }
    return String(val).substring(0,12);
}

function renderInt(){
    const listEl=document.getElementById('ikoGroupList');
    const countEl=document.getElementById('ikoCount');
    const withValEl=document.getElementById('ikoWithValue');
    const groupCountEl=document.getElementById('ikoGroupCount');
    
    if(countEl)countEl.textContent=internalAddrs.length;
    const withVal=internalAddrs.filter(a=>a.last_value!==null&&a.last_value!==undefined&&a.last_value!=='').length;
    if(withValEl)withValEl.textContent=withVal;
    
    if(!listEl)return;
    
    if(internalAddrs.length===0){
        listEl.innerHTML='<div style="color:var(--text-muted);text-align:center;padding:40px">Keine IKOs vorhanden. Klicke auf "+ Neue IKO" oder "Aus Baustein" um welche anzulegen.</div>';
        if(groupCountEl)groupCountEl.textContent='0';
        return;
    }
    
    // Group by prefix (everything except the last segment)
    const groups={};
    internalAddrs.forEach(a=>{
        const parts=a.address.split('/');
        // Use all parts except the last as group key
        const groupKey = parts.length > 1 ? parts.slice(0, -1).join('/') : 'Ungroupiert';
        if(!groups[groupKey])groups[groupKey]=[];
        groups[groupKey].push(a);
    });
    
    const groupKeys=Object.keys(groups).sort();
    if(groupCountEl)groupCountEl.textContent=groupKeys.length;
    
    // Table header
    let html=`<div class="iko-row" style="background:var(--sidebar);font-weight:600;font-size:11px;text-transform:uppercase;color:var(--text-muted);letter-spacing:0.5px;border:none;border-bottom:2px solid var(--border)">
        <span class="iko-row-addr">Adresse</span>
        <span class="iko-row-name">Name</span>
        <span class="iko-row-dpt">DPT</span>
        <span class="iko-row-value" style="background:transparent;cursor:default">Wert</span>
        <span class="iko-row-initial">Initial</span>
        <span class="iko-row-actions">Aktionen</span>
    </div>`;
    
    html+=groupKeys.map(groupKey=>{
        const items=groups[groupKey];
        const expanded=localStorage.getItem('iko_group_'+groupKey)!=='collapsed';
        
        return `<div class="iko-group${expanded?'':' collapsed'}" data-group="${groupKey}">
            <div class="iko-group-header" onclick="toggleIkoGroup('${groupKey}')">
                <i class="mdi mdi-chevron-down"></i>
                <i class="mdi mdi-folder${expanded?'-open':''}" style="color:var(--accent)"></i>
                <span class="iko-group-name">${groupKey}</span>
                <span class="iko-group-count">${items.length} IKO${items.length!==1?'s':''}</span>
                <button class="btn btn-sm btn-danger" onclick="event.stopPropagation();deleteIkoGroup('${groupKey}')" title="Gruppe l√∂schen"><i class="mdi mdi-delete"></i></button>
            </div>
            <div class="iko-group-body">
                ${items.map(a=>{
                    const val=a.last_value;
                    const hasVal=val!==null&&val!==undefined&&val!=='';
                    const displayVal=hasVal?fmtVal(val,a.dpt):'‚Äì';
                    const initVal=a.initial_value!==undefined&&a.initial_value!==null&&a.initial_value!==''?a.initial_value:'';
                    const escName=(a.name||'').replace(/'/g,"\\'");
                    // Show only the last segment as short address
                    const parts = a.address.split('/');
                    const shortAddr = parts[parts.length - 1];
                    
                    return `<div class="iko-row">
                        <span class="iko-row-addr" title="${a.address}">${shortAddr}</span>
                        <span class="iko-row-name">${a.name||'<span style="color:var(--text-muted)">-</span>'}</span>
                        <span class="iko-row-dpt">${a.dpt||'-'}</span>
                        <span class="iko-row-value" style="color:${hasVal?'var(--accent)':'var(--text-muted)'}" onclick="editIkoValue('${a.address}','${escName}')" title="Wert bearbeiten">${displayVal}</span>
                        <span class="iko-row-initial">${initVal?'Init: '+initVal:''}</span>
                        <span class="iko-row-actions">
                            <button class="btn btn-sm btn-secondary" onclick="editAddr('${a.address}','${escName}','${a.dpt||''}')" title="Bearbeiten"><i class="mdi mdi-pencil"></i></button>
                            <button class="btn btn-sm btn-warning" onclick="editIkoInitial('${a.address}','${escName}','${initVal}')" title="Initial-Wert"><i class="mdi mdi-restart"></i></button>
                            <button class="btn btn-sm btn-danger" onclick="delAddr('${a.address}')" title="L√∂schen"><i class="mdi mdi-delete"></i></button>
                        </span>
                    </div>`;
                }).join('')}
            </div>
        </div>`;
    }).join('');
    
    listEl.innerHTML=html;
}

function toggleIkoGroup(groupKey){
    const el=document.querySelector(`.iko-group[data-group="${groupKey}"]`);
    if(!el)return;
    el.classList.toggle('collapsed');
    const collapsed=el.classList.contains('collapsed');
    localStorage.setItem('iko_group_'+groupKey,collapsed?'collapsed':'expanded');
    const icon=el.querySelector('.iko-group-header .mdi-folder, .iko-group-header .mdi-folder-open');
    if(icon){icon.className='mdi mdi-folder'+(collapsed?'':'-open');icon.style.color='var(--accent)';}
}

function toggleAllGroups(expand){
    document.querySelectorAll('.iko-group').forEach(el=>{
        const groupKey=el.dataset.group;
        if(expand){el.classList.remove('collapsed');localStorage.setItem('iko_group_'+groupKey,'expanded');}
        else{el.classList.add('collapsed');localStorage.setItem('iko_group_'+groupKey,'collapsed');}
        const icon=el.querySelector('.iko-group-header .mdi-folder, .iko-group-header .mdi-folder-open');
        if(icon){icon.className='mdi mdi-folder'+(expand?'-open':'');icon.style.color='var(--accent)';}
    });
}

async function deleteIkoGroup(groupKey){
    // Find all items where the prefix (everything except last segment) matches the groupKey
    const items=internalAddrs.filter(a=>{
        const parts = a.address.split('/');
        const prefix = parts.length > 1 ? parts.slice(0, -1).join('/') : 'Ungroupiert';
        return prefix === groupKey;
    });
    
    if(items.length === 0){
        showAlert('warning', 'Keine IKOs in dieser Gruppe gefunden');
        return;
    }
    if(!confirm(`Alle ${items.length} IKOs in Gruppe "${groupKey}" l√∂schen?`))return;
    
    let deleted = 0, errors = 0;
    for(const a of items){
        try {
            const r = await fetch(`${API}/group-addresses/${encodeURIComponent(a.address)}`,{method:'DELETE'});
            if(r.ok) deleted++;
            else {
                errors++;
                console.error('Delete failed:', a.address, r.status);
            }
        } catch(e) {
            errors++;
            console.error('Delete error:', a.address, e);
        }
    }
    
    loadAddresses();
    if(errors === 0){
        showAlert('success',`${deleted} IKOs gel√∂scht`);
    } else {
        showAlert('warning', `${deleted} gel√∂scht, ${errors} Fehler`);
    }
}

// IKO from Block functions
function showIkoFromBlockModal(){
    // Populate block type dropdown
    const select=document.getElementById('ikoBlockType');
    select.innerHTML='<option value="">-- Baustein w√§hlen --</option>'+
        availBlocks.map(b=>`<option value="${b.type}">[${b.id}] ${b.name} (E:${Object.keys(b.inputs||{}).length} A:${Object.keys(b.outputs||{}).length})</option>`).join('');
    document.getElementById('ikoGroupPrefix').value='';
    document.getElementById('ikoBlockPreview').innerHTML='<span style="color:var(--text-muted)">W√§hle einen Baustein und gib einen Prefix ein</span>';
    document.getElementById('ikoCreateInputs').checked=true;
    document.getElementById('ikoCreateOutputs').checked=true;
    showModal('ikoFromBlockModal');
}

function previewBlockIkos(){
    const blockType=document.getElementById('ikoBlockType').value;
    let groupName=document.getElementById('ikoGroupPrefix').value.trim();
    const preview=document.getElementById('ikoBlockPreview');
    const createInputs=document.getElementById('ikoCreateInputs').checked;
    const createOutputs=document.getElementById('ikoCreateOutputs').checked;
    
    if(!blockType||!groupName){
        preview.innerHTML='<span style="color:var(--text-muted)">W√§hle einen Baustein und gib einen Gruppen-Namen ein</span>';
        return;
    }
    
    // Auto-add INT/ prefix
    const prefix = 'INT/' + groupName.replace(/^INT\//i, '');
    
    const block=availBlocks.find(b=>b.type===blockType);
    if(!block){preview.innerHTML='<span style="color:var(--danger)">Baustein nicht gefunden</span>';return;}
    
    let html='';
    const inputs=Object.entries(block.inputs||{});
    const outputs=Object.entries(block.outputs||{});
    
    if(createInputs&&inputs.length>0){
        html+=`<div style="font-weight:600;color:var(--success);margin-bottom:6px"><i class="mdi mdi-arrow-right-bold"></i> Eing√§nge (${inputs.length})</div>`;
        inputs.forEach(([key,info])=>{
            const addr=`${prefix}/${key}`;
            const name=info.name||info.description||key;
            const dpt=info.dpt||'';
            html+=`<div style="display:flex;gap:10px;padding:4px 0;border-bottom:1px solid var(--border)">
                <code style="color:var(--purple);min-width:150px">${addr}</code>
                <span style="flex:1">${name}</span>
                <span style="color:var(--text-muted);font-size:11px">${dpt||'-'}</span>
            </div>`;
        });
    }
    
    if(createOutputs&&outputs.length>0){
        html+=`<div style="font-weight:600;color:var(--accent);margin:12px 0 6px 0"><i class="mdi mdi-arrow-left-bold"></i> Ausg√§nge (${outputs.length})</div>`;
        outputs.forEach(([key,info])=>{
            const addr=`${prefix}/${key}`;
            const name=info.name||info.description||key;
            const dpt=info.dpt||'';
            html+=`<div style="display:flex;gap:10px;padding:4px 0;border-bottom:1px solid var(--border)">
                <code style="color:var(--purple);min-width:150px">${addr}</code>
                <span style="flex:1">${name}</span>
                <span style="color:var(--text-muted);font-size:11px">${dpt||'-'}</span>
            </div>`;
        });
    }
    
    if(!html)html='<span style="color:var(--warning)">Keine IKOs ausgew√§hlt</span>';
    
    const total=(createInputs?inputs.length:0)+(createOutputs?outputs.length:0);
    html=`<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:2px solid var(--border)"><b>${total} IKOs</b> werden erstellt f√ºr <b>${block.name}</b> in Gruppe <code style="color:var(--purple)">${prefix}</code></div>`+html;
    
    preview.innerHTML=html;
}

async function createIkosFromBlock(){
    const blockType=document.getElementById('ikoBlockType').value;
    let groupName=document.getElementById('ikoGroupPrefix').value.trim();
    const createInputs=document.getElementById('ikoCreateInputs').checked;
    const createOutputs=document.getElementById('ikoCreateOutputs').checked;
    
    if(!blockType){showAlert('error','Bitte Baustein w√§hlen');return;}
    if(!groupName){showAlert('error','Bitte Gruppen-Name eingeben');return;}
    
    // Auto-add INT/ prefix and clean up
    const prefix = 'INT/' + groupName.replace(/^INT\//i, '').replace(/\/$/, '');
    
    const block=availBlocks.find(b=>b.type===blockType);
    if(!block){showAlert('error','Baustein nicht gefunden');return;}
    
    const toCreate=[];
    
    if(createInputs){
        Object.entries(block.inputs||{}).forEach(([key,info])=>{
            toCreate.push({
                address:`${prefix}/${key}`,
                name:info.name||info.description||key,
                dpt:info.dpt||null,
                is_internal:true
            });
        });
    }
    
    if(createOutputs){
        Object.entries(block.outputs||{}).forEach(([key,info])=>{
            toCreate.push({
                address:`${prefix}/${key}`,
                name:info.name||info.description||key,
                dpt:info.dpt||null,
                is_internal:true
            });
        });
    }
    
    if(toCreate.length===0){showAlert('warning','Keine IKOs zum Erstellen');return;}
    
    let created=0,errors=0;
    for(const iko of toCreate){
        try{
            const r=await fetch(`${API}/group-addresses`,{
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify(iko)
            });
            if(r.ok)created++;
            else errors++;
        }catch(e){errors++;}
    }
    
    hideModal('ikoFromBlockModal');
    loadAddresses();
    
    if(errors===0){
        showAlert('success',`${created} IKOs erstellt in Gruppe "${prefix}"`);
    }else{
        showAlert('warning',`${created} erstellt, ${errors} Fehler (evtl. bereits vorhanden)`);
    }
}

function renderBlockTypeTable(){document.getElementById('blockTypeTable').innerHTML=availBlocks.map(b=>`<tr><td><code style="color:var(--success)">${b.id}</code></td><td><b>${b.name}</b></td><td>${b.category||'-'}</td><td style="max-width:300px">${b.description||'-'}</td><td>${Object.keys(b.inputs||{}).length} / ${Object.keys(b.outputs||{}).length}</td></tr>`).join('');}

function renderPageTabs(){
    const tabs=document.getElementById('pagesTabs');
    let html=`<div class="tab${currentPage==='default'?' active':''}" onclick="selectPage('default')">Standard</div>`;
    (pages||[]).forEach(p=>{html+=`<div class="tab${currentPage===p.id?' active':''}" onclick="selectPage('${p.id}')">${p.name||p.id}<span class="delete-tab" onclick="event.stopPropagation();deletePage('${p.id}')">√ó</span></div>`;});
    tabs.innerHTML=html;
}

function selectPage(id){currentPage=id;renderPageTabs();renderLogicBlocks();}
function updateDatalist(){document.getElementById('addr-list').innerHTML=allAddresses.map(a=>`<option value="${a.address}">${a.name||a.address}</option>`).join('');}

function renderLogicBlocks(){
    const c=document.getElementById('logicBlocksContainer');
    const pb=blocks.filter(b=>(currentPage==='default'&&!b.page_id)||(b.page_id===currentPage));
    
    if(!pb.length){
        c.innerHTML='<svg id="wiresCanvas" class="wire-svg"></svg><div class="empty" style="width:100%">Keine Bausteine auf dieser Seite</div>';
        return;
    }
    
    // Calculate wire connections (output bindings that match input bindings of other blocks)
    const wireConnections = [];
    pb.forEach(srcBlock => {
        const outBindings = srcBlock.output_bindings || {};
        Object.entries(outBindings).forEach(([outKey, addr]) => {
            if (!addr) return;
            pb.forEach(tgtBlock => {
                if (tgtBlock.instance_id === srcBlock.instance_id) return;
                const inBindings = tgtBlock.input_bindings || {};
                Object.entries(inBindings).forEach(([inKey, inAddr]) => {
                    if (inAddr === addr) {
                        wireConnections.push({
                            fromBlock: srcBlock.instance_id,
                            fromKey: outKey,
                            toBlock: tgtBlock.instance_id,
                            toKey: inKey
                        });
                    }
                });
            });
        });
    });
    
    const blocksHtml = pb.map((b,i)=>{
        const pos=blockPositions[b.instance_id]||{x:60+((i%2)*460),y:60+(Math.floor(i/2)*320)};
        const meta=availBlocks.find(x=>x.id===b.block_id)||{};
        // Sort inputs and outputs by key (E1, E2, ... and A1, A2, ...)
        const inputsArr=Object.entries(b.inputs||{}).sort((a,b) => {
            const numA = parseInt(a[0].replace(/\D/g,'')) || 0;
            const numB = parseInt(b[0].replace(/\D/g,'')) || 0;
            return numA - numB;
        });
        const outputsArr=Object.entries(b.outputs||{}).sort((a,b) => {
            const numA = parseInt(a[0].replace(/\D/g,'')) || 0;
            const numB = parseInt(b[0].replace(/\D/g,'')) || 0;
            return numA - numB;
        });
        const inBindings=b.input_bindings||{};
        const outBindings=b.output_bindings||{};
        const selected=selectedBlock===b.instance_id?'selected':'';
        const hasError = b.error ? 'error' : '';
        
        // Berechne Anzahl Zeilen = max(inputs, outputs)
        const numRows = Math.max(inputsArr.length, outputsArr.length, 1);
        
        // Baue Tabellen-Zeilen
        let rowsHtml = '';
        for(let r=0; r<numRows; r++){
            const inp = inputsArr[r];
            const out = outputsArr[r];
            
            // Input-Seite (links) mit Port und Wert
            let inputHtml = '';
            if(inp){
                const [k,v] = inp;
                const binding = inBindings[k]||v.binding||'';
                const val = b.input_values?.[k]??v.value;
                // Check if this input has a wire connection to another block
                const hasWire = wireConnections.some(w=>w.toBlock===b.instance_id&&w.toKey===k);
                const wiredClass = hasWire?'wired':'';
                const displayVal = formatDisplayVal(val);
                const fullVal = escVal(val);
                const label = v.config?.name||k;
                const inputNum = r+1;
                const bindingLabel = binding ? `<span class="eblock-binding" title="${binding}">${binding.length>15?binding.substring(0,15)+'‚Ä¶':binding}</span>` : '';
                inputHtml = `
                    <div class="eblock-port input ${wiredClass}" data-block="${b.instance_id}" data-io="input" data-key="${k}"
                        onmousedown="event.stopPropagation();startWire(event,'${b.instance_id}','input','${k}')" 
                        onmouseup="endWire(event,'${b.instance_id}','input','${k}')"></div>
                    <span class="eblock-input-label"><span class="eblock-input-num">E${inputNum}</span>${label}</span>
                    <div style="display:flex;align-items:center;gap:4px;margin-top:2px">
                        ${bindingLabel}
                        <span class="eblock-input-value" title="${fullVal}" 
                            onclick="event.stopPropagation();editBinding('${b.instance_id}','input','${k}','${(binding||'').replace(/'/g,"\\'")}')">${displayVal || '‚Äì'}</span>
                    </div>`;
            }
            
            // Output-Seite (rechts) mit Port und Wert
            let outputHtml = '';
            if(out){
                const [k,v] = out;
                const binding = outBindings[k]||v.binding||'';
                const val = b.output_values?.[k]??v.value;
                // Check if this output has a wire connection to another block
                const hasWire = wireConnections.some(w=>w.fromBlock===b.instance_id&&w.fromKey===k);
                const wiredClass = hasWire?'wired':'';
                const displayVal = formatDisplayVal(val);
                const fullVal = escVal(val);
                const label = v.config?.name||k;
                const outputNum = r+1;
                const bindingLabel = binding ? `<span class="eblock-binding" title="${binding}">${binding.length>15?binding.substring(0,15)+'‚Ä¶':binding}</span>` : '';
                outputHtml = `
                    <span class="eblock-output-label">${label}<span class="eblock-output-num">A${outputNum}</span></span>
                    <div style="display:flex;align-items:center;gap:4px;margin-top:2px;justify-content:flex-end">
                        ${bindingLabel}
                        <span class="eblock-output-value" title="${fullVal}"
                            onclick="event.stopPropagation();editBinding('${b.instance_id}','output','${k}','${(binding||'').replace(/'/g,"\\'")}')">${displayVal || '‚Äì'}</span>
                    </div>
                    <div class="eblock-port output ${wiredClass}" data-block="${b.instance_id}" data-io="output" data-key="${k}"
                        onmousedown="event.stopPropagation();startWire(event,'${b.instance_id}','output','${k}')" 
                        onmouseup="endWire(event,'${b.instance_id}','output','${k}')"></div>`;
            }
            
            rowsHtml += `<tr class="eblock-row">
                <td class="eblock-input">${inputHtml}</td>
                <td class="eblock-output">${outputHtml}</td>
            </tr>`;
        }
        
        // Status-Zeile
        const statusText = b.status || (b.enabled ? 'Aktiv' : 'Pausiert');
        const blockVersion = meta.version || '1.0';
        const blockNum = b.block_id || meta.id || '?';
        
        return `
        <div class="eblock ${selected} ${hasError}" id="block-${b.instance_id}" style="left:${pos.x}px;top:${pos.y}px" onclick="selectBlock('${b.instance_id}')">
            <div class="eblock-header" onmousedown="startDrag(event,'${b.instance_id}')" ondblclick="event.stopPropagation();showBlockDebug('${b.instance_id}')">
                ${b.name||meta.name||'Block'}<span class="eblock-header-info">(${blockNum} v${blockVersion})</span>
            </div>
            <div class="eblock-body">
                <table class="eblock-table"><tbody>${rowsHtml}</tbody></table>
            </div>
            <div class="eblock-status">${statusText}</div>
        </div>`;
    }).join('');
    
    c.innerHTML = '<svg id="wiresCanvas" class="wire-svg"></svg>' + blocksHtml;
    setTimeout(drawWires, 100);
}

function getCategoryColor(cat){
    // Not used anymore - single green color
    return '';
}

function formatDisplayVal(val){
    if(val===null||val===undefined||val==='')return'';
    if(typeof val==='boolean')return val?'1':'0';
    if(val==='True')return'1';
    if(val==='False')return'0';
    const s=String(val);
    if(s.length>18)return s.substring(0,15)+'...';
    return s;
}

function shortAddr(addr){
    if(!addr)return'';
    if(addr.length>15)return addr.substring(0,12)+'...';
    return addr;
}

// ========== BLOCK PROPERTIES PANEL ==========
function selectBlock(instanceId){
    selectedBlock=instanceId;
    
    // Update selection visuals
    document.querySelectorAll('.eblock').forEach(el=>el.classList.remove('selected'));
    const blockEl=document.getElementById('block-'+instanceId);
    if(blockEl)blockEl.classList.add('selected');
    
    // Show props panel
    const panel=document.getElementById('logicPropsPanel');
    panel.classList.add('active');
    
    // Find block data
    const b=blocks.find(x=>x.instance_id===instanceId);
    if(!b)return;
    
    const meta=availBlocks.find(x=>x.id===b.block_id)||{};
    const inputs=b.inputs||{};
    const outputs=b.outputs||{};
    // Use bindings from the dedicated binding objects, NOT from inputs/outputs
    const inBindings=b.input_bindings||{};
    const outBindings=b.output_bindings||{};
    
    // Debug logging
    console.log('Block:', instanceId);
    console.log('output_bindings:', JSON.stringify(outBindings));
    console.log('outputs:', Object.keys(outputs).map(k => `${k}: binding=${outputs[k]?.binding}`));
    
    // Sort inputs and outputs by key (E1, E2, ... and A1, A2, ...)
    const sortedInputs = Object.entries(inputs).sort((a,b) => {
        const numA = parseInt(a[0].replace(/\D/g,'')) || 0;
        const numB = parseInt(b[0].replace(/\D/g,'')) || 0;
        return numA - numB;
    });
    const sortedOutputs = Object.entries(outputs).sort((a,b) => {
        const numA = parseInt(a[0].replace(/\D/g,'')) || 0;
        const numB = parseInt(b[0].replace(/\D/g,'')) || 0;
        return numA - numB;
    });
    
    let html=`
        <div style="margin-bottom:16px">
            <div style="font-size:16px;font-weight:600;margin-bottom:4px">${b.name||'Block'}</div>
            <div style="font-size:12px;color:var(--text-muted)">${meta.category||'Baustein'}</div>
        </div>
        
        <div style="display:flex;gap:8px;margin-bottom:16px">
            <button class="btn btn-sm btn-primary" onclick="triggerBlock('${instanceId}')">‚ñ∂ Ausf√ºhren</button>
            <button class="btn btn-sm btn-secondary" onclick="showBlockDebug('${instanceId}')">üîç Debug</button>
            <button class="btn btn-sm btn-danger" onclick="delBlock('${instanceId}')">üóë</button>
        </div>
        
        <div class="logic-props-section">
            <h4>Eing√§nge</h4>
            ${sortedInputs.map(([k,v])=>{
                // IMPORTANT: Use the binding from input_bindings, not from v.binding
                const binding=inBindings[k]||'';
                const val=b.input_values?.[k]??v.value;
                return `
                <div class="logic-props-row">
                    <span class="logic-props-label">${k}: ${v.config?.name||k}</span>
                    <span class="logic-props-value ${valClass(val)}" data-live-input="${instanceId}-${k}">${shortVal(val)}</span>
                </div>
                <div class="logic-props-row" style="border:none;padding-top:0">
                    <span class="logic-props-label" style="font-size:10px">Binding</span>
                    <span class="logic-props-value" style="font-size:10px;color:var(--accent);cursor:pointer" onclick="editBinding('${instanceId}','input','${k}','${(binding||'').replace(/'/g,"\\'")}')">
                        ${binding||'<i style="color:var(--text-muted)">nicht verbunden</i>'}
                    </span>
                </div>`;
            }).join('')}
        </div>
        
        <div class="logic-props-section">
            <h4>Ausg√§nge</h4>
            ${sortedOutputs.map(([k,v])=>{
                // IMPORTANT: Use the binding from output_bindings, not from v.binding
                const binding=outBindings[k]||'';
                const val=b.output_values?.[k]??v.value;
                return `
                <div class="logic-props-row">
                    <span class="logic-props-label">${k}: ${v.config?.name||k}</span>
                    <span class="logic-props-value ${valClass(val)}" data-live-output="${instanceId}-${k}">${shortVal(val)}</span>
                </div>
                <div class="logic-props-row" style="border:none;padding-top:0">
                    <span class="logic-props-label" style="font-size:10px">Binding</span>
                    <span class="logic-props-value" style="font-size:10px;color:var(--accent);cursor:pointer" onclick="editBinding('${instanceId}','output','${k}','${(binding||'').replace(/'/g,"\\'")}')">
                        ${binding||'<i style="color:var(--text-muted)">nicht verbunden</i>'}
                    </span>
                </div>`;
            }).join('')}
        </div>
        
        ${meta.description?`<div class="logic-props-section"><h4>Beschreibung</h4><p style="font-size:12px;color:var(--text-muted);line-height:1.5">${meta.description}</p></div>`:''}
    `;
    
    document.getElementById('propsContent').innerHTML=html;
}

function closePropsPanel(){
    selectedBlock=null;
    document.querySelectorAll('.eblock').forEach(el=>el.classList.remove('selected'));
    document.getElementById('logicPropsPanel').classList.remove('active');
}

function getCategoryClass(cat){
    const c=(cat||'').toLowerCase();
    if(c.includes('system')||c.includes('zeit'))return'cat-system';
    if(c.includes('math')||c.includes('rechen'))return'cat-math';
    if(c.includes('logic')||c.includes('logik')||c.includes('vergleich'))return'cat-logic';
    if(c.includes('timer')||c.includes('trigger'))return'cat-timer';
    if(c.includes('knx'))return'cat-knx';
    if(c.includes('api')||c.includes('http')||c.includes('oauth'))return'cat-api';
    if(c.includes('wetter')||c.includes('weather')||c.includes('netatmo')||c.includes('ecowitt'))return'cat-weather';
    if(c.includes('sensor'))return'cat-sensor';
    if(c.includes('kalender')||c.includes('calendar')||c.includes('ical'))return'cat-calendar';
    if(c.includes('eigen')||c.includes('custom'))return'cat-custom';
    return'cat-default';
}

function escVal(v){return String(v??'').replace(/`/g,'\\`').replace(/\\/g,'\\\\');}
function valClass(v){
    if(v===null||v===undefined||v==='')return'null';
    if(typeof v==='boolean')return v?'bool-on':'bool-off';
    if(v==='True'||v==='1'||v===1)return'bool-on';
    if(v==='False'||v==='0'||v===0)return'bool-off';
    if(typeof v==='number')return'number';
    if(typeof v==='string'&&v.length>0)return'string';
    return'';
}
function shortVal(v){
    if(v===null||v===undefined||v==='')return'‚Äì';
    if(typeof v==='boolean')return v?'ON':'OFF';
    if(v==='True')return'ON';
    if(v==='False')return'OFF';
    if(typeof v==='number')return v%1===0?String(v):v.toFixed(2);
    const s=String(v);
    if(s.length>20)return s.substring(0,18)+'‚Ä¶';
    return s;
}

function updateBlockValues(){
    blocks.forEach(b=>{
        const inputs=b.inputs||{};
        const outputs=b.outputs||{};
        
        Object.entries(inputs).forEach(([k,v],idx)=>{
            const el=document.querySelector(`#block-${b.instance_id} .eblock-inputs .eio:nth-child(${idx+1}) .eio-val`);
            if(el){el.textContent=shortVal(v?.value);el.className='eio-val '+valClass(v?.value);}
        });
        Object.entries(outputs).forEach(([k,v],idx)=>{
            const el=document.querySelector(`#block-${b.instance_id} .eblock-outputs .eio:nth-child(${idx+1}) .eio-val`);
            if(el){el.textContent=shortVal(v?.value);el.className='eio-val '+valClass(v?.value);}
        });
        
        // Update props panel live values
        Object.entries(inputs).forEach(([k,v])=>{
            const val = b.input_values?.[k] ?? v.value;
            const el = document.querySelector(`[data-live-input="${b.instance_id}-${k}"]`);
            if(el){
                el.textContent = shortVal(val);
                el.className = 'logic-props-value ' + valClass(val);
            }
        });
        Object.entries(outputs).forEach(([k,v])=>{
            const val = b.output_values?.[k] ?? v.value;
            const el = document.querySelector(`[data-live-output="${b.instance_id}-${k}"]`);
            if(el){
                el.textContent = shortVal(val);
                el.className = 'logic-props-value ' + valClass(val);
            }
        });
    });
}

let dragEl=null,dragOff={x:0,y:0};
function startDrag(e,id){
    if(e.target.tagName==='BUTTON')return;
    e.preventDefault();
    dragEl=document.getElementById('block-'+id);
    dragOff={x:e.clientX-dragEl.offsetLeft,y:e.clientY-dragEl.offsetTop};
    dragEl.style.zIndex=1000;
    document.addEventListener('mousemove',onDrag);
    document.addEventListener('mouseup',stopDrag);
}
function onDrag(e){if(dragEl){dragEl.style.left=(e.clientX-dragOff.x)+'px';dragEl.style.top=(e.clientY-dragOff.y)+'px';drawWires();}}
function stopDrag(){
    if(dragEl){
        dragEl.style.zIndex='';
        blockPositions[dragEl.id.replace('block-','')]={x:parseInt(dragEl.style.left),y:parseInt(dragEl.style.top)};
        saveBlockPositions();
        drawWires();
    }
    dragEl=null;
    document.removeEventListener('mousemove',onDrag);
    document.removeEventListener('mouseup',stopDrag);
}

async function saveBlockPositions(){
    try{
        await fetch(`${API}/logic/positions`,{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify(blockPositions)
        });
    }catch(e){console.error('Save positions failed:',e);}
}

async function loadBlockPositions(){
    try{
        const r=await fetch(`${API}/logic/positions`);
        if(r.ok){
            const data=await r.json();
            blockPositions=data||{};
        }
    }catch(e){console.error('Load positions failed:',e);}
}

// ============ WIRE CONNECTION SYSTEM ============
let wireStart = null;  // {blockId, ioType, key, el}
let tempWireLine = null;

function startWire(e, blockId, ioType, key) {
    e.preventDefault();
    e.stopPropagation();
    
    const el = e.target;
    el.classList.add('wire-dragging');
    
    wireStart = { blockId, ioType, key, el };
    
    // Create temporary wire line
    const svg = document.getElementById('wiresCanvas');
    const srcBlock = document.getElementById(`block-${blockId}`);
    
    const startX = srcBlock.offsetLeft + (ioType === 'output' ? srcBlock.offsetWidth - 10 : 10);
    const startY = srcBlock.offsetTop + el.offsetTop + el.offsetHeight / 2;
    
    tempWireLine = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    tempWireLine.setAttribute('stroke', ioType === 'output' ? '#3fb950' : '#58a6ff');
    tempWireLine.setAttribute('stroke-width', '2');
    tempWireLine.setAttribute('fill', 'none');
    tempWireLine.setAttribute('stroke-dasharray', '5,5');
    tempWireLine.setAttribute('d', `M${startX},${startY} L${startX},${startY}`);
    svg.appendChild(tempWireLine);
    
    document.addEventListener('mousemove', onWireMove);
    document.addEventListener('mouseup', cancelWire);
}

function onWireMove(e) {
    if (!wireStart || !tempWireLine) return;
    
    const container = document.getElementById('logicBlocksContainer');
    const containerRect = container.getBoundingClientRect();
    
    // Get start position from the source block's position
    const srcBlock = document.getElementById(`block-${wireStart.blockId}`);
    const startX = srcBlock.offsetLeft + (wireStart.ioType === 'output' ? srcBlock.offsetWidth - 10 : 10);
    const startY = srcBlock.offsetTop + wireStart.el.offsetTop + wireStart.el.offsetHeight / 2;
    
    const endX = e.clientX - containerRect.left + container.scrollLeft;
    const endY = e.clientY - containerRect.top + container.scrollTop;
    
    // Bezier curve for nice wire look
    const midX = (startX + endX) / 2;
    const d = `M${startX},${startY} C${midX},${startY} ${midX},${endY} ${endX},${endY}`;
    tempWireLine.setAttribute('d', d);
    
    // Highlight potential targets
    document.querySelectorAll('.eblock-port').forEach(pin => {
        pin.classList.remove('wire-target');
        const pinIo = pin.dataset.io;
        const pinBlock = pin.dataset.block;
        
        // Valid target: different block, different io type
        if (pinBlock !== wireStart.blockId && pinIo !== wireStart.ioType) {
            const pinRect = pin.getBoundingClientRect();
            const dist = Math.hypot(e.clientX - (pinRect.left + pinRect.width/2), 
                                     e.clientY - (pinRect.top + pinRect.height/2));
            if (dist < 30) {
                pin.classList.add('wire-target');
            }
        }
    });
}

function endWire(e, blockId, ioType, key) {
    e.preventDefault();
    e.stopPropagation();
    
    if (!wireStart) return;
    
    // Check if valid connection (output -> input or input -> output, different blocks)
    if (wireStart.blockId !== blockId && wireStart.ioType !== ioType) {
        // Determine source (output) and target (input)
        let sourceBlock, sourceKey, targetBlock, targetKey;
        
        if (wireStart.ioType === 'output') {
            sourceBlock = wireStart.blockId;
            sourceKey = wireStart.key;
            targetBlock = blockId;
            targetKey = key;
        } else {
            sourceBlock = blockId;
            sourceKey = key;
            targetBlock = wireStart.blockId;
            targetKey = wireStart.key;
        }
        
        // Create connection via API
        createWireConnection(sourceBlock, sourceKey, targetBlock, targetKey);
    }
    
    cleanupWire();
}

function cancelWire(e) {
    // Check if we dropped on a valid target
    const target = document.elementFromPoint(e.clientX, e.clientY);
    if (target && target.classList.contains('eio-pin') && target.dataset.block) {
        endWire(e, target.dataset.block, target.dataset.io, target.dataset.key);
        return;
    }
    cleanupWire();
}

function cleanupWire() {
    if (wireStart && wireStart.el) {
        wireStart.el.classList.remove('wire-dragging');
    }
    if (tempWireLine) {
        tempWireLine.remove();
    }
    document.querySelectorAll('.eblock-port.wire-target').forEach(p => p.classList.remove('wire-target'));
    
    wireStart = null;
    tempWireLine = null;
    
    document.removeEventListener('mousemove', onWireMove);
    document.removeEventListener('mouseup', cancelWire);
}

async function createWireConnection(sourceBlock, sourceKey, targetBlock, targetKey) {
    // Create auto IKO name
    const sourceName = blocks.find(b => b.instance_id === sourceBlock)?.name || sourceBlock.split('_')[0];
    const ikoAddr = `IKO:${sourceName.substring(0,12)}_${sourceKey}`;
    
    showAlert('info', `Verbinde ${sourceName}.${sourceKey} ‚Üí ${targetKey}...`);
    console.log('Creating wire:', {sourceBlock, sourceKey, targetBlock, targetKey, ikoAddr});
    
    try {
        // 1. Create IKO address if not exists
        const r1 = await fetch(`${API}/group-addresses`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                address: ikoAddr,
                name: `${sourceName} ${sourceKey}`,
                is_internal: true,
                enabled: true
            })
        });
        console.log('IKO create response:', r1.status, await r1.text().catch(()=>''));
        
        // 2. Bind source output to IKO
        const r2 = await fetch(`${API}/logic/blocks/${sourceBlock}/bind-output`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ output_key: sourceKey, address: ikoAddr })
        });
        console.log('Output bind response:', r2.status, await r2.clone().text().catch(()=>''));
        if (!r2.ok) {
            showAlert('error', 'Ausgang-Binding fehlgeschlagen');
            return;
        }
        
        // 3. Bind target input to same IKO
        const r3 = await fetch(`${API}/logic/blocks/${targetBlock}/bind`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ input_key: targetKey, address: ikoAddr })
        });
        console.log('Input bind response:', r3.status, await r3.clone().text().catch(()=>''));
        if (!r3.ok) {
            showAlert('error', 'Eingang-Binding fehlgeschlagen');
            return;
        }
        
        showAlert('success', `‚úì Verbindung erstellt: ${ikoAddr}`);
        
        // Reload and redraw
        await loadBlocks(true);
        await loadAddresses();
        
        // Redraw wires after data is loaded
        setTimeout(() => {
            console.log('Redrawing wires. Blocks:', blocks.map(b => ({id: b.instance_id, in: b.input_bindings, out: b.output_bindings})));
            drawWires();
        }, 500);
        
    } catch(err) {
        console.error('Wire connection error:', err);
        showAlert('error', 'Verbindung fehlgeschlagen: ' + err.message);
    }
}

function drawWires() {
    const svg = document.getElementById('wiresCanvas');
    if (!svg) {
        console.log('drawWires: No SVG canvas found');
        return;
    }
    
    // Clear existing wires (except temp wire)
    svg.querySelectorAll('path:not([stroke-dasharray])').forEach(p => p.remove());
    
    const container = document.getElementById('logicBlocksContainer');
    if (!container) return;
    
    // Calculate required SVG size based on block positions
    let maxX = 1000, maxY = 800;
    document.querySelectorAll('.eblock').forEach(block => {
        const right = block.offsetLeft + block.offsetWidth + 50;
        const bottom = block.offsetTop + block.offsetHeight + 50;
        if (right > maxX) maxX = right;
        if (bottom > maxY) maxY = bottom;
    });
    svg.style.width = maxX + 'px';
    svg.style.height = maxY + 'px';
    
    // Find all connections: output bindings that match input bindings
    const connections = [];
    
    blocks.forEach(srcBlock => {
        const outBindings = srcBlock.output_bindings || {};
        Object.entries(outBindings).forEach(([outKey, addr]) => {
            if (!addr) return;
            
            // Find blocks with inputs bound to same address
            blocks.forEach(tgtBlock => {
                if (tgtBlock.instance_id === srcBlock.instance_id) return;
                
                const inBindings = tgtBlock.input_bindings || {};
                Object.entries(inBindings).forEach(([inKey, inAddr]) => {
                    if (inAddr === addr) {
                        connections.push({
                            srcBlock: srcBlock.instance_id,
                            srcKey: outKey,
                            tgtBlock: tgtBlock.instance_id,
                            tgtKey: inKey,
                            addr: addr
                        });
                    }
                });
            });
        });
    });
    
    console.log('drawWires: Found', connections.length, 'connections');
    
    // Draw each connection
    connections.forEach(conn => {
        const srcBlockEl = document.getElementById(`block-${conn.srcBlock}`);
        const tgtBlockEl = document.getElementById(`block-${conn.tgtBlock}`);
        if (!srcBlockEl || !tgtBlockEl) {
            console.log('drawWires: Block elements not found', conn.srcBlock, conn.tgtBlock);
            return;
        }
        
        const srcPin = srcBlockEl.querySelector(`.eblock-port.output[data-key="${conn.srcKey}"]`);
        const tgtPin = tgtBlockEl.querySelector(`.eblock-port.input[data-key="${conn.tgtKey}"]`);
        if (!srcPin || !tgtPin) {
            console.log('drawWires: Pins not found', conn.srcKey, conn.tgtKey);
            return;
        }
        
        // Get pin positions relative to their block
        const srcPinRect = srcPin.getBoundingClientRect();
        const tgtPinRect = tgtPin.getBoundingClientRect();
        const srcBlockRect = srcBlockEl.getBoundingClientRect();
        const tgtBlockRect = tgtBlockEl.getBoundingClientRect();
        
        // Calculate positions in container coordinates
        const x1 = srcBlockEl.offsetLeft + (srcPinRect.left - srcBlockRect.left) + srcPinRect.width / 2;
        const y1 = srcBlockEl.offsetTop + (srcPinRect.top - srcBlockRect.top) + srcPinRect.height / 2;
        const x2 = tgtBlockEl.offsetLeft + (tgtPinRect.left - tgtBlockRect.left) + tgtPinRect.width / 2;
        const y2 = tgtBlockEl.offsetTop + (tgtPinRect.top - tgtBlockRect.top) + tgtPinRect.height / 2;
        
        // Draw bezier curve
        const dx = Math.abs(x2 - x1);
        const controlOffset = Math.max(40, dx * 0.5);
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('d', `M${x1},${y1} C${x1 + controlOffset},${y1} ${x2 - controlOffset},${y2} ${x2},${y2}`);
        path.setAttribute('class', 'wire-path');
        path.setAttribute('data-conn', `${conn.srcBlock}-${conn.tgtBlock}`);
        
        svg.appendChild(path);
    });
}

// ============ END WIRE SYSTEM ============

function editBinding(blockId,ioType,key,current){
    document.getElementById('bindModalError').style.display='none';
    
    // Refresh addresses before showing dialog
    loadAddresses();
    
    // Find current block to get current value
    const block = blocks.find(b => b.instance_id === blockId);
    const currentValue = block ? (ioType === 'input' ? block.input_values?.[key] : block.output_values?.[key]) : '';
    
    // Build list of other blocks' outputs for direct connection (only for inputs)
    let blockOutputs = [];
    if (ioType === 'input') {
        const otherBlocks = blocks.filter(b => b.instance_id !== blockId);
        blockOutputs = otherBlocks.flatMap(b => 
            Object.keys(b.outputs||{}).map(ok => ({
                addr: `BLOCK:${b.instance_id}:${ok}`,
                label: `${b.name||b.block_type}.${ok}`,
                val: b.output_values?.[ok]
            }))
        );
    }
    
    // Combine all addresses (KNX + IKO)
    const allAddrs = [...addresses, ...internalAddrs];
    
    let html = `<div class="form-group">
        <label class="form-label">${ioType==='output'?'Ausgang':'Eingang'} ${key}</label>`;
    
    // Only show direct value input for inputs
    if (ioType === 'input') {
        html += `<div style="margin-bottom:12px">
            <label class="form-label" style="font-size:11px;color:var(--text-muted)">Direkter Wert (f√ºr statische Konfiguration)</label>
            <input id="directValue" value="${currentValue !== null && currentValue !== undefined ? String(currentValue).replace(/"/g,'&quot;') : ''}" placeholder="Wert direkt eingeben...">
        </div>`;
    } else {
        html += `<div style="margin-bottom:12px;padding:8px;background:var(--sidebar);border-radius:6px">
            <label class="form-label" style="font-size:11px;color:var(--text-muted)">Aktueller Wert:</label>
            <div style="font-family:monospace;color:var(--success)">${currentValue !== null && currentValue !== undefined ? String(currentValue) : '-'}</div>
        </div>`;
    }
    
    html += `<div>
            <label class="form-label" style="font-size:11px;color:var(--text-muted)">Binding an KNX/IKO Adresse ${ioType==='output'?'(schreibt Wert auf Adresse)':'(liest Wert von Adresse)'}</label>
            <input id="bindValue" value="${current||''}" list="addr-list" placeholder="z.B. 1/2/3 oder INT/name">
        </div>
    </div>
    <div style="margin-top:8px">
        <input type="text" id="bindAddrFilter" placeholder="üîç Adressen filtern..." oninput="filterBindAddresses()" style="font-size:11px;padding:6px 10px">
    </div>
    <div id="bindAddrList" style="margin-top:8px;max-height:200px;overflow-y:auto;background:var(--sidebar);border-radius:6px;padding:8px;font-size:11px">
        <div style="color:var(--text-muted);font-size:10px;margin-bottom:4px;display:flex;justify-content:space-between">
            <span>üìç KNX Adressen (${addresses.length})</span>
            <span style="color:var(--purple)">üîó IKO (${internalAddrs.length})</span>
        </div>
        ${allAddrs.map(a=>{
            const isInternal=a.is_internal||a.address.startsWith('INT/');
            return `<div class="bind-addr-item" data-addr="${a.address}" data-name="${(a.name||'').toLowerCase()}" style="padding:4px 6px;cursor:pointer;border-radius:4px;display:flex;justify-content:space-between;border-bottom:1px solid var(--border)" onmouseover="this.style.background='var(--card-hover)'" onmouseout="this.style.background=''" onclick="document.getElementById('bindValue').value='${a.address}'">
                <code style="color:${isInternal?'var(--purple)':'var(--accent)'}">${a.address}</code>
                <span style="color:var(--text-muted);font-size:10px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:150px">${a.name||''}</span>
            </div>`;
        }).join('')}
        ${blockOutputs.length ? `<div style="color:var(--text-muted);font-size:10px;margin:12px 0 4px 0;padding-top:8px;border-top:1px solid var(--border)">üß© Bausteinausg√§nge (${blockOutputs.length}):</div>` : ''}
        ${blockOutputs.map(o=>`<div class="bind-addr-item" data-addr="${o.addr}" data-name="${o.label.toLowerCase()}" style="padding:4px 6px;cursor:pointer;border-radius:4px;display:flex;justify-content:space-between" onmouseover="this.style.background='var(--card-hover)'" onmouseout="this.style.background=''" onclick="document.getElementById('bindValue').value='${o.addr}'"><code style="color:var(--success)">${o.label}</code><span style="color:var(--text-muted)">${o.val??'-'}</span></div>`).join('')}
    </div>
    <div style="margin-top:16px;display:flex;gap:8px;flex-wrap:wrap">`;
    
    if (ioType === 'input') {
        html += `<button class="btn btn-primary" onclick="saveInputValue('${blockId}','${key}')">üíæ Wert speichern</button>`;
    }
    html += `<button class="btn btn-success" onclick="saveBind('${blockId}','${ioType}','${key}')">üîó Binding speichern</button>
        <button class="btn btn-danger" onclick="saveBind('${blockId}','${ioType}','${key}',true)">üóë Entfernen</button>
    </div>`;
    
    document.getElementById('bindContent').innerHTML = html;
    showModal('bindModal');
}

function filterBindAddresses(){
    const filter=document.getElementById('bindAddrFilter').value.toLowerCase();
    document.querySelectorAll('.bind-addr-item').forEach(el=>{
        const addr=el.dataset.addr.toLowerCase();
        const name=el.dataset.name||'';
        el.style.display=(addr.includes(filter)||name.includes(filter))?'flex':'none';
    });
}

async function saveInputValue(blockId, key) {
    const val = document.getElementById('directValue').value;
    const errEl = document.getElementById('bindModalError');
    
    try {
        const r = await fetch(`${API}/logic/blocks/${blockId}/input/${key}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({value: val})
        });
        if (!r.ok) {
            const d = await r.json();
            errEl.textContent = getErrMsg(d);
            errEl.style.display = 'block';
            return;
        }
        hideModal('bindModal');
        loadBlocks(true);
        showAlert('success', '‚úì Wert gespeichert');
    } catch(e) {
        errEl.textContent = getErrMsg(e);
        errEl.style.display = 'block';
    }
}

async function saveBind(blockId,ioType,key,remove=false){
    const val=remove?'':document.getElementById('bindValue').value;
    const errEl=document.getElementById('bindModalError');
    const endpoint=ioType==='input'?`${API}/logic/blocks/${blockId}/bind`:`${API}/logic/blocks/${blockId}/bind-output`;
    const body=ioType==='input'?{input_key:key,address:val}:{output_key:key,address:val};
    
    try{
        const r=await fetch(endpoint,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
        if(!r.ok){const d=await r.json();errEl.textContent=getErrMsg(d);errEl.style.display='block';return;}
        hideModal('bindModal');loadBlocks(true);showAlert('success',remove?'‚úì Entfernt':'‚úì Gespeichert');
    }catch(e){errEl.textContent=getErrMsg(e);errEl.style.display='block';}
}

async function addBlock(){
    const type=document.getElementById('blockType').value;
    if(!type){showAlert('error','Bitte Bausteintyp w√§hlen');return;}
    
    const body={block_type:type};
    if(currentPage!=='default')body.page_id=currentPage;
    
    console.log('Creating block:',body);
    
    try{
        const r=await fetch(`${API}/logic/blocks`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
        const d=await r.json();
        console.log('Response:',r.status,d);
        
        if(r.ok){
            showAlert('success','‚úì Baustein erstellt');
            loadBlocks(true);
        }else{
            showAlert('error','Fehler: '+getErrMsg(d));
        }
    }catch(e){
        console.error('addBlock error:',e);
        showAlert('error','Fehler: '+getErrMsg(e));
    }
}

async function delBlock(id){if(!confirm('L√∂schen?'))return;await fetch(`${API}/logic/blocks/${id}`,{method:'DELETE'});delete blockPositions[id];loadBlocks(true);}
async function toggleBlock(id,en){await fetch(`${API}/logic/blocks/${id}/enable?enabled=${en}`,{method:'POST'});loadBlocks(true);}
async function triggerBlock(id){try{await fetch(`${API}/logic/blocks/${id}/trigger`,{method:'POST'});showAlert('success','‚úì Ausgef√ºhrt');}catch(e){showAlert('error',getErrMsg(e));}loadBlocks();}

async function showBlockDebug(id){
    try{
        const r=await fetch(`${API}/logic/blocks/${id}/debug`);
        const d=await r.json();
        document.getElementById('debugContent').value=JSON.stringify(d,null,2);
        showModal('debugModal');
    }catch(e){document.getElementById('debugContent').value='Error: '+e;showModal('debugModal');}
}

async function addPage(){
    const nameEl=document.getElementById('pageName');
    const errEl=document.getElementById('pageModalError');
    const name=nameEl.value.trim();
    errEl.style.display='none';
    
    if(!name){errEl.textContent='Bitte Namen eingeben';errEl.style.display='block';return;}
    
    const body={name:name};
    console.log('Creating page:',body);
    
    try{
        const r=await fetch(`${API}/logic/pages`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
        const text=await r.text();
        console.log('Response:',r.status,text);
        
        if(!r.ok){
            let msg='HTTP '+r.status;
            try{msg=getErrMsg(JSON.parse(text));}catch{}
            errEl.textContent=msg;errEl.style.display='block';
            return;
        }
        
        hideModal('pageModal');
        nameEl.value='';
        await loadPages();
        showAlert('success','‚úì Seite erstellt');
    }catch(e){
        console.error('addPage error:',e);
        errEl.textContent=getErrMsg(e);errEl.style.display='block';
    }
}

async function deletePage(id){if(!confirm('L√∂schen?'))return;await fetch(`${API}/logic/pages/${id}`,{method:'DELETE'});if(currentPage===id)currentPage='default';loadPages();loadBlocks(true);}

async function addInt(){
    const addr=document.getElementById('intAddr').value.trim();
    const name=document.getElementById('intName').value.trim();
    const dpt=document.getElementById('intDpt').value.trim();
    const initial=document.getElementById('intInitial').value.trim();
    if(!addr){showAlert('error','Bitte Adresse eingeben');return;}
    await fetch(`${API}/group-addresses`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({address:addr,name:name||addr,dpt:dpt||null,is_internal:true,initial_value:initial||null})});
    hideModal('intModal');document.getElementById('intAddr').value='';document.getElementById('intName').value='';document.getElementById('intDpt').value='';document.getElementById('intInitial').value='';
    loadAddresses();showAlert('success','‚úì IKO erstellt');
}
async function delAddr(addr){
    if(!confirm(`Adresse "${addr}" l√∂schen?`))return;
    try {
        const r=await fetch(`${API}/group-addresses/${encodeURIComponent(addr)}`,{method:'DELETE'});
        if(r.ok){
            showAlert('success', 'Adresse gel√∂scht');
        } else {
            const e=await r.json().catch(()=>({}));
            showAlert('error', 'Fehler: '+(e.detail||r.statusText));
        }
    } catch(e) {
        showAlert('error', 'Verbindungsfehler: ' + e.message);
    }
    loadAddresses();
}
async function setVal(addr){const val=prompt('Neuer Wert:');if(val===null)return;await fetch(`${API}/group-addresses/${encodeURIComponent(addr)}/value`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({value:val})});loadAddresses();}

// IKO Value Edit Functions
function editIkoValue(addr,name){
    document.getElementById('ikoValueAddr').value=addr;
    document.getElementById('ikoValueTitle').textContent='Wert setzen: '+(name||addr);
    const current=internalAddrs.find(a=>a.address===addr);
    document.getElementById('ikoValueInput').value=current?.last_value??'';
    showModal('ikoValueModal');
}

async function saveIkoValue(){
    const addr=document.getElementById('ikoValueAddr').value;
    const val=document.getElementById('ikoValueInput').value;
    try{
        await fetch(`${API}/group-addresses/${encodeURIComponent(addr)}/value`,{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({value:val})
        });
        closeModal('ikoValueModal');
        loadInternal();
        showAlert('success','Wert gespeichert');
    }catch(e){showAlert('error','Fehler: '+e.message);}
}

function editIkoInitial(addr,name,currentInit){
    document.getElementById('ikoInitialAddr').value=addr;
    document.getElementById('ikoInitialTitle').textContent='Initial-Wert: '+(name||addr);
    document.getElementById('ikoInitialInput').value=currentInit||'';
    showModal('ikoInitialModal');
}

async function saveIkoInitial(){
    const addr=document.getElementById('ikoInitialAddr').value;
    const val=document.getElementById('ikoInitialInput').value;
    try{
        // Update the address with initial_value
        const current=internalAddrs.find(a=>a.address===addr);
        await fetch(`${API}/group-addresses/${encodeURIComponent(addr)}`,{
            method:'PUT',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({
                address:addr,
                name:current?.name||'',
                dpt:current?.dpt||null,
                enabled:true,
                initial_value:val||null
            })
        });
        closeModal('ikoInitialModal');
        loadInternal();
        showAlert('success','Initial-Wert gespeichert');
    }catch(e){showAlert('error','Fehler: '+e.message);}
}

function editAddr(addr,name,dpt){
    document.getElementById('editAddrError').style.display='none';
    document.getElementById('editAddrOrig').value=addr;
    document.getElementById('editAddrAddr').value=addr;
    document.getElementById('editAddrName').value=name||'';
    document.getElementById('editAddrDpt').value=dpt||'';
    showModal('editAddrModal');
}

async function saveAddr(){
    const addr=document.getElementById('editAddrOrig').value;
    const name=document.getElementById('editAddrName').value.trim();
    const dpt=document.getElementById('editAddrDpt').value.trim()||null;
    
    try{
        const r=await fetch(`${API}/group-addresses/${encodeURIComponent(addr)}`,{
            method:'PUT',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({address:addr,name:name,dpt:dpt,enabled:true})
        });
        if(!r.ok){
            const e=await r.json().catch(()=>({}));
            document.getElementById('editAddrError').textContent='Fehler: '+(e.detail||r.statusText);
            document.getElementById('editAddrError').style.display='block';
            return;
        }
        hideModal('editAddrModal');
        loadAddresses();
    }catch(e){
        document.getElementById('editAddrError').textContent='Fehler: '+e.message;
        document.getElementById('editAddrError').style.display='block';
    }
}

function showValuePopup(key, name, value) {
    document.getElementById('valueModalLabel').textContent = `${key}: ${name}`;
    
    // Try to format JSON nicely
    let displayValue = value;
    try {
        if (value && (value.startsWith('[') || value.startsWith('{'))) {
            displayValue = JSON.stringify(JSON.parse(value), null, 2);
        }
    } catch(e) {}
    
    document.getElementById('valueModalContent').value = displayValue;
    showModal('valueModal');
}

function copyValueToClipboard() {
    const content = document.getElementById('valueModalContent');
    content.select();
    document.execCommand('copy');
    showAlert('success', '‚úì In Zwischenablage kopiert');
}

// Multi-select for addresses
let selectedAddrs = new Set();

function toggleAddrSelect(addr, checked) {
    if (checked) selectedAddrs.add(addr);
    else selectedAddrs.delete(addr);
    updateDeleteSelectedBtn();
}

function toggleAllAddrs(checked) {
    const checkboxes = document.querySelectorAll('#addrTable input[type="checkbox"]');
    checkboxes.forEach(cb => {
        cb.checked = checked;
        if (checked) selectedAddrs.add(cb.dataset.addr);
        else selectedAddrs.delete(cb.dataset.addr);
    });
    updateDeleteSelectedBtn();
}

function updateDeleteSelectedBtn() {
    const btn = document.getElementById('deleteSelectedBtn');
    if (btn) btn.style.display = selectedAddrs.size > 0 ? 'inline-block' : 'none';
}

async function deleteSelectedAddrs() {
    if (selectedAddrs.size === 0) return;
    if (!confirm(`${selectedAddrs.size} Adresse(n) l√∂schen?`)) return;
    
    for (const addr of selectedAddrs) {
        await fetch(`${API}/group-addresses/${encodeURIComponent(addr)}`, {method: 'DELETE'});
    }
    selectedAddrs.clear();
    loadAddresses();
    showAlert('success', '‚úì Adressen gel√∂scht');
}

async function uploadEsf(){
    const file=document.getElementById('esfFile').files[0];
    if(!file)return;
    const password=document.getElementById('importPassword').value;
    const form=new FormData();
    form.append('file',file);
    
    let url=`${API}/import/esf`;
    if(password){
        url+=`?password=${encodeURIComponent(password)}`;
    }
    
    showAlert('info','Importiere...');
    try{
        const r=await fetch(url,{method:'POST',body:form});
        const d=await r.json();
        showAlert(r.ok?'success':'error',d.message||getErrMsg(d));
        document.getElementById('esfFile').value='';
    }catch(e){
        showAlert('error',getErrMsg(e));
    }
    loadAddresses();
}
async function uploadUpdate(){const file=document.getElementById('updateFile').files[0];if(!file)return;const form=new FormData();form.append('file',file);showAlert('info','Wird hochgeladen...');try{const r=await fetch(`${API}/system/update/upload`,{method:'POST',body:form});const d=await r.json();showAlert(r.ok?'success':'error',d.message||getErrMsg(d));}catch(e){showAlert('error',getErrMsg(e));}}

async function checkVersion(){
    const info=document.getElementById('versionInfo');
    const ver=document.getElementById('currentVersion');
    info.style.display='block';
    ver.textContent='L√§dt...';
    try{
        const r=await fetch(`${API}/status`);
        const d=await r.json();
        ver.textContent=d.version||'1.7.3';
    }catch(e){
        ver.textContent='Fehler';
    }
}
async function restartSystem(){if(!confirm('Neustarten?'))return;showAlert('info','Wird neugestartet...');try{await fetch(`${API}/system/restart`,{method:'POST'});setTimeout(()=>location.reload(),5000);}catch(e){showAlert('error',getErrMsg(e));}}
async function uploadBlock(){
    const fileInput = document.getElementById('blockUpload');
    const file = fileInput.files[0];
    if(!file) return;
    
    const form = new FormData();
    form.append('file', file);
    
    showAlert('info', 'Wird hochgeladen...');
    
    try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000);
        
        const r = await fetch(`${API}/logic/custom-blocks/upload`, {
            method: 'POST',
            body: form,
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        const d = await r.json();
        showAlert(r.ok ? 'success' : 'error', d.message || d.detail || 'Unbekannter Fehler');
    } catch(e) {
        if (e.name === 'AbortError') {
            showAlert('error', 'Timeout - Server antwortet nicht');
        } else {
            showAlert('error', 'Verbindungsfehler: ' + (e.message || 'Server nicht erreichbar'));
        }
    }
    
    fileInput.value = '';
    loadFiles();
    loadAvail();
}

async function downloadBackup() {
    showAlert('info', 'Backup wird erstellt...');
    try {
        const r = await fetch(`${API}/system/backup`);
        if (!r.ok) throw new Error('Backup fehlgeschlagen');
        const blob = await r.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `knx-backup-${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        showAlert('success', '‚úì Backup heruntergeladen');
    } catch(e) {
        showAlert('error', 'Backup Fehler: ' + getErrMsg(e));
    }
}

async function uploadBackup() {
    const file = document.getElementById('backupFile').files[0];
    if (!file) return;
    if (!confirm('Alle aktuellen Einstellungen werden √ºberschrieben. Fortfahren?')) {
        document.getElementById('backupFile').value = '';
        return;
    }
    
    showAlert('info', 'Backup wird wiederhergestellt...');
    const form = new FormData();
    form.append('file', file);
    
    try {
        const r = await fetch(`${API}/system/restore`, {method: 'POST', body: form});
        const d = await r.json();
        if (r.ok) {
            showAlert('success', '‚úì Backup wiederhergestellt! Seite wird neu geladen...');
            setTimeout(() => location.reload(), 2000);
        } else {
            showAlert('error', 'Fehler: ' + (d.detail || d.message || 'Unbekannt'));
        }
    } catch(e) {
        showAlert('error', 'Restore Fehler: ' + getErrMsg(e));
    }
    document.getElementById('backupFile').value = '';
}

async function editCode(fn){try{const r=await fetch(`${API}/logic/custom-blocks/${fn}/code`);const d=await r.json();document.getElementById('codeFileName').textContent=fn;document.getElementById('codeEditor').value=d.code;showModal('codeModal');}catch(e){showAlert('error',getErrMsg(e));}}
async function saveCode(){const fn=document.getElementById('codeFileName').textContent;const code=document.getElementById('codeEditor').value;await fetch(`${API}/logic/custom-blocks/${fn}/code`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({code})});hideModal('codeModal');showAlert('success','‚úì Gespeichert');loadAvail();}
function newBlockFile(){const name=prompt('Dateiname (ohne .py):');if(!name)return;document.getElementById('codeFileName').textContent=name+'.py';document.getElementById('codeEditor').value=`from logic.base import LogicBlock\n\nclass MyBlock(LogicBlock):\n    ID = 99999\n    NAME = "Mein Baustein"\n    CATEGORY = "Eigene"\n    INPUTS = {'E1': {'name': 'Eingang', 'type': 'float'}}\n    OUTPUTS = {'A1': {'name': 'Ausgang', 'type': 'float'}}\n    \n    def on_input_change(self, key, value, old):\n        self.set_output('A1', value)\n`;showModal('codeModal');}
async function delFile(fn){if(!confirm('L√∂schen?'))return;await fetch(`${API}/logic/custom-blocks/${fn}`,{method:'DELETE'});loadFiles();loadAvail();}

async function loadLogs(){
    try{
        const level=document.getElementById('logLevel').value;
        const logs=await(await fetch(`${API}/logs?limit=100${level?'&level='+level:''}`)).json();
        document.getElementById('logContainer').innerHTML=logs.length?logs.map(l=>`<div class="log-entry"><span class="log-time">${new Date(l.time*1000).toLocaleTimeString('de-DE')}</span><span class="log-level ${l.level}">${l.level}</span>${l.message}</div>`).join(''):'<div class="empty">Keine Logs</div>';
    }catch(e){document.getElementById('logContainer').innerHTML='<div class="empty">Fehler</div>';}
}

// ========== VISU FUNCTIONS ==========
function setVisuSize(w,h){
    const canvas=document.getElementById('visuCanvas');
    document.querySelectorAll('.visu-size-btns button').forEach(b=>b.classList.remove('active'));
    event.target.classList.add('active');
    canvas.className='visu-canvas';
    if(w===0){canvas.classList.add('fullsize');}
    else if(w===375){canvas.classList.add('phone');}
    else if(w===768){canvas.classList.add('tablet');}
    else if(w===1920){canvas.classList.add('desktop');}
    else{canvas.style.width=w+'px';canvas.style.height=h+'px';}
}

function toggleVisuEdit(){
    visuEditMode=!visuEditMode;
    document.querySelectorAll('.visu-element').forEach(el=>el.classList.toggle('editing',visuEditMode));
    event.target.textContent=visuEditMode?'‚úì Fertig':'‚úèÔ∏è Bearbeiten';
    event.target.classList.toggle('btn-success',visuEditMode);
    event.target.classList.toggle('btn-secondary',!visuEditMode);
}

function openVisuFullscreen(){
    const container=document.getElementById('visuContainer');
    if(container.requestFullscreen)container.requestFullscreen();
    else if(container.webkitRequestFullscreen)container.webkitRequestFullscreen();
}

function showAddWidgetModal(){
    document.getElementById('visuWidgetLabel').value='';
    updateVisuWidgetForm();
    showModal('visuWidgetModal');
}

function updateVisuWidgetForm(){
    const type=document.getElementById('visuWidgetType').value;
    let html='';
    const addrOpts=allAddresses.map(a=>`<option value="${a.address}">${a.name||a.address}</option>`).join('');
    
    if(type==='switch'){
        html=`<div class="form-group"><label class="form-label">Schalt-Adresse</label><select id="vwAddr1"><option value="">-- Ausw√§hlen --</option>${addrOpts}</select></div>
              <div class="form-group"><label class="form-label">Status-Adresse (optional)</label><select id="vwAddr2"><option value="">-- Gleiche --</option>${addrOpts}</select></div>
              <div class="form-group"><label class="form-label">Icon</label><select id="vwIcon"><option value="üí°">üí° Lampe</option><option value="üîå">üîå Steckdose</option><option value="üöø">üöø Bad</option><option value="üç≥">üç≥ K√ºche</option><option value="‚ö°">‚ö° Strom</option></select></div>`;
    }else if(type==='dimmer'){
        html=`<div class="form-group"><label class="form-label">Dimm-Adresse (0-100%)</label><select id="vwAddr1"><option value="">-- Ausw√§hlen --</option>${addrOpts}</select></div>
              <div class="form-group"><label class="form-label">Icon</label><select id="vwIcon"><option value="üí°">üí° Lampe</option><option value="üîÜ">üîÜ Leuchte</option></select></div>`;
    }else if(type==='value'){
        html=`<div class="form-group"><label class="form-label">Wert-Adresse</label><select id="vwAddr1"><option value="">-- Ausw√§hlen --</option>${addrOpts}</select></div>
              <div class="form-group"><label class="form-label">Einheit</label><input id="vwUnit" placeholder="z.B. ¬∞C, %, kW"></div>
              <div class="form-group"><label class="form-label">Typ</label><select id="vwSubtype"><option value="">Standard</option><option value="temp">üå°Ô∏è Temperatur</option><option value="hum">üíß Feuchtigkeit</option><option value="power">‚ö° Leistung</option></select></div>`;
    }else if(type==='shutter'){
        html=`<div class="form-group"><label class="form-label">Position-Adresse (0-100%)</label><select id="vwAddr1"><option value="">-- Ausw√§hlen --</option>${addrOpts}</select></div>
              <div class="form-group"><label class="form-label">Auf/Ab-Adresse</label><select id="vwAddr2"><option value="">-- Ausw√§hlen --</option>${addrOpts}</select></div>`;
    }else if(type==='scene'){
        html=`<div class="form-group"><label class="form-label">Szenen-Adresse</label><select id="vwAddr1"><option value="">-- Ausw√§hlen --</option>${addrOpts}</select></div>
              <div class="form-group"><label class="form-label">Szenen-Nr (Wert)</label><input id="vwSceneNr" type="number" value="1"></div>
              <div class="form-group"><label class="form-label">Icon</label><select id="vwIcon"><option value="üé¨">üé¨ Szene</option><option value="üåô">üåô Nacht</option><option value="‚òÄÔ∏è">‚òÄÔ∏è Tag</option><option value="üéâ">üéâ Party</option><option value="üì∫">üì∫ Kino</option></select></div>`;
    }else if(type==='clock'){
        html=`<p style="color:var(--text-muted)">Zeigt die aktuelle Uhrzeit an.</p>`;
    }else if(type==='label'){
        html=`<div class="form-group"><label class="form-label">Text</label><input id="vwText" placeholder="Mein Text"></div>
              <div class="form-group"><label class="form-label">Schriftgr√∂√üe</label><select id="vwFontSize"><option value="14">14px</option><option value="18">18px</option><option value="24">24px</option><option value="32">32px</option></select></div>`;
    }
    document.getElementById('visuWidgetFields').innerHTML=html;
}

function addVisuWidget(){
    const type=document.getElementById('visuWidgetType').value;
    const label=document.getElementById('visuWidgetLabel').value||'Widget';
    const widget={
        id:'w'+Date.now(),
        type:type,
        label:label,
        x:50,y:50
    };
    
    if(type==='switch'){
        widget.addr=document.getElementById('vwAddr1').value;
        widget.statusAddr=document.getElementById('vwAddr2').value||widget.addr;
        widget.icon=document.getElementById('vwIcon').value;
    }else if(type==='dimmer'){
        widget.addr=document.getElementById('vwAddr1').value;
        widget.icon=document.getElementById('vwIcon').value;
    }else if(type==='value'){
        widget.addr=document.getElementById('vwAddr1').value;
        widget.unit=document.getElementById('vwUnit').value;
        widget.subtype=document.getElementById('vwSubtype').value;
    }else if(type==='shutter'){
        widget.posAddr=document.getElementById('vwAddr1').value;
        widget.moveAddr=document.getElementById('vwAddr2').value;
    }else if(type==='scene'){
        widget.addr=document.getElementById('vwAddr1').value;
        widget.sceneNr=document.getElementById('vwSceneNr').value;
        widget.icon=document.getElementById('vwIcon').value;
    }else if(type==='label'){
        widget.text=document.getElementById('vwText')?.value||label;
        widget.fontSize=document.getElementById('vwFontSize')?.value||'14';
    }
    
    visuPages[currentVisuPage].widgets.push(widget);
    saveVisuConfig();
    renderVisuPage();
    hideModal('visuWidgetModal');
}

function renderVisuPage(){
    const page=visuPages[currentVisuPage];
    if(!page)return;
    
    const canvas=document.getElementById('visuCanvas');
    let html='';
    
    (page.widgets||[]).forEach(w=>{
        const editClass=visuEditMode?'editing':'';
        html+=`<div class="visu-element ${editClass}" id="ve-${w.id}" style="left:${w.x}px;top:${w.y}px" 
                    onmousedown="startVisuDrag(event,'${w.id}')" ondblclick="editVisuWidget('${w.id}')">
                    ${renderWidget(w)}
                    <div class="resize-handle"></div>
               </div>`;
    });
    
    canvas.innerHTML=html;
    updateVisuValues();
}

function renderWidget(w){
    if(w.type==='switch'){
        const val=getAddrValue(w.statusAddr||w.addr);
        const on=val==='1'||val===true||val==='True'||val==='ON';
        return `<div class="ve-switch ${on?'on':''}" onclick="event.stopPropagation();toggleSwitch('${w.addr}',${!on})">
                    <span class="icon">${w.icon||'üí°'}</span>
                    <span class="label">${w.label}</span>
                </div>`;
    }else if(w.type==='dimmer'){
        const val=parseInt(getAddrValue(w.addr))||0;
        return `<div class="ve-dimmer">
                    <span class="icon">${w.icon||'üí°'}</span>
                    <div class="slider-v" onclick="event.stopPropagation();setDimmer('${w.addr}',event)">
                        <div class="slider-fill" style="height:${val}%"></div>
                    </div>
                    <span class="value">${val}%</span>
                </div>`;
    }else if(w.type==='value'){
        const val=getAddrValue(w.addr);
        const numVal=parseFloat(val)||0;
        const display=numVal%1===0?numVal:numVal.toFixed(1);
        return `<div class="ve-value ${w.subtype||''}">
                    <span class="label">${w.label}</span>
                    <span><span class="number">${display}</span><span class="unit">${w.unit||''}</span></span>
                </div>`;
    }else if(w.type==='shutter'){
        const pos=parseInt(getAddrValue(w.posAddr))||0;
        return `<div class="ve-shutter">
                    <div class="preview"><div class="slats" style="height:${pos}%"></div></div>
                    <div class="btns">
                        <button onclick="event.stopPropagation();sendAddr('${w.moveAddr}',0)">‚ñ≤</button>
                        <button onclick="event.stopPropagation();sendAddr('${w.moveAddr}',2)">‚óº</button>
                        <button onclick="event.stopPropagation();sendAddr('${w.moveAddr}',1)">‚ñº</button>
                    </div>
                    <span class="label">${w.label}</span>
                </div>`;
    }else if(w.type==='scene'){
        return `<div class="ve-scene" onclick="event.stopPropagation();sendAddr('${w.addr}',${w.sceneNr||1})">
                    <span class="icon">${w.icon||'üé¨'}</span>
                    <span class="label">${w.label}</span>
                </div>`;
    }else if(w.type==='clock'){
        return `<div class="ve-clock"><span class="time">${new Date().toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'})}</span></div>`;
    }else if(w.type==='label'){
        return `<div class="ve-label" style="font-size:${w.fontSize||14}px">${w.text||w.label}</div>`;
    }
    return `<div>${w.type}</div>`;
}

function getAddrValue(addr){
    if(!addr)return null;
    const a=allAddresses.find(x=>x.address===addr);
    return a?.last_value;
}

async function toggleSwitch(addr,state){
    if(!addr)return;
    await fetch(`${API}/knx/send`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({address:addr,value:state?1:0})});
    setTimeout(()=>{loadAddresses();updateVisuValues();},500);
}

async function setDimmer(addr,event){
    if(!addr)return;
    const rect=event.currentTarget.getBoundingClientRect();
    const pct=Math.round(100-((event.clientY-rect.top)/rect.height*100));
    const val=Math.max(0,Math.min(100,pct));
    await fetch(`${API}/knx/send`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({address:addr,value:val})});
    setTimeout(()=>{loadAddresses();updateVisuValues();},500);
}

async function sendAddr(addr,value){
    if(!addr)return;
    await fetch(`${API}/knx/send`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({address:addr,value:value})});
}

function updateVisuValues(){
    const page=visuPages[currentVisuPage];
    if(!page)return;
    page.widgets.forEach(w=>{
        const el=document.getElementById('ve-'+w.id);
        if(el){
            const inner=el.querySelector('.ve-switch,.ve-dimmer,.ve-value,.ve-shutter,.ve-clock');
            if(inner){
                const newContent=renderWidget(w);
                const temp=document.createElement('div');
                temp.innerHTML=newContent;
                inner.replaceWith(temp.firstChild);
            }
        }
    });
}

function startVisuDrag(e,id){
    if(!visuEditMode)return;
    if(e.target.classList.contains('resize-handle'))return;
    e.preventDefault();
    const el=document.getElementById('ve-'+id);
    visuDragEl={el,id};
    visuDragOff={x:e.clientX-el.offsetLeft,y:e.clientY-el.offsetTop};
    document.addEventListener('mousemove',onVisuDrag);
    document.addEventListener('mouseup',stopVisuDrag);
}

function onVisuDrag(e){
    if(!visuDragEl)return;
    visuDragEl.el.style.left=(e.clientX-visuDragOff.x)+'px';
    visuDragEl.el.style.top=(e.clientY-visuDragOff.y)+'px';
}

function stopVisuDrag(){
    if(visuDragEl){
        const w=visuPages[currentVisuPage].widgets.find(x=>x.id===visuDragEl.id);
        if(w){
            w.x=parseInt(visuDragEl.el.style.left);
            w.y=parseInt(visuDragEl.el.style.top);
            saveVisuConfig();
        }
    }
    visuDragEl=null;
    document.removeEventListener('mousemove',onVisuDrag);
    document.removeEventListener('mouseup',stopVisuDrag);
}

// Resize functionality
let visuResizeEl = null;
let visuResizeStart = null;

function startVisuResize(e, id) {
    if (!visuEditMode) return;
    e.preventDefault();
    e.stopPropagation();
    
    const el = document.getElementById('ve-' + id);
    const w = visuPages[currentVisuPage].widgets.find(x => x.id === id);
    if (!el || !w) return;
    
    visuResizeEl = { el, id, w };
    visuResizeStart = {
        x: e.clientX,
        y: e.clientY,
        width: el.offsetWidth || w.width || 100,
        height: el.offsetHeight || w.height || 60
    };
    
    document.addEventListener('mousemove', onVisuResize);
    document.addEventListener('mouseup', stopVisuResize);
}

function onVisuResize(e) {
    if (!visuResizeEl) return;
    
    const deltaX = e.clientX - visuResizeStart.x;
    const deltaY = e.clientY - visuResizeStart.y;
    
    const newWidth = Math.max(50, visuResizeStart.width + deltaX);
    const newHeight = Math.max(30, visuResizeStart.height + deltaY);
    
    visuResizeEl.el.style.width = newWidth + 'px';
    visuResizeEl.el.style.height = newHeight + 'px';
}

function stopVisuResize() {
    if (visuResizeEl) {
        const w = visuResizeEl.w;
        w.width = parseInt(visuResizeEl.el.style.width);
        w.height = parseInt(visuResizeEl.el.style.height);
        saveVisuConfig();
    }
    visuResizeEl = null;
    document.removeEventListener('mousemove', onVisuResize);
    document.removeEventListener('mouseup', stopVisuResize);
}

function editVisuWidget(id){
    if(!visuEditMode)return;
    const w=visuPages[currentVisuPage].widgets.find(x=>x.id===id);
    if(!w)return;
    currentEditWidget=w;
    
    const addrOpts=allAddresses.map(a=>`<option value="${a.address}" ${a.address===(w.addr||w.ko1)?'selected':''}>${a.name||a.address}</option>`).join('');
    
    let html='';
    
    if(w.type==='vse'){
        // Detect VSE type
        const vseId = w.vseId || '';
        const isSensorCard = vseId.includes('sensor') || (w.vseName||'').toLowerCase().includes('sensor');
        
        // Initialize vars if not present
        if(!w.vars) w.vars = {};
        const v = w.vars;
        
        if(isSensorCard){
            // Comprehensive Sensor Card Editor
            html = `
            <div style="max-height:60vh;overflow-y:auto;padding-right:10px">
                <h4 style="margin:0 0 12px 0;color:var(--accent)"><i class="mdi mdi-card-outline"></i> Sensor Card Einstellungen</h4>
                
                <!-- Basic -->
                <div class="form-group"><label class="form-label">Wert-Adresse (KO)</label>
                    <select id="veAddr"><option value="">-- Keine --</option>${addrOpts}</select>
                </div>
                
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                    <div class="form-group"><label class="form-label">Bezeichnung</label><input id="veLabel" value="${v.label||w.label||''}"></div>
                    <div class="form-group"><label class="form-label">Einheit</label><input id="veUnit" value="${v.unit||''}" placeholder="z.B. ¬∞C, %, W"></div>
                </div>
                
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
                    <div class="form-group"><label class="form-label">Dezimalstellen</label><input type="number" id="veDecimals" value="${v.decimals||1}" min="0" max="5"></div>
                    <div class="form-group"><label class="form-label">Breite</label><input type="number" id="veWidth" value="${w.width||200}"></div>
                    <div class="form-group"><label class="form-label">H√∂he</label><input type="number" id="veHeight" value="${w.height||120}"></div>
                </div>
                
                <hr style="border:none;border-top:1px solid var(--border);margin:16px 0">
                <h4 style="margin:0 0 12px 0;color:var(--purple)"><i class="mdi mdi-palette"></i> Icon</h4>
                
                <div style="display:grid;grid-template-columns:2fr 1fr 1fr;gap:12px">
                    <div class="form-group"><label class="form-label">Icon (MDI Name)</label>
                        <div style="display:flex;gap:8px">
                            <span class="mdi mdi-${v.icon||'thermometer'}" id="veIconPreview" style="font-size:24px;color:${v.iconColor||'#58a6ff'}"></span>
                            <input id="veIcon" value="${v.icon||'thermometer'}" placeholder="thermometer" oninput="document.getElementById('veIconPreview').className='mdi mdi-'+this.value">
                        </div>
                    </div>
                    <div class="form-group"><label class="form-label">Gr√∂√üe (px)</label><input type="number" id="veIconSize" value="${v.iconSize||28}"></div>
                    <div class="form-group"><label class="form-label">Farbe</label><input type="color" id="veIconColor" value="${v.iconColor||'#58a6ff'}" style="height:38px" oninput="document.getElementById('veIconPreview').style.color=this.value"></div>
                </div>
                
                <hr style="border:none;border-top:1px solid var(--border);margin:16px 0">
                <h4 style="margin:0 0 12px 0;color:var(--success)"><i class="mdi mdi-format-text"></i> Text</h4>
                
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:12px">
                    <div class="form-group"><label class="form-label">Label-Gr√∂√üe</label><input type="number" id="veLabelSize" value="${v.labelSize||12}"></div>
                    <div class="form-group"><label class="form-label">Label-Farbe</label><input type="color" id="veLabelColor" value="${v.labelColor||'#888888'}" style="height:38px"></div>
                    <div class="form-group"><label class="form-label">Wert-Gr√∂√üe</label><input type="number" id="veValueSize" value="${v.valueSize||22}"></div>
                    <div class="form-group"><label class="form-label">Wert-Farbe</label><input type="color" id="veValueColor" value="${v.valueColor||'#ffffff'}" style="height:38px"></div>
                </div>
                
                <hr style="border:none;border-top:1px solid var(--border);margin:16px 0">
                <h4 style="margin:0 0 12px 0;color:var(--warning)"><i class="mdi mdi-card-multiple-outline"></i> Rahmen & Hintergrund</h4>
                
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:12px">
                    <div class="form-group"><label class="form-label">Hintergrund</label><input type="color" id="veBgColor" value="${rgbaToHex(v.bgColor)||'#1a1a2e'}" style="height:38px"></div>
                    <div class="form-group"><label class="form-label">BG Deckkraft</label><input type="number" id="veBgOpacity" value="${(v.bgOpacity!==undefined?v.bgOpacity:6)}" min="0" max="100" step="1"></div>
                    <div class="form-group"><label class="form-label">Rahmenfarbe</label><input type="color" id="veBorderColor" value="${rgbaToHex(v.borderColor)||'#58a6ff'}" style="height:38px"></div>
                    <div class="form-group"><label class="form-label">Rahmen Deckkraft</label><input type="number" id="veBorderOpacity" value="${(v.borderOpacity!==undefined?v.borderOpacity:40)}" min="0" max="100" step="1"></div>
                </div>
                
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                    <div class="form-group"><label class="form-label">Rundung (px)</label><input type="number" id="veBorderRadius" value="${v.borderRadius||12}"></div>
                    <div class="form-group"><label class="form-label">Rahmenbreite</label><input type="number" id="veBorderWidth" value="${v.borderWidth||1.5}" step="0.5"></div>
                </div>
                
                <div style="display:grid;grid-template-columns:auto 1fr 1fr;gap:12px;align-items:end">
                    <div class="form-group"><label class="form-label" style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="veGlowEnabled" ${v.glowEnabled!==false&&v.glowEnabled!=='false'?'checked':''} style="width:auto"> Glow-Effekt</label></div>
                    <div class="form-group"><label class="form-label">Glow-Farbe</label><input type="color" id="veGlowColor" value="${rgbaToHex(v.glowColor)||'#58a6ff'}" style="height:38px"></div>
                </div>
                
                <hr style="border:none;border-top:1px solid var(--border);margin:16px 0">
                <h4 style="margin:0 0 12px 0;color:var(--danger)"><i class="mdi mdi-code-braces"></i> Bedingte Formatierung</h4>
                <p style="font-size:11px;color:var(--text-muted);margin-bottom:12px">√Ñndert Icon/Farben basierend auf dem Wert. Bedingungen werden von oben nach unten gepr√ºft.</p>
                
                ${[1,2,3].map(i=>`
                <div style="background:var(--sidebar);border-radius:8px;padding:12px;margin-bottom:10px">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
                        <input type="checkbox" id="veCond${i}Enabled" ${v['cond'+i+'_enabled']?'checked':''} style="width:auto">
                        <span style="font-weight:600">Bedingung ${i}</span>
                        <span style="color:var(--text-muted);font-size:11px">Wenn Wert</span>
                        <select id="veCond${i}Op" style="width:60px">
                            <option value=">=" ${(v['cond'+i+'_op']||'>=')==='>='?'selected':''}>>=</option>
                            <option value=">" ${v['cond'+i+'_op']==='>'?'selected':''}>&gt;</option>
                            <option value="<=" ${v['cond'+i+'_op']==='<='?'selected':''}>&lt;=</option>
                            <option value="<" ${v['cond'+i+'_op']==='<'?'selected':''}>&lt;</option>
                            <option value="==" ${v['cond'+i+'_op']==='=='?'selected':''}>==</option>
                        </select>
                        <input type="number" id="veCond${i}Value" value="${v['cond'+i+'_value']||0}" style="width:80px" step="any">
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px">
                        <div class="form-group" style="margin:0"><label class="form-label" style="font-size:10px">Icon</label><input id="veCond${i}Icon" value="${v['cond'+i+'_icon']||''}" placeholder="(Standard)"></div>
                        <div class="form-group" style="margin:0"><label class="form-label" style="font-size:10px">Icon-Farbe</label><input type="color" id="veCond${i}IconColor" value="${v['cond'+i+'_iconColor']||'#4caf50'}" style="height:32px"></div>
                        <div class="form-group" style="margin:0"><label class="form-label" style="font-size:10px">Rahmen</label><input type="color" id="veCond${i}BorderColor" value="${rgbaToHex(v['cond'+i+'_borderColor'])||'#4caf50'}" style="height:32px"></div>
                        <div class="form-group" style="margin:0"><label class="form-label" style="font-size:10px">Glow</label><input type="color" id="veCond${i}GlowColor" value="${rgbaToHex(v['cond'+i+'_glowColor'])||'#4caf50'}" style="height:32px"></div>
                    </div>
                </div>
                `).join('')}
            </div>`;
        } else {
            // Generic VSE Editor
            html=`<div class="form-group"><label class="form-label">Bezeichnung</label><input id="veLabel" value="${w.label||''}"></div>`;
            html+=`<div class="form-group"><label class="form-label">Gr√∂√üe</label>
                <div style="display:flex;gap:8px;align-items:center">
                    <input type="number" id="veWidth" value="${w.width||100}" style="width:80px">
                    <span>√ó</span>
                    <input type="number" id="veHeight" value="${w.height||60}" style="width:80px">
                    <span style="color:var(--text-muted);font-size:11px">px</span>
                </div>
            </div>`;
            html+=`<div class="form-group"><label class="form-label">VSE Element</label><input value="${w.vseName||w.vseId||''}" disabled style="background:var(--sidebar)"></div>`;
            html+=`<div class="form-group"><label class="form-label">KO1 (Wert-Adresse)</label><select id="veAddr"><option value="">-- Keine --</option>${addrOpts}</select></div>`;
            
            if(Object.keys(v).length > 0){
                html+=`<div class="form-group"><label class="form-label">Variablen</label>`;
                Object.entries(v).forEach(([key, val])=>{
                    html+=`<div style="display:flex;gap:8px;margin-bottom:4px">
                        <span style="min-width:100px;font-size:11px;color:var(--text-muted)">${key}:</span>
                        <input id="veVar_${key}" value="${val||''}" style="flex:1">
                    </div>`;
                });
                html+=`</div>`;
            }
        }
    } else {
        // Standard widget types
        html=`<div class="form-group"><label class="form-label">Bezeichnung</label><input id="veLabel" value="${w.label||''}"></div>`;
        html+=`<div class="form-group"><label class="form-label">Gr√∂√üe</label>
            <div style="display:flex;gap:8px;align-items:center">
                <input type="number" id="veWidth" value="${w.width||100}" style="width:80px">
                <span>√ó</span>
                <input type="number" id="veHeight" value="${w.height||60}" style="width:80px">
                <span style="color:var(--text-muted);font-size:11px">px</span>
            </div>
        </div>`;
        
        if(w.type==='switch'||w.type==='dimmer'){
            html+=`<div class="form-group"><label class="form-label">Adresse</label><select id="veAddr">${addrOpts}</select></div>`;
        }else if(w.type==='value'){
            html+=`<div class="form-group"><label class="form-label">Adresse</label><select id="veAddr">${addrOpts}</select></div>`;
            html+=`<div class="form-group"><label class="form-label">Einheit</label><input id="veUnit" value="${w.unit||''}"></div>`;
        }
    }
    
    document.getElementById('visuEditFields').innerHTML=html;
    showModal('visuEditModal');
}

function rgbaToHex(rgba) {
    if (!rgba) return null;
    if (rgba.startsWith('#')) return rgba;
    const match = rgba.match(/[\d.]+/g);
    if (!match || match.length < 3) return '#58a6ff';
    return '#' + match.slice(0,3).map(x => {
        const hex = Math.round(parseFloat(x)).toString(16);
        return hex.length === 1 ? '0' + hex : hex;
    }).join('');
}

function hexToRgba(hex, alpha = 0.4) {
    if (!hex) return null;
    const r = parseInt(hex.slice(1,3), 16);
    const g = parseInt(hex.slice(3,5), 16);
    const b = parseInt(hex.slice(5,7), 16);
    return `rgba(${r},${g},${b},${alpha})`;
}

function saveVisuWidget(){
    if(!currentEditWidget)return;
    const w = currentEditWidget;
    
    // Common fields
    if(document.getElementById('veLabel')) w.label = document.getElementById('veLabel').value;
    if(document.getElementById('veWidth')) w.width = parseInt(document.getElementById('veWidth').value) || 100;
    if(document.getElementById('veHeight')) w.height = parseInt(document.getElementById('veHeight').value) || 60;
    if(document.getElementById('veAddr')) {
        w.addr = document.getElementById('veAddr').value;
        w.ko1 = document.getElementById('veAddr').value;
    }
    if(document.getElementById('veUnit')) w.unit = document.getElementById('veUnit').value;
    
    // VSE specific
    if(w.type === 'vse'){
        if(!w.vars) w.vars = {};
        const v = w.vars;
        
        // Check if it's a sensor card
        const isSensorCard = (w.vseId||'').includes('sensor') || (w.vseName||'').toLowerCase().includes('sensor');
        
        if(isSensorCard){
            // Save all sensor card options
            v.label = document.getElementById('veLabel')?.value || '';
            v.unit = document.getElementById('veUnit')?.value || '';
            v.decimals = parseInt(document.getElementById('veDecimals')?.value) || 1;
            
            v.icon = document.getElementById('veIcon')?.value || 'thermometer';
            v.iconSize = parseInt(document.getElementById('veIconSize')?.value) || 28;
            v.iconColor = document.getElementById('veIconColor')?.value || '#58a6ff';
            
            v.labelSize = parseInt(document.getElementById('veLabelSize')?.value) || 12;
            v.labelColor = document.getElementById('veLabelColor')?.value || '#888888';
            v.valueSize = parseInt(document.getElementById('veValueSize')?.value) || 22;
            v.valueColor = document.getElementById('veValueColor')?.value || '#ffffff';
            
            const bgOpacity = parseInt(document.getElementById('veBgOpacity')?.value) || 6;
            const borderOpacity = parseInt(document.getElementById('veBorderOpacity')?.value) || 40;
            v.bgOpacity = bgOpacity;
            v.borderOpacity = borderOpacity;
            v.bgColor = hexToRgba(document.getElementById('veBgColor')?.value, bgOpacity/100) || 'rgba(255,255,255,0.06)';
            v.borderColor = hexToRgba(document.getElementById('veBorderColor')?.value, borderOpacity/100) || 'rgba(88,166,255,0.4)';
            v.borderRadius = parseInt(document.getElementById('veBorderRadius')?.value) || 12;
            v.borderWidth = parseFloat(document.getElementById('veBorderWidth')?.value) || 1.5;
            v.glowEnabled = document.getElementById('veGlowEnabled')?.checked;
            v.glowColor = hexToRgba(document.getElementById('veGlowColor')?.value, 0.15) || 'rgba(88,166,255,0.15)';
            
            // Save conditions
            [1,2,3].forEach(i => {
                v['cond'+i+'_enabled'] = document.getElementById('veCond'+i+'Enabled')?.checked;
                v['cond'+i+'_op'] = document.getElementById('veCond'+i+'Op')?.value || '>=';
                v['cond'+i+'_value'] = parseFloat(document.getElementById('veCond'+i+'Value')?.value) || 0;
                v['cond'+i+'_icon'] = document.getElementById('veCond'+i+'Icon')?.value || '';
                v['cond'+i+'_iconColor'] = document.getElementById('veCond'+i+'IconColor')?.value || '#4caf50';
                v['cond'+i+'_borderColor'] = hexToRgba(document.getElementById('veCond'+i+'BorderColor')?.value, 0.45);
                v['cond'+i+'_glowColor'] = hexToRgba(document.getElementById('veCond'+i+'GlowColor')?.value, 0.15);
            });
        } else {
            // Generic VSE - save all veVar_ inputs
            document.querySelectorAll('[id^="veVar_"]').forEach(input => {
                const key = input.id.replace('veVar_', '');
                v[key] = input.value;
            });
        }
    }
    
    saveVisuConfig();
    renderVisuPage();
    hideModal('visuEditModal');
}

function deleteVisuWidget(){
    if(!currentEditWidget)return;
    if(!confirm('Widget l√∂schen?'))return;
    const page=visuPages[currentVisuPage];
    page.widgets=page.widgets.filter(w=>w.id!==currentEditWidget.id);
    saveVisuConfig();
    renderVisuPage();
    hideModal('visuEditModal');
}

function createVisuPage(){
    const name=document.getElementById('visuPageName').value;
    if(!name){showAlert('error','Name erforderlich');return;}
    const id='vp'+Date.now();
    const size=document.getElementById('visuPageSize').value;
    visuPages[id]={id,name,size,widgets:[]};
    saveVisuConfig();
    loadVisuPageSelect();
    document.getElementById('visuPageSelect').value=id;
    loadVisuPage(id);
    hideModal('visuPageModal');
}

function loadVisuPage(id){
    currentVisuPage=id;
    const page=visuPages[id];
    if(!page)return;
    
    const canvas=document.getElementById('visuCanvas');
    canvas.className='visu-canvas';
    
    // Apply size
    if(page.size==='phone'){
        canvas.classList.add('phone');
        canvas.style.width='375px';
        canvas.style.height='667px';
    }else if(page.size==='tablet'){
        canvas.classList.add('tablet');
        canvas.style.width='768px';
        canvas.style.height='1024px';
    }else if(page.size==='desktop'){
        canvas.classList.add('desktop');
        canvas.style.width='1920px';
        canvas.style.height='1080px';
    }else if(page.size==='custom'){
        canvas.style.width=(page.customWidth||1024)+'px';
        canvas.style.height=(page.customHeight||768)+'px';
    }else{
        canvas.classList.add('fullsize');
        canvas.style.width='';
        canvas.style.height='';
    }
    
    // Apply background image
    if(page.bgImage){
        canvas.style.backgroundImage=`url('${page.bgImage}')`;
        canvas.style.backgroundSize=page.bgSize||'cover';
        canvas.style.backgroundPosition='center';
        canvas.style.backgroundRepeat=page.bgSize==='repeat'?'repeat':'no-repeat';
    }else{
        canvas.style.backgroundImage='';
    }
    
    renderVisuPage();
}

function loadVisuPageSelect(){
    const sel=document.getElementById('visuPageSelect');
    sel.innerHTML=Object.values(visuPages).map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
}

async function saveVisuConfig(){
    try{
        await fetch(`${API}/visu/config`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(visuPages)});
    }catch(e){console.error('Save visu config failed:',e);}
}

async function loadVisuConfig(){
    try{
        const r=await fetch(`${API}/visu/config`);
        if(r.ok){
            const data=await r.json();
            if(data&&Object.keys(data).length>0)visuPages=data;
        }
    }catch(e){console.error('Load visu config failed:',e);}
    loadVisuPageSelect();
    renderVisuPage();
}

// ========== VSE FUNCTIONS ==========
let vseElements = [];
let selectedVSE = null;

async function loadVSEElements() {
    try {
        const r = await fetch(`${API}/visu/vse`);
        vseElements = await r.json();
        renderVSEList();
        updateVSEStats();
    } catch(e) {
        console.error('Error loading VSE:', e);
    }
}

function updateVSEStats() {
    const countEl = document.getElementById('vseCount');
    if (countEl) countEl.textContent = vseElements.length;
}

function filterVSE() {
    const search = (document.getElementById('vseSearch')?.value || '').toLowerCase();
    const filter = document.getElementById('vseFilter')?.value || 'all';
    
    document.querySelectorAll('#vseList .vse-card').forEach(card => {
        const name = card.dataset.name?.toLowerCase() || '';
        const id = card.dataset.id?.toLowerCase() || '';
        const vse = vseElements.find(v => v.id === card.dataset.id);
        const category = vse?.category || 'other';
        
        let show = name.includes(search) || id.includes(search);
        if (filter !== 'all') {
            if (filter === 'other') {
                show = show && !['sensor', 'switch'].includes(category);
            } else {
                show = show && category === filter;
            }
        }
        
        card.style.display = show ? '' : 'none';
    });
}

function renderVSEList() {
    const container = document.getElementById('vseList');
    if (!container) return;
    
    if (vseElements.length === 0) {
        container.innerHTML = `<div class="empty" style="grid-column:1/-1;text-align:center;padding:40px;color:var(--text-muted)">
            <i class="mdi mdi-palette-outline" style="font-size:48px;display:block;margin-bottom:12px"></i>
            Keine Widgets vorhanden.<br>
            <button class="btn btn-primary" style="margin-top:12px" onclick="showVseCreateModal()"><i class="mdi mdi-plus"></i> Widget erstellen</button>
        </div>`;
        return;
    }
    
    container.innerHTML = vseElements.map(vse => {
        const catIcon = getCategoryIcon(vse.category);
        const renderType = vse.render || 'custom';
        const renderLabel = {sensorCard:'Sensor',switchCard:'Switch',titleCard:'Titel',custom:'Custom'}[renderType] || renderType;
        
        return `<div class="vse-card" data-id="${vse.id}" data-name="${vse.name}" onclick="editVSEElement('${vse.id}')">
            <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px">
                <span style="font-size:24px">${catIcon}</span>
                <span style="font-size:10px;padding:2px 6px;border-radius:4px;background:rgba(88,166,255,0.2);color:var(--accent)">${renderLabel}</span>
            </div>
            <div style="font-weight:600;font-size:13px;margin-bottom:4px">${vse.name}</div>
            <div style="font-size:11px;color:var(--text-muted);margin-bottom:2px">${vse.description || ''}</div>
            <div style="font-size:10px;color:var(--text-muted)">${vse.xsize||100} √ó ${vse.ysize||60} px</div>
            <div style="display:flex;gap:4px;margin-top:10px;padding-top:8px;border-top:1px solid var(--border)">
                <button class="btn btn-sm btn-primary" style="flex:1" onclick="event.stopPropagation();addVSEToVisu('${vse.id}')" title="Zur Visu hinzuf√ºgen"><i class="mdi mdi-plus"></i> Visu</button>
                <button class="btn btn-sm btn-secondary" style="flex:1" onclick="event.stopPropagation();editVSEElement('${vse.id}')" title="Bearbeiten"><i class="mdi mdi-pencil"></i></button>
                <button class="btn btn-sm btn-danger" onclick="event.stopPropagation();deleteVSE('${vse.id}')" title="L√∂schen"><i class="mdi mdi-delete"></i></button>
            </div>
        </div>`;
    }).join('');
}

function getCategoryIcon(cat) {
    const icons = {
        'sensor': 'üå°Ô∏è', 'switch': 'üîò', 'slider': 'üéöÔ∏è', 
        'gauge': 'üìä', 'chart': 'üìà', 'media': 'üñºÔ∏è',
        'button': '‚è∫Ô∏è', 'display': 'üìü', 'title': 'üìù', 'other': 'üì¶'
    };
    return icons[cat] || 'üì¶';
}

async function uploadVSE(file) {
    if (!file) return;
    
    const ext = file.name.split('.').pop().toLowerCase();
    if (!['json', 'yaml', 'yml'].includes(ext)) {
        showAlert('error', 'Unterst√ºtzte Formate: .json, .yaml');
        return;
    }
    
    const formData = new FormData();
    formData.append('file', file);
    
    try {
        showAlert('info', 'Wird hochgeladen...');
        const r = await fetch(`${API}/visu/vse/upload`, {method: 'POST', body: formData});
        if (r.ok) {
            const result = await r.json();
            showAlert('success', result.message || '‚úì Widget hochgeladen');
            loadVSEElements();
        } else {
            const err = await r.json();
            showAlert('error', err.detail || 'Upload fehlgeschlagen');
        }
    } catch(e) {
        showAlert('error', 'Upload fehlgeschlagen');
    }
    
    document.getElementById('vseUploadInput').value = '';
}

async function deleteVSE(filename) {
    if (!confirm(`Widget "${filename}" l√∂schen?`)) return;
    
    try {
        await fetch(`${API}/visu/vse/${filename}`, {method: 'DELETE'});
        showAlert('success', '‚úì Gel√∂scht');
        loadVSEElements();
    } catch(e) {
        showAlert('error', 'L√∂schen fehlgeschlagen');
    }
}

async function showVSEDetails(id) {
    // Open edit modal for details view
    editVSEElement(id);
}

function escapeHtml(str) {
    return String(str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// VSE Variable management
let vseVarCounter = 0;

function showVseCreateModal() {
    document.getElementById('vseEditMode').value = '';
    document.getElementById('vseModalTitle').innerHTML = '<i class="mdi mdi-palette"></i> Neues Widget erstellen';
    document.getElementById('vseDeleteBtn').style.display = 'none';
    
    // Reset form
    document.getElementById('vseCreateName').value = '';
    document.getElementById('vseCreateId').value = '';
    document.getElementById('vseCreateCategory').value = 'sensor';
    document.getElementById('vseCreateRender').value = 'sensorCard';
    document.getElementById('vseCreateWidth').value = '200';
    document.getElementById('vseCreateHeight').value = '100';
    document.getElementById('vseCreateDesc').value = '';
    document.getElementById('vseCreateHtml').value = '';
    document.getElementById('vseCreateCss').value = '';
    
    // Clear variables
    vseVarCounter = 0;
    document.getElementById('vseVarList').innerHTML = '';
    document.getElementById('vseCondList').innerHTML = '';
    
    // Add default variables for sensorCard
    addVseVariable('label', 'text', 'Bezeichnung', 'Sensor');
    addVseVariable('unit', 'text', 'Einheit', '¬∞C');
    addVseVariable('decimals', 'number', 'Dezimalstellen', '1');
    addVseVariable('icon', 'icon', 'Icon (MDI)', 'thermometer');
    addVseVariable('iconSize', 'number', 'Icon-Gr√∂√üe', '28');
    addVseVariable('iconColor', 'color', 'Icon-Farbe', '#58a6ff');
    addVseVariable('borderRadius', 'number', 'Rundung', '12');
    addVseVariable('glowEnabled', 'bool', 'Glow-Effekt', 'true');
    
    updateVseRenderHelp();
    showModal('vseCreateModal');
}

function editVSEElement(id) {
    const vse = vseElements.find(v => v.id === id);
    if (!vse) return;
    
    document.getElementById('vseEditMode').value = id;
    document.getElementById('vseModalTitle').innerHTML = '<i class="mdi mdi-pencil"></i> Widget bearbeiten';
    document.getElementById('vseDeleteBtn').style.display = '';
    
    document.getElementById('vseCreateName').value = vse.name || '';
    document.getElementById('vseCreateId').value = vse.id || '';
    document.getElementById('vseCreateCategory').value = vse.category || 'sensor';
    document.getElementById('vseCreateRender').value = vse.render || 'sensorCard';
    document.getElementById('vseCreateWidth').value = vse.xsize || 200;
    document.getElementById('vseCreateHeight').value = vse.ysize || 100;
    document.getElementById('vseCreateDesc').value = vse.description || '';
    document.getElementById('vseCreateHtml').value = vse.html || '';
    document.getElementById('vseCreateCss').value = vse.css || '';
    
    // Load variables
    vseVarCounter = 0;
    document.getElementById('vseVarList').innerHTML = '';
    if (vse.vars) {
        Object.entries(vse.vars).forEach(([key, def]) => {
            addVseVariable(key, def.type || 'text', def.name || key, def.default || '');
        });
    }
    
    // Load conditions
    document.getElementById('vseCondList').innerHTML = '';
    if (vse.conditions) {
        vse.conditions.forEach((cond, i) => {
            addVseCondition(cond);
        });
    }
    
    updateVseRenderHelp();
    showModal('vseCreateModal');
}

function addVseVariable(key, type, name, defaultVal) {
    const id = vseVarCounter++;
    const container = document.getElementById('vseVarList');
    
    const typeOptions = ['text', 'number', 'color', 'icon', 'bool', 'select'].map(t => 
        `<option value="${t}" ${t===type?'selected':''}>${t}</option>`
    ).join('');
    
    const html = `<div class="vse-var-row" id="vseVar${id}" style="display:grid;grid-template-columns:100px 80px 1fr 100px 30px;gap:8px;align-items:center;margin-bottom:8px;padding:8px;background:var(--sidebar);border-radius:6px">
        <input placeholder="key" value="${key||''}" class="vseVarKey">
        <select class="vseVarType">${typeOptions}</select>
        <input placeholder="Anzeigename" value="${name||''}" class="vseVarName">
        <input placeholder="Default" value="${defaultVal||''}" class="vseVarDefault">
        <button class="btn btn-sm btn-danger" onclick="this.parentElement.remove()"><i class="mdi mdi-close"></i></button>
    </div>`;
    
    container.insertAdjacentHTML('beforeend', html);
}

let vseCondCounter = 0;

function addVseCondition(existing) {
    const id = vseCondCounter++;
    const container = document.getElementById('vseCondList');
    
    const cond = existing || {
        enabled: { default: false },
        operator: { default: '>=' },
        value: { default: 0 },
        iconColor: { default: '#4caf50' },
        borderColor: { default: 'rgba(76,175,80,0.45)' },
        icon: { default: '' }
    };
    
    const html = `<div class="vse-cond-row" id="vseCond${id}" style="background:var(--sidebar);border-radius:8px;padding:12px;margin-bottom:10px">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
            <span style="font-weight:600">Wenn Wert</span>
            <select class="vseCondOp" style="width:60px">
                <option value=">=" ${cond.operator?.default==='>='?'selected':''}>>=</option>
                <option value=">" ${cond.operator?.default==='>'?'selected':''}>&gt;</option>
                <option value="<=" ${cond.operator?.default==='<='?'selected':''}>&lt;=</option>
                <option value="<" ${cond.operator?.default==='<'?'selected':''}>&lt;</option>
                <option value="==" ${cond.operator?.default==='=='?'selected':''}>==</option>
            </select>
            <input type="number" class="vseCondValue" value="${cond.value?.default||0}" style="width:80px" step="any">
            <span style="flex:1"></span>
            <button class="btn btn-sm btn-danger" onclick="this.parentElement.parentElement.remove()"><i class="mdi mdi-close"></i></button>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px">
            <div class="form-group" style="margin:0"><label class="form-label" style="font-size:10px">Icon (leer=Standard)</label><input class="vseCondIcon" value="${cond.icon?.default||''}" placeholder="mdi name"></div>
            <div class="form-group" style="margin:0"><label class="form-label" style="font-size:10px">Icon-Farbe</label><input type="color" class="vseCondIconColor" value="${rgbaToHex(cond.iconColor?.default)||'#4caf50'}" style="height:32px"></div>
            <div class="form-group" style="margin:0"><label class="form-label" style="font-size:10px">Rahmen-Farbe</label><input type="color" class="vseCondBorderColor" value="${rgbaToHex(cond.borderColor?.default)||'#4caf50'}" style="height:32px"></div>
        </div>
    </div>`;
    
    container.insertAdjacentHTML('beforeend', html);
}

function updateVseRenderHelp() {
    const render = document.getElementById('vseCreateRender').value;
    const help = document.getElementById('vseRenderHelp');
    const condSection = document.getElementById('vseConditionsSection');
    const customSection = document.getElementById('vseCustomSection');
    
    const helpTexts = {
        'sensorCard': 'Zeigt einen Wert mit Icon, Label und optionaler bedingter Formatierung',
        'switchCard': 'Schalter mit Icon und An/Aus Status',
        'titleCard': '√úberschrift oder Trenntext',
        'custom': 'Eigenes HTML/CSS Template mit Variablen-Ersetzung'
    };
    
    help.textContent = helpTexts[render] || '';
    condSection.style.display = render === 'sensorCard' ? '' : 'none';
    customSection.style.display = render === 'custom' ? '' : 'none';
}

function previewVSEElement() {
    const render = document.getElementById('vseCreateRender').value;
    const preview = document.getElementById('vsePreview');
    
    // Collect current settings
    const vars = collectVseVariables();
    
    if (render === 'sensorCard') {
        const v = vars;
        const icon = v.icon || 'thermometer';
        const iconColor = v.iconColor || '#58a6ff';
        const iconSize = v.iconSize || 28;
        const label = v.label || 'Sensor';
        const unit = v.unit || '';
        const borderRadius = v.borderRadius || 12;
        const glowEnabled = v.glowEnabled === 'true' || v.glowEnabled === true;
        const glowColor = hexToRgba(iconColor, 0.15);
        const borderColor = hexToRgba(iconColor, 0.4);
        
        preview.innerHTML = `<div style="
            display:flex;align-items:center;gap:12px;padding:10px 14px;
            background:rgba(255,255,255,0.06);
            border:1.5px solid ${borderColor};
            border-radius:${borderRadius}px;
            ${glowEnabled ? `box-shadow:0 8px 22px rgba(0,0,0,0.24), 0 0 18px ${glowColor};` : ''}
            min-width:180px;
        ">
            <span class="mdi mdi-${icon}" style="font-size:${iconSize}px;color:${iconColor}"></span>
            <div style="display:flex;flex-direction:column">
                <div style="font-size:12px;color:#888">${label}</div>
                <div style="font-size:22px;font-weight:600">23.5 ${unit}</div>
            </div>
        </div>`;
    } else if (render === 'switchCard') {
        const v = vars;
        const icon = v.icon || 'lightbulb';
        const colorOn = v.colorOn || '#ffc107';
        
        preview.innerHTML = `<div style="
            display:flex;flex-direction:column;align-items:center;justify-content:center;
            padding:16px;border-radius:12px;border:1.5px solid ${colorOn}66;
            background:rgba(255,255,255,0.06);min-width:100px;min-height:100px;
        ">
            <span class="mdi mdi-${icon}" style="font-size:40px;color:${colorOn}"></span>
            <div style="font-size:13px;margin-top:8px">${v.label || 'Schalter'}</div>
            <div style="font-size:14px;font-weight:600;color:${colorOn}">${v.textOn || 'An'}</div>
        </div>`;
    } else if (render === 'titleCard') {
        const v = vars;
        preview.innerHTML = `<div style="padding:12px">
            <div style="font-size:${v.fontSize || 18}px;font-weight:600;color:${v.color || '#fff'}">
                ${v.icon ? `<span class="mdi mdi-${v.icon}" style="margin-right:8px"></span>` : ''}${v.label || '√úberschrift'}
            </div>
            ${v.subtitle ? `<div style="font-size:12px;color:rgba(255,255,255,0.7);margin-top:4px">${v.subtitle}</div>` : ''}
        </div>`;
    } else {
        preview.innerHTML = '<span style="color:var(--text-muted)">Custom Template - Vorschau nicht verf√ºgbar</span>';
    }
}

function collectVseVariables() {
    const vars = {};
    document.querySelectorAll('.vse-var-row').forEach(row => {
        const key = row.querySelector('.vseVarKey').value.trim();
        if (key) {
            vars[key] = row.querySelector('.vseVarDefault').value;
        }
    });
    return vars;
}

function collectVseVarDefinitions() {
    const vars = {};
    document.querySelectorAll('.vse-var-row').forEach(row => {
        const key = row.querySelector('.vseVarKey').value.trim();
        if (key) {
            vars[key] = {
                name: row.querySelector('.vseVarName').value || key,
                type: row.querySelector('.vseVarType').value || 'text',
                default: row.querySelector('.vseVarDefault').value || ''
            };
        }
    });
    return vars;
}

function collectVseConditions() {
    const conditions = [];
    document.querySelectorAll('.vse-cond-row').forEach(row => {
        conditions.push({
            enabled: { name: 'Aktiviert', type: 'bool', default: true },
            operator: { name: 'Operator', type: 'select', default: row.querySelector('.vseCondOp').value },
            value: { name: 'Wert', type: 'number', default: parseFloat(row.querySelector('.vseCondValue').value) || 0 },
            icon: { name: 'Icon', type: 'icon', default: row.querySelector('.vseCondIcon').value },
            iconColor: { name: 'Icon-Farbe', type: 'color', default: row.querySelector('.vseCondIconColor').value },
            borderColor: { name: 'Rahmen-Farbe', type: 'color', default: hexToRgba(row.querySelector('.vseCondBorderColor').value, 0.45) }
        });
    });
    return conditions;
}

async function saveVSEElement() {
    const name = document.getElementById('vseCreateName').value.trim();
    let id = document.getElementById('vseCreateId').value.trim();
    const category = document.getElementById('vseCreateCategory').value;
    const render = document.getElementById('vseCreateRender').value;
    const width = parseInt(document.getElementById('vseCreateWidth').value) || 200;
    const height = parseInt(document.getElementById('vseCreateHeight').value) || 100;
    const description = document.getElementById('vseCreateDesc').value.trim();
    const html = document.getElementById('vseCreateHtml').value;
    const css = document.getElementById('vseCreateCss').value;
    
    if (!name) {
        showAlert('error', 'Name ist erforderlich');
        return;
    }
    
    // Auto-generate ID if empty
    if (!id) {
        id = name.toLowerCase().replace(/[^a-z0-9]/g, '_').replace(/_+/g, '_');
    }
    
    const vars = collectVseVarDefinitions();
    const conditions = render === 'sensorCard' ? collectVseConditions() : [];
    
    const vse = {
        id, name, category, render,
        xsize: width, ysize: height,
        description,
        vars, 
        conditions: conditions.length > 0 ? conditions : undefined,
        html: render === 'custom' ? html : undefined,
        css: render === 'custom' ? css : undefined,
        format: 'json',
        version: '2.0'
    };
    
    try {
        const r = await fetch(`${API}/visu/vse`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(vse)
        });
        
        if (r.ok) {
            showAlert('success', '‚úì Widget gespeichert');
            hideModal('vseCreateModal');
            loadVSEElements();
        } else {
            const err = await r.json();
            showAlert('error', err.detail || 'Speichern fehlgeschlagen');
        }
    } catch(e) {
        showAlert('error', 'Speichern fehlgeschlagen: ' + e.message);
    }
}

async function deleteVSEElement() {
    const id = document.getElementById('vseEditMode').value;
    if (!id) return;
    
    if (!confirm(`Widget "${id}" wirklich l√∂schen?`)) return;
    
    try {
        await fetch(`${API}/visu/vse/${id}`, {method: 'DELETE'});
        showAlert('success', '‚úì Gel√∂scht');
        hideModal('vseCreateModal');
        loadVSEElements();
    } catch(e) {
        showAlert('error', 'L√∂schen fehlgeschlagen');
    }
}

async function showAddVSEModal() {
    await loadVSEElements();
    
    const addrOpts = allAddresses.map(a => `<option value="${a.address}">${a.name || a.address}</option>`).join('');
    document.getElementById('vseConfigKO1').innerHTML = `<option value="">-- Keine --</option>${addrOpts}`;
    
    const grid = document.getElementById('vseSelectGrid');
    if (vseElements.length === 0) {
        grid.innerHTML = `<div class="empty" style="grid-column:1/-1;text-align:center;padding:30px;color:var(--text-muted)">
            Keine Widgets vorhanden.<br>
            <a href="#" onclick="hideModal('visuVSEModal');showPage('vse');showVseCreateModal();" style="color:var(--accent)">Widget erstellen</a>
        </div>`;
    } else {
        grid.innerHTML = vseElements.map(vse => {
            const catIcon = getCategoryIcon(vse.category);
            const renderLabel = {sensorCard:'Sensor',switchCard:'Switch',titleCard:'Titel',custom:'Custom'}[vse.render] || vse.render || 'Custom';
            return `<div class="vse-card" onclick="selectVSE('${vse.id}')" id="vse-select-${vse.id}" style="cursor:pointer">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
                    <span style="font-size:20px">${catIcon}</span>
                    <span style="font-size:9px;padding:2px 5px;border-radius:3px;background:rgba(88,166,255,0.2);color:var(--accent)">${renderLabel}</span>
                </div>
                <div style="font-weight:600;font-size:12px">${vse.name}</div>
                <div style="font-size:10px;color:var(--text-muted)">${vse.xsize||100} √ó ${vse.ysize||60} px</div>
            </div>`;
        }).join('');
    }
    
    document.getElementById('vseConfigPanel').style.display = 'none';
    document.getElementById('vseAddBtn').disabled = true;
    selectedVSE = null;
    
    showModal('visuVSEModal');
}

function selectVSE(id) {
    // Highlight selected
    document.querySelectorAll('#vseSelectGrid .vse-card').forEach(c => {
        c.style.borderColor = '';
        c.style.background = '';
    });
    const selected = document.getElementById('vse-select-' + id);
    if (selected) {
        selected.style.borderColor = 'var(--accent)';
        selected.style.background = 'rgba(88,166,255,0.1)';
    }
    
    // Find VSE in loaded elements
    const vse = vseElements.find(v => v.id === id);
    if (!vse) {
        console.error('VSE not found:', id);
        return;
    }
    
    selectedVSE = vse;
    
    document.getElementById('vseConfigName').textContent = vse.name;
    document.getElementById('vseConfigText').value = vse.vars?.label?.default || vse.name;
    
    // Build config fields for variables
    let varsHtml = '';
    if (vse.vars) {
        Object.entries(vse.vars).forEach(([key, def]) => {
            const defaultVal = def.default || '';
            const label = def.name || key;
            const type = def.type || 'text';
            
            if (type === 'bool') {
                const checked = defaultVal === 'true' || defaultVal === '1' || defaultVal === true ? 'checked' : '';
                varsHtml += `<div class="form-group"><label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="vseVar-${key}" ${checked} style="width:auto"> ${label}</label></div>`;
            } else if (type === 'color') {
                varsHtml += `<div class="form-group"><label class="form-label">${label}</label><input type="color" id="vseVar-${key}" value="${defaultVal || '#58a6ff'}" style="height:36px"></div>`;
            } else if (type === 'number') {
                varsHtml += `<div class="form-group"><label class="form-label">${label}</label><input type="number" id="vseVar-${key}" value="${defaultVal}" step="any"></div>`;
            } else if (type === 'icon') {
                varsHtml += `<div class="form-group"><label class="form-label">${label}</label><div style="display:flex;gap:6px;align-items:center"><span class="mdi mdi-${defaultVal||'help'}" style="font-size:20px"></span><input id="vseVar-${key}" value="${defaultVal}" placeholder="mdi name"></div></div>`;
            } else {
                varsHtml += `<div class="form-group"><label class="form-label">${label}</label><input id="vseVar-${key}" value="${defaultVal}"></div>`;
            }
        });
    }
    
    document.getElementById('vseConfigVars').innerHTML = varsHtml || '<div style="color:var(--text-muted);font-size:12px">Keine konfigurierbaren Variablen</div>';
    document.getElementById('vseConfigPanel').style.display = 'block';
    document.getElementById('vseAddBtn').disabled = false;
}

function addVSEWidget() {
    if (!selectedVSE) return;
    
    const vse = selectedVSE;
    
    const widget = {
        id: 'vse' + Date.now(),
        type: 'vse',
        vseId: vse.id,
        vseName: vse.name,
        label: document.getElementById('vseConfigText').value || vse.name,
        x: 50 + Math.floor(Math.random() * 100),
        y: 50 + Math.floor(Math.random() * 100),
        width: vse.xsize || 200,
        height: vse.ysize || 100,
        ko1: document.getElementById('vseConfigKO1').value,
        vars: {}
    };
    
    // Collect var values from the config form
    if (vse.vars) {
        Object.keys(vse.vars).forEach(key => {
            const el = document.getElementById('vseVar-' + key);
            if (el) {
                if (el.type === 'checkbox') {
                    widget.vars[key] = el.checked ? 'true' : 'false';
                } else {
                    widget.vars[key] = el.value;
                }
            } else {
                // Use default value
                widget.vars[key] = vse.vars[key].default || '';
            }
        });
    }
    
    visuPages[currentVisuPage].widgets.push(widget);
    saveVisuConfig();
    renderVisuPage();
    hideModal('visuVSEModal');
    
    // Enable edit mode if not already
    if (!visuEditMode) {
        toggleVisuEdit();
    }
}

function addVSEToVisu(id) {
    showPage('visu');
    setTimeout(() => {
        showAddVSEModal();
        setTimeout(() => selectVSE(id), 300);
    }, 100);
}

function addQuickSensorCard() {
    // Create a sensor card with default settings
    const widget = {
        id: 'vse' + Date.now(),
        type: 'vse',
        vseId: 'sensor_card',
        vseName: 'Sensor Card',
        label: 'Sensor',
        x: 50 + Math.floor(Math.random() * 100),
        y: 50 + Math.floor(Math.random() * 100),
        width: 200,
        height: 100,
        ko1: '',
        vars: {
            label: 'Sensor',
            unit: '¬∞C',
            decimals: 1,
            icon: 'thermometer',
            iconSize: 28,
            iconColor: '#58a6ff',
            labelSize: 12,
            labelColor: '#888888',
            valueSize: 22,
            valueColor: '#ffffff',
            bgColor: 'rgba(255,255,255,0.06)',
            borderColor: 'rgba(88,166,255,0.4)',
            borderRadius: 12,
            borderWidth: 1.5,
            glowEnabled: true,
            glowColor: 'rgba(88,166,255,0.15)'
        }
    };
    
    visuPages[currentVisuPage].widgets.push(widget);
    saveVisuConfig();
    
    // Enable edit mode and open edit dialog
    if (!visuEditMode) {
        toggleVisuEdit();
    }
    renderVisuPage();
    
    // Open edit dialog for the new widget
    setTimeout(() => editVisuWidget(widget.id), 100);
}

// Page Settings
function showPageSettings() {
    const page = visuPages[currentVisuPage];
    if (!page) return;
    
    document.getElementById('pageSettingsName').value = page.name || '';
    document.getElementById('pageSettingsBgColor').value = page.bgColor || '#1a1a2e';
    document.getElementById('pageSettingsBgColorText').value = page.bgColor || '#1a1a2e';
    document.getElementById('pageSettingsSize').value = page.size || 'full';
    document.getElementById('pageSettingsWidth').value = page.customWidth || 1024;
    document.getElementById('pageSettingsHeight').value = page.customHeight || 768;
    document.getElementById('pageSettingsBgImage').value = page.bgImage || '';
    document.getElementById('pageSettingsBgSize').value = page.bgSize || 'cover';
    
    toggleCustomSize();
    showModal('visuPageSettingsModal');
}

function toggleCustomSize() {
    const size = document.getElementById('pageSettingsSize').value;
    document.getElementById('customSizeGroup').style.display = size === 'custom' ? 'block' : 'none';
}

function setPageBgColor(color) {
    document.getElementById('pageSettingsBgColor').value = color;
    document.getElementById('pageSettingsBgColorText').value = color;
}

function savePageSettings() {
    const page = visuPages[currentVisuPage];
    if (!page) return;
    
    page.name = document.getElementById('pageSettingsName').value;
    page.bgColor = document.getElementById('pageSettingsBgColor').value;
    page.size = document.getElementById('pageSettingsSize').value;
    page.customWidth = parseInt(document.getElementById('pageSettingsWidth').value) || 1024;
    page.customHeight = parseInt(document.getElementById('pageSettingsHeight').value) || 768;
    page.bgImage = document.getElementById('pageSettingsBgImage').value.trim();
    page.bgSize = document.getElementById('pageSettingsBgSize').value;
    
    saveVisuConfig();
    loadVisuPageSelect();
    loadVisuPage(currentVisuPage);
    hideModal('visuPageSettingsModal');
}

function deleteVisuPage() {
    if (currentVisuPage === 'default') {
        showAlert('error', 'Standard-Seite kann nicht gel√∂scht werden');
        return;
    }
    if (!confirm('Seite wirklich l√∂schen?')) return;
    
    delete visuPages[currentVisuPage];
    saveVisuConfig();
    loadVisuPageSelect();
    loadVisuPage('default');
    hideModal('visuPageSettingsModal');
}

// Enhanced renderVisuPage to handle VSE elements
const originalRenderVisuPage = renderVisuPage;
renderVisuPage = function() {
    const page = visuPages[currentVisuPage];
    if (!page) return;
    
    const canvas = document.getElementById('visuCanvas');
    
    // Apply background color
    if (page.bgColor) {
        canvas.style.background = page.bgColor;
    }
    
    let html = '';
    
    (page.widgets || []).forEach(w => {
        const editClass = visuEditMode ? 'editing' : '';
        const widthStyle = w.width ? `width:${w.width}px;` : '';
        const heightStyle = w.height ? `height:${w.height}px;` : '';
        
        if (w.type === 'vse') {
            // VSE Widget
            html += `<div class="visu-element ${editClass}" id="ve-${w.id}" 
                        style="left:${w.x}px;top:${w.y}px;${widthStyle}${heightStyle}"
                        onmousedown="startVisuDrag(event,'${w.id}')" ondblclick="editVisuWidget('${w.id}')">
                        <div class="vse-widget" data-vseid="${w.vseId}" data-ko1="${w.ko1||''}" 
                             style="width:100%;height:100%"
                             ${Object.entries(w.vars||{}).map(([k,v])=>`data-${k}="${v}"`).join(' ')}>
                            ${renderVSEWidget(w)}
                        </div>
                        <div class="resize-handle" onmousedown="startVisuResize(event,'${w.id}')"></div>
                    </div>`;
        } else {
            // Standard widgets
            html += `<div class="visu-element ${editClass}" id="ve-${w.id}" 
                        style="left:${w.x}px;top:${w.y}px;${widthStyle}${heightStyle}" 
                        onmousedown="startVisuDrag(event,'${w.id}')" ondblclick="editVisuWidget('${w.id}')">
                        ${renderWidget(w)}
                        <div class="resize-handle" onmousedown="startVisuResize(event,'${w.id}')"></div>
                    </div>`;
        }
    });
    
    canvas.innerHTML = html;
    updateVisuValues();
};

function renderVSEWidget(w) {
    // Get current value for KO1
    const val = w.ko1 ? getAddrValue(w.ko1) : null;
    const numVal = parseFloat(val) || 0;
    
    // Get VSE definition if available
    const vseDef = vseElements.find(v => v.id === w.vseId);
    
    // Check for new JSON-based VSE (render type)
    if (vseDef?.render === 'sensorCard' || w.vseId === 'sensor_card') {
        return renderSensorCard(w, numVal, vseDef);
    }
    
    // Legacy: Pattern-based rendering
    const name = (w.vseName || w.vseId || '').toLowerCase();
    
    if (name.includes('sensor') || name.includes('card')) {
        return renderSensorCard(w, numVal, vseDef);
    } else if (name.includes('switch') || name.includes('light')) {
        return renderSwitchCard(w, val, numVal);
    } else if (name.includes('markdown') || name.includes('title')) {
        return renderTitleCard(w);
    } else {
        // Generic VSE widget
        return `<div style="width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;
                    padding:8px;border:1px dashed rgba(255,255,255,0.3);border-radius:8px;font-size:12px">
            <div style="font-weight:600">${w.vseName || 'VSE'}</div>
            <div style="color:var(--text-muted)">${w.label}</div>
            ${w.ko1 ? `<div style="margin-top:4px">${numVal}</div>` : ''}
        </div>`;
    }
}

function renderSensorCard(w, numVal, vseDef) {
    const v = w.vars || {};
    
    // Base styling from vars or defaults
    let icon = v.icon || 'thermometer';
    let iconSize = parseInt(v.iconSize) || 28;
    let iconColor = v.iconColor || '#58a6ff';
    let iconOpacity = parseInt(v.iconOpacity) || 100;
    let label = v.label || w.label || 'Sensor';
    let unit = v.unit || '';
    let decimals = parseInt(v.decimals) || 1;
    let labelSize = parseInt(v.labelSize) || 12;
    let labelColor = v.labelColor || '#888888';
    let valueSize = parseInt(v.valueSize) || 22;
    let valueColor = v.valueColor || '#ffffff';
    let bgColor = v.bgColor || '#1a1a2e';
    let bgOpacity = parseInt(v.bgOpacity) || 80;
    let borderColor = v.borderColor || '#58a6ff';
    let borderOpacity = parseInt(v.borderOpacity) || 40;
    let borderRadius = parseInt(v.borderRadius) || 12;
    let borderWidth = parseFloat(v.borderWidth) || 1.5;
    let glowEnabled = v.glowEnabled !== false && v.glowEnabled !== 'false';
    let glowColor = v.glowColor || '#58a6ff';
    let glowOpacity = parseInt(v.glowOpacity) || 15;
    
    // Apply conditions (check from highest to lowest priority)
    const conditions = [
        { enabled: v.cond3_enabled, op: v.cond3_op, val: parseFloat(v.cond3_value), iconColor: v.cond3_iconColor, borderColor: v.cond3_borderColor, glowColor: v.cond3_glowColor, icon: v.cond3_icon },
        { enabled: v.cond2_enabled, op: v.cond2_op, val: parseFloat(v.cond2_value), iconColor: v.cond2_iconColor, borderColor: v.cond2_borderColor, glowColor: v.cond2_glowColor, icon: v.cond2_icon },
        { enabled: v.cond1_enabled, op: v.cond1_op, val: parseFloat(v.cond1_value), iconColor: v.cond1_iconColor, borderColor: v.cond1_borderColor, glowColor: v.cond1_glowColor, icon: v.cond1_icon }
    ];
    
    for (const cond of conditions) {
        if (cond.enabled === true || cond.enabled === 'true' || cond.enabled === '1') {
            const match = evaluateCondition(numVal, cond.op || '>=', cond.val || 0);
            if (match) {
                if (cond.iconColor) iconColor = cond.iconColor;
                if (cond.borderColor) borderColor = cond.borderColor;
                if (cond.glowColor) glowColor = cond.glowColor;
                if (cond.icon) icon = cond.icon;
                break;
            }
        }
    }
    
    // Convert colors to rgba with opacity
    const bgRgba = hexToRgbaStr(bgColor, bgOpacity / 100);
    const borderRgba = hexToRgbaStr(borderColor, borderOpacity / 100);
    const glowRgba = hexToRgbaStr(glowColor, glowOpacity / 100);
    const iconStyle = iconOpacity < 100 ? `opacity:${iconOpacity/100}` : '';
    
    // Build shadow/glow effect
    let boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
    if (glowEnabled) {
        boxShadow = `0 8px 22px rgba(0,0,0,0.24), 0 0 0 1px ${hexToRgbaStr(borderColor, 0.2)}, 0 0 18px ${glowRgba}`;
    }
    
    return `<div style="
        width:100%;height:100%;display:flex;align-items:center;gap:12px;padding:10px 14px;
        background:${bgRgba};
        border:${borderWidth}px solid ${borderRgba};
        border-radius:${borderRadius}px;
        box-shadow:${boxShadow};
        box-sizing:border-box;
        transition: all 0.3s ease;
    ">
        <span class="mdi mdi-${icon}" style="font-size:${iconSize}px;color:${iconColor};flex-shrink:0;${iconStyle}"></span>
        <div style="display:flex;flex-direction:column;flex:1;min-width:0">
            <div style="font-size:${labelSize}px;color:${labelColor};white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${label}</div>
            <div style="font-size:${valueSize}px;font-weight:600;color:${valueColor}">${numVal.toFixed(decimals)}${unit ? ' ' + unit : ''}</div>
        </div>
    </div>`;
}

function hexToRgbaStr(hex, alpha) {
    if (!hex) return `rgba(88,166,255,${alpha})`;
    if (hex.startsWith('rgba')) return hex;
    if (hex.startsWith('rgb')) return hex.replace('rgb', 'rgba').replace(')', `,${alpha})`);
    hex = hex.replace('#', '');
    if (hex.length === 3) hex = hex[0]+hex[0]+hex[1]+hex[1]+hex[2]+hex[2];
    const r = parseInt(hex.substring(0,2), 16);
    const g = parseInt(hex.substring(2,4), 16);
    const b = parseInt(hex.substring(4,6), 16);
    return `rgba(${r},${g},${b},${alpha})`;
}

function renderSwitchCard(w, val, numVal) {
    const v = w.vars || {};
    const isOn = val === '1' || val === true || val === 'True' || numVal > 0;
    const colorOn = v.colorOn || '#ffc107';
    const colorOff = v.colorOff || '#9e9e9e';
    const color = isOn ? colorOn : colorOff;
    const icon = v.icon || 'lightbulb';
    const iconSize = parseInt(v.iconSize) || 40;
    const textOn = v.textOn || 'An';
    const textOff = v.textOff || 'Aus';
    const borderRadius = parseInt(v.borderRadius) || 12;
    
    return `<div style="width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;
                padding:8px;border-radius:${borderRadius}px;border:1.5px solid ${color}66;background:rgba(255,255,255,0.06);box-sizing:border-box;cursor:pointer;transition:all 0.2s"
                onclick="event.stopPropagation();toggleSwitch('${w.ko1}',${!isOn})">
        <span class="mdi mdi-${icon}" style="font-size:${iconSize}px;color:${color}"></span>
        <div style="font-size:13px;margin-top:6px">${w.label}</div>
        <div style="font-size:14px;font-weight:600;color:${color}">${isOn ? textOn : textOff}</div>
    </div>`;
}

function renderTitleCard(w) {
    const v = w.vars || {};
    const icon = v.icon || '';
    const subtitle = v.subtitle || '';
    const fontSize = parseInt(v.fontSize) || 18;
    const color = v.color || '#ffffff';
    
    return `<div style="width:100%;height:100%;display:flex;flex-direction:column;justify-content:center;padding:12px 10px">
        <div style="font-size:${fontSize}px;font-weight:600;color:${color}">${icon ? `<span class="mdi mdi-${icon}" style="margin-right:8px"></span>` : ''}${w.label}</div>
        ${subtitle ? `<div style="font-size:${fontSize * 0.7}px;color:rgba(255,255,255,0.7);margin-top:4px">${subtitle}</div>` : ''}
    </div>`;
}

function evaluateCondition(value, operator, threshold) {
    switch(operator) {
        case '>=': return value >= threshold;
        case '>': return value > threshold;
        case '<=': return value <= threshold;
        case '<': return value < threshold;
        case '==': return value == threshold;
        case '!=': return value != threshold;
        default: return false;
    }
}

// Load MDI font for VSE elements
(function loadMDIFont() {
    if (document.getElementById('mdi-font-css')) return;
    const link = document.createElement('link');
    link.id = 'mdi-font-css';
    link.rel = 'stylesheet';
    link.href = 'https://cdn.jsdelivr.net/npm/@mdi/font@7.4.47/css/materialdesignicons.min.css';
    document.head.appendChild(link);
})();

// Update clock every minute
setInterval(()=>{
    document.querySelectorAll('.ve-clock .time').forEach(el=>{
        el.textContent=new Date().toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'});
    });
},10000);
</script>
</body>
</html>
