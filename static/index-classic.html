<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>KNX Automation v2.5.11</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@7.2.96/css/materialdesignicons.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap">
    <script>
    // Force reload on version mismatch
    const APP_VERSION = '2.5.11';
    const stored = localStorage.getItem('app_version');
    if (stored && stored !== APP_VERSION) {
        localStorage.setItem('app_version', APP_VERSION);
        location.reload(true);
    } else {
        localStorage.setItem('app_version', APP_VERSION);
    }
    </script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        
        /* New Design System - HSL Colors */
        :root {
            --background: hsl(220, 20%, 10%);
            --foreground: hsl(210, 20%, 92%);
            --card: hsl(220, 18%, 13%);
            --card-foreground: hsl(210, 20%, 92%);
            --primary: hsl(142, 60%, 45%);
            --primary-foreground: hsl(220, 20%, 10%);
            --secondary: hsl(220, 16%, 18%);
            --secondary-foreground: hsl(210, 20%, 85%);
            --muted: hsl(220, 14%, 16%);
            --muted-foreground: hsl(215, 12%, 55%);
            --accent: hsl(200, 80%, 55%);
            --accent-foreground: hsl(220, 20%, 10%);
            --destructive: hsl(0, 70%, 55%);
            --border: hsl(220, 14%, 20%);
            --ring: hsl(142, 60%, 45%);
            --sidebar-bg: hsl(220, 20%, 8%);
            --sidebar-border: hsl(220, 14%, 18%);
            --sidebar-accent: hsl(220, 16%, 15%);
            --knx-online: hsl(142, 60%, 45%);
            --knx-offline: hsl(0, 70%, 55%);
            --knx-warning: hsl(38, 90%, 55%);
            --knx-info: hsl(200, 80%, 55%);
            --knx-purple: hsl(270, 60%, 60%);
            --radius: 0.75rem;
            --sidebar-width: 16rem;
            --sidebar-width-collapsed: 3.5rem;
            --header-height: 3.5rem;
        }
        
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: var(--background);
            color: var(--foreground);
            font-size: 14px;
            line-height: 1.5;
            min-height: 100vh;
        }
        
        code, .mono { font-family: 'JetBrains Mono', monospace; }
        
        /* App Layout */
        .app-wrapper {
            display: flex;
            min-height: 100vh;
        }
        
        /* Collapsible Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--sidebar-bg);
            border-right: 1px solid var(--sidebar-border);
            display: flex;
            flex-direction: column;
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            z-index: 100;
            transition: width 0.2s ease;
        }
        .sidebar.collapsed {
            width: var(--sidebar-width-collapsed);
        }
        .sidebar.collapsed .sidebar-brand-text,
        .sidebar.collapsed .nav-text,
        .sidebar.collapsed .nav-badge,
        .sidebar.collapsed .sidebar-version {
            display: none;
        }
        .sidebar.collapsed .sidebar-brand {
            justify-content: center;
            padding: 16px 8px;
        }
        .sidebar.collapsed .nav-item {
            justify-content: center;
            padding: 12px 8px;
        }
        .sidebar.collapsed .sidebar-footer {
            justify-content: center;
        }
        
        .sidebar-header {
            padding: 0;
            border-bottom: 1px solid var(--sidebar-border);
        }
        
        .sidebar-brand {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            height: var(--header-height);
        }
        .sidebar-brand-icon {
            font-size: 24px;
            color: var(--primary);
        }
        .sidebar-brand-text {
            font-weight: 600;
            font-size: 16px;
            color: var(--foreground);
            white-space: nowrap;
        }
        
        .sidebar-content {
            flex: 1;
            padding: 16px 12px;
            overflow-y: auto;
        }
        
        .nav-section {
            padding: 8px 4px;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--muted-foreground);
            margin-top: 8px;
        }
        .sidebar.collapsed .nav-section {
            text-align: center;
            padding: 8px 0;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            color: var(--muted-foreground);
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.15s ease;
            margin-bottom: 4px;
            font-size: 13px;
            font-weight: 500;
        }
        .nav-item:hover {
            background: var(--sidebar-accent);
            color: var(--foreground);
        }
        .nav-item.active {
            background: var(--sidebar-accent);
            color: var(--foreground);
        }
        .nav-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 3px;
            height: 24px;
            background: var(--primary);
            border-radius: 0 4px 4px 0;
        }
        .nav-item {
            position: relative;
        }
        .nav-item i {
            font-size: 18px;
            width: 20px;
            text-align: center;
            flex-shrink: 0;
        }
        .nav-text {
            white-space: nowrap;
            overflow: hidden;
        }
        .nav-badge {
            margin-left: auto;
            background: var(--secondary);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 500;
        }
        
        .sidebar-footer {
            padding: 12px;
            border-top: 1px solid var(--sidebar-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .sidebar-version {
            font-size: 11px;
            color: var(--muted-foreground);
            font-family: 'JetBrains Mono', monospace;
        }
        .sidebar-toggle {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--secondary);
            color: var(--muted-foreground);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }
        .sidebar-toggle:hover {
            background: var(--sidebar-accent);
            color: var(--foreground);
        }
        .sidebar.collapsed .sidebar-toggle i {
            transform: rotate(180deg);
        }
        
        /* Main Content */
        .main {
            flex: 1;
            margin-left: var(--sidebar-width);
            display: flex;
            flex-direction: column;
            transition: margin-left 0.2s ease;
        }
        .sidebar.collapsed ~ .main {
            margin-left: var(--sidebar-width-collapsed);
        }
        
        /* Header */
        .header {
            height: var(--header-height);
            background: var(--card);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            position: sticky;
            top: 0;
            z-index: 50;
        }
        .header-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--foreground);
        }
        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }
        .status-dot.online { background: var(--knx-online); }
        .status-dot.offline { background: var(--knx-offline); }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .status-text { color: var(--muted-foreground); }
        .status-ip { font-family: 'JetBrains Mono', monospace; font-size: 11px; }
        .settings-btn {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            border: none;
            background: transparent;
            color: var(--muted-foreground);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .settings-btn:hover {
            background: var(--secondary);
            color: var(--foreground);
        }
        
        /* Content Area */
        .content {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
        }
        .page { display: none; }
        .page.active { display: block; }
        
        /* Stat Widgets */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        .stat-widget {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .stat-icon {
            font-size: 20px;
            color: var(--muted-foreground);
            margin-bottom: 12px;
        }
        .stat-value {
            font-size: 28px;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
            line-height: 1;
        }
        .stat-value.online { color: var(--knx-online); }
        .stat-value.offline { color: var(--knx-offline); }
        .stat-value.info { color: var(--knx-info); }
        .stat-value.purple { color: var(--knx-purple); }
        .stat-value.warning { color: var(--knx-warning); }
        .stat-label {
            font-size: 11px;
            color: var(--muted-foreground);
            margin-top: 6px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        /* Cards */
        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
            animation: fadeIn 0.3s ease;
        }
        .card-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 12px;
        }
        .card-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--card-foreground);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .card-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .card-body {
            padding: 20px;
        }
        
        /* Table */
        table { width: 100%; border-collapse: collapse; }
        thead tr {
            border-bottom: 1px solid var(--border);
        }
        th {
            text-align: left;
            padding: 12px 16px;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--muted-foreground);
            font-weight: 500;
        }
        td {
            padding: 12px 16px;
            border-bottom: 1px solid hsl(220, 14%, 15%);
            font-size: 13px;
        }
        tbody tr:hover {
            background: var(--secondary);
        }
        .addr-code {
            font-family: 'JetBrains Mono', monospace;
            color: var(--knx-info);
            font-size: 12px;
        }
        .value-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-family: 'JetBrains Mono', monospace;
        }
        .value-badge.on {
            background: hsla(142, 60%, 45%, 0.15);
            color: var(--knx-online);
        }
        .value-badge.off {
            background: var(--secondary);
            color: var(--muted-foreground);
        }
        .type-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 500;
        }
        .type-badge.iko {
            background: hsla(270, 60%, 60%, 0.15);
            color: var(--knx-purple);
        }
        .type-badge.knx {
            background: hsla(200, 80%, 55%, 0.15);
            color: var(--knx-info);
        }
        
        /* Forms */
        .form-group { margin-bottom: 16px; }
        .form-label {
            display: block;
            margin-bottom: 6px;
            font-size: 12px;
            color: var(--muted-foreground);
            font-weight: 500;
        }
        input, select, textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 13px;
            font-family: inherit;
            background: var(--secondary);
            color: var(--foreground);
            transition: border-color 0.15s, box-shadow 0.15s;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--ring);
            box-shadow: 0 0 0 2px hsla(142, 60%, 45%, 0.2);
        }
        input[type="color"] {
            padding: 4px;
            height: 38px;
        }
        textarea {
            font-family: 'JetBrains Mono', monospace;
            resize: vertical;
        }
        
        /* Buttons */
        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.15s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-family: inherit;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-primary {
            background: var(--primary);
            color: var(--primary-foreground);
        }
        .btn-primary:hover:not(:disabled) {
            background: hsl(142, 60%, 40%);
        }
        .btn-secondary {
            background: var(--secondary);
            color: var(--secondary-foreground);
            border-color: var(--border);
        }
        .btn-secondary:hover:not(:disabled) {
            background: var(--muted);
        }
        .btn-destructive {
            background: var(--destructive);
            color: white;
        }
        .btn-destructive:hover:not(:disabled) {
            background: hsl(0, 70%, 50%);
        }
        .btn-ghost {
            background: transparent;
            color: var(--muted-foreground);
        }
        .btn-ghost:hover:not(:disabled) {
            background: var(--secondary);
            color: var(--foreground);
        }
        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }
        .btn-icon {
            width: 32px;
            height: 32px;
            padding: 0;
            justify-content: center;
        }
        
        /* Search Input */
        .search-wrapper {
            position: relative;
        }
        .search-wrapper i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--muted-foreground);
            font-size: 16px;
        }
        .search-wrapper input {
            padding-left: 36px;
            width: 200px;
        }
        
        /* Alerts */
        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            display: none;
            font-size: 13px;
            align-items: center;
            gap: 8px;
        }
        .alert.show { display: flex; }
        .alert.success {
            background: hsla(142, 60%, 45%, 0.15);
            color: var(--knx-online);
            border: 1px solid hsla(142, 60%, 45%, 0.3);
        }
        .alert.error {
            background: hsla(0, 70%, 55%, 0.15);
            color: var(--knx-offline);
            border: 1px solid hsla(0, 70%, 55%, 0.3);
        }
        .alert.info {
            background: hsla(200, 80%, 55%, 0.15);
            color: var(--knx-info);
            border: 1px solid hsla(200, 80%, 55%, 0.3);
        }
        
        .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:200;align-items:center;justify-content:center;backdrop-filter:blur(4px)}
        .modal.show{display:flex}
        .modal-content{background:var(--card);border-radius:12px;width:500px;max-width:90%;max-height:85vh;overflow-y:auto;border:1px solid var(--border)}
        .modal-content.wide{width:800px}
        .modal-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
        .modal-title{font-weight:600;font-size:15px}
        .modal-close{background:none;border:none;font-size:20px;cursor:pointer;color:var(--text-muted);padding:4px}.modal-close:hover{color:var(--text)}
        .modal-body{padding:20px}
        .modal-footer{padding:16px 20px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px}
        .modal-error{background:rgba(248,81,73,.15);color:var(--danger);padding:10px;border-radius:6px;margin-bottom:12px;display:none;font-size:12px}
        
        .tabs{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap}
        .tab{padding:8px 16px;background:var(--sidebar);border:1px solid var(--border);border-radius:6px;cursor:pointer;font-size:12px;transition:all .15s}
        .tab:hover{background:var(--card-hover)}
        .tab.active{background:var(--accent);color:#fff;border-color:var(--accent)}
        .tab .delete-tab{margin-left:8px;opacity:.6}.tab .delete-tab:hover{opacity:1}
        
        .upload-zone{border:2px dashed var(--border);border-radius:8px;padding:32px;text-align:center;cursor:pointer;transition:all .15s}
        .upload-zone:hover{border-color:var(--accent);background:rgba(88,166,255,.05)}
        .upload-zone input{display:none}
        
        .logic-canvas{min-height:calc(100vh - 200px);padding:40px 60px;position:relative;background:#e0e0e0;overflow:auto;flex:1}
        :root:not(.light) .logic-canvas{background:#2a2a2a}
        
        .logic-wrapper{display:flex;height:calc(100vh - 200px)}
        .logic-main{flex:1;overflow:auto;position:relative}
        .logic-props{width:320px;background:var(--card);border-left:1px solid var(--border);overflow-y:auto;display:none}
        .logic-props.active{display:block}
        .logic-props-header{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
        .logic-props-header h3{font-size:14px;margin:0}
        .logic-props-body{padding:16px}
        .logic-props-section{margin-bottom:16px}
        .logic-props-section h4{font-size:11px;text-transform:uppercase;color:var(--text-muted);margin-bottom:8px;letter-spacing:0.5px}
        .logic-props-row{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border);font-size:12px}
        .logic-props-row:last-child{border-bottom:none}
        .logic-props-label{color:var(--text-muted)}
        .logic-props-value{color:var(--text);font-weight:500;max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
        
        /* ========== EDOMI EXACT STYLE ========== */
        .eblock{--block-color:#c0d700;position:absolute;width:420px;font-family:sans-serif;font-size:11px;box-shadow:4px 4px 12px rgba(0,0,0,0.2);border:1px solid #a0a0a0}
        .eblock.selected{outline:3px solid #58a6ff;outline-offset:2px}
        .eblock.error{--block-color:#ff4d4d}
        
        /* Header - DUNKEL */
        .eblock-header{background:#2d2d2d;color:#fff;padding:6px 10px;font-size:12px;font-weight:bold;cursor:move;user-select:none;display:flex;align-items:center;gap:8px}
        
        /* Body - GRÜN */
        .eblock-body{background:var(--block-color)}
        
        /* Tabelle */
        .eblock-table{width:100%;border-collapse:collapse}
        
        .eblock-row{border-bottom:1px solid rgba(0,0,0,0.1)}
        .eblock-row:last-child{border-bottom:none}
        
        /* Input-Seite (links) - mit Port und Wert */
        .eblock-input{width:50%;padding:4px 8px 4px 22px;background:rgba(255,255,255,0.2);border-right:1px solid #a0a0a0;vertical-align:middle;position:relative}
        .eblock-input-label{color:#444;font-size:10px;display:block}
        .eblock-input-num{color:#666;font-size:11px;font-weight:600;margin-right:5px}
        .eblock-input-value{background:#d8d8d8;color:#444;font-weight:bold;padding:4px 10px;font-size:12px;display:inline-block;cursor:pointer;max-width:130px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
        .eblock-input-value:hover{background:#c8c8c8}
        
        /* Output-Seite (rechts) - mit Port und Wert */
        .eblock-output{width:50%;padding:4px 22px 4px 8px;vertical-align:middle;position:relative}
        .eblock-output-label{color:#444;font-size:10px;display:block;text-align:right}
        .eblock-output-num{color:#666;font-size:11px;font-weight:600;margin-left:5px}
        .eblock-output-value{background:#d8d8d8;color:#444;font-weight:bold;padding:4px 10px;font-size:12px;display:inline-block;cursor:pointer;max-width:130px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
        .eblock-output-value:hover{background:#c8c8c8}
        
        /* Binding Label (rot) */
        .eblock-binding{background:#f85149;color:#fff;font-size:9px;padding:1px 5px;border-radius:3px;font-weight:500;max-width:100px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;cursor:help}
        
        /* Port (Verbindungspunkt) - ohne Striche */
        .eblock-port{position:absolute;top:50%;transform:translateY(-50%);width:10px;height:10px;background:#888;border-radius:50%;border:1px solid rgba(0,0,0,0.3);cursor:crosshair;z-index:5}
        .eblock-port:hover{background:#58a6ff;transform:translateY(-50%) scale(1.3);box-shadow:0 0 6px #58a6ff}
        .eblock-port.wired{background:#f85149;border-color:#c0392b}
        .eblock-port.wire-target{background:#3fb950;transform:translateY(-50%) scale(1.4);box-shadow:0 0 8px #3fb950}
        
        /* Port links für Inputs */
        .eblock-port.input{left:6px}
        /* Port rechts für Outputs */
        .eblock-port.output{right:6px}
        
        /* Status Box unten */
        .eblock-status{background:rgba(0,0,0,0.05);padding:5px 10px;font-size:10px;border-top:1px solid rgba(0,0,0,0.1);color:#333}
        
        /* Block Header Info */
        .eblock-header-info{font-size:9px;color:rgba(255,255,255,0.7);font-weight:normal;margin-left:6px}
        
        /* Wire SVG */
        .wire-svg{position:absolute;top:0;left:0;pointer-events:none;z-index:5;overflow:visible;width:100%;height:100%}
        .wire-path{fill:none;stroke:#555;stroke-width:2}
        .wire-path.active{stroke:#f0e068;stroke-width:2.5}
        .wire-temp{stroke:#58a6ff;stroke-width:2;stroke-dasharray:5,5}
        
        .log-entry{padding:6px 12px;font-family:'SF Mono',Consolas,monospace;font-size:11px;border-bottom:1px solid var(--border)}
        .log-time{color:var(--text-muted);margin-right:8px}
        .log-level{font-weight:600;margin-right:8px;padding:2px 6px;border-radius:3px;font-size:10px}
        .log-level.INFO{background:rgba(63,185,80,.2);color:var(--success)}
        .log-level.DEBUG{background:rgba(88,166,255,.2);color:var(--accent)}
        .log-level.WARNING{background:rgba(210,153,34,.2);color:var(--warning)}
        .log-level.ERROR{background:rgba(248,81,73,.2);color:var(--danger)}
        
        .empty{padding:40px;text-align:center;color:var(--text-muted)}
        .info-box{background:var(--sidebar);border:1px solid var(--border);border-radius:8px;padding:16px;margin-top:16px}
        .info-box h4{margin-bottom:8px;color:var(--text)}
        
        /* ========== MODERN DASHBOARD DESIGN ========== */
        .dashboard-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));grid-auto-rows:min-content;gap:20px}
        .widget{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:20px;display:flex;flex-direction:column;gap:15px;transition:all 0.2s}
        .widget:hover{border-color:var(--text-muted)}
        .widget-header{display:flex;justify-content:space-between;align-items:center}
        .widget-title{font-weight:600;font-size:14px;color:var(--text)}
        .widget-subtitle{font-size:11px;color:var(--text-muted)}
        .widget-actions{display:flex;gap:4px}
        .widget-actions button{background:none;border:none;color:var(--text-muted);cursor:pointer;padding:4px;font-size:16px;transition:color 0.2s}
        .widget-actions button:hover{color:var(--accent)}
        .widget-body{flex:1;overflow:auto}
        .widget-lg{grid-column:span 2}
        .widget-xl{grid-column:span 2;grid-row:span 2}
        
        /* Status Pill */
        .status-pill{font-size:10px;padding:3px 10px;border-radius:12px;font-weight:600;text-transform:uppercase}
        .status-pill.active{background:rgba(63,185,80,0.1);color:var(--success);border:1px solid var(--success)}
        .status-pill.error{background:rgba(248,81,73,0.1);color:var(--danger);border:1px solid var(--danger)}
        .status-pill.warning{background:rgba(210,153,34,0.1);color:var(--warning);border:1px solid var(--warning)}
        
        /* Energy/Value Display */
        .energy-value{font-size:28px;font-weight:700;text-align:center;margin:10px 0}
        .energy-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
        .energy-item{background:var(--bg);padding:12px;border-radius:10px;display:flex;flex-direction:column;gap:4px}
        .energy-label{font-size:10px;color:var(--text-muted);display:flex;align-items:center;gap:5px}
        .energy-val{font-weight:600;font-size:14px}
        
        /* Stat Widgets */
        .stat-widget{display:flex;flex-direction:column;height:100%}
        .stat-widget .stat-icon{font-size:20px;color:var(--text-muted)}
        .stat-widget .stat-number{font-size:28px;font-weight:700;color:var(--text);line-height:1}
        .stat-widget .stat-label{font-size:12px;color:var(--text-muted);margin-top:4px}
        
        /* Donut Widget */
        .donut-widget{display:flex;align-items:center;gap:16px;height:100%}
        .donut-svg{width:80px;height:80px;flex-shrink:0}
        .donut-legend{flex:1}
        .donut-item{display:flex;align-items:center;gap:8px;margin-bottom:6px;font-size:11px}
        .donut-color{width:10px;height:10px;border-radius:2px}
        
        /* OAuth Container */
        .oauth-container{display:flex;flex-direction:column;height:100%;gap:12px}
        .oauth-header{display:flex;justify-content:space-between;align-items:center}
        .oauth-status-dot{width:10px;height:10px;border-radius:50%;background:var(--text-muted);flex-shrink:0}
        .oauth-status-dot.active{background:var(--success);box-shadow:0 0 10px var(--success)}
        .oauth-status-dot.error{background:var(--danger);box-shadow:0 0 10px var(--danger)}
        .progress-box{height:6px;background:var(--bg);border-radius:3px;overflow:hidden}
        :root.light .progress-box{background:var(--border)}
        .progress-bar{height:100%;background:var(--accent);width:0%;transition:width 0.5s ease}
        .oauth-info{display:flex;justify-content:space-between;font-size:11px;color:var(--text-muted)}
        .oauth-error{font-size:10px;color:var(--danger);display:none}
        .oauth-error.show{display:block}
        .btn-oauth{background:var(--card-hover);border:1px solid var(--border);color:var(--text);padding:10px;border-radius:8px;cursor:pointer;font-size:12px;font-weight:600;display:flex;align-items:center;justify-content:center;gap:8px;text-decoration:none;transition:all 0.2s}
        .btn-oauth:hover{background:var(--border)}
        .btn-oauth.needed{background:var(--purple);color:white;border:none;animation:pulse 2s infinite}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.8}}
        
        /* Quick Values */
        .quick-values{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px}
        .quick-value-item{background:var(--bg);border-radius:10px;padding:12px;display:flex;flex-direction:column;gap:2px}
        :root.light .quick-value-item{background:var(--card-hover)}
        .quick-value-addr{font-size:10px;color:var(--accent);font-family:monospace}
        .quick-value-name{font-size:11px;color:var(--text-muted)}
        .quick-value-val{font-size:18px;font-weight:600}
        
        /* IKO Group Styles */
        .iko-group{border:1px solid var(--border);border-radius:8px;margin-bottom:8px;overflow:hidden}
        .iko-group-header{display:flex;align-items:center;gap:10px;padding:12px 16px;background:var(--sidebar);cursor:pointer;user-select:none}
        .iko-group-header:hover{background:var(--card-hover)}
        .iko-group-header i{transition:transform 0.2s}
        .iko-group.collapsed .iko-group-header i.mdi-chevron-down{transform:rotate(-90deg)}
        .iko-group-name{font-weight:600;font-size:14px;flex:1}
        .iko-group-count{font-size:11px;color:var(--text-muted);background:var(--card-hover);padding:3px 10px;border-radius:10px}
        .iko-group-body{display:block}
        .iko-group.collapsed .iko-group-body{display:none}
        .iko-row{display:flex;align-items:center;padding:10px 16px;border-top:1px solid var(--border);gap:16px;font-size:13px}
        .iko-row:hover{background:var(--card-hover)}
        .iko-row-addr{font-family:monospace;color:var(--purple);min-width:200px;font-weight:600;font-size:13px}
        .iko-row-name{flex:1;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;min-width:150px}
        .iko-row-dpt{color:var(--text-muted);min-width:80px;text-align:center}
        .iko-row-value{min-width:120px;font-weight:600;cursor:pointer;padding:6px 12px;background:var(--bg);border-radius:6px;text-align:center;font-size:14px}
        .iko-row-value:hover{background:var(--accent);color:#fff}
        .iko-row-initial{min-width:120px;font-size:11px;color:var(--text-muted)}
        .iko-row-actions{display:flex;gap:6px}
        .iko-row-actions button{padding:6px 10px;font-size:12px}
        :root.light .iko-group-header{background:var(--card-hover)}
        :root.light .iko-row-value{background:var(--border)}
        
        /* ========== EDOMI-STYLE VISU ========== */
        .visu-toolbar{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:var(--card);border:1px solid var(--border);border-radius:8px;margin-bottom:16px;flex-wrap:wrap;gap:12px}
        .visu-breadcrumb{padding:8px 16px;background:var(--bg);border:1px solid var(--border);border-radius:8px;margin-bottom:12px;font-size:13px;display:flex;align-items:center;gap:4px;flex-wrap:wrap;min-height:36px}
        .visu-breadcrumb:empty{display:none}
        .visu-breadcrumb .breadcrumb-link{color:var(--accent);text-decoration:none;display:inline-flex;align-items:center;gap:4px;padding:2px 6px;border-radius:4px;transition:background 0.2s}
        .visu-breadcrumb .breadcrumb-link:hover{background:rgba(88,166,255,0.15)}
        .visu-breadcrumb .breadcrumb-link .mdi{font-size:16px}
        .visu-breadcrumb .breadcrumb-sep{color:var(--text-muted);margin:0 4px}
        .visu-breadcrumb .breadcrumb-current{color:var(--text);font-weight:500;display:inline-flex;align-items:center;gap:4px}
        .visu-breadcrumb .breadcrumb-current .mdi{font-size:16px;color:var(--accent)}
        .visu-size-btns{display:flex;gap:4px}
        .visu-size-btns button.active{background:var(--accent);color:#fff}
        .visu-container{background:#1a1a2e;border:1px solid var(--border);border-radius:8px;overflow:auto;min-height:calc(100vh - 280px);display:flex;justify-content:center;align-items:flex-start;padding:20px;flex:1}
        .visu-layout{display:flex;gap:16px;min-height:calc(100vh - 280px)}
        .visu-tree-panel{width:280px;background:var(--card);border:1px solid var(--border);border-radius:8px;display:none;flex-direction:column;flex-shrink:0}
        .visu-tree-panel.show{display:flex}
        .visu-tree-header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid var(--border);font-weight:600;font-size:14px}
        .visu-tree-header .mdi{margin-right:8px;color:var(--accent)}
        .visu-tree-content{flex:1;overflow-y:auto;padding:8px}
        .visu-tree-item{display:flex;align-items:center;padding:8px 12px;border-radius:6px;cursor:pointer;margin:2px 0;transition:background 0.2s;font-size:13px}
        .visu-tree-item:hover{background:rgba(88,166,255,0.1)}
        .visu-tree-item.active{background:var(--accent);color:#fff}
        .visu-tree-item.active .mdi{color:#fff}
        .visu-tree-item .mdi{font-size:18px;margin-right:8px;color:var(--text-muted)}
        .visu-tree-item .tree-name{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .visu-tree-item .tree-children{font-size:10px;color:var(--text-muted);margin-left:8px}
        .visu-tree-group{margin-left:16px;border-left:1px solid var(--border);padding-left:8px}
        .visu-canvas{background:linear-gradient(135deg,#1a1a2e 0%,#16213e 100%);position:relative;border-radius:8px;box-shadow:0 0 30px rgba(0,0,0,0.5);transition:width 0.3s,height 0.3s;min-height:500px}
        .visu-canvas.fullsize{width:100%;min-height:calc(100vh - 280px)}
        .visu-canvas.phone{width:375px;height:667px}
        .visu-canvas.tablet{width:768px;height:1024px}
        .visu-canvas.desktop{width:1920px;height:1080px}
        
        .visu-element{position:absolute;cursor:pointer;user-select:none;transition:transform 0.1s}
        .visu-element:hover{z-index:100}
        .visu-element.editing{outline:2px dashed var(--accent);cursor:move}
        .visu-element .resize-handle{position:absolute;width:16px;height:16px;background:var(--accent);border-radius:3px;right:-8px;bottom:-8px;cursor:se-resize;display:none;opacity:0.8}
        .visu-element .resize-handle:hover{opacity:1;transform:scale(1.1)}
        .visu-element.editing .resize-handle{display:block}
        
        .ve-switch{width:80px;height:80px;background:linear-gradient(145deg,#2d2d44,#1a1a2e);border-radius:12px;display:flex;flex-direction:column;align-items:center;justify-content:center;border:2px solid #3d3d5c;box-shadow:0 4px 15px rgba(0,0,0,0.4)}
        .ve-switch.on{background:linear-gradient(145deg,#1e4d2b,#0d3318);border-color:var(--success);box-shadow:0 0 20px rgba(63,185,80,0.3)}
        .ve-switch .icon{font-size:28px}
        .ve-switch .label{font-size:10px;color:var(--text-muted);margin-top:4px}
        
        .ve-dimmer{width:100px;height:140px;background:linear-gradient(145deg,#2d2d44,#1a1a2e);border-radius:12px;padding:10px;display:flex;flex-direction:column;align-items:center;border:2px solid #3d3d5c}
        .ve-dimmer .icon{font-size:24px;margin-bottom:8px}
        .ve-dimmer .slider-v{width:20px;height:70px;background:#1a1a2e;border-radius:10px;position:relative}
        .ve-dimmer .slider-fill{position:absolute;bottom:0;width:100%;background:linear-gradient(to top,var(--warning),#ffd93d);border-radius:10px;transition:height 0.2s}
        .ve-dimmer .value{font-size:12px;font-weight:600;margin-top:8px}
        
        .ve-value{min-width:100px;height:60px;background:linear-gradient(145deg,#2d2d44,#1a1a2e);border-radius:10px;padding:8px 12px;display:flex;flex-direction:column;justify-content:center;border:2px solid #3d3d5c}
        .ve-value .label{font-size:10px;color:var(--text-muted)}
        .ve-value .number{font-size:22px;font-weight:700}
        .ve-value .unit{font-size:12px;color:var(--text-muted);margin-left:4px}
        .ve-value.temp .number{color:#ff7b54}
        .ve-value.hum .number{color:#00b4d8}
        .ve-value.power .number{color:#ffd93d}
        
        .ve-shutter{width:80px;height:120px;background:linear-gradient(145deg,#2d2d44,#1a1a2e);border-radius:12px;padding:8px;display:flex;flex-direction:column;align-items:center;border:2px solid #3d3d5c}
        .ve-shutter .preview{width:50px;height:50px;background:#0d1117;border:2px solid #3d3d5c;border-radius:4px;position:relative;overflow:hidden}
        .ve-shutter .slats{position:absolute;top:0;width:100%;background:repeating-linear-gradient(0deg,#6d6d8d 0px,#6d6d8d 3px,transparent 3px,transparent 6px);transition:height 0.3s}
        .ve-shutter .btns{display:flex;gap:4px;margin-top:6px}
        .ve-shutter .btns button{width:22px;height:22px;border:none;border-radius:4px;background:#3d3d5c;color:#fff;cursor:pointer;font-size:10px}
        .ve-shutter .btns button:hover{background:var(--accent)}
        .ve-shutter .label{font-size:9px;color:var(--text-muted);margin-top:4px}
        
        .ve-scene{width:90px;height:70px;background:linear-gradient(145deg,#2d2d44,#1a1a2e);border-radius:12px;display:flex;flex-direction:column;align-items:center;justify-content:center;border:2px solid #3d3d5c}
        .ve-scene:hover{border-color:var(--accent);box-shadow:0 0 15px rgba(88,166,255,0.3)}
        .ve-scene:active{transform:scale(0.95)}
        .ve-scene .icon{font-size:24px}
        .ve-scene .label{font-size:10px;color:var(--text-muted);margin-top:4px}
        
        .ve-clock{min-width:120px;height:50px;background:linear-gradient(145deg,#2d2d44,#1a1a2e);border-radius:10px;display:flex;align-items:center;justify-content:center;border:2px solid #3d3d5c;padding:0 15px}
        .ve-clock .time{font-size:26px;font-weight:300;font-family:'SF Mono',monospace}
        
        .ve-label{padding:4px 8px;color:var(--text);font-size:14px}
        
        /* Navigation Link Widget */
        .ve-navlink{cursor:pointer;transition:all 0.2s;display:flex;align-items:center;gap:8px}
        .ve-navlink.button{background:linear-gradient(145deg,var(--accent),#4090e0);color:#fff;padding:10px 20px;border-radius:8px;font-weight:500;box-shadow:0 4px 15px rgba(88,166,255,0.3)}
        .ve-navlink.button:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(88,166,255,0.4)}
        .ve-navlink.button:active{transform:translateY(0)}
        .ve-navlink.button .mdi{font-size:20px}
        .ve-navlink.card{background:linear-gradient(145deg,#2d2d44,#1a1a2e);padding:16px 24px;border-radius:12px;border:2px solid var(--border);flex-direction:column;text-align:center;min-width:100px}
        .ve-navlink.card:hover{border-color:var(--accent);background:linear-gradient(145deg,#3d3d54,#2a2a3e)}
        .ve-navlink.card .mdi{font-size:32px;color:var(--accent);margin-bottom:8px}
        .ve-navlink.card .name{font-size:13px;color:var(--text)}
        .ve-navlink.text-only{color:var(--accent);font-size:14px;text-decoration:underline;padding:8px}
        .ve-navlink.text-only:hover{color:#fff}
        .ve-navlink.icon-only{width:50px;height:50px;background:rgba(88,166,255,0.15);border-radius:50%;justify-content:center;border:2px solid var(--accent)}
        .ve-navlink.icon-only:hover{background:var(--accent);color:#fff}
        .ve-navlink.icon-only .mdi{font-size:24px;color:var(--accent)}
        .ve-navlink.icon-only:hover .mdi{color:#fff}
        
        /* Navigation Menu Widget */
        .ve-navmenu{display:flex;gap:8px;padding:8px 16px;background:rgba(0,0,0,0.5);border-radius:12px;backdrop-filter:blur(10px)}
        .ve-navmenu.bottom,.ve-navmenu.top{flex-direction:row;justify-content:center}
        .ve-navmenu.left{flex-direction:column}
        .ve-navmenu .nav-item{display:flex;flex-direction:column;align-items:center;padding:8px 12px;border-radius:8px;cursor:pointer;transition:all 0.2s;color:var(--text-muted)}
        .ve-navmenu .nav-item:hover{background:rgba(255,255,255,0.1);color:var(--text)}
        .ve-navmenu .nav-item.active{background:var(--accent);color:#fff}
        .ve-navmenu .nav-item .mdi{font-size:20px;margin-bottom:4px}
        .ve-navmenu .nav-item .name{font-size:10px}
        .ve-navmenu.text .nav-item{flex-direction:row;gap:4px}
        .ve-navmenu.text .nav-item .name{font-size:13px}
        .ve-navmenu .nav-dot{width:10px;height:10px;border-radius:50%;background:rgba(255,255,255,0.3);cursor:pointer;transition:all 0.2s}
        .ve-navmenu .nav-dot:hover{background:rgba(255,255,255,0.5);transform:scale(1.2)}
        .ve-navmenu .nav-dot.active{background:var(--accent);transform:scale(1.2)}
        .ve-navmenu .nav-back{background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2)}
        .ve-navmenu .nav-back:hover{background:rgba(255,255,255,0.2)}
        
        /* VSE Grid */
        .vse-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:16px}
        .vse-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;cursor:pointer;transition:all 0.2s}
        .vse-card:hover{border-color:var(--accent);transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.3)}
        .vse-card .vse-preview{height:80px;background:#1a1a2e;border-radius:8px;margin-bottom:12px;display:flex;align-items:center;justify-content:center;overflow:hidden}
        .vse-card .vse-name{font-weight:600;margin-bottom:4px}
        .vse-card .vse-id{font-size:11px;color:var(--text-muted)}
        .vse-card .vse-size{font-size:11px;color:var(--accent)}
        .vse-card .vse-actions{display:flex;gap:8px;margin-top:12px}
        .btn-purple{background:var(--purple);color:#fff;border:none}
        .btn-purple:hover{background:#8b5cf6}
        .btn-accent{background:var(--accent);color:#fff;border:none}
        .btn-accent:hover{background:#1e88e5}
    </style>
</head>
<body>
    <div class="app-wrapper">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-brand">
                    <i class="mdi mdi-lightning-bolt sidebar-brand-icon"></i>
                    <span class="sidebar-brand-text">KNX Automation</span>
                </div>
            </div>
            
            <nav class="sidebar-content">
                <div class="nav-section">Übersicht</div>
                <div class="nav-item active" onclick="showPage('dashboard')" data-tooltip="Dashboard">
                    <i class="mdi mdi-view-dashboard"></i>
                    <span class="nav-text">Dashboard</span>
                </div>
                <div class="nav-item" onclick="showPage('visu')" data-tooltip="Visualisierung">
                    <i class="mdi mdi-monitor-dashboard"></i>
                    <span class="nav-text">Visualisierung</span>
                </div>
                <div class="nav-item" onclick="showPage('vse')" data-tooltip="Widgets">
                    <i class="mdi mdi-palette"></i>
                    <span class="nav-text">Widgets</span>
                </div>
                
                <div class="nav-section">KNX</div>
                <div class="nav-item" onclick="showPage('addresses')" data-tooltip="KNX Adressen">
                    <i class="mdi mdi-format-list-bulleted"></i>
                    <span class="nav-text">KNX Adressen</span>
                    <span class="nav-badge" id="addrCount">0</span>
                </div>
                <div class="nav-item" onclick="showPage('internal')" data-tooltip="Interne (IKO)">
                    <i class="mdi mdi-link-variant"></i>
                    <span class="nav-text">Interne (IKO)</span>
                    <span class="nav-badge" id="intCount">0</span>
                </div>
                
                <div class="nav-section">Automatisierung</div>
                <div class="nav-item" onclick="showPage('logic')" data-tooltip="Logik-Editor">
                    <i class="mdi mdi-puzzle"></i>
                    <span class="nav-text">Logik-Editor</span>
                    <span class="nav-badge" id="blockCount">0</span>
                </div>
                <div class="nav-item" onclick="showPage('blocks')" data-tooltip="Bausteintypen">
                    <i class="mdi mdi-package-variant"></i>
                    <span class="nav-text">Bausteintypen</span>
                </div>
                <div class="nav-item" onclick="showPage('code')" data-tooltip="Code-Editor">
                    <i class="mdi mdi-code-tags"></i>
                    <span class="nav-text">Code-Editor</span>
                </div>
                
                <div class="nav-section">System</div>
                <div class="nav-item" onclick="showPage('settings')" data-tooltip="Einstellungen">
                    <i class="mdi mdi-cog"></i>
                    <span class="nav-text">Einstellungen</span>
                </div>
                <div class="nav-item" onclick="showPage('import')" data-tooltip="Import/Export">
                    <i class="mdi mdi-swap-vertical"></i>
                    <span class="nav-text">Import/Export</span>
                </div>
                <div class="nav-item" onclick="showPage('update')" data-tooltip="System-Update">
                    <i class="mdi mdi-update"></i>
                    <span class="nav-text">System-Update</span>
                </div>
                <div class="nav-item" onclick="showPage('logs')" data-tooltip="Logs">
                    <i class="mdi mdi-text-box-outline"></i>
                    <span class="nav-text">Logs</span>
                </div>
            </nav>
            
            <div class="sidebar-footer">
                <span class="sidebar-version">v2.5.11</span>
                <button class="sidebar-toggle" onclick="toggleSidebar()" title="Sidebar ein-/ausklappen">
                    <i class="mdi mdi-chevron-left"></i>
                </button>
            </div>
        </aside>
        
        <div class="main">
            <header class="header">
                <div class="header-title" id="pageTitle">Dashboard</div>
                <div class="header-right">
                    <div class="status-indicator" id="connStatus">
                        <span class="status-dot offline"></span>
                        <span class="status-text" id="connText">Verbinde...</span>
                        <span class="status-ip" id="connIp"></span>
                    </div>
                    <button class="settings-btn" onclick="showPage('settings')" title="Einstellungen">
                        <i class="mdi mdi-cog"></i>
                    </button>
                </div>
            </header>
            
            <main class="content">
                <div id="mainAlert" class="alert"></div>
                
                <div id="page-dashboard" class="page active">
                    <!-- Status Widgets -->
                    <div class="stats-grid" id="statsGrid">
                        <div class="stat-widget">
                            <i class="mdi mdi-wifi stat-icon" id="connIcon"></i>
                            <div class="stat-value online" id="connStatusText">Online</div>
                            <div class="stat-label">KNX Gateway</div>
                        </div>
                        <div class="stat-widget">
                            <i class="mdi mdi-format-list-bulleted stat-icon"></i>
                            <div class="stat-value info" id="sAddr">0</div>
                            <div class="stat-label">Gruppenadressen</div>
                        </div>
                        <div class="stat-widget">
                            <i class="mdi mdi-link-variant stat-icon"></i>
                            <div class="stat-value purple" id="sInt">0</div>
                            <div class="stat-label">Interne (IKO)</div>
                        </div>
                        <div class="stat-widget">
                            <i class="mdi mdi-lightning-bolt stat-icon"></i>
                            <div class="stat-value warning" id="sActive">0</div>
                            <div class="stat-label">Aktive Geräte</div>
                        </div>
                    </div>
                    
                    <div class="dashboard-grid" id="dashboardGrid">
                        <!-- OAuth2 Service Widget -->
                        <div class="widget widget-lg" id="oauthWidgetContainer">
                            <div class="widget-header">
                                <div>
                                    <div style="font-weight:600">Netatmo Service</div>
                                    <div class="widget-subtitle" id="oauth-source">Status: -</div>
                                </div>
                                <i class="mdi mdi-key-variant" id="oauth-status-icon" style="color:var(--muted-foreground);font-size:20px"></i>
                            </div>
                            <div class="progress-box">
                                <div class="progress-bar" id="oauth-progress" style="width:86%"></div>
                            </div>
                            <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--muted-foreground)">
                                <span id="oauth-expiry">0s verbleibend</span>
                                <span id="oauth-ready-text">Quelle: -</span>
                            </div>
                            <a href="#" id="oauth-auth-link" class="btn-oauth needed" style="display:none">
                                <i class="mdi mdi-login"></i> Neu Autorisieren
                            </a>
                            <button id="oauth-refresh-btn" class="btn-oauth" onclick="triggerOAuthRefresh()">
                                <i class="mdi mdi-refresh"></i> Token erneuern
                            </button>
                        </div>
                        
                        <!-- Temperatur Widget -->
                        <div class="widget" id="tempWidget">
                            <div style="display:flex;justify-content:space-between">
                                <i class="mdi mdi-thermometer" style="font-size:20px;color:var(--muted-foreground)"></i>
                                <span style="font-size:12px;color:var(--knx-online)">+1.2%</span>
                            </div>
                            <div style="margin-top:auto">
                                <div style="font-size:28px;font-weight:600" id="tempValue">--°C</div>
                                <div style="font-size:12px;color:var(--muted-foreground)">Außentemperatur</div>
                            </div>
                        </div>
                    
                    <div class="widget">
                        <div style="display:flex;justify-content:space-between">
                            <i class="mdi mdi-puzzle" style="font-size:20px;color:var(--text-muted)"></i>
                        </div>
                        <div style="margin-top:auto">
                            <div style="font-size:28px;font-weight:600;color:var(--success)" id="sBlocks">0</div>
                            <div style="font-size:12px;color:var(--text-muted)">Logik-Bausteine</div>
                        </div>
                    </div>
                    
                    <!-- KNX Gateway Status -->
                    <div class="widget">
                        <div style="display:flex;justify-content:space-between">
                            <i class="mdi mdi-router-wireless" style="font-size:20px;color:var(--text-muted)"></i>
                        </div>
                        <div style="margin-top:auto">
                            <div style="font-size:18px;font-weight:600" id="gatewayStatus">●</div>
                            <div style="font-size:12px;color:var(--text-muted)" id="sGateway">Verbinde...</div>
                        </div>
                    </div>
                    
                    <!-- System Control Widget -->
                    <div class="widget">
                        <div style="display:flex;justify-content:space-between;align-items:center">
                            <i class="mdi mdi-cog" style="font-size:20px;color:var(--text-muted)"></i>
                            <span style="font-size:10px;color:var(--text-muted)" id="systemUptime">--</span>
                        </div>
                        <div style="margin-top:auto">
                            <div style="font-size:12px;color:var(--text-muted);margin-bottom:8px">System</div>
                            <button class="btn btn-warning btn-sm" style="width:100%" onclick="restartSystem()">
                                <i class="mdi mdi-restart"></i> Neustart
                            </button>
                        </div>
                    </div>
                    
                    <!-- Status Donut -->
                    <div class="widget">
                        <div class="widget-header" style="margin-bottom:8px">
                            <span class="widget-title">Status</span>
                        </div>
                        <div class="donut-widget">
                            <svg class="donut-svg" viewBox="0 0 42 42" id="statusDonut">
                                <circle cx="21" cy="21" r="15.9" fill="transparent" stroke="var(--border)" stroke-width="5"/>
                                <circle cx="21" cy="21" r="15.9" fill="transparent" stroke="var(--success)" stroke-width="5" 
                                    stroke-dasharray="75 25" stroke-dashoffset="25" id="donutActive"/>
                            </svg>
                            <div class="donut-legend">
                                <div class="donut-item"><div class="donut-color" style="background:var(--success)"></div><span id="legendActive">Aktiv: 0</span></div>
                                <div class="donut-item"><div class="donut-color" style="background:var(--border)"></div><span id="legendInactive">Ohne: 0</span></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Schnellzugriff Werte -->
                    <div class="widget widget-lg">
                        <div class="widget-header">
                            <span class="widget-title"><i class="mdi mdi-chart-line" style="color:var(--text-muted)"></i> Aktuelle Werte</span>
                            <div class="widget-actions">
                                <button onclick="loadAddresses()" title="Aktualisieren"><i class="mdi mdi-refresh"></i></button>
                            </div>
                        </div>
                        <div class="widget-body" id="quickValues">
                            <div style="color:var(--text-muted);text-align:center;padding:20px">
                                Werte werden automatisch angezeigt wenn KNX-Adressen vorhanden sind
                            </div>
                        </div>
                    </div>
                    
                    <!-- Telegramme -->
                    <div class="widget widget-lg">
                        <div class="widget-header">
                            <span class="widget-title"><i class="mdi mdi-antenna" style="color:var(--text-muted)"></i> Letzte Telegramme</span>
                            <div class="widget-actions">
                                <button onclick="loadTelegrams()" title="Aktualisieren"><i class="mdi mdi-refresh"></i></button>
                            </div>
                        </div>
                        <div class="widget-body" style="padding:0;max-height:250px;overflow-y:auto">
                            <table style="margin:0"><thead><tr><th>Zeit</th><th>Von</th><th>Nach</th><th>Wert</th></tr></thead><tbody id="telegramTable"><tr><td colspan="4" class="empty">Keine Telegramme</td></tr></tbody></table>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="page-visu" class="page">
                <div class="visu-toolbar">
                    <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
                        <select id="visuPageSelect" onchange="loadVisuPage(this.value)">
                            <option value="default">Standard-Seite</option>
                        </select>
                        <button class="btn btn-secondary" onclick="showModal('visuPageModal')">+ Seite</button>
                        <button class="btn btn-secondary" onclick="showPageSettings()">⚙️</button>
                        <div class="visu-size-btns">
                            <button class="btn btn-sm" onclick="setVisuSize(375,667)" title="iPhone">📱</button>
                            <button class="btn btn-sm" onclick="setVisuSize(768,1024)" title="Tablet">📲</button>
                            <button class="btn btn-sm" onclick="setVisuSize(1920,1080)" title="Desktop">🖥️</button>
                            <button class="btn btn-sm active" onclick="setVisuSize(0,0)" title="Voll">⛶</button>
                        </div>
                    </div>
                    <div style="display:flex;gap:8px;flex-wrap:wrap">
                        <button class="btn btn-purple" onclick="showAddVSEModal()">+ VSE Element</button>
                        <button class="btn btn-secondary" onclick="toggleVisuEdit()">✏️ Bearbeiten</button>
                        <button class="btn btn-secondary" onclick="showVisuLink()" title="Link für Handy/Tablet">📱 Link</button>
                        <button class="btn btn-secondary" onclick="toggleVisuTree()" title="Baumansicht ein/aus">🌳 Baum</button>
                        <button class="btn btn-success" onclick="openVisuFullscreen()">⛶ Vollbild</button>
                    </div>
                </div>
                <div id="visuBreadcrumb" class="visu-breadcrumb"></div>
                <div class="visu-layout">
                    <div class="visu-container" id="visuContainer">
                        <div class="visu-canvas" id="visuCanvas"></div>
                    </div>
                    <div class="visu-tree-panel" id="visuTreePanel">
                        <div class="visu-tree-header">
                            <span><i class="mdi mdi-file-tree"></i> Seitenstruktur</span>
                            <button class="btn btn-sm" onclick="toggleVisuTree()" title="Schließen">×</button>
                        </div>
                        <div class="visu-tree-content" id="visuTreeContent"></div>
                    </div>
                </div>
            </div>
            
            <div id="page-vse" class="page">
                <div class="widget" style="min-height:calc(100vh - 180px)">
                    <div class="widget-header">
                        <div>
                            <div style="font-weight:600;font-size:16px"><i class="mdi mdi-palette" style="color:var(--purple)"></i> Widget-Bibliothek</div>
                            <div class="widget-subtitle">Wiederverwendbare Widgets für die Visualisierung</div>
                        </div>
                        <div style="display:flex;gap:8px">
                            <input type="file" id="vseUploadInput" accept=".json,.yaml,.yml" style="display:none" onchange="uploadVSE(this.files[0])" multiple>
                            <button class="btn btn-secondary" onclick="showVseCreateModal()"><i class="mdi mdi-plus"></i> Neu erstellen</button>
                            <button class="btn btn-primary" onclick="document.getElementById('vseUploadInput').click()"><i class="mdi mdi-upload"></i> Hochladen</button>
                        </div>
                    </div>
                    
                    <!-- Stats & Filter -->
                    <div style="display:flex;gap:20px;padding:12px 0;border-bottom:1px solid var(--border);flex-wrap:wrap;align-items:center">
                        <div style="display:flex;align-items:center;gap:8px">
                            <i class="mdi mdi-widgets" style="color:var(--accent)"></i>
                            <span style="font-size:13px"><b id="vseCount">0</b> Widgets</span>
                        </div>
                        <div style="margin-left:auto;display:flex;gap:8px">
                            <input type="text" id="vseSearch" placeholder="🔍 Suchen..." style="width:200px" oninput="filterVSE()">
                            <select id="vseFilter" onchange="filterVSE()" style="width:120px">
                                <option value="all">Alle</option>
                                <option value="sensor">Sensor</option>
                                <option value="switch">Schalter</option>
                                <option value="other">Sonstige</option>
                            </select>
                            <button class="btn btn-sm btn-secondary" onclick="loadVSEElements()"><i class="mdi mdi-refresh"></i></button>
                        </div>
                    </div>
                    
                    <!-- Info Box -->
                    <div style="background:var(--sidebar);border-radius:8px;padding:12px;margin:12px 0;font-size:12px">
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
                            <i class="mdi mdi-information" style="color:var(--accent)"></i>
                            <b>Widget-System</b>
                        </div>
                        <div style="color:var(--text-muted)">
                            Erstelle wiederverwendbare Sensor Card Widgets mit konfigurierbaren Variablen und bedingter Formatierung.
                            Widgets können als JSON-Dateien exportiert und importiert werden.
                        </div>
                    </div>
                    
                    <!-- Version 2.0.0 Features -->
                    <div style="background:linear-gradient(135deg, rgba(88,166,255,0.1), rgba(163,113,247,0.1));border:1px solid var(--accent);border-radius:8px;padding:14px;margin:12px 0;font-size:12px">
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
                            <i class="mdi mdi-new-box" style="color:var(--accent);font-size:18px"></i>
                            <b style="color:var(--accent);font-size:13px">NEU in Version 2.0.0</b>
                        </div>
                        <div style="color:var(--text);line-height:1.6">
                            <b>✨ Erweiterte Features:</b><br>
                            • <b>Icon-Deckkraft</b> - Transparenz des Icons einstellbar (0-100%)<br>
                            • <b>Label-Deckkraft</b> - Transparenz der Beschriftung einstellbar (0-100%)<br>
                            • <b>Wert-Deckkraft</b> - Transparenz der Wertanzeige einstellbar (0-100%)<br>
                            • <b>Bedingte Formatierung erweitert</b> - Icon-Deckkraft, Label- & Wert-Farbe änderbar bei Bedingungen<br>
                            • <b>Auto-Refresh</b> - Logikbausteine aktualisieren sich automatisch
                        </div>
                    </div>
                    
                    <!-- VSE Grid -->
                    <div id="vseList" class="vse-grid" style="margin-top:12px"></div>
                </div>
            </div>
            
            <div id="page-addresses" class="page">
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">KNX Gruppenadressen</span>
                        <div style="display:flex;gap:8px;align-items:center">
                            <input type="text" id="searchAddr" placeholder="🔍 Suchen..." style="width:200px" oninput="renderAddr()">
                            <button id="deleteSelectedBtn" class="btn btn-danger" style="display:none" onclick="deleteSelectedAddrs()">🗑 Ausgewählte löschen</button>
                        </div>
                    </div>
                    <div class="card-body" style="padding:0"><table><thead><tr><th style="width:30px"><input type="checkbox" onchange="toggleAllAddrs(this.checked)" title="Alle auswählen"></th><th>Adresse</th><th>Name</th><th>DPT</th><th>Wert</th><th>Zuletzt</th><th>Aktionen</th></tr></thead><tbody id="addrTable"></tbody></table></div>
                </div>
            </div>
            
            <div id="page-internal" class="page">
                <div class="widget" style="min-height:calc(100vh - 180px)">
                    <div class="widget-header">
                        <div>
                            <div style="font-weight:600;font-size:16px">Interne Kommunikationsobjekte (IKO)</div>
                            <div class="widget-subtitle">Virtuelle Adressen für interne Logik-Verknüpfungen</div>
                        </div>
                        <div style="display:flex;gap:8px">
                            <button class="btn btn-secondary" onclick="showIkoFromBlockModal()"><i class="mdi mdi-puzzle-plus"></i> Aus Baustein</button>
                            <button class="btn btn-primary" onclick="showModal('intModal')"><i class="mdi mdi-plus"></i> Neue IKO</button>
                        </div>
                    </div>
                    
                    <!-- Stats Row -->
                    <div style="display:flex;gap:20px;padding:12px 0;border-bottom:1px solid var(--border);flex-wrap:wrap">
                        <div style="display:flex;align-items:center;gap:8px">
                            <i class="mdi mdi-link-variant" style="color:var(--purple)"></i>
                            <span style="font-size:13px"><b id="ikoCount">0</b> IKOs gesamt</span>
                        </div>
                        <div style="display:flex;align-items:center;gap:8px">
                            <i class="mdi mdi-folder-multiple" style="color:var(--accent)"></i>
                            <span style="font-size:13px"><b id="ikoGroupCount">0</b> Gruppen</span>
                        </div>
                        <div style="display:flex;align-items:center;gap:8px">
                            <i class="mdi mdi-check-circle" style="color:var(--success)"></i>
                            <span style="font-size:13px"><b id="ikoWithValue">0</b> mit Wert</span>
                        </div>
                        <div style="margin-left:auto;display:flex;gap:4px;flex-wrap:wrap">
                            <button class="btn btn-sm btn-secondary" onclick="toggleAllGroups(true)"><i class="mdi mdi-unfold-more-horizontal"></i> Alle öffnen</button>
                            <button class="btn btn-sm btn-secondary" onclick="toggleAllGroups(false)"><i class="mdi mdi-unfold-less-horizontal"></i> Alle schließen</button>
                            <button class="btn btn-sm btn-secondary" onclick="loadInternal()"><i class="mdi mdi-refresh"></i></button>
                        </div>
                    </div>
                    
                    <!-- IKO Groups List -->
                    <div id="ikoGroupList" style="flex:1;overflow-y:auto;margin-top:12px">
                        <div style="color:var(--text-muted);text-align:center;padding:40px">
                            Keine IKOs vorhanden. Klicke auf "+ Neue IKO" oder "Aus Baustein" um welche anzulegen.
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="page-logic" class="page">
                <div class="card" style="display:flex;flex-direction:column;height:calc(100vh - 180px)">
                    <div class="card-header">
                        <span class="card-title">🧩 Logik-Editor</span>
                        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
                            <select id="blockType" style="width:200px"></select>
                            <button class="btn btn-success" onclick="addBlock()">+ Baustein</button>
                            <button class="btn btn-secondary" onclick="showModal('pageModal')">📄 Seite</button>
                            <span style="color:var(--text-muted);font-size:11px;margin-left:8px">Ziehe am Header um zu verschieben</span>
                        </div>
                    </div>
                    <div class="tabs" id="pagesTabs" style="padding:0 16px"></div>
                    <div class="logic-wrapper">
                        <div class="logic-main logic-canvas logic-canvas-grid" id="logicBlocksContainer">
                            <svg id="wiresCanvas" class="wire-svg"></svg>
                        </div>
                        <div class="logic-props" id="logicPropsPanel">
                            <div class="logic-props-header">
                                <h3>× Eigenschaften</h3>
                                <button class="btn btn-sm" onclick="closePropsPanel()">×</button>
                            </div>
                            <div class="logic-props-body">
                                <div id="propsContent">
                                    <div style="color:var(--text-muted);text-align:center;padding:40px">
                                        Klicke auf einen Baustein um seine Eigenschaften anzuzeigen
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="page-blocks" class="page">
                <div class="card">
                    <div class="card-header"><span class="card-title">📦 Verfügbare Bausteintypen</span></div>
                    <div class="card-body" style="padding:0"><table><thead><tr><th>ID</th><th>Name</th><th>Kategorie</th><th>Beschreibung</th><th>E/A</th></tr></thead><tbody id="blockTypeTable"></tbody></table></div>
                </div>
            </div>
            
            <div id="page-code" class="page">
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">💻 Eigene Bausteine</span>
                        <div style="display:flex;gap:8px">
                            <button class="btn btn-primary" onclick="document.getElementById('blockUpload').click()">📤 Hochladen</button>
                            <button class="btn btn-success" onclick="newBlockFile()">+ Neuer Baustein</button>
                        </div>
                        <input type="file" id="blockUpload" accept=".py" style="display:none" onchange="uploadBlock()">
                    </div>
                    <div class="card-body" style="padding:0"><table><thead><tr><th>Datei</th><th>Aktionen</th></tr></thead><tbody id="filesTable"></tbody></table></div>
                </div>
            </div>
            
            <!-- SETTINGS PAGE -->
            <div id="page-settings" class="page">
                <div class="card">
                    <div class="card-header"><span class="card-title">⚙️ KNX Gateway Einstellungen</span></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Gateway IP-Adresse</label>
                            <input type="text" id="settingsGatewayIp" placeholder="z.B. 192.168.1.10">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Gateway Port</label>
                            <input type="number" id="settingsGatewayPort" value="3671" placeholder="3671">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Verbindungsmodus</label>
                            <select id="settingsMode">
                                <option value="tunneling">Tunneling (Standard)</option>
                                <option value="routing">Routing (Multicast)</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="saveSettings()">💾 Speichern & Verbinden</button>
                        <div class="info-box">
                            <h4>Hinweis</h4>
                            <p style="color:var(--text-muted)">Nach dem Speichern wird die Verbindung zum Gateway neu aufgebaut. Die aktuelle Gateway-IP wird oben im Dashboard angezeigt.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="page-import" class="page">
                <div class="card">
                    <div class="card-header"><span class="card-title">📤 ESF / knxproj / CSV Import</span></div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Projekt-Passwort (nur für verschlüsselte knxproj)</label>
                            <input type="password" id="importPassword" placeholder="Leer lassen wenn nicht verschlüsselt">
                        </div>
                        <div class="upload-zone" onclick="document.getElementById('esfFile').click()">
                            <input type="file" id="esfFile" accept=".esf,.knxproj,.csv" onchange="uploadEsf()">
                            <div style="font-size:32px;margin-bottom:12px">📁</div>
                            <div>ESF, knxproj oder CSV Datei hochladen</div>
                            <div style="color:var(--text-muted);font-size:11px;margin-top:8px">Vorhandene Adressen werden aktualisiert (nicht dupliziert)</div>
                        </div>
                    </div>
                </div>
                
                <div class="card" style="margin-top:16px">
                    <div class="card-header"><span class="card-title">💾 Backup & Restore</span></div>
                    <div class="card-body">
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
                            <div class="info-box">
                                <h4>📥 Backup erstellen</h4>
                                <p style="color:var(--text-muted);margin-bottom:12px">Speichert alle Adressen, Bausteine, Einstellungen und Bindings.</p>
                                <button class="btn btn-primary" onclick="downloadBackup()">💾 Backup herunterladen</button>
                            </div>
                            <div class="info-box">
                                <h4>📤 Backup wiederherstellen</h4>
                                <p style="color:var(--text-muted);margin-bottom:12px">Stellt alle Einstellungen aus einem Backup wieder her.</p>
                                <input type="file" id="backupFile" accept=".json" style="display:none" onchange="uploadBackup()">
                                <button class="btn btn-warning" onclick="document.getElementById('backupFile').click()">📤 Backup laden</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="page-update" class="page">
                <div class="widget" style="max-width:800px">
                    <div class="widget-header">
                        <div>
                            <div style="font-weight:600;font-size:16px"><i class="mdi mdi-update" style="color:var(--accent)"></i> System-Update</div>
                            <div class="widget-subtitle">Aktualisiere das KNX Automation System</div>
                        </div>
                    </div>
                    
                    <div class="upload-zone" onclick="document.getElementById('updateFile').click()" style="margin:16px 0">
                        <input type="file" id="updateFile" accept=".tar.gz,.tgz" onchange="uploadUpdate()">
                        <i class="mdi mdi-cloud-upload" style="font-size:48px;color:var(--accent);margin-bottom:12px"></i>
                        <div style="font-size:14px;font-weight:600;margin-bottom:4px">Update-Paket hochladen</div>
                        <div style="font-size:12px;color:var(--text-muted)">.tar.gz Datei hierher ziehen oder klicken</div>
                    </div>
                    
                    <div id="updateProgress" style="display:none;margin:16px 0">
                        <div style="display:flex;justify-content:space-between;margin-bottom:6px">
                            <span style="font-size:12px">Upload läuft...</span>
                            <span style="font-size:12px" id="updatePercent">0%</span>
                        </div>
                        <div class="progress-box">
                            <div class="progress-bar" id="updateProgressBar" style="width:0%"></div>
                        </div>
                    </div>
                    
                    <div style="background:var(--bg);border-radius:8px;padding:16px;margin-top:16px">
                        <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
                            <i class="mdi mdi-information" style="font-size:20px;color:var(--accent)"></i>
                            <span style="font-weight:600">Hinweise</span>
                        </div>
                        <ul style="margin:0;padding-left:20px;font-size:13px;color:var(--text-muted);line-height:1.8">
                            <li>Das Update-Paket muss eine <code>.tar.gz</code> Datei sein</li>
                            <li>Nach dem Upload wird das System automatisch aktualisiert</li>
                            <li>Ein Neustart ist nach dem Update erforderlich</li>
                            <li>Bestehende Konfigurationen bleiben erhalten</li>
                        </ul>
                    </div>
                    
                    <div style="display:flex;gap:12px;margin-top:20px;padding-top:16px;border-top:1px solid var(--border)">
                        <button class="btn btn-warning" onclick="restartSystem()" style="flex:1">
                            <i class="mdi mdi-restart"></i> System neustarten
                        </button>
                        <button class="btn btn-secondary" onclick="checkVersion()" style="flex:1">
                            <i class="mdi mdi-information"></i> Version prüfen
                        </button>
                    </div>
                    
                    <div id="versionInfo" style="margin-top:16px;padding:12px;background:var(--sidebar);border-radius:8px;display:none">
                        <div style="display:flex;justify-content:space-between;font-size:13px">
                            <span>Installierte Version:</span>
                            <span id="currentVersion" style="font-weight:600;color:var(--success)">--</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="page-logs" class="page">
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">📜 System Logs</span>
                        <div style="display:flex;gap:8px;align-items:center">
                            <select id="logLevel" style="width:100px" onchange="loadLogs()">
                                <option value="">Alle</option>
                                <option value="DEBUG">DEBUG</option>
                                <option value="INFO">INFO</option>
                                <option value="WARNING">WARNING</option>
                                <option value="ERROR">ERROR</option>
                            </select>
                            <button class="btn btn-sm btn-secondary" onclick="loadLogs()">🔄</button>
                        </div>
                    </div>
                    <div class="card-body" style="max-height:500px;overflow-y:auto;padding:0">
                        <div id="logContainer"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <div class="modal" id="intModal"><div class="modal-content"><div class="modal-header"><span class="modal-title">Neue IKO erstellen</span><button class="modal-close" onclick="hideModal('intModal')">×</button></div><div class="modal-body"><div class="form-group"><label class="form-label">Adresse</label><input id="intAddr" placeholder="z.B. INT/wetter/temp"></div><div class="form-group"><label class="form-label">Name</label><input id="intName" placeholder="Beschreibung"></div><div class="form-group"><label class="form-label">DPT (optional)</label><input id="intDpt" placeholder="z.B. 9.001"></div><div class="form-group"><label class="form-label">Initial-Wert (optional)</label><input id="intInitial" placeholder="Startwert beim Systemstart"></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="hideModal('intModal')">Abbrechen</button><button class="btn btn-primary" onclick="addInt()">Erstellen</button></div></div></div>
    
    <div class="modal" id="ikoValueModal"><div class="modal-content"><div class="modal-header"><span class="modal-title" id="ikoValueTitle">Wert setzen</span><button class="modal-close" onclick="hideModal('ikoValueModal')">×</button></div><div class="modal-body"><input type="hidden" id="ikoValueAddr"><div class="form-group"><label class="form-label">Neuer Wert</label><input id="ikoValueInput" placeholder="Wert eingeben" autofocus></div><div style="font-size:11px;color:var(--text-muted);margin-top:8px"><i class="mdi mdi-information"></i> Der Wert wird sofort an alle verbundenen Bausteine weitergeleitet.</div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="hideModal('ikoValueModal')">Abbrechen</button><button class="btn btn-primary" onclick="saveIkoValue()"><i class="mdi mdi-content-save"></i> Speichern</button></div></div></div>
    
    <div class="modal" id="ikoInitialModal"><div class="modal-content"><div class="modal-header"><span class="modal-title" id="ikoInitialTitle">Initial-Wert</span><button class="modal-close" onclick="hideModal('ikoInitialModal')">×</button></div><div class="modal-body"><input type="hidden" id="ikoInitialAddr"><div class="form-group"><label class="form-label">Initial-Wert</label><input id="ikoInitialInput" placeholder="Wert beim Systemstart"></div><div style="font-size:11px;color:var(--text-muted);margin-top:8px"><i class="mdi mdi-information"></i> Dieser Wert wird beim Neustart des Systems automatisch gesetzt. Leer lassen um keinen Initial-Wert zu verwenden.</div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="hideModal('ikoInitialModal')">Abbrechen</button><button class="btn btn-primary" onclick="saveIkoInitial()"><i class="mdi mdi-restart"></i> Speichern</button></div></div></div>
    
    <div class="modal" id="ikoFromBlockModal"><div class="modal-content"><div class="modal-header"><span class="modal-title"><i class="mdi mdi-puzzle-plus"></i> IKOs aus Baustein erstellen</span><button class="modal-close" onclick="hideModal('ikoFromBlockModal')">×</button></div><div class="modal-body">
        <div class="form-group"><label class="form-label">Bausteintyp auswählen</label><select id="ikoBlockType" onchange="previewBlockIkos()"><option value="">-- Baustein wählen --</option></select></div>
        <div class="form-group"><label class="form-label">Gruppen-Name</label>
            <div style="display:flex;align-items:center;gap:4px">
                <span style="background:var(--sidebar);padding:8px 12px;border-radius:6px;font-family:monospace;color:var(--purple)">INT/</span>
                <input id="ikoGroupPrefix" placeholder="z.B. wetter" oninput="previewBlockIkos()" style="flex:1">
            </div>
            <div style="font-size:10px;color:var(--text-muted);margin-top:4px">Alle IKOs werden in einer Gruppe erstellt: INT/name/E1, INT/name/A1, ...</div>
        </div>
        <div class="form-group"><label class="form-label">Vorschau</label><div id="ikoBlockPreview" style="background:var(--bg);border-radius:8px;padding:12px;max-height:250px;overflow-y:auto;font-size:12px"><span style="color:var(--text-muted)">Wähle einen Baustein und gib einen Gruppen-Namen ein</span></div></div>
        <div class="form-group"><label class="form-label" style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="ikoCreateInputs" checked style="width:auto"> Eingänge erstellen</label></div>
        <div class="form-group"><label class="form-label" style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="ikoCreateOutputs" checked style="width:auto"> Ausgänge erstellen</label></div>
    </div><div class="modal-footer"><button class="btn btn-secondary" onclick="hideModal('ikoFromBlockModal')">Abbrechen</button><button class="btn btn-primary" onclick="createIkosFromBlock()"><i class="mdi mdi-plus"></i> IKOs erstellen</button></div></div></div>
    
    <div class="modal" id="pageModal"><div class="modal-content"><div class="modal-header"><span class="modal-title">Neue Logik-Seite erstellen</span><button class="modal-close" onclick="hideModal('pageModal')">×</button></div><div class="modal-body"><div class="modal-error" id="pageModalError"></div><div class="form-group"><label class="form-label">Seitenname</label><input id="pageName" placeholder="z.B. Wetter, Heizung..."></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="hideModal('pageModal')">Abbrechen</button><button class="btn btn-primary" onclick="addPage()">Erstellen</button></div></div></div>
    
    <div class="modal" id="codeModal"><div class="modal-content wide"><div class="modal-header"><span class="modal-title">Code: <span id="codeFileName"></span></span><button class="modal-close" onclick="hideModal('codeModal')">×</button></div><div class="modal-body"><textarea id="codeEditor" rows="25"></textarea></div><div class="modal-footer"><button class="btn btn-secondary" onclick="hideModal('codeModal')">Abbrechen</button><button class="btn btn-success" onclick="saveCode()">💾 Speichern</button></div></div></div>
    
    <div class="modal" id="debugModal"><div class="modal-content wide"><div class="modal-header"><span class="modal-title">🔍 Debug Info</span><button class="modal-close" onclick="hideModal('debugModal')">×</button></div><div class="modal-body"><textarea id="debugContent" rows="20" readonly></textarea></div><div class="modal-footer"><button class="btn btn-secondary" onclick="hideModal('debugModal')">Schließen</button></div></div></div>
    
    <div class="modal" id="bindModal"><div class="modal-content wide"><div class="modal-header"><span class="modal-title">🔗 Verbindung bearbeiten</span><button class="modal-close" onclick="hideModal('bindModal')">×</button></div><div class="modal-body"><div class="modal-error" id="bindModalError"></div><div id="bindContent"></div></div></div></div>
    
    <div class="modal" id="editAddrModal"><div class="modal-content"><div class="modal-header"><span class="modal-title">✏️ Adresse bearbeiten</span><button class="modal-close" onclick="hideModal('editAddrModal')">×</button></div><div class="modal-body"><div class="modal-error" id="editAddrError"></div><input type="hidden" id="editAddrOrig"><div class="form-group"><label class="form-label">Adresse (nur lesen)</label><input id="editAddrAddr" readonly style="background:#333"></div><div class="form-group"><label class="form-label">Name</label><input id="editAddrName" placeholder="Beschreibung"></div><div class="form-group"><label class="form-label">DPT</label><input id="editAddrDpt" placeholder="z.B. 1.001, 9.001, 14.056"></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="hideModal('editAddrModal')">Abbrechen</button><button class="btn btn-primary" onclick="saveAddr()">💾 Speichern</button></div></div></div>
    
    <div class="modal" id="valueModal"><div class="modal-content"><div class="modal-header"><span class="modal-title">📋 Wert Details</span><button class="modal-close" onclick="hideModal('valueModal')">×</button></div><div class="modal-body"><div class="form-group"><label class="form-label" id="valueModalLabel">E1: Name</label><textarea id="valueModalContent" rows="8" readonly style="font-family:monospace;font-size:12px;background:#1a1a2e;color:#fff;border:1px solid var(--border)"></textarea></div></div><div class="modal-footer"><button class="btn btn-primary" onclick="copyValueToClipboard()">📋 Kopieren</button><button class="btn btn-secondary" onclick="hideModal('valueModal')">Schließen</button></div></div></div>
    
    <div class="modal" id="visuWidgetModal"><div class="modal-content"><div class="modal-header"><span class="modal-title">+ Widget hinzufügen</span><button class="modal-close" onclick="hideModal('visuWidgetModal')">×</button></div><div class="modal-body">
        <div class="form-group"><label class="form-label">Widget-Typ</label>
            <select id="visuWidgetType" onchange="updateVisuWidgetForm()">
                <option value="switch">💡 Schalter</option>
                <option value="dimmer">🔆 Dimmer</option>
                <option value="value">🌡️ Wert-Anzeige</option>
                <option value="shutter">🪟 Jalousie</option>
                <option value="scene">🎬 Szene</option>
                <option value="clock">🕐 Uhr</option>
                <option value="label">📝 Text/Label</option>
                <option value="navlink">🔗 Seiten-Link</option>
                <option value="navmenu">📂 Navigation</option>
            </select>
        </div>
        <div class="form-group"><label class="form-label">Bezeichnung</label><input id="visuWidgetLabel" placeholder="z.B. Wohnzimmer Licht"></div>
        <div id="visuWidgetFields"></div>
    </div><div class="modal-footer"><button class="btn btn-secondary" onclick="hideModal('visuWidgetModal')">Abbrechen</button><button class="btn btn-primary" onclick="addVisuWidget()">Hinzufügen</button></div></div></div>
    
    <div class="modal" id="visuPageModal"><div class="modal-content"><div class="modal-header"><span class="modal-title">+ Visu-Seite erstellen</span><button class="modal-close" onclick="hideModal('visuPageModal')">×</button></div><div class="modal-body">
        <div class="form-group"><label class="form-label">Seitenname</label><input id="visuPageName" placeholder="z.B. Erdgeschoss"></div>
        <div class="form-group"><label class="form-label">Größe</label>
            <select id="visuPageSize">
                <option value="full">Volle Größe (responsiv)</option>
                <option value="phone">Smartphone (375×667)</option>
                <option value="tablet">Tablet (768×1024)</option>
                <option value="desktop">Desktop (1920×1080)</option>
            </select>
        </div>
    </div><div class="modal-footer"><button class="btn btn-secondary" onclick="hideModal('visuPageModal')">Abbrechen</button><button class="btn btn-primary" onclick="createVisuPage()">Erstellen</button></div></div></div>
    
    <div class="modal" id="visuEditModal"><div class="modal-content wide"><div class="modal-header"><span class="modal-title"><i class="mdi mdi-pencil"></i> Widget bearbeiten</span><button class="modal-close" onclick="hideModal('visuEditModal')">×</button></div><div class="modal-body"><div id="visuEditFields"></div></div><div class="modal-footer"><button class="btn btn-danger" onclick="deleteVisuWidget()" style="margin-right:auto"><i class="mdi mdi-delete"></i> Löschen</button><button class="btn btn-secondary" onclick="hideModal('visuEditModal')">Abbrechen</button><button class="btn btn-primary" onclick="saveVisuWidget()"><i class="mdi mdi-content-save"></i> Speichern</button></div></div></div>
    
    <div class="modal" id="visuPageSettingsModal"><div class="modal-content"><div class="modal-header"><span class="modal-title">⚙️ Seiten-Einstellungen</span><button class="modal-close" onclick="hideModal('visuPageSettingsModal')">×</button></div><div class="modal-body">
        <div class="form-group"><label class="form-label">Seitenname</label><input id="pageSettingsName" placeholder="Seitenname"></div>
        <div class="form-group"><label class="form-label">Übergeordnete Seite (Baumstruktur)</label>
            <select id="pageSettingsParent">
                <option value="">-- Keine (Hauptseite) --</option>
            </select>
            <div style="font-size:10px;color:var(--text-muted);margin-top:4px">Wähle eine übergeordnete Seite für die Baumstruktur</div>
        </div>
        <div class="form-group"><label class="form-label">Seiten-Icon (MDI Name)</label>
            <div style="display:flex;gap:8px;align-items:center">
                <span class="mdi mdi-home" id="pageIconPreview" style="font-size:24px;color:var(--accent)"></span>
                <input id="pageSettingsIcon" placeholder="z.B. home, floor-plan, lightbulb" value="home" oninput="document.getElementById('pageIconPreview').className='mdi mdi-'+this.value" style="flex:1">
            </div>
            <div style="font-size:10px;color:var(--text-muted);margin-top:4px">Icons: <a href="https://pictogrammers.com/library/mdi/" target="_blank">MDI Icons</a> (z.B. home, sofa, bed, shower, car)</div>
        </div>
        <div class="form-group"><label class="form-label">Hintergrundfarbe</label>
            <div style="display:flex;gap:8px;align-items:center">
                <input type="color" id="pageSettingsBgColor" value="#1a1a2e" style="width:60px;height:36px;border:none;cursor:pointer">
                <input id="pageSettingsBgColorText" value="#1a1a2e" style="width:100px" oninput="document.getElementById('pageSettingsBgColor').value=this.value">
                <button class="btn btn-sm" onclick="document.getElementById('pageSettingsBgColor').value='#1a1a2e';document.getElementById('pageSettingsBgColorText').value='#1a1a2e'">Reset</button>
            </div>
        </div>
        <div class="form-group"><label class="form-label">Vordefinierte Farben</label>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
                <button class="btn btn-sm" style="background:#1a1a2e" onclick="setPageBgColor('#1a1a2e')">Dunkel</button>
                <button class="btn btn-sm" style="background:#0d1117" onclick="setPageBgColor('#0d1117')">GitHub</button>
                <button class="btn btn-sm" style="background:#1e1e1e" onclick="setPageBgColor('#1e1e1e')">VSCode</button>
                <button class="btn btn-sm" style="background:#2d2d2d" onclick="setPageBgColor('#2d2d2d')">Grau</button>
                <button class="btn btn-sm" style="background:#0a192f" onclick="setPageBgColor('#0a192f')">Navy</button>
                <button class="btn btn-sm" style="background:#1a1a1a" onclick="setPageBgColor('#1a1a1a')">EDOMI</button>
            </div>
        </div>
        <div class="form-group"><label class="form-label">Größe</label>
            <select id="pageSettingsSize" onchange="toggleCustomSize()">
                <option value="full">Volle Größe</option>
                <option value="phone">Smartphone (375×667)</option>
                <option value="tablet">Tablet (768×1024)</option>
                <option value="desktop">Desktop (1920×1080)</option>
                <option value="custom">Benutzerdefiniert</option>
            </select>
        </div>
        <div class="form-group" id="customSizeGroup" style="display:none">
            <label class="form-label">Benutzerdefinierte Größe (Pixel)</label>
            <div style="display:flex;gap:8px;align-items:center">
                <input type="number" id="pageSettingsWidth" placeholder="Breite" style="width:100px" value="1024">
                <span>×</span>
                <input type="number" id="pageSettingsHeight" placeholder="Höhe" style="width:100px" value="768">
            </div>
        </div>
        <div class="form-group"><label class="form-label">Hintergrundbild (URL)</label>
            <input id="pageSettingsBgImage" placeholder="https://... oder /data/images/hintergrund.jpg">
            <div style="font-size:10px;color:var(--text-muted);margin-top:4px">Leer lassen für kein Bild. Unterstützt: URL oder lokaler Pfad</div>
        </div>
        <div class="form-group"><label class="form-label">Bild-Stil</label>
            <select id="pageSettingsBgSize">
                <option value="cover">Ausfüllen (cover)</option>
                <option value="contain">Einpassen (contain)</option>
                <option value="100% 100%">Strecken</option>
                <option value="repeat">Kacheln</option>
            </select>
        </div>
    </div><div class="modal-footer"><button class="btn btn-danger" onclick="deleteVisuPage()" style="margin-right:auto">🗑 Seite löschen</button><button class="btn btn-secondary" onclick="hideModal('visuPageSettingsModal')">Abbrechen</button><button class="btn btn-primary" onclick="savePageSettings()">Speichern</button></div></div></div>
    
    <div class="modal" id="visuVSEModal"><div class="modal-content wide"><div class="modal-header"><span class="modal-title">+ VSE Element hinzufügen</span><button class="modal-close" onclick="hideModal('visuVSEModal')">×</button></div><div class="modal-body">
        <div id="vseSelectGrid" class="vse-grid" style="max-height:400px;overflow-y:auto"></div>
        <div id="vseConfigPanel" style="display:none;margin-top:16px;padding-top:16px;border-top:1px solid var(--border)">
            <h4 style="margin-bottom:12px">Konfiguration: <span id="vseConfigName"></span></h4>
            <div class="form-group"><label class="form-label">Text/Label</label><input id="vseConfigText" placeholder="Beschriftung"></div>
            <div class="form-group"><label class="form-label">KO1 (Wert-Adresse)</label>
                <select id="vseConfigKO1"><option value="">-- Keine --</option></select>
            </div>
            <div id="vseConfigVars"></div>
        </div>
    </div><div class="modal-footer"><button class="btn btn-secondary" onclick="hideModal('visuVSEModal')">Abbrechen</button><button class="btn btn-primary" onclick="addVSEWidget()" id="vseAddBtn" disabled>Hinzufügen</button></div></div></div>
    
    <!-- VSE Create/Edit Modal -->
    <div class="modal" id="vseCreateModal"><div class="modal-content wide"><div class="modal-header"><span class="modal-title" id="vseModalTitle"><i class="mdi mdi-palette"></i> Widget erstellen</span><button class="modal-close" onclick="hideModal('vseCreateModal')">×</button></div><div class="modal-body">
        <input type="hidden" id="vseEditMode" value="">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
            <!-- Left Column: Basic Settings -->
            <div>
                <h4 style="margin:0 0 12px 0;color:var(--accent)"><i class="mdi mdi-information"></i> Grundeinstellungen</h4>
                <div class="form-group"><label class="form-label">Name *</label><input id="vseCreateName" placeholder="z.B. Temperatur Sensor"></div>
                <div class="form-group"><label class="form-label">ID (eindeutig) *</label><input id="vseCreateId" placeholder="z.B. temp_sensor_v1"></div>
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
                    <div class="form-group"><label class="form-label">Kategorie</label>
                        <select id="vseCreateCategory">
                            <option value="sensor">🌡️ Sensor</option>
                        </select>
                    </div>
                    <div class="form-group"><label class="form-label">Breite</label><input type="number" id="vseCreateWidth" value="200"></div>
                    <div class="form-group"><label class="form-label">Höhe</label><input type="number" id="vseCreateHeight" value="100"></div>
                </div>
                <div class="form-group"><label class="form-label">Render-Typ</label>
                    <select id="vseCreateRender" onchange="updateVseRenderHelp()">
                        <option value="sensorCard">Sensor Card (Wert mit Icon)</option>
                    </select>
                    <div id="vseRenderHelp" style="font-size:10px;color:var(--text-muted);margin-top:4px"></div>
                </div>
                <div class="form-group"><label class="form-label">Beschreibung</label><textarea id="vseCreateDesc" rows="2" placeholder="Kurze Beschreibung des Widgets..."></textarea></div>
            </div>
            
            <!-- Right Column: Variables -->
            <div>
                <h4 style="margin:0 0 12px 0;color:var(--purple)"><i class="mdi mdi-variable"></i> Variablen <button class="btn btn-sm btn-secondary" onclick="addVseVariable()" style="float:right"><i class="mdi mdi-plus"></i> Hinzufügen</button></h4>
                <div id="vseVarList" style="max-height:280px;overflow-y:auto">
                    <!-- Variable rows will be added here -->
                </div>
                <div style="margin-top:12px;padding:10px;background:var(--sidebar);border-radius:8px;font-size:11px;color:var(--text-muted)">
                    <b>Verfügbare Typen:</b> text, number, color, icon, bool, select<br>
                    <b>Spezielle Variablen:</b> {{value}} = aktueller KO-Wert
                </div>
            </div>
        </div>
        
        <!-- Conditions Section (for sensorCard) -->
        <div id="vseConditionsSection" style="margin-top:20px;display:none">
            <h4 style="margin:0 0 12px 0;color:var(--warning)"><i class="mdi mdi-code-braces"></i> Bedingte Formatierung</h4>
            <div id="vseCondList">
                <!-- Condition rows will be added here -->
            </div>
            <button class="btn btn-sm btn-secondary" onclick="addVseCondition()"><i class="mdi mdi-plus"></i> Bedingung hinzufügen</button>
        </div>
        
        <!-- Custom HTML/CSS Section -->
        <div id="vseCustomSection" style="margin-top:20px;display:none">
            <h4 style="margin:0 0 12px 0;color:var(--success)"><i class="mdi mdi-code-tags"></i> Custom Template</h4>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
                <div class="form-group"><label class="form-label">HTML</label>
                    <textarea id="vseCreateHtml" rows="8" style="font-family:monospace;font-size:12px" placeholder='<div class="widget">
  <i class="mdi mdi-{{icon}}"></i>
  <span class="label">{{label}}</span>
  <span class="value">{{value}} {{unit}}</span>
</div>'></textarea>
                </div>
                <div class="form-group"><label class="form-label">CSS</label>
                    <textarea id="vseCreateCss" rows="8" style="font-family:monospace;font-size:12px" placeholder='.widget { 
  display: flex; 
  align-items: center;
  gap: 12px;
  padding: 12px;
  background: rgba(255,255,255,0.06);
  border-radius: 12px;
}'></textarea>
                </div>
            </div>
        </div>
        
        <!-- Preview -->
        <div style="margin-top:20px">
            <h4 style="margin:0 0 12px 0;color:var(--text-muted)"><i class="mdi mdi-eye"></i> Vorschau</h4>
            <div id="vsePreview" style="background:var(--bg);border:1px solid var(--border);border-radius:12px;padding:20px;min-height:80px;display:flex;align-items:center;justify-content:center">
                <span style="color:var(--text-muted)">Vorschau wird nach Eingabe generiert...</span>
            </div>
        </div>
    </div><div class="modal-footer">
        <button class="btn btn-danger" id="vseDeleteBtn" onclick="deleteVSEElement()" style="margin-right:auto;display:none"><i class="mdi mdi-delete"></i> Löschen</button>
        <button class="btn btn-secondary" onclick="hideModal('vseCreateModal')">Abbrechen</button>
        <button class="btn btn-accent" onclick="previewVSEElement()"><i class="mdi mdi-eye"></i> Vorschau</button>
        <button class="btn btn-primary" onclick="saveVSEElement()"><i class="mdi mdi-content-save"></i> Speichern</button>
    </div></div></div>
    
            </main>
        </div>
    </div>
    
    <datalist id="addr-list"></datalist>
    
<script>
// Theme handling - restore before page renders
(function(){
    const saved=localStorage.getItem('knx-theme');
    if(saved==='light')document.documentElement.classList.add('light');
})();

function toggleTheme(){
    const root=document.documentElement;
    const isLight=root.classList.toggle('light');
    localStorage.setItem('knx-theme',isLight?'light':'dark');
}

function toggleSidebar(){
    const sidebar = document.getElementById('sidebar');
    sidebar.classList.toggle('collapsed');
    const isCollapsed = sidebar.classList.contains('collapsed');
    localStorage.setItem('sidebar-collapsed', isCollapsed ? 'true' : 'false');
}

// Initialize sidebar state from localStorage
document.addEventListener('DOMContentLoaded', () => {
    const isCollapsed = localStorage.getItem('sidebar-collapsed') === 'true';
    if(isCollapsed) {
        document.getElementById('sidebar')?.classList.add('collapsed');
    }
});

const API='/api/v1';
let addresses=[],internalAddrs=[],allAddresses=[],blocks=[],availBlocks=[],pages=[],currentPage='default';
let blockPositions={};

// ========== VISU SYSTEM ==========
let visuPages={default:{id:'default',name:'Standard',size:'full',widgets:[]}};
let currentVisuPage='default';
let visuEditMode=false;
let visuDragEl=null,visuDragOff={x:0,y:0};
let currentEditWidget=null;
let selectedBlock=null;

function getErrMsg(e){
    if(!e)return'Unbekannter Fehler';
    if(typeof e==='string')return e;
    if(e instanceof Error)return e.message;
    if(e.detail){
        if(typeof e.detail==='string')return e.detail;
        if(Array.isArray(e.detail)&&e.detail[0]?.msg)return e.detail[0].loc?.join('.')+': '+e.detail[0].msg;
        if(e.detail.msg)return e.detail.msg;
        return JSON.stringify(e.detail);
    }
    if(e.message)return String(e.message);
    return JSON.stringify(e);
}

// Global polling control
let pollingPaused = false;
function isModalOpen() {
    return document.querySelector('.modal.show') !== null;
}

document.addEventListener('DOMContentLoaded',async()=>{
    await loadAll();
    
    // Polling - pause when any modal is open (longer interval to reduce load)
    setInterval(()=>{
        // Don't poll if a modal is open or polling is paused
        if(isModalOpen() || pollingPaused) return;
        loadStatus();
        loadTelegrams();
        loadBlocks();
    }, 5000);
    
    // Addresses update - faster when on visu page
    setInterval(async ()=>{
        if(isModalOpen() || pollingPaused) return;
        await loadAddresses();
        // Update visu values if on visu page
        if(document.getElementById('page-visu')?.classList.contains('active')) {
            updateVisuValues();
        }
    }, 3000);
    
    // Auto version check every 60 seconds (only once per session)
    let versionCheckDone = false;
    setInterval(async()=>{
        if(versionCheckDone || isModalOpen()) return;
        try{
            const r=await fetch(`${API}/status`);
            const d=await r.json();
            if(d.version&&d.version!==APP_VERSION){
                console.log('New version detected:',d.version,'(current:',APP_VERSION,')');
                versionCheckDone = true;
                if(confirm(`Neue Version ${d.version} verfügbar! Seite neu laden?`)){
                    localStorage.setItem('app_version',d.version);
                    location.reload(true);
                }
            }
        }catch(e){}
    },60000);
});

async function loadAll(){
    loadStatus();
    loadAddresses();
    await loadBlockPositions();
    loadBlocks(true);
    loadAvail();
    loadPages();
    loadTelegrams();
    loadFiles();
    loadVisuConfig();
    loadVSEElements();
}

function showPage(id){
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
    document.getElementById('page-'+id)?.classList.add('active');
    document.querySelector(`[onclick="showPage('${id}')"]`)?.classList.add('active');
    const titles={dashboard:'Dashboard',visu:'Visualisierung',vse:'Widget-Bibliothek',addresses:'KNX Adressen',internal:'Interne (IKO)',logic:'Logik-Editor',blocks:'Bausteintypen',code:'Code-Editor',settings:'Einstellungen',import:'Import/Export',update:'System-Update',logs:'Logs'};
    document.getElementById('pageTitle').textContent=titles[id]||id;
    if(id==='logs')loadLogs();
    if(id==='settings')loadSettings();
    // Reload addresses and blocks when switching to logic or internal page
    if(id==='logic'||id==='internal'){loadAddresses();loadAvail();}
    // Show tree panel when switching to visu page
    if(id==='visu'){
        const treePanel = document.getElementById('visuTreePanel');
        if(treePanel && !treePanel.classList.contains('show')){
            treePanel.classList.add('show');
            renderVisuTree();
        }
    }
}

async function restartSystem(){
    if(!confirm('System wirklich neu starten?\n\nAlle laufenden Prozesse werden beendet und neu gestartet.'))return;
    showAlert('info','System wird neu gestartet...');
    try{
        const r=await fetch(`${API}/system/restart`,{method:'POST'});
        if(r.ok){
            showAlert('success','Neustart eingeleitet - Seite lädt in 5 Sekunden neu...');
            setTimeout(()=>location.reload(),5000);
        }else{
            showAlert('error','Neustart fehlgeschlagen');
        }
    }catch(e){
        // Server might be restarting, try reload anyway
        showAlert('info','Verbindung unterbrochen - Seite lädt neu...');
        setTimeout(()=>location.reload(),3000);
    }
}

function showModal(id){
    pollingPaused=true;
    const modal = document.getElementById(id);
    modal.classList.add('show');
    // Use requestAnimationFrame for faster focus
    requestAnimationFrame(() => {
        requestAnimationFrame(() => {
            const firstInput = modal.querySelector('input:not([type="hidden"]):not([type="checkbox"]):not([type="color"]), select, textarea');
            if (firstInput && !firstInput.disabled) {
                firstInput.focus();
            }
        });
    });
}
function hideModal(id){document.getElementById(id).classList.remove('show');pollingPaused=false;}
function closeModal(id){hideModal(id);}
function showAlert(type,msg){const a=document.getElementById('mainAlert');a.className='alert show '+type;a.textContent=msg;setTimeout(()=>a.classList.remove('show'),4000);}

// Conditional formatting tab switcher
function showCondTab(n) {
    [1,2,3].forEach(i => {
        const tab = document.getElementById('condTab'+i);
        const panel = document.getElementById('condPanel'+i);
        if(tab && panel) {
            if(i === n) {
                tab.classList.add('active');
                tab.style.borderBottomColor = 'var(--accent)';
                tab.style.color = 'var(--text)';
                tab.style.fontWeight = '600';
                panel.style.display = 'block';
            } else {
                tab.classList.remove('active');
                tab.style.borderBottomColor = 'transparent';
                tab.style.color = 'var(--text-muted)';
                tab.style.fontWeight = '400';
                panel.style.display = 'none';
            }
        }
    });
}

async function loadStatus(){
    try{
        const d=await(await fetch(`${API}/status`)).json();
        const isConnected = d.knx_connected;
        
        // Update header status
        const statusDot = document.querySelector('#connStatus .status-dot');
        const statusText = document.getElementById('connText');
        const statusIp = document.getElementById('connIp');
        if(statusDot) {
            statusDot.classList.toggle('online', isConnected);
            statusDot.classList.toggle('offline', !isConnected);
        }
        if(statusText) statusText.textContent = isConnected ? 'Verbunden' : 'Getrennt';
        if(statusIp) statusIp.textContent = isConnected ? (d.gateway_ip || '') : '';
        
        // Update dashboard status widget
        const connStatusText = document.getElementById('connStatusText');
        const connIcon = document.getElementById('connIcon');
        if(connStatusText) {
            connStatusText.textContent = isConnected ? 'Online' : 'Offline';
            connStatusText.classList.toggle('online', isConnected);
            connStatusText.classList.toggle('offline', !isConnected);
        }
        if(connIcon) {
            connIcon.className = 'mdi ' + (isConnected ? 'mdi-wifi' : 'mdi-wifi-off') + ' stat-icon';
        }
        
        // Legacy elements (if still present)
        const sGateway = document.getElementById('sGateway');
        if(sGateway) sGateway.textContent = d.gateway_ip || '-';
        
        // Update gateway gauge (if still present)
        const gauge=document.getElementById('gatewayGauge');
        const status=document.getElementById('gatewayStatus');
        if(gauge&&status){
            if(isConnected){
                gauge.setAttribute('stroke','var(--knx-online)');
                gauge.setAttribute('stroke-dashoffset','0');
                status.textContent='●';
                status.style.color='var(--knx-online)';
            }else{
                gauge.setAttribute('stroke','var(--knx-offline)');
                gauge.setAttribute('stroke-dashoffset','63');
                status.textContent='○';
                status.style.color='var(--knx-offline)';
            }
        }
    }catch(e){}
}

function updateDashboard(){
    // Update donut chart
    const total=addresses.length+internalAddrs.length;
    const active=allAddresses.filter(a=>a.last_value!==null&&a.last_value!==undefined&&a.last_value!=='').length;
    const inactive=total-active;
    
    // Update active devices stat widget
    const sActive = document.getElementById('sActive');
    if(sActive) {
        // Count devices that are "on" (value = 1, true, or > 0)
        const onDevices = allAddresses.filter(a => {
            const v = a.last_value;
            if(v === null || v === undefined || v === '') return false;
            if(v === '1' || v === true || v === 'true' || v === 'True') return true;
            const num = parseFloat(v);
            return !isNaN(num) && num > 0;
        }).length;
        sActive.textContent = onDevices;
    }
    
    if(total>0){
        const activePercent=Math.round((active/total)*100);
        const inactivePercent=100-activePercent;
        
        const donutActive=document.getElementById('donutActive');
        if(donutActive){
            donutActive.setAttribute('stroke-dasharray',`${activePercent} ${inactivePercent}`);
            donutActive.setAttribute('stroke-dashoffset','25');
        }
    }
    
    const legendActive=document.getElementById('legendActive');
    const legendInactive=document.getElementById('legendInactive');
    if(legendActive)legendActive.textContent=`Aktiv: ${active}`;
    if(legendInactive)legendInactive.textContent=`Ohne: ${inactive}`;
    
    // Update temperature widget (find first temperature address)
    const tempAddr=allAddresses.find(a=>a.dpt&&a.dpt.startsWith('9')&&a.last_value!==null&&a.last_value!==undefined);
    const tempValueEl=document.getElementById('tempValue');
    if(tempValueEl){
        if(tempAddr){
            const val=parseFloat(tempAddr.last_value);
            tempValueEl.textContent=(!isNaN(val)?val.toFixed(1):'--')+'°C';
        }else{
            tempValueEl.textContent='--°C';
        }
    }
    
    // Update quick values - show with nice grid layout
    const withValues=allAddresses.filter(a=>a.last_value!==null&&a.last_value!==undefined&&a.last_value!=='').slice(0,8);
    const qv=document.getElementById('quickValues');
    if(qv){
        if(withValues.length>0){
            qv.innerHTML=`<div class="quick-values">
                ${withValues.map(a=>{
                    const val=a.last_value;
                    const numVal=parseFloat(val);
                    const isNum=!isNaN(numVal);
                    const display=isNum?(numVal%1===0?numVal:numVal.toFixed(1)):val;
                    const isTemp=a.dpt&&a.dpt.startsWith('9');
                    const isBool=val==='1'||val==='0'||val===true||val===false||val==='True'||val==='False';
                    const boolVal=val==='1'||val===true||val==='True';
                    return `<div class="quick-value-item">
                        <div class="quick-value-addr">${a.address}</div>
                        <div class="quick-value-name">${a.name||'-'}</div>
                        <div class="quick-value-val" style="color:${isTemp?'var(--warning)':isBool?(boolVal?'var(--success)':'var(--text-muted)'):'var(--accent)'}">${isBool?(boolVal?'ON':'OFF'):display}</div>
                    </div>`;
                }).join('')}
            </div>`;
        }else{
            qv.innerHTML='<div style="color:var(--text-muted);text-align:center;padding:20px">Keine aktuellen Werte vorhanden</div>';
        }
    }
    
    // Check for OAuth2 blocks and update widget
    updateOAuthWidgets();
}

// OAuth Widget Update Functions
function updateOAuthWidgets(){
    const oauthBlocks=blocks.filter(b=>b.block_id&&(b.block_id.includes('oauth')||b.block_id.includes('OAuth')||b.name?.toLowerCase().includes('oauth')||b.name?.toLowerCase().includes('netatmo')||b.name?.toLowerCase().includes('token')));
    
    if(oauthBlocks.length>0){
        const b=oauthBlocks[0];
        const outputs=b.output_values||{};
        
        // Map outputs to OAuth data
        const data={
            A2:parseInt(outputs.expires_in||outputs.A2||3200),
            A3:outputs.status||outputs.A3||1,
            A4:outputs.error||outputs.message||outputs.A4||'',
            A5:outputs.ready||outputs.A5||(outputs.status===1?1:0)||1,
            A7:outputs.auth_url||outputs.A7||'',
            A8:outputs.source||outputs.A8||b.name||'API-Refresh'
        };
        
        updateOAuthWidget(data, b.name||'Netatmo Service');
    }else{
        // Demo data when no OAuth blocks
        updateOAuthWidget({A2:3200,A3:1,A4:'',A5:1,A7:'',A8:'Demo'}, 'OAuth2 Service');
    }
}

function updateOAuthWidget(data, title){
    const statusIcon=document.getElementById('oauth-status-icon');
    const progressBar=document.getElementById('oauth-progress');
    const authLink=document.getElementById('oauth-auth-link');
    const refreshBtn=document.getElementById('oauth-refresh-btn');
    const readyText=document.getElementById('oauth-ready-text');
    const sourceEl=document.getElementById('oauth-source');
    const expiryEl=document.getElementById('oauth-expiry');
    
    if(!progressBar)return;
    
    // Status Logic - Icon color
    const isReady=data.A5===1||data.A5==='1'||data.A5===true;
    if(statusIcon){
        statusIcon.style.color=isReady?'var(--success)':'var(--danger)';
    }
    
    // Source text
    if(sourceEl)sourceEl.textContent='Status: '+(isReady?'Aktiv':'Inaktiv');
    if(readyText)readyText.textContent='Quelle: '+(data.A8||'-');
    
    // Progress bar
    const percent=Math.min(100,(data.A2/3600)*100);
    progressBar.style.width=percent+'%';
    if(percent<20)progressBar.style.background='var(--danger)';
    else if(percent<50)progressBar.style.background='var(--warning)';
    else progressBar.style.background='var(--accent)';
    
    if(expiryEl)expiryEl.textContent=data.A2>0?formatDuration(data.A2)+' verbleibend':'-';
    
    // Auth flow
    if(authLink&&refreshBtn){
        if(data.A7&&data.A7!==''){
            authLink.href=data.A7;
            authLink.style.display='flex';
            refreshBtn.style.display='none';
        }else{
            authLink.style.display='none';
            refreshBtn.style.display='flex';
        }
    }
}

function formatDuration(seconds){
    if(seconds>=3600)return Math.floor(seconds/3600)+'h '+Math.floor((seconds%3600)/60)+'m';
    if(seconds>=60)return Math.floor(seconds/60)+'m '+Math.floor(seconds%60)+'s';
    return seconds+'s';
}

function triggerOAuthRefresh(){
    // Find OAuth block and trigger refresh
    const oauthBlocks=blocks.filter(b=>b.block_id&&(b.block_id.includes('oauth')||b.block_id.includes('OAuth')));
    if(oauthBlocks.length>0){
        triggerBlock(oauthBlocks[0].instance_id);
        showAlert('info','Token-Refresh angefordert...');
    }else{
        showAlert('warning','Kein OAuth-Baustein gefunden');
    }
}

async function loadSettings(){
    try{
        const d=await(await fetch(`${API}/status`)).json();
        document.getElementById('settingsGatewayIp').value=d.gateway_ip||'';
        document.getElementById('settingsGatewayPort').value=d.gateway_port||3671;
    }catch(e){}
}

async function saveSettings(){
    const ip=document.getElementById('settingsGatewayIp').value.trim();
    const port=parseInt(document.getElementById('settingsGatewayPort').value)||3671;
    const mode=document.getElementById('settingsMode').value;
    
    if(!ip){showAlert('error','Bitte Gateway IP eingeben');return;}
    
    try{
        const r=await fetch(`${API}/settings/gateway?gateway_ip=${encodeURIComponent(ip)}&gateway_port=${port}&use_tunneling=${mode==='tunneling'}`,{method:'POST'});
        if(r.ok){
            showAlert('success','✓ Einstellungen gespeichert, Verbindung wird aufgebaut...');
        }else{
            const d=await r.json();
            showAlert('error',getErrMsg(d));
        }
    }catch(e){showAlert('error','Fehler: '+getErrMsg(e));}
}

async function loadAddresses(){
    try{
        const all=await(await fetch(`${API}/group-addresses`)).json();
        // Skip DOM updates if modal is open
        if(isModalOpen()) return;
        allAddresses=all;
        addresses=all.filter(a=>!a.is_internal);
        internalAddrs=all.filter(a=>a.is_internal);
        document.getElementById('sAddr').textContent=addresses.length;
        document.getElementById('addrCount').textContent=addresses.length;
        document.getElementById('sInt').textContent=internalAddrs.length;
        document.getElementById('intCount').textContent=internalAddrs.length;
        renderAddr();renderInt();updateDatalist();updateDashboard();
    }catch(e){}
}

async function loadBlocks(forceRender=false){
    try{
        const newBlocks=await(await fetch(`${API}/logic/blocks`)).json();
        // Skip DOM updates if modal is open (unless forceRender)
        if(isModalOpen() && !forceRender) return;
        const changed=blocks.length!==newBlocks.length;
        blocks=newBlocks;
        document.getElementById('sBlocks').textContent=blocks.length;
        document.getElementById('blockCount').textContent=blocks.length;
        if(forceRender||changed){
            renderLogicBlocks();
        } else {
            updateBlockValues();
            // Redraw wires in case bindings changed
            if(document.getElementById('page-logic')?.classList.contains('active')){
                drawWires();
            }
        }
    }catch(e){console.error('loadBlocks:',e)}
}

async function loadAvail(){
    try{
        availBlocks=await(await fetch(`${API}/logic/blocks/available`)).json();
        console.log('loadAvail received:', availBlocks.length, 'available blocks');
        console.log('Available block types:', availBlocks.map(b => b.type).join(', '));
        document.getElementById('blockType').innerHTML=availBlocks.map(b=>`<option value="${b.type}">[${b.id}] ${b.name}</option>`).join('');
        renderBlockTypeTable();
    }catch(e){console.error('loadAvail:',e)}
}

async function loadPages(){
    try{
        pages=await(await fetch(`${API}/logic/pages`)).json();
        renderPageTabs();
    }catch(e){console.error('loadPages:',e);pages=[];renderPageTabs()}
}

async function loadFiles(){try{const files=await(await fetch(`${API}/logic/custom-blocks`)).json();document.getElementById('filesTable').innerHTML=files.length?files.map(f=>`<tr><td><code>${f.filename}</code></td><td><button class="btn btn-sm btn-secondary" onclick="editCode('${f.filename}')">✏️</button> <button class="btn btn-sm btn-danger" onclick="delFile('${f.filename}')">🗑</button></td></tr>`).join(''):'<tr><td colspan="2" class="empty">Keine eigenen Bausteine</td></tr>';}catch(e){}}
async function loadTelegrams(){try{const t=await(await fetch(`${API}/knx/telegrams?count=10`)).json();const telegrams=t.telegrams||t||[];document.getElementById('telegramTable').innerHTML=telegrams.length?telegrams.map(x=>`<tr><td>${new Date(x.timestamp).toLocaleTimeString('de-DE')}</td><td><code>${x.source}</code></td><td><code>${x.destination}</code></td><td><b>${x.payload}</b></td></tr>`).join(''):'<tr><td colspan="4" class="empty">Keine Telegramme</td></tr>';}catch(e){console.error('loadTelegrams:',e);}}

function renderAddr(){
    const q=(document.getElementById('searchAddr')?.value||'').toLowerCase();
    const f=addresses.filter(a=>(a.name||'').toLowerCase().includes(q)||(a.address||'').includes(q));
    updateDeleteSelectedBtn();
    document.getElementById('addrTable').innerHTML=f.length?f.map(a=>`<tr><td><input type="checkbox" data-addr="${a.address}" ${selectedAddrs.has(a.address)?'checked':''} onchange="toggleAddrSelect('${a.address}',this.checked)"></td><td><code>${a.address}</code></td><td>${a.name||'-'}</td><td>${a.dpt||'-'}</td><td><b>${fmtVal(a.last_value,a.dpt)}</b></td><td>${a.last_updated?new Date(a.last_updated).toLocaleString('de-DE'):'-'}</td><td><button class="btn btn-sm btn-secondary" onclick="editAddr('${a.address}','${(a.name||'').replace(/'/g,"\\'")}','${a.dpt||''}')">✏️</button><button class="btn btn-sm btn-danger" onclick="delAddr('${a.address}')">🗑</button></td></tr>`).join(''):'<tr><td colspan="7" class="empty">Keine Adressen</td></tr>';
}

function fmtVal(val,dpt){
    if(val===null||val===undefined||val==='')return'-';
    if(typeof val==='boolean')return val?'ON':'OFF';
    if(typeof val==='number')return val%1===0?String(val):val.toFixed(2);
    if(typeof val==='string'){
        if(/^[0-9a-f]{4}$/i.test(val)&&dpt&&dpt.startsWith('9')){
            const b=[parseInt(val.substr(0,2),16),parseInt(val.substr(2,2),16)];
            const s=(b[0]>>7)&1,e=(b[0]>>3)&0xF;let m=((b[0]&7)<<8)|b[1];if(s)m-=2048;
            return((0.01*m)*Math.pow(2,e)).toFixed(2);
        }
        return val.length>12?val.substring(0,11)+'…':val;
    }
    return String(val).substring(0,12);
}

function renderInt(){
    const listEl=document.getElementById('ikoGroupList');
    const countEl=document.getElementById('ikoCount');
    const withValEl=document.getElementById('ikoWithValue');
    const groupCountEl=document.getElementById('ikoGroupCount');
    
    if(countEl)countEl.textContent=internalAddrs.length;
    const withVal=internalAddrs.filter(a=>a.last_value!==null&&a.last_value!==undefined&&a.last_value!=='').length;
    if(withValEl)withValEl.textContent=withVal;
    
    if(!listEl)return;
    
    if(internalAddrs.length===0){
        listEl.innerHTML='<div style="color:var(--text-muted);text-align:center;padding:40px">Keine IKOs vorhanden. Klicke auf "+ Neue IKO" oder "Aus Baustein" um welche anzulegen.</div>';
        if(groupCountEl)groupCountEl.textContent='0';
        return;
    }
    
    // Group by prefix (everything except the last segment)
    const groups={};
    internalAddrs.forEach(a=>{
        const parts=a.address.split('/');
        // Use all parts except the last as group key
        const groupKey = parts.length > 1 ? parts.slice(0, -1).join('/') : 'Ungroupiert';
        if(!groups[groupKey])groups[groupKey]=[];
        groups[groupKey].push(a);
    });
    
    const groupKeys=Object.keys(groups).sort();
    if(groupCountEl)groupCountEl.textContent=groupKeys.length;
    
    // Table header
    let html=`<div class="iko-row" style="background:var(--sidebar);font-weight:600;font-size:11px;text-transform:uppercase;color:var(--text-muted);letter-spacing:0.5px;border:none;border-bottom:2px solid var(--border)">
        <span class="iko-row-addr">Adresse</span>
        <span class="iko-row-name">Name</span>
        <span class="iko-row-dpt">DPT</span>
        <span class="iko-row-value" style="background:transparent;cursor:default">Wert</span>
        <span class="iko-row-initial">Initial</span>
        <span class="iko-row-actions">Aktionen</span>
    </div>`;
    
    html+=groupKeys.map(groupKey=>{
        const items=groups[groupKey];
        const expanded=localStorage.getItem('iko_group_'+groupKey)!=='collapsed';
        
        return `<div class="iko-group${expanded?'':' collapsed'}" data-group="${groupKey}">
            <div class="iko-group-header" onclick="toggleIkoGroup('${groupKey}')">
                <i class="mdi mdi-chevron-down"></i>
                <i class="mdi mdi-folder${expanded?'-open':''}" style="color:var(--accent)"></i>
                <span class="iko-group-name">${groupKey}</span>
                <span class="iko-group-count">${items.length} IKO${items.length!==1?'s':''}</span>
                <button class="btn btn-sm btn-danger" onclick="event.stopPropagation();deleteIkoGroup('${groupKey}')" title="Gruppe löschen"><i class="mdi mdi-delete"></i></button>
            </div>
            <div class="iko-group-body">
                ${items.map(a=>{
                    const val=a.last_value;
                    const hasVal=val!==null&&val!==undefined&&val!=='';
                    const displayVal=hasVal?fmtVal(val,a.dpt):'–';
                    const initVal=a.initial_value!==undefined&&a.initial_value!==null&&a.initial_value!==''?a.initial_value:'';
                    const escName=(a.name||'').replace(/'/g,"\\'");
                    // Show only the last segment as short address
                    const parts = a.address.split('/');
                    const shortAddr = parts[parts.length - 1];
                    
                    return `<div class="iko-row">
                        <span class="iko-row-addr" title="${a.address}">${shortAddr}</span>
                        <span class="iko-row-name">${a.name||'<span style="color:var(--text-muted)">-</span>'}</span>
                        <span class="iko-row-dpt">${a.dpt||'-'}</span>
                        <span class="iko-row-value" style="color:${hasVal?'var(--accent)':'var(--text-muted)'}" onclick="editIkoValue('${a.address}','${escName}')" title="Wert bearbeiten">${displayVal}</span>
                        <span class="iko-row-initial">${initVal?'Init: '+initVal:''}</span>
                        <span class="iko-row-actions">
                            <button class="btn btn-sm btn-secondary" onclick="editAddr('${a.address}','${escName}','${a.dpt||''}')" title="Bearbeiten"><i class="mdi mdi-pencil"></i></button>
                            <button class="btn btn-sm btn-warning" onclick="editIkoInitial('${a.address}','${escName}','${initVal}')" title="Initial-Wert"><i class="mdi mdi-restart"></i></button>
                            <button class="btn btn-sm btn-danger" onclick="delAddr('${a.address}')" title="Löschen"><i class="mdi mdi-delete"></i></button>
                        </span>
                    </div>`;
                }).join('')}
            </div>
        </div>`;
    }).join('');
    
    listEl.innerHTML=html;
}

function toggleIkoGroup(groupKey){
    const el=document.querySelector(`.iko-group[data-group="${groupKey}"]`);
    if(!el)return;
    el.classList.toggle('collapsed');
    const collapsed=el.classList.contains('collapsed');
    localStorage.setItem('iko_group_'+groupKey,collapsed?'collapsed':'expanded');
    const icon=el.querySelector('.iko-group-header .mdi-folder, .iko-group-header .mdi-folder-open');
    if(icon){icon.className='mdi mdi-folder'+(collapsed?'':'-open');icon.style.color='var(--accent)';}
}

function toggleAllGroups(expand){
    document.querySelectorAll('.iko-group').forEach(el=>{
        const groupKey=el.dataset.group;
        if(expand){el.classList.remove('collapsed');localStorage.setItem('iko_group_'+groupKey,'expanded');}
        else{el.classList.add('collapsed');localStorage.setItem('iko_group_'+groupKey,'collapsed');}
        const icon=el.querySelector('.iko-group-header .mdi-folder, .iko-group-header .mdi-folder-open');
        if(icon){icon.className='mdi mdi-folder'+(expand?'-open':'');icon.style.color='var(--accent)';}
    });
}

async function deleteIkoGroup(groupKey){
    // Find all items where the prefix (everything except last segment) matches the groupKey
    const items=internalAddrs.filter(a=>{
        const parts = a.address.split('/');
        const prefix = parts.length > 1 ? parts.slice(0, -1).join('/') : 'Ungroupiert';
        return prefix === groupKey;
    });
    
    if(items.length === 0){
        showAlert('warning', 'Keine IKOs in dieser Gruppe gefunden');
        return;
    }
    if(!confirm(`Alle ${items.length} IKOs in Gruppe "${groupKey}" löschen?`))return;
    
    let deleted = 0, errors = 0;
    for(const a of items){
        try {
            const r = await fetch(`${API}/group-addresses/${encodeURIComponent(a.address)}`,{method:'DELETE'});
            if(r.ok) deleted++;
            else {
                errors++;
                console.error('Delete failed:', a.address, r.status);
            }
        } catch(e) {
            errors++;
            console.error('Delete error:', a.address, e);
        }
    }
    
    loadAddresses();
    if(errors === 0){
        showAlert('success',`${deleted} IKOs gelöscht`);
    } else {
        showAlert('warning', `${deleted} gelöscht, ${errors} Fehler`);
    }
}

// IKO from Block functions
function showIkoFromBlockModal(){
    // Populate block type dropdown
    const select=document.getElementById('ikoBlockType');
    select.innerHTML='<option value="">-- Baustein wählen --</option>'+
        availBlocks.map(b=>`<option value="${b.type}">[${b.id}] ${b.name} (E:${Object.keys(b.inputs||{}).length} A:${Object.keys(b.outputs||{}).length})</option>`).join('');
    document.getElementById('ikoGroupPrefix').value='';
    document.getElementById('ikoBlockPreview').innerHTML='<span style="color:var(--text-muted)">Wähle einen Baustein und gib einen Prefix ein</span>';
    document.getElementById('ikoCreateInputs').checked=true;
    document.getElementById('ikoCreateOutputs').checked=true;
    showModal('ikoFromBlockModal');
}

function previewBlockIkos(){
    const blockType=document.getElementById('ikoBlockType').value;
    let groupName=document.getElementById('ikoGroupPrefix').value.trim();
    const preview=document.getElementById('ikoBlockPreview');
    const createInputs=document.getElementById('ikoCreateInputs').checked;
    const createOutputs=document.getElementById('ikoCreateOutputs').checked;
    
    if(!blockType||!groupName){
        preview.innerHTML='<span style="color:var(--text-muted)">Wähle einen Baustein und gib einen Gruppen-Namen ein</span>';
        return;
    }
    
    // Auto-add INT/ prefix
    const prefix = 'INT/' + groupName.replace(/^INT\//i, '');
    
    const block=availBlocks.find(b=>b.type===blockType);
    if(!block){preview.innerHTML='<span style="color:var(--danger)">Baustein nicht gefunden</span>';return;}
    
    let html='';
    const inputs=Object.entries(block.inputs||{});
    const outputs=Object.entries(block.outputs||{});
    
    if(createInputs&&inputs.length>0){
        html+=`<div style="font-weight:600;color:var(--success);margin-bottom:6px"><i class="mdi mdi-arrow-right-bold"></i> Eingänge (${inputs.length})</div>`;
        inputs.forEach(([key,info])=>{
            const addr=`${prefix}/${key}`;
            const name=info.name||info.description||key;
            const dpt=info.dpt||'';
            html+=`<div style="display:flex;gap:10px;padding:4px 0;border-bottom:1px solid var(--border)">
                <code style="color:var(--purple);min-width:150px">${addr}</code>
                <span style="flex:1">${name}</span>
                <span style="color:var(--text-muted);font-size:11px">${dpt||'-'}</span>
            </div>`;
        });
    }
    
    if(createOutputs&&outputs.length>0){
        html+=`<div style="font-weight:600;color:var(--accent);margin:12px 0 6px 0"><i class="mdi mdi-arrow-left-bold"></i> Ausgänge (${outputs.length})</div>`;
        outputs.forEach(([key,info])=>{
            const addr=`${prefix}/${key}`;
            const name=info.name||info.description||key;
            const dpt=info.dpt||'';
            html+=`<div style="display:flex;gap:10px;padding:4px 0;border-bottom:1px solid var(--border)">
                <code style="color:var(--purple);min-width:150px">${addr}</code>
                <span style="flex:1">${name}</span>
                <span style="color:var(--text-muted);font-size:11px">${dpt||'-'}</span>
            </div>`;
        });
    }
    
    if(!html)html='<span style="color:var(--warning)">Keine IKOs ausgewählt</span>';
    
    const total=(createInputs?inputs.length:0)+(createOutputs?outputs.length:0);
    html=`<div style="margin-bottom:10px;padding-bottom:8px;border-bottom:2px solid var(--border)"><b>${total} IKOs</b> werden erstellt für <b>${block.name}</b> in Gruppe <code style="color:var(--purple)">${prefix}</code></div>`+html;
    
    preview.innerHTML=html;
}

async function createIkosFromBlock(){
    const blockType=document.getElementById('ikoBlockType').value;
    let groupName=document.getElementById('ikoGroupPrefix').value.trim();
    const createInputs=document.getElementById('ikoCreateInputs').checked;
    const createOutputs=document.getElementById('ikoCreateOutputs').checked;
    
    if(!blockType){showAlert('error','Bitte Baustein wählen');return;}
    if(!groupName){showAlert('error','Bitte Gruppen-Name eingeben');return;}
    
    // Auto-add INT/ prefix and clean up
    const prefix = 'INT/' + groupName.replace(/^INT\//i, '').replace(/\/$/, '');
    
    const block=availBlocks.find(b=>b.type===blockType);
    if(!block){showAlert('error','Baustein nicht gefunden');return;}
    
    const toCreate=[];
    
    if(createInputs){
        Object.entries(block.inputs||{}).forEach(([key,info])=>{
            toCreate.push({
                address:`${prefix}/${key}`,
                name:info.name||info.description||key,
                dpt:info.dpt||null,
                is_internal:true
            });
        });
    }
    
    if(createOutputs){
        Object.entries(block.outputs||{}).forEach(([key,info])=>{
            toCreate.push({
                address:`${prefix}/${key}`,
                name:info.name||info.description||key,
                dpt:info.dpt||null,
                is_internal:true
            });
        });
    }
    
    if(toCreate.length===0){showAlert('warning','Keine IKOs zum Erstellen');return;}
    
    let created=0,errors=0;
    for(const iko of toCreate){
        try{
            const r=await fetch(`${API}/group-addresses`,{
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify(iko)
            });
            if(r.ok)created++;
            else errors++;
        }catch(e){errors++;}
    }
    
    hideModal('ikoFromBlockModal');
    loadAddresses();
    
    if(errors===0){
        showAlert('success',`${created} IKOs erstellt in Gruppe "${prefix}"`);
    }else{
        showAlert('warning',`${created} erstellt, ${errors} Fehler (evtl. bereits vorhanden)`);
    }
}

function renderBlockTypeTable(){document.getElementById('blockTypeTable').innerHTML=availBlocks.map(b=>`<tr><td><code style="color:var(--success)">${b.id}</code></td><td><b>${b.name}</b></td><td>${b.category||'-'}</td><td style="max-width:300px">${b.description||'-'}</td><td>${Object.keys(b.inputs||{}).length} / ${Object.keys(b.outputs||{}).length}</td></tr>`).join('');}

function renderPageTabs(){
    const tabs=document.getElementById('pagesTabs');
    let html=`<div class="tab${currentPage==='default'?' active':''}" onclick="selectPage('default')">Standard</div>`;
    (pages||[]).forEach(p=>{html+=`<div class="tab${currentPage===p.id?' active':''}" onclick="selectPage('${p.id}')">${p.name||p.id}<span class="delete-tab" onclick="event.stopPropagation();deletePage('${p.id}')">×</span></div>`;});
    tabs.innerHTML=html;
}

function selectPage(id){currentPage=id;renderPageTabs();renderLogicBlocks();}
function updateDatalist(){document.getElementById('addr-list').innerHTML=allAddresses.map(a=>`<option value="${a.address}">${a.name||a.address}</option>`).join('');}

function renderLogicBlocks(){
    const c=document.getElementById('logicBlocksContainer');
    console.log('renderLogicBlocks called, blocks:', blocks.length, 'currentPage:', currentPage);
    console.log('blocks data:', JSON.stringify(blocks.map(b => ({id: b.instance_id, page: b.page_id, hasInputs: !!b.inputs})), null, 2));
    
    const pb=blocks.filter(b=>(currentPage==='default'&&!b.page_id)||(b.page_id===currentPage));
    console.log('Filtered blocks for page:', pb.length);
    
    if(!pb.length){
        c.innerHTML='<svg id="wiresCanvas" class="wire-svg"></svg><div class="empty" style="width:100%">Keine Bausteine auf dieser Seite</div>';
        return;
    }
    
    // Calculate wire connections (output bindings that match input bindings of other blocks)
    const wireConnections = [];
    pb.forEach(srcBlock => {
        const outBindings = srcBlock.output_bindings || {};
        Object.entries(outBindings).forEach(([outKey, addr]) => {
            if (!addr) return;
            pb.forEach(tgtBlock => {
                if (tgtBlock.instance_id === srcBlock.instance_id) return;
                const inBindings = tgtBlock.input_bindings || {};
                Object.entries(inBindings).forEach(([inKey, inAddr]) => {
                    if (inAddr === addr) {
                        wireConnections.push({
                            fromBlock: srcBlock.instance_id,
                            fromKey: outKey,
                            toBlock: tgtBlock.instance_id,
                            toKey: inKey
                        });
                    }
                });
            });
        });
    });
    
    const blocksHtml = pb.map((b,i)=>{
        const pos=blockPositions[b.instance_id]||{x:60+((i%2)*460),y:60+(Math.floor(i/2)*320)};
        const meta=availBlocks.find(x=>x.id===b.block_id)||{};
        // Sort inputs and outputs by key (E1, E2, ... and A1, A2, ...)
        const inputsArr=Object.entries(b.inputs||{}).sort((x,y) => {
            const numA = parseInt(x[0].replace(/\D/g,'')) || 0;
            const numB = parseInt(y[0].replace(/\D/g,'')) || 0;
            return numA - numB;
        });
        const outputsArr=Object.entries(b.outputs||{}).sort((x,y) => {
            const numA = parseInt(x[0].replace(/\D/g,'')) || 0;
            const numB = parseInt(y[0].replace(/\D/g,'')) || 0;
            return numA - numB;
        });
        const inBindings=b.input_bindings||{};
        const outBindings=b.output_bindings||{};
        const selected=selectedBlock===b.instance_id?'selected':'';
        const hasError = b.error ? 'error' : '';
        
        // Berechne Anzahl Zeilen = max(inputs, outputs)
        const numRows = Math.max(inputsArr.length, outputsArr.length, 1);
        
        // Baue Tabellen-Zeilen
        let rowsHtml = '';
        for(let r=0; r<numRows; r++){
            const inp = inputsArr[r];
            const out = outputsArr[r];
            
            // Input-Seite (links) mit Port und Wert
            let inputHtml = '';
            if(inp){
                const [k,v] = inp;
                const binding = inBindings[k]||v.binding||'';
                const val = b.input_values?.[k]??v.value;
                // Check if this input has a wire connection to another block
                const hasWire = wireConnections.some(w=>w.toBlock===b.instance_id&&w.toKey===k);
                const wiredClass = hasWire?'wired':'';
                const displayVal = formatDisplayVal(val);
                const fullVal = escVal(val);
                const label = v.config?.name||k;
                const inputNum = r+1;
                const bindingLabel = binding ? `<span class="eblock-binding" title="${binding}">${binding.length>15?binding.substring(0,15)+'…':binding}</span>` : '';
                inputHtml = `
                    <div class="eblock-port input ${wiredClass}" data-block="${b.instance_id}" data-io="input" data-key="${k}"
                        onmousedown="event.stopPropagation();startWire(event,'${b.instance_id}','input','${k}')" 
                        onmouseup="endWire(event,'${b.instance_id}','input','${k}')"></div>
                    <span class="eblock-input-label"><span class="eblock-input-num">E${inputNum}</span>${label}</span>
                    <div style="display:flex;align-items:center;gap:4px;margin-top:2px">
                        ${bindingLabel}
                        <span class="eblock-input-value" title="${fullVal}" 
                            onclick="event.stopPropagation();editBinding('${b.instance_id}','input','${k}','${(binding||'').replace(/'/g,"\\'")}')">${displayVal || '–'}</span>
                    </div>`;
            }
            
            // Output-Seite (rechts) mit Port und Wert
            let outputHtml = '';
            if(out){
                const [k,v] = out;
                const binding = outBindings[k]||v.binding||'';
                const val = b.output_values?.[k]??v.value;
                // Check if this output has a wire connection to another block
                const hasWire = wireConnections.some(w=>w.fromBlock===b.instance_id&&w.fromKey===k);
                const wiredClass = hasWire?'wired':'';
                const displayVal = formatDisplayVal(val);
                const fullVal = escVal(val);
                const label = v.config?.name||k;
                const outputNum = r+1;
                const bindingLabel = binding ? `<span class="eblock-binding" title="${binding}">${binding.length>15?binding.substring(0,15)+'…':binding}</span>` : '';
                outputHtml = `
                    <span class="eblock-output-label">${label}<span class="eblock-output-num">A${outputNum}</span></span>
                    <div style="display:flex;align-items:center;gap:4px;margin-top:2px;justify-content:flex-end">
                        ${bindingLabel}
                        <span class="eblock-output-value" title="${fullVal}"
                            onclick="event.stopPropagation();editBinding('${b.instance_id}','output','${k}','${(binding||'').replace(/'/g,"\\'")}')">${displayVal || '–'}</span>
                    </div>
                    <div class="eblock-port output ${wiredClass}" data-block="${b.instance_id}" data-io="output" data-key="${k}"
                        onmousedown="event.stopPropagation();startWire(event,'${b.instance_id}','output','${k}')" 
                        onmouseup="endWire(event,'${b.instance_id}','output','${k}')"></div>`;
            }
            
            rowsHtml += `<tr class="eblock-row">
                <td class="eblock-input">${inputHtml}</td>
                <td class="eblock-output">${outputHtml}</td>
            </tr>`;
        }
        
        // Status-Zeile
        const statusText = b.status || (b.enabled ? 'Aktiv' : 'Pausiert');
        const blockVersion = meta.version || '1.0';
        const blockNum = b.block_id || meta.id || '?';
        
        return `
        <div class="eblock ${selected} ${hasError}" id="block-${b.instance_id}" style="left:${pos.x}px;top:${pos.y}px" onclick="selectBlock('${b.instance_id}')">
            <div class="eblock-header" onmousedown="startDrag(event,'${b.instance_id}')" ondblclick="event.stopPropagation();showBlockDebug('${b.instance_id}')">
                ${b.name||meta.name||'Block'}<span class="eblock-header-info">(${blockNum} v${blockVersion})</span>
            </div>
            <div class="eblock-body">
                <table class="eblock-table"><tbody>${rowsHtml}</tbody></table>
            </div>
            <div class="eblock-status">${statusText}</div>
        </div>`;
    }).join('');
    
    c.innerHTML = '<svg id="wiresCanvas" class="wire-svg"></svg>' + blocksHtml;
    setTimeout(drawWires, 100);
}

function getCategoryColor(cat){
    // Not used anymore - single green color
    return '';
}

function formatDisplayVal(val){
    if(val===null||val===undefined||val==='')return'';
    if(typeof val==='boolean')return val?'1':'0';
    if(val==='True')return'1';
    if(val==='False')return'0';
    const s=String(val);
    if(s.length>18)return s.substring(0,15)+'...';
    return s;
}

function shortAddr(addr){
    if(!addr)return'';
    if(addr.length>15)return addr.substring(0,12)+'...';
    return addr;
}

// ========== BLOCK PROPERTIES PANEL ==========
function selectBlock(instanceId){
    selectedBlock=instanceId;
    
    // Update selection visuals
    document.querySelectorAll('.eblock').forEach(el=>el.classList.remove('selected'));
    const blockEl=document.getElementById('block-'+instanceId);
    if(blockEl)blockEl.classList.add('selected');
    
    // Show props panel
    const panel=document.getElementById('logicPropsPanel');
    panel.classList.add('active');
    
    // Find block data
    const b=blocks.find(x=>x.instance_id===instanceId);
    if(!b)return;
    
    const meta=availBlocks.find(x=>x.id===b.block_id)||{};
    const inputs=b.inputs||{};
    const outputs=b.outputs||{};
    // Use bindings from the dedicated binding objects, NOT from inputs/outputs
    const inBindings=b.input_bindings||{};
    const outBindings=b.output_bindings||{};
    
    // Debug logging
    console.log('output_bindings:', JSON.stringify(outBindings));
    
    // Sort inputs and outputs by key (E1, E2, ... and A1, A2, ...)
    const sortedInputs = Object.entries(inputs).sort((x,y) => {
        const numA = parseInt(x[0].replace(/\D/g,'')) || 0;
        const numB = parseInt(y[0].replace(/\D/g,'')) || 0;
        return numA - numB;
    });
    const sortedOutputs = Object.entries(outputs).sort((x,y) => {
        const numA = parseInt(x[0].replace(/\D/g,'')) || 0;
        const numB = parseInt(y[0].replace(/\D/g,'')) || 0;
        return numA - numB;
    });
    
    let html=`
        <div style="margin-bottom:16px">
            <div style="font-size:16px;font-weight:600;margin-bottom:4px">${b.name||'Block'}</div>
            <div style="font-size:12px;color:var(--text-muted)">${meta.category||'Baustein'}</div>
        </div>
        
        <div style="display:flex;gap:8px;margin-bottom:16px">
            <button class="btn btn-sm btn-primary" onclick="triggerBlock('${instanceId}')">▶ Ausführen</button>
            <button class="btn btn-sm btn-secondary" onclick="showBlockDebug('${instanceId}')">🔍 Debug</button>
            <button class="btn btn-sm btn-danger" onclick="delBlock('${instanceId}')">🗑</button>
        </div>
        
        <div class="logic-props-section">
            <h4>Eingänge</h4>
            ${sortedInputs.map(([k,v])=>{
                // IMPORTANT: Use the binding from input_bindings, not from v.binding
                const binding=inBindings[k]||'';
                const val=b.input_values?.[k]??v.value;
                return `
                <div class="logic-props-row">
                    <span class="logic-props-label">${k}: ${v.config?.name||k}</span>
                    <span class="logic-props-value ${valClass(val)}" data-live-input="${instanceId}-${k}">${shortVal(val)}</span>
                </div>
                <div class="logic-props-row" style="border:none;padding-top:0">
                    <span class="logic-props-label" style="font-size:10px">Binding</span>
                    <span class="logic-props-value" style="font-size:10px;color:var(--accent);cursor:pointer" onclick="editBinding('${instanceId}','input','${k}','${(binding||'').replace(/'/g,"\\'")}')">
                        ${binding||'<i style="color:var(--text-muted)">nicht verbunden</i>'}
                    </span>
                </div>`;
            }).join('')}
        </div>
        
        <div class="logic-props-section">
            <h4>Ausgänge</h4>
            ${sortedOutputs.map(([k,v])=>{
                // IMPORTANT: Use the binding from output_bindings, not from v.binding
                const binding=outBindings[k]||'';
                const val=b.output_values?.[k]??v.value;
                return `
                <div class="logic-props-row">
                    <span class="logic-props-label">${k}: ${v.config?.name||k}</span>
                    <span class="logic-props-value ${valClass(val)}" data-live-output="${instanceId}-${k}">${shortVal(val)}</span>
                </div>
                <div class="logic-props-row" style="border:none;padding-top:0">
                    <span class="logic-props-label" style="font-size:10px">Binding</span>
                    <span class="logic-props-value" style="font-size:10px;color:var(--accent);cursor:pointer" onclick="editBinding('${instanceId}','output','${k}','${(binding||'').replace(/'/g,"\\'")}')">
                        ${binding||'<i style="color:var(--text-muted)">nicht verbunden</i>'}
                    </span>
                </div>`;
            }).join('')}
        </div>
        
        ${meta.description?`<div class="logic-props-section"><h4>Beschreibung</h4><p style="font-size:12px;color:var(--text-muted);line-height:1.5">${meta.description}</p></div>`:''}
    `;
    
    document.getElementById('propsContent').innerHTML=html;
}

function closePropsPanel(){
    selectedBlock=null;
    document.querySelectorAll('.eblock').forEach(el=>el.classList.remove('selected'));
    document.getElementById('logicPropsPanel').classList.remove('active');
}

function getCategoryClass(cat){
    const c=(cat||'').toLowerCase();
    if(c.includes('system')||c.includes('zeit'))return'cat-system';
    if(c.includes('math')||c.includes('rechen'))return'cat-math';
    if(c.includes('logic')||c.includes('logik')||c.includes('vergleich'))return'cat-logic';
    if(c.includes('timer')||c.includes('trigger'))return'cat-timer';
    if(c.includes('knx'))return'cat-knx';
    if(c.includes('api')||c.includes('http')||c.includes('oauth'))return'cat-api';
    if(c.includes('wetter')||c.includes('weather')||c.includes('netatmo')||c.includes('ecowitt'))return'cat-weather';
    if(c.includes('sensor'))return'cat-sensor';
    if(c.includes('kalender')||c.includes('calendar')||c.includes('ical'))return'cat-calendar';
    if(c.includes('eigen')||c.includes('custom'))return'cat-custom';
    return'cat-default';
}

function escVal(v){return String(v??'').replace(/`/g,'\\`').replace(/\\/g,'\\\\');}
function valClass(v){
    if(v===null||v===undefined||v==='')return'null';
    if(typeof v==='boolean')return v?'bool-on':'bool-off';
    if(v==='True'||v==='1'||v===1)return'bool-on';
    if(v==='False'||v==='0'||v===0)return'bool-off';
    if(typeof v==='number')return'number';
    if(typeof v==='string'&&v.length>0)return'string';
    return'';
}
function shortVal(v){
    if(v===null||v===undefined||v==='')return'–';
    if(typeof v==='boolean')return v?'ON':'OFF';
    if(v==='True')return'ON';
    if(v==='False')return'OFF';
    if(typeof v==='number')return v%1===0?String(v):v.toFixed(2);
    const s=String(v);
    if(s.length>20)return s.substring(0,18)+'…';
    return s;
}

function updateBlockValues(){
    blocks.forEach(b=>{
        const inputs=b.inputs||{};
        const outputs=b.outputs||{};
        
        // Update input values with correct selector
        Object.entries(inputs).forEach(([k,v])=>{
            const val = b.input_values?.[k] ?? v.value;
            const el=document.querySelector(`#block-${b.instance_id} .eblock-input-value[onclick*="${k}"]`);
            if(el){
                el.textContent=formatDisplayVal(val) || '–';
                el.title=escVal(val);
            }
        });
        
        // Update output values with correct selector
        Object.entries(outputs).forEach(([k,v])=>{
            const val = b.output_values?.[k] ?? v.value;
            const el=document.querySelector(`#block-${b.instance_id} .eblock-output-value[onclick*="${k}"]`);
            if(el){
                el.textContent=formatDisplayVal(val) || '–';
                el.title=escVal(val);
            }
        });
        
        // Update props panel live values
        Object.entries(inputs).forEach(([k,v])=>{
            const val = b.input_values?.[k] ?? v.value;
            const el = document.querySelector(`[data-live-input="${b.instance_id}-${k}"]`);
            if(el){
                el.textContent = shortVal(val);
                el.className = 'logic-props-value ' + valClass(val);
            }
        });
        Object.entries(outputs).forEach(([k,v])=>{
            const val = b.output_values?.[k] ?? v.value;
            const el = document.querySelector(`[data-live-output="${b.instance_id}-${k}"]`);
            if(el){
                el.textContent = shortVal(val);
                el.className = 'logic-props-value ' + valClass(val);
            }
        });
    });
}

let dragEl=null,dragOff={x:0,y:0};
function startDrag(e,id){
    if(e.target.tagName==='BUTTON')return;
    e.preventDefault();
    dragEl=document.getElementById('block-'+id);
    dragOff={x:e.clientX-dragEl.offsetLeft,y:e.clientY-dragEl.offsetTop};
    dragEl.style.zIndex=1000;
    document.addEventListener('mousemove',onDrag);
    document.addEventListener('mouseup',stopDrag);
}
function onDrag(e){if(dragEl){dragEl.style.left=(e.clientX-dragOff.x)+'px';dragEl.style.top=(e.clientY-dragOff.y)+'px';drawWires();}}
function stopDrag(){
    if(dragEl){
        dragEl.style.zIndex='';
        blockPositions[dragEl.id.replace('block-','')]={x:parseInt(dragEl.style.left),y:parseInt(dragEl.style.top)};
        saveBlockPositions();
        drawWires();
    }
    dragEl=null;
    document.removeEventListener('mousemove',onDrag);
    document.removeEventListener('mouseup',stopDrag);
}

async function saveBlockPositions(){
    try{
        await fetch(`${API}/logic/positions`,{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify(blockPositions)
        });
    }catch(e){console.error('Save positions failed:',e);}
}

async function loadBlockPositions(){
    try{
        const r=await fetch(`${API}/logic/positions`);
        if(r.ok){
            const data=await r.json();
            blockPositions=data||{};
        }
    }catch(e){console.error('Load positions failed:',e);}
}

// ============ WIRE CONNECTION SYSTEM ============
let wireStart = null;  // {blockId, ioType, key, el}
let tempWireLine = null;

function startWire(e, blockId, ioType, key) {
    e.preventDefault();
    e.stopPropagation();
    
    const el = e.target;
    el.classList.add('wire-dragging');
    
    wireStart = { blockId, ioType, key, el };
    
    // Create temporary wire line
    const svg = document.getElementById('wiresCanvas');
    const srcBlock = document.getElementById(`block-${blockId}`);
    
    const startX = srcBlock.offsetLeft + (ioType === 'output' ? srcBlock.offsetWidth - 10 : 10);
    const startY = srcBlock.offsetTop + el.offsetTop + el.offsetHeight / 2;
    
    tempWireLine = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    tempWireLine.setAttribute('stroke', ioType === 'output' ? '#3fb950' : '#58a6ff');
    tempWireLine.setAttribute('stroke-width', '2');
    tempWireLine.setAttribute('fill', 'none');
    tempWireLine.setAttribute('stroke-dasharray', '5,5');
    tempWireLine.setAttribute('d', `M${startX},${startY} L${startX},${startY}`);
    svg.appendChild(tempWireLine);
    
    document.addEventListener('mousemove', onWireMove);
    document.addEventListener('mouseup', cancelWire);
}

function onWireMove(e) {
    if (!wireStart || !tempWireLine) return;
    
    const container = document.getElementById('logicBlocksContainer');
    const containerRect = container.getBoundingClientRect();
    
    // Get start position from the source block's position
    const srcBlock = document.getElementById(`block-${wireStart.blockId}`);
    const startX = srcBlock.offsetLeft + (wireStart.ioType === 'output' ? srcBlock.offsetWidth - 10 : 10);
    const startY = srcBlock.offsetTop + wireStart.el.offsetTop + wireStart.el.offsetHeight / 2;
    
    const endX = e.clientX - containerRect.left + container.scrollLeft;
    const endY = e.clientY - containerRect.top + container.scrollTop;
    
    // Bezier curve for nice wire look
    const midX = (startX + endX) / 2;
    const d = `M${startX},${startY} C${midX},${startY} ${midX},${endY} ${endX},${endY}`;
    tempWireLine.setAttribute('d', d);
    
    // Highlight potential targets
    document.querySelectorAll('.eblock-port').forEach(pin => {
        pin.classList.remove('wire-target');
        const pinIo = pin.dataset.io;
        const pinBlock = pin.dataset.block;
        
        // Valid target: different block, different io type
        if (pinBlock !== wireStart.blockId && pinIo !== wireStart.ioType) {
            const pinRect = pin.getBoundingClientRect();
            const dist = Math.hypot(e.clientX - (pinRect.left + pinRect.width/2), 
                                     e.clientY - (pinRect.top + pinRect.height/2));
            if (dist < 30) {
                pin.classList.add('wire-target');
            }
        }
    });
}

function endWire(e, blockId, ioType, key) {
    e.preventDefault();
    e.stopPropagation();
    
    if (!wireStart) return;
    
    // Check if valid connection (output -> input or input -> output, different blocks)
    if (wireStart.blockId !== blockId && wireStart.ioType !== ioType) {
        // Determine source (output) and target (input)
        let sourceBlock, sourceKey, targetBlock, targetKey;
        
        if (wireStart.ioType === 'output') {
            sourceBlock = wireStart.blockId;
            sourceKey = wireStart.key;
            targetBlock = blockId;
            targetKey = key;
        } else {
            sourceBlock = blockId;
            sourceKey = key;
            targetBlock = wireStart.blockId;
            targetKey = wireStart.key;
        }
        
        // Create connection via API
        createWireConnection(sourceBlock, sourceKey, targetBlock, targetKey);
    }
    
    cleanupWire();
}

function cancelWire(e) {
    // Check if we dropped on a valid target
    const target = document.elementFromPoint(e.clientX, e.clientY);
    if (target && target.classList.contains('eio-pin') && target.dataset.block) {
        endWire(e, target.dataset.block, target.dataset.io, target.dataset.key);
        return;
    }
    cleanupWire();
}

function cleanupWire() {
    if (wireStart && wireStart.el) {
        wireStart.el.classList.remove('wire-dragging');
    }
    if (tempWireLine) {
        tempWireLine.remove();
    }
    document.querySelectorAll('.eblock-port.wire-target').forEach(p => p.classList.remove('wire-target'));
    
    wireStart = null;
    tempWireLine = null;
    
    document.removeEventListener('mousemove', onWireMove);
    document.removeEventListener('mouseup', cancelWire);
}

async function createWireConnection(sourceBlock, sourceKey, targetBlock, targetKey) {
    // Create auto IKO name
    const sourceName = blocks.find(b => b.instance_id === sourceBlock)?.name || sourceBlock.split('_')[0];
    const ikoAddr = `IKO:${sourceName.substring(0,12)}_${sourceKey}`;
    
    showAlert('info', `Verbinde ${sourceName}.${sourceKey} → ${targetKey}...`);
    console.log('Creating wire:', {sourceBlock, sourceKey, targetBlock, targetKey, ikoAddr});
    
    try {
        // 1. Create IKO address if not exists
        const r1 = await fetch(`${API}/group-addresses`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                address: ikoAddr,
                name: `${sourceName} ${sourceKey}`,
                is_internal: true,
                enabled: true
            })
        });
        console.log('IKO create response:', r1.status, await r1.text().catch(()=>''));
        
        // 2. Bind source output to IKO
        const r2 = await fetch(`${API}/logic/blocks/${sourceBlock}/bind-output`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ output_key: sourceKey, address: ikoAddr })
        });
        console.log('Output bind response:', r2.status, await r2.clone().text().catch(()=>''));
        if (!r2.ok) {
            showAlert('error', 'Ausgang-Binding fehlgeschlagen');
            return;
        }
        
        // 3. Bind target input to same IKO
        const r3 = await fetch(`${API}/logic/blocks/${targetBlock}/bind`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ input_key: targetKey, address: ikoAddr })
        });
        console.log('Input bind response:', r3.status, await r3.clone().text().catch(()=>''));
        if (!r3.ok) {
            showAlert('error', 'Eingang-Binding fehlgeschlagen');
            return;
        }
        
        showAlert('success', `✓ Verbindung erstellt: ${ikoAddr}`);
        
        // Reload and redraw
        await loadBlocks(true);
        await loadAddresses();
        
        // Redraw wires after data is loaded
        setTimeout(() => {
            console.log('Redrawing wires. Blocks:', blocks.map(b => ({id: b.instance_id, in: b.input_bindings, out: b.output_bindings})));
            drawWires();
        }, 500);
        
    } catch(err) {
        console.error('Wire connection error:', err);
        showAlert('error', 'Verbindung fehlgeschlagen: ' + err.message);
    }
}

function drawWires() {
    const svg = document.getElementById('wiresCanvas');
    if (!svg) {
        console.log('drawWires: No SVG canvas found');
        return;
    }
    
    // Clear existing wires (except temp wire)
    svg.querySelectorAll('path:not([stroke-dasharray])').forEach(p => p.remove());
    
    const container = document.getElementById('logicBlocksContainer');
    if (!container) return;
    
    // Calculate required SVG size based on block positions
    let maxX = 1000, maxY = 800;
    document.querySelectorAll('.eblock').forEach(block => {
        const right = block.offsetLeft + block.offsetWidth + 50;
        const bottom = block.offsetTop + block.offsetHeight + 50;
        if (right > maxX) maxX = right;
        if (bottom > maxY) maxY = bottom;
    });
    svg.style.width = maxX + 'px';
    svg.style.height = maxY + 'px';
    
    // Find all connections: output bindings that match input bindings
    const connections = [];
    
    blocks.forEach(srcBlock => {
        const outBindings = srcBlock.output_bindings || {};
        Object.entries(outBindings).forEach(([outKey, addr]) => {
            if (!addr) return;
            
            // Find blocks with inputs bound to same address
            blocks.forEach(tgtBlock => {
                if (tgtBlock.instance_id === srcBlock.instance_id) return;
                
                const inBindings = tgtBlock.input_bindings || {};
                Object.entries(inBindings).forEach(([inKey, inAddr]) => {
                    if (inAddr === addr) {
                        connections.push({
                            srcBlock: srcBlock.instance_id,
                            srcKey: outKey,
                            tgtBlock: tgtBlock.instance_id,
                            tgtKey: inKey,
                            addr: addr
                        });
                    }
                });
            });
        });
    });
    
    console.log('drawWires: Found', connections.length, 'connections');
    
    // Draw each connection
    connections.forEach(conn => {
        const srcBlockEl = document.getElementById(`block-${conn.srcBlock}`);
        const tgtBlockEl = document.getElementById(`block-${conn.tgtBlock}`);
        if (!srcBlockEl || !tgtBlockEl) {
            console.log('drawWires: Block elements not found', conn.srcBlock, conn.tgtBlock);
            return;
        }
        
        const srcPin = srcBlockEl.querySelector(`.eblock-port.output[data-key="${conn.srcKey}"]`);
        const tgtPin = tgtBlockEl.querySelector(`.eblock-port.input[data-key="${conn.tgtKey}"]`);
        if (!srcPin || !tgtPin) {
            console.log('drawWires: Pins not found', conn.srcKey, conn.tgtKey);
            return;
        }
        
        // Get pin positions relative to their block
        const srcPinRect = srcPin.getBoundingClientRect();
        const tgtPinRect = tgtPin.getBoundingClientRect();
        const srcBlockRect = srcBlockEl.getBoundingClientRect();
        const tgtBlockRect = tgtBlockEl.getBoundingClientRect();
        
        // Calculate positions in container coordinates
        const x1 = srcBlockEl.offsetLeft + (srcPinRect.left - srcBlockRect.left) + srcPinRect.width / 2;
        const y1 = srcBlockEl.offsetTop + (srcPinRect.top - srcBlockRect.top) + srcPinRect.height / 2;
        const x2 = tgtBlockEl.offsetLeft + (tgtPinRect.left - tgtBlockRect.left) + tgtPinRect.width / 2;
        const y2 = tgtBlockEl.offsetTop + (tgtPinRect.top - tgtBlockRect.top) + tgtPinRect.height / 2;
        
        // Draw bezier curve
        const dx = Math.abs(x2 - x1);
        const controlOffset = Math.max(40, dx * 0.5);
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('d', `M${x1},${y1} C${x1 + controlOffset},${y1} ${x2 - controlOffset},${y2} ${x2},${y2}`);
        path.setAttribute('class', 'wire-path');
        path.setAttribute('data-conn', `${conn.srcBlock}-${conn.tgtBlock}`);
        
        svg.appendChild(path);
    });
}

// ============ END WIRE SYSTEM ============

function editBinding(blockId,ioType,key,current){
    document.getElementById('bindModalError').style.display='none';
    
    // Refresh addresses before showing dialog
    loadAddresses();
    
    // Find current block to get current value
    const block = blocks.find(b => b.instance_id === blockId);
    const currentValue = block ? (ioType === 'input' ? block.input_values?.[key] : block.output_values?.[key]) : '';
    
    // Build list of other blocks' outputs for direct connection (only for inputs)
    let blockOutputs = [];
    if (ioType === 'input') {
        const otherBlocks = blocks.filter(b => b.instance_id !== blockId);
        blockOutputs = otherBlocks.flatMap(b => 
            Object.keys(b.outputs||{}).map(ok => ({
                addr: `BLOCK:${b.instance_id}:${ok}`,
                label: `${b.name||b.block_type}.${ok}`,
                val: b.output_values?.[ok]
            }))
        );
    }
    
    // Combine all addresses (KNX + IKO)
    const allAddrs = [...addresses, ...internalAddrs];
    
    let html = `<div class="form-group">
        <label class="form-label">${ioType==='output'?'Ausgang':'Eingang'} ${key}</label>`;
    
    // Only show direct value input for inputs
    if (ioType === 'input') {
        html += `<div style="margin-bottom:12px">
            <label class="form-label" style="font-size:11px;color:var(--text-muted)">Direkter Wert (für statische Konfiguration)</label>
            <input id="directValue" value="${currentValue !== null && currentValue !== undefined ? String(currentValue).replace(/"/g,'&quot;') : ''}" placeholder="Wert direkt eingeben...">
        </div>`;
    } else {
        html += `<div style="margin-bottom:12px;padding:8px;background:var(--sidebar);border-radius:6px">
            <label class="form-label" style="font-size:11px;color:var(--text-muted)">Aktueller Wert:</label>
            <div style="font-family:monospace;color:var(--success)">${currentValue !== null && currentValue !== undefined ? String(currentValue) : '-'}</div>
        </div>`;
    }
    
    html += `<div>
            <label class="form-label" style="font-size:11px;color:var(--text-muted)">Binding an KNX/IKO Adresse ${ioType==='output'?'(schreibt Wert auf Adresse)':'(liest Wert von Adresse)'}</label>
            <input id="bindValue" value="${current||''}" list="addr-list" placeholder="z.B. 1/2/3 oder INT/name">
        </div>
    </div>
    <div style="margin-top:8px">
        <input type="text" id="bindAddrFilter" placeholder="🔍 Adressen filtern..." oninput="filterBindAddresses()" style="font-size:11px;padding:6px 10px">
    </div>
    <div id="bindAddrList" style="margin-top:8px;max-height:200px;overflow-y:auto;background:var(--sidebar);border-radius:6px;padding:8px;font-size:11px">
        <div style="color:var(--text-muted);font-size:10px;margin-bottom:4px;display:flex;justify-content:space-between">
            <span>📍 KNX Adressen (${addresses.length})</span>
            <span style="color:var(--purple)">🔗 IKO (${internalAddrs.length})</span>
        </div>
        ${allAddrs.map(a=>{
            const isInternal=a.is_internal||a.address.startsWith('INT/');
            return `<div class="bind-addr-item" data-addr="${a.address}" data-name="${(a.name||'').toLowerCase()}" style="padding:4px 6px;cursor:pointer;border-radius:4px;display:flex;justify-content:space-between;border-bottom:1px solid var(--border)" onmouseover="this.style.background='var(--card-hover)'" onmouseout="this.style.background=''" onclick="document.getElementById('bindValue').value='${a.address}'">
                <code style="color:${isInternal?'var(--purple)':'var(--accent)'}">${a.address}</code>
                <span style="color:var(--text-muted);font-size:10px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:150px">${a.name||''}</span>
            </div>`;
        }).join('')}
        ${blockOutputs.length ? `<div style="color:var(--text-muted);font-size:10px;margin:12px 0 4px 0;padding-top:8px;border-top:1px solid var(--border)">🧩 Bausteinausgänge (${blockOutputs.length}):</div>` : ''}
        ${blockOutputs.map(o=>`<div class="bind-addr-item" data-addr="${o.addr}" data-name="${o.label.toLowerCase()}" style="padding:4px 6px;cursor:pointer;border-radius:4px;display:flex;justify-content:space-between" onmouseover="this.style.background='var(--card-hover)'" onmouseout="this.style.background=''" onclick="document.getElementById('bindValue').value='${o.addr}'"><code style="color:var(--success)">${o.label}</code><span style="color:var(--text-muted)">${o.val??'-'}</span></div>`).join('')}
    </div>
    <div style="margin-top:16px;display:flex;gap:8px;flex-wrap:wrap">`;
    
    if (ioType === 'input') {
        html += `<button class="btn btn-primary" onclick="saveInputValue('${blockId}','${key}')">💾 Wert speichern</button>`;
    }
    html += `<button class="btn btn-success" onclick="saveBind('${blockId}','${ioType}','${key}')">🔗 Binding speichern</button>
        <button class="btn btn-danger" onclick="saveBind('${blockId}','${ioType}','${key}',true)">🗑 Entfernen</button>
    </div>`;
    
    document.getElementById('bindContent').innerHTML = html;
    showModal('bindModal');
}

function filterBindAddresses(){
    const filter=document.getElementById('bindAddrFilter').value.toLowerCase();
    document.querySelectorAll('.bind-addr-item').forEach(el=>{
        const addr=el.dataset.addr.toLowerCase();
        const name=el.dataset.name||'';
        el.style.display=(addr.includes(filter)||name.includes(filter))?'flex':'none';
    });
}

async function saveInputValue(blockId, key) {
    const val = document.getElementById('directValue').value;
    const errEl = document.getElementById('bindModalError');
    
    try {
        const r = await fetch(`${API}/logic/blocks/${blockId}/input/${key}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({value: val})
        });
        if (!r.ok) {
            const d = await r.json();
            errEl.textContent = getErrMsg(d);
            errEl.style.display = 'block';
            return;
        }
        hideModal('bindModal');
        loadBlocks(true);
        showAlert('success', '✓ Wert gespeichert');
    } catch(e) {
        errEl.textContent = getErrMsg(e);
        errEl.style.display = 'block';
    }
}

async function saveBind(blockId,ioType,key,remove=false){
    const val=remove?'':document.getElementById('bindValue').value;
    const errEl=document.getElementById('bindModalError');
    const endpoint=ioType==='input'?`${API}/logic/blocks/${blockId}/bind`:`${API}/logic/blocks/${blockId}/bind-output`;
    const body=ioType==='input'?{input_key:key,address:val}:{output_key:key,address:val};
    
    try{
        const r=await fetch(endpoint,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
        if(!r.ok){const d=await r.json();errEl.textContent=getErrMsg(d);errEl.style.display='block';return;}
        hideModal('bindModal');loadBlocks(true);showAlert('success',remove?'✓ Entfernt':'✓ Gespeichert');
    }catch(e){errEl.textContent=getErrMsg(e);errEl.style.display='block';}
}

async function addBlock(){
    const type=document.getElementById('blockType').value;
    if(!type){showAlert('error','Bitte Bausteintyp wählen');return;}
    
    const body={block_type:type};
    if(currentPage!=='default')body.page_id=currentPage;
    
    console.log('Creating block:',body);
    
    try{
        const r=await fetch(`${API}/logic/blocks`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
        const d=await r.json();
        console.log('Response:',r.status,d);
        
        if(r.ok){
            showAlert('success','✓ Baustein erstellt');
            loadBlocks(true);
        }else{
            showAlert('error','Fehler: '+getErrMsg(d));
        }
    }catch(e){
        console.error('addBlock error:',e);
        showAlert('error','Fehler: '+getErrMsg(e));
    }
}

async function delBlock(id){if(!confirm('Löschen?'))return;await fetch(`${API}/logic/blocks/${id}`,{method:'DELETE'});delete blockPositions[id];loadBlocks(true);}
async function toggleBlock(id,en){await fetch(`${API}/logic/blocks/${id}/enable?enabled=${en}`,{method:'POST'});loadBlocks(true);}
async function triggerBlock(id){try{await fetch(`${API}/logic/blocks/${id}/trigger`,{method:'POST'});showAlert('success','✓ Ausgeführt');}catch(e){showAlert('error',getErrMsg(e));}loadBlocks();}

async function showBlockDebug(id){
    try{
        const r=await fetch(`${API}/logic/blocks/${id}/debug`);
        const d=await r.json();
        document.getElementById('debugContent').value=JSON.stringify(d,null,2);
        showModal('debugModal');
    }catch(e){document.getElementById('debugContent').value='Error: '+e;showModal('debugModal');}
}

async function addPage(){
    const nameEl=document.getElementById('pageName');
    const errEl=document.getElementById('pageModalError');
    const name=nameEl.value.trim();
    errEl.style.display='none';
    
    if(!name){errEl.textContent='Bitte Namen eingeben';errEl.style.display='block';return;}
    
    const body={name:name};
    console.log('Creating page:',body);
    
    try{
        const r=await fetch(`${API}/logic/pages`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
        const text=await r.text();
        console.log('Response:',r.status,text);
        
        if(!r.ok){
            let msg='HTTP '+r.status;
            try{msg=getErrMsg(JSON.parse(text));}catch{}
            errEl.textContent=msg;errEl.style.display='block';
            return;
        }
        
        hideModal('pageModal');
        nameEl.value='';
        await loadPages();
        showAlert('success','✓ Seite erstellt');
    }catch(e){
        console.error('addPage error:',e);
        errEl.textContent=getErrMsg(e);errEl.style.display='block';
    }
}

async function deletePage(id){if(!confirm('Löschen?'))return;await fetch(`${API}/logic/pages/${id}`,{method:'DELETE'});if(currentPage===id)currentPage='default';loadPages();loadBlocks(true);}

async function addInt(){
    const addr=document.getElementById('intAddr').value.trim();
    const name=document.getElementById('intName').value.trim();
    const dpt=document.getElementById('intDpt').value.trim();
    const initial=document.getElementById('intInitial').value.trim();
    if(!addr){showAlert('error','Bitte Adresse eingeben');return;}
    await fetch(`${API}/group-addresses`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({address:addr,name:name||addr,dpt:dpt||null,is_internal:true,initial_value:initial||null})});
    hideModal('intModal');document.getElementById('intAddr').value='';document.getElementById('intName').value='';document.getElementById('intDpt').value='';document.getElementById('intInitial').value='';
    loadAddresses();showAlert('success','✓ IKO erstellt');
}
async function delAddr(addr){
    if(!confirm(`Adresse "${addr}" löschen?`))return;
    try {
        const r=await fetch(`${API}/group-addresses/${encodeURIComponent(addr)}`,{method:'DELETE'});
        if(r.ok){
            showAlert('success', 'Adresse gelöscht');
        } else {
            const e=await r.json().catch(()=>({}));
            showAlert('error', 'Fehler: '+(e.detail||r.statusText));
        }
    } catch(e) {
        showAlert('error', 'Verbindungsfehler: ' + e.message);
    }
    loadAddresses();
}
async function setVal(addr){const val=prompt('Neuer Wert:');if(val===null)return;await fetch(`${API}/group-addresses/${encodeURIComponent(addr)}/value`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({value:val})});loadAddresses();}

// IKO Value Edit Functions
function editIkoValue(addr,name){
    document.getElementById('ikoValueAddr').value=addr;
    document.getElementById('ikoValueTitle').textContent='Wert setzen: '+(name||addr);
    const current=internalAddrs.find(a=>a.address===addr);
    document.getElementById('ikoValueInput').value=current?.last_value??'';
    showModal('ikoValueModal');
}

async function saveIkoValue(){
    const addr=document.getElementById('ikoValueAddr').value;
    const val=document.getElementById('ikoValueInput').value;
    try{
        await fetch(`${API}/group-addresses/${encodeURIComponent(addr)}/value`,{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({value:val})
        });
        closeModal('ikoValueModal');
        loadInternal();
        showAlert('success','Wert gespeichert');
    }catch(e){showAlert('error','Fehler: '+e.message);}
}

function editIkoInitial(addr,name,currentInit){
    document.getElementById('ikoInitialAddr').value=addr;
    document.getElementById('ikoInitialTitle').textContent='Initial-Wert: '+(name||addr);
    document.getElementById('ikoInitialInput').value=currentInit||'';
    showModal('ikoInitialModal');
}

async function saveIkoInitial(){
    const addr=document.getElementById('ikoInitialAddr').value;
    const val=document.getElementById('ikoInitialInput').value;
    try{
        // Update the address with initial_value
        const current=internalAddrs.find(a=>a.address===addr);
        await fetch(`${API}/group-addresses/${encodeURIComponent(addr)}`,{
            method:'PUT',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({
                address:addr,
                name:current?.name||'',
                dpt:current?.dpt||null,
                enabled:true,
                initial_value:val||null
            })
        });
        closeModal('ikoInitialModal');
        loadInternal();
        showAlert('success','Initial-Wert gespeichert');
    }catch(e){showAlert('error','Fehler: '+e.message);}
}

function editAddr(addr,name,dpt){
    document.getElementById('editAddrError').style.display='none';
    document.getElementById('editAddrOrig').value=addr;
    document.getElementById('editAddrAddr').value=addr;
    document.getElementById('editAddrName').value=name||'';
    document.getElementById('editAddrDpt').value=dpt||'';
    showModal('editAddrModal');
}

async function saveAddr(){
    const addr=document.getElementById('editAddrOrig').value;
    const name=document.getElementById('editAddrName').value.trim();
    const dpt=document.getElementById('editAddrDpt').value.trim()||null;
    
    try{
        const r=await fetch(`${API}/group-addresses/${encodeURIComponent(addr)}`,{
            method:'PUT',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({address:addr,name:name,dpt:dpt,enabled:true})
        });
        if(!r.ok){
            const e=await r.json().catch(()=>({}));
            document.getElementById('editAddrError').textContent='Fehler: '+(e.detail||r.statusText);
            document.getElementById('editAddrError').style.display='block';
            return;
        }
        hideModal('editAddrModal');
        loadAddresses();
    }catch(e){
        document.getElementById('editAddrError').textContent='Fehler: '+e.message;
        document.getElementById('editAddrError').style.display='block';
    }
}

function showValuePopup(key, name, value) {
    document.getElementById('valueModalLabel').textContent = `${key}: ${name}`;
    
    // Try to format JSON nicely
    let displayValue = value;
    try {
        if (value && (value.startsWith('[') || value.startsWith('{'))) {
            displayValue = JSON.stringify(JSON.parse(value), null, 2);
        }
    } catch(e) {}
    
    document.getElementById('valueModalContent').value = displayValue;
    showModal('valueModal');
}

function copyValueToClipboard() {
    const content = document.getElementById('valueModalContent');
    content.select();
    document.execCommand('copy');
    showAlert('success', '✓ In Zwischenablage kopiert');
}

// Multi-select for addresses
let selectedAddrs = new Set();

function toggleAddrSelect(addr, checked) {
    if (checked) selectedAddrs.add(addr);
    else selectedAddrs.delete(addr);
    updateDeleteSelectedBtn();
}

function toggleAllAddrs(checked) {
    const checkboxes = document.querySelectorAll('#addrTable input[type="checkbox"]');
    checkboxes.forEach(cb => {
        cb.checked = checked;
        if (checked) selectedAddrs.add(cb.dataset.addr);
        else selectedAddrs.delete(cb.dataset.addr);
    });
    updateDeleteSelectedBtn();
}

function updateDeleteSelectedBtn() {
    const btn = document.getElementById('deleteSelectedBtn');
    if (btn) btn.style.display = selectedAddrs.size > 0 ? 'inline-block' : 'none';
}

async function deleteSelectedAddrs() {
    if (selectedAddrs.size === 0) return;
    if (!confirm(`${selectedAddrs.size} Adresse(n) löschen?`)) return;
    
    for (const addr of selectedAddrs) {
        await fetch(`${API}/group-addresses/${encodeURIComponent(addr)}`, {method: 'DELETE'});
    }
    selectedAddrs.clear();
    loadAddresses();
    showAlert('success', '✓ Adressen gelöscht');
}

async function uploadEsf(){
    const file=document.getElementById('esfFile').files[0];
    if(!file)return;
    const password=document.getElementById('importPassword').value;
    const form=new FormData();
    form.append('file',file);
    
    let url=`${API}/import/esf`;
    if(password){
        url+=`?password=${encodeURIComponent(password)}`;
    }
    
    showAlert('info','Importiere...');
    try{
        const r=await fetch(url,{method:'POST',body:form});
        const d=await r.json();
        showAlert(r.ok?'success':'error',d.message||getErrMsg(d));
        document.getElementById('esfFile').value='';
    }catch(e){
        showAlert('error',getErrMsg(e));
    }
    loadAddresses();
}
async function uploadUpdate(){const file=document.getElementById('updateFile').files[0];if(!file)return;const form=new FormData();form.append('file',file);showAlert('info','Wird hochgeladen...');try{const r=await fetch(`${API}/system/update/upload`,{method:'POST',body:form});const d=await r.json();showAlert(r.ok?'success':'error',d.message||getErrMsg(d));}catch(e){showAlert('error',getErrMsg(e));}}

async function checkVersion(){
    const info=document.getElementById('versionInfo');
    const ver=document.getElementById('currentVersion');
    info.style.display='block';
    ver.textContent='Lädt...';
    try{
        const r=await fetch(`${API}/status`);
        const d=await r.json();
        ver.textContent=d.version||'2.0.8';
    }catch(e){
        ver.textContent='Fehler';
    }
}
async function restartSystem(){if(!confirm('Neustarten?'))return;showAlert('info','Wird neugestartet...');try{await fetch(`${API}/system/restart`,{method:'POST'});setTimeout(()=>location.reload(),5000);}catch(e){showAlert('error',getErrMsg(e));}}
async function uploadBlock(){
    const fileInput = document.getElementById('blockUpload');
    const file = fileInput.files[0];
    if(!file) return;
    
    const form = new FormData();
    form.append('file', file);
    
    showAlert('info', 'Wird hochgeladen...');
    
    try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000);
        
        const r = await fetch(`${API}/logic/custom-blocks/upload`, {
            method: 'POST',
            body: form,
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        const d = await r.json();
        showAlert(r.ok ? 'success' : 'error', d.message || d.detail || 'Unbekannter Fehler');
    } catch(e) {
        if (e.name === 'AbortError') {
            showAlert('error', 'Timeout - Server antwortet nicht');
        } else {
            showAlert('error', 'Verbindungsfehler: ' + (e.message || 'Server nicht erreichbar'));
        }
    }
    
    fileInput.value = '';
    loadFiles();
    await loadAvail();
    loadBlocks(true);  // Blöcke neu rendern
}

async function downloadBackup() {
    showAlert('info', 'Backup wird erstellt...');
    try {
        const r = await fetch(`${API}/system/backup`);
        if (!r.ok) throw new Error('Backup fehlgeschlagen');
        const blob = await r.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `knx-backup-${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        showAlert('success', '✓ Backup heruntergeladen');
    } catch(e) {
        showAlert('error', 'Backup Fehler: ' + getErrMsg(e));
    }
}

async function uploadBackup() {
    const file = document.getElementById('backupFile').files[0];
    if (!file) return;
    if (!confirm('Alle aktuellen Einstellungen werden überschrieben. Fortfahren?')) {
        document.getElementById('backupFile').value = '';
        return;
    }
    
    showAlert('info', 'Backup wird wiederhergestellt...');
    const form = new FormData();
    form.append('file', file);
    
    try {
        const r = await fetch(`${API}/system/restore`, {method: 'POST', body: form});
        const d = await r.json();
        if (r.ok) {
            showAlert('success', '✓ Backup wiederhergestellt! Seite wird neu geladen...');
            setTimeout(() => location.reload(), 2000);
        } else {
            showAlert('error', 'Fehler: ' + (d.detail || d.message || 'Unbekannt'));
        }
    } catch(e) {
        showAlert('error', 'Restore Fehler: ' + getErrMsg(e));
    }
    document.getElementById('backupFile').value = '';
}

async function editCode(fn){try{const r=await fetch(`${API}/logic/custom-blocks/${fn}/code`);const d=await r.json();document.getElementById('codeFileName').textContent=fn;document.getElementById('codeEditor').value=d.code;showModal('codeModal');}catch(e){showAlert('error',getErrMsg(e));}}
async function saveCode(){const fn=document.getElementById('codeFileName').textContent;const code=document.getElementById('codeEditor').value;await fetch(`${API}/logic/custom-blocks/${fn}/code`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({code})});hideModal('codeModal');showAlert('success','✓ Gespeichert');await loadAvail();loadBlocks(true);}
function newBlockFile(){const name=prompt('Dateiname (ohne .py):');if(!name)return;document.getElementById('codeFileName').textContent=name+'.py';document.getElementById('codeEditor').value=`from logic.base import LogicBlock\n\nclass MyBlock(LogicBlock):\n    ID = 99999\n    NAME = "Mein Baustein"\n    CATEGORY = "Eigene"\n    INPUTS = {'E1': {'name': 'Eingang', 'type': 'float'}}\n    OUTPUTS = {'A1': {'name': 'Ausgang', 'type': 'float'}}\n    \n    def on_input_change(self, key, value, old):\n        self.set_output('A1', value)\n`;showModal('codeModal');}
async function delFile(fn){if(!confirm('Löschen?'))return;await fetch(`${API}/logic/custom-blocks/${fn}`,{method:'DELETE'});loadFiles();loadAvail();}

async function loadLogs(){
    try{
        const level=document.getElementById('logLevel').value;
        const logs=await(await fetch(`${API}/logs?limit=100${level?'&level='+level:''}`)).json();
        document.getElementById('logContainer').innerHTML=logs.length?logs.map(l=>`<div class="log-entry"><span class="log-time">${new Date(l.time*1000).toLocaleTimeString('de-DE')}</span><span class="log-level ${l.level}">${l.level}</span>${l.message}</div>`).join(''):'<div class="empty">Keine Logs</div>';
    }catch(e){document.getElementById('logContainer').innerHTML='<div class="empty">Fehler</div>';}
}

// ========== VISU FUNCTIONS ==========
function setVisuSize(w,h){
    const canvas=document.getElementById('visuCanvas');
    document.querySelectorAll('.visu-size-btns button').forEach(b=>b.classList.remove('active'));
    event.target.classList.add('active');
    canvas.className='visu-canvas';
    if(w===0){canvas.classList.add('fullsize');}
    else if(w===375){canvas.classList.add('phone');}
    else if(w===768){canvas.classList.add('tablet');}
    else if(w===1920){canvas.classList.add('desktop');}
    else{canvas.style.width=w+'px';canvas.style.height=h+'px';}
}

function toggleVisuEdit(){
    visuEditMode=!visuEditMode;
    document.querySelectorAll('.visu-element').forEach(el=>el.classList.toggle('editing',visuEditMode));
    event.target.textContent=visuEditMode?'✓ Fertig':'✏️ Bearbeiten';
    event.target.classList.toggle('btn-success',visuEditMode);
    event.target.classList.toggle('btn-secondary',!visuEditMode);
}

function showVisuLink(){
    const baseUrl = window.location.origin;
    const pageId = currentVisuPage || 'default';
    const link = `${baseUrl}/api/v1/visu/view/${pageId}`;
    
    const html = `
        <div style="margin-bottom:16px">
            <p style="margin-bottom:12px">Öffne diesen Link auf deinem Handy oder Tablet:</p>
            <div style="display:flex;gap:8px;align-items:center">
                <input id="visuLinkInput" value="${link}" readonly style="flex:1;font-family:monospace;font-size:11px">
                <button class="btn btn-primary" onclick="copyVisuLink()">📋 Kopieren</button>
            </div>
        </div>
        <div style="margin-bottom:16px">
            <p style="margin-bottom:8px;font-size:12px;color:var(--text-muted)"><b>Tipps:</b></p>
            <ul style="font-size:12px;color:var(--text-muted);padding-left:20px;line-height:1.6">
                <li><b>iOS:</b> Safari öffnen → Teilen → "Zum Home-Bildschirm"</li>
                <li><b>Android:</b> Chrome öffnen → Menü (⋮) → "Zum Startbildschirm hinzufügen"</li>
                <li><b>Vollbild:</b> Oben rechts auf ⛶ tippen</li>
            </ul>
        </div>
        <div>
            <p style="margin-bottom:8px;font-size:12px;color:var(--text-muted)"><b>Verfügbare Seiten:</b></p>
            <div style="display:flex;flex-wrap:wrap;gap:8px">
                ${Object.values(visuPages).map(p => `
                    <a href="${baseUrl}/api/v1/visu/view/${p.id}" target="_blank" class="btn btn-sm btn-secondary">${p.name}</a>
                `).join('')}
            </div>
        </div>
    `;
    
    // Create modal dynamically
    let modal = document.getElementById('visuLinkModal');
    if(!modal){
        modal = document.createElement('div');
        modal.id = 'visuLinkModal';
        modal.className = 'modal';
        modal.innerHTML = `<div class="modal-content"><div class="modal-header"><span class="modal-title">📱 Visu-Link für Handy/Tablet</span><button class="modal-close" onclick="hideModal('visuLinkModal')">×</button></div><div class="modal-body" id="visuLinkContent"></div><div class="modal-footer"><button class="btn btn-secondary" onclick="hideModal('visuLinkModal')">Schließen</button></div></div>`;
        document.body.appendChild(modal);
    }
    document.getElementById('visuLinkContent').innerHTML = html;
    showModal('visuLinkModal');
}

function copyVisuLink(){
    const input = document.getElementById('visuLinkInput');
    input.select();
    document.execCommand('copy');
    showAlert('success', 'Link kopiert!');
}

function openVisuFullscreen(){
    const container=document.getElementById('visuContainer');
    if(container.requestFullscreen)container.requestFullscreen();
    else if(container.webkitRequestFullscreen)container.webkitRequestFullscreen();
}

function showAddWidgetModal(){
    document.getElementById('visuWidgetLabel').value='';
    updateVisuWidgetForm();
    showModal('visuWidgetModal');
}

function updateVisuWidgetForm(){
    const type=document.getElementById('visuWidgetType').value;
    let html='';
    const addrOpts=allAddresses.map(a=>`<option value="${a.address}">${a.name||a.address}</option>`).join('');
    
    if(type==='switch'){
        html=`<div class="form-group"><label class="form-label">Schalt-Adresse</label><select id="vwAddr1"><option value="">-- Auswählen --</option>${addrOpts}</select></div>
              <div class="form-group"><label class="form-label">Status-Adresse (optional)</label><select id="vwAddr2"><option value="">-- Gleiche --</option>${addrOpts}</select></div>
              <div class="form-group"><label class="form-label">Icon</label><select id="vwIcon"><option value="💡">💡 Lampe</option><option value="🔌">🔌 Steckdose</option><option value="🚿">🚿 Bad</option><option value="🍳">🍳 Küche</option><option value="⚡">⚡ Strom</option></select></div>`;
    }else if(type==='dimmer'){
        html=`<div class="form-group"><label class="form-label">Dimm-Adresse (0-100%)</label><select id="vwAddr1"><option value="">-- Auswählen --</option>${addrOpts}</select></div>
              <div class="form-group"><label class="form-label">Icon</label><select id="vwIcon"><option value="💡">💡 Lampe</option><option value="🔆">🔆 Leuchte</option></select></div>`;
    }else if(type==='value'){
        html=`<div class="form-group"><label class="form-label">Wert-Adresse</label><select id="vwAddr1"><option value="">-- Auswählen --</option>${addrOpts}</select></div>
              <div class="form-group"><label class="form-label">Einheit</label><input id="vwUnit" placeholder="z.B. °C, %, kW"></div>
              <div class="form-group"><label class="form-label">Typ</label><select id="vwSubtype"><option value="">Standard</option><option value="temp">🌡️ Temperatur</option><option value="hum">💧 Feuchtigkeit</option><option value="power">⚡ Leistung</option></select></div>`;
    }else if(type==='shutter'){
        html=`<div class="form-group"><label class="form-label">Position-Adresse (0-100%)</label><select id="vwAddr1"><option value="">-- Auswählen --</option>${addrOpts}</select></div>
              <div class="form-group"><label class="form-label">Auf/Ab-Adresse</label><select id="vwAddr2"><option value="">-- Auswählen --</option>${addrOpts}</select></div>`;
    }else if(type==='scene'){
        html=`<div class="form-group"><label class="form-label">Szenen-Adresse</label><select id="vwAddr1"><option value="">-- Auswählen --</option>${addrOpts}</select></div>
              <div class="form-group"><label class="form-label">Szenen-Nr (Wert)</label><input id="vwSceneNr" type="number" value="1"></div>
              <div class="form-group"><label class="form-label">Icon</label><select id="vwIcon"><option value="🎬">🎬 Szene</option><option value="🌙">🌙 Nacht</option><option value="☀️">☀️ Tag</option><option value="🎉">🎉 Party</option><option value="📺">📺 Kino</option></select></div>`;
    }else if(type==='clock'){
        html=`<p style="color:var(--text-muted)">Zeigt die aktuelle Uhrzeit an.</p>`;
    }else if(type==='label'){
        html=`<div class="form-group"><label class="form-label">Text</label><input id="vwText" placeholder="Mein Text"></div>
              <div class="form-group"><label class="form-label">Schriftgröße</label><select id="vwFontSize"><option value="14">14px</option><option value="18">18px</option><option value="24">24px</option><option value="32">32px</option></select></div>`;
    }else if(type==='navlink'){
        const pageOpts=Object.values(visuPages).map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
        html=`<div class="form-group"><label class="form-label">Zielseite</label><select id="vwTargetPage">${pageOpts}</select></div>
              <div class="form-group"><label class="form-label">Icon (MDI Name)</label><input id="vwIcon" value="arrow-right-circle" placeholder="z.B. home, arrow-right"></div>
              <div class="form-group"><label class="form-label">Stil</label><select id="vwStyle">
                <option value="button">Button</option>
                <option value="card">Karte</option>
                <option value="text">Nur Text</option>
                <option value="icon">Nur Icon</option>
              </select></div>`;
    }else if(type==='navmenu'){
        html=`<div class="form-group"><label class="form-label">Navigation Modus</label><select id="vwNavMode">
                <option value="all">Alle Seiten</option>
                <option value="root">Nur Hauptseiten</option>
                <option value="siblings">Gleiche Ebene (Geschwister)</option>
                <option value="children">Unterseiten (mit Zurück-Button)</option>
              </select></div>
              <div class="form-group"><label class="form-label">Position</label><select id="vwPosition">
                <option value="left">Links</option>
                <option value="bottom">Unten</option>
                <option value="top">Oben</option>
              </select></div>
              <div class="form-group"><label class="form-label">Stil</label><select id="vwStyle">
                <option value="icons">Icons + Text</option>
                <option value="text">Nur Text</option>
                <option value="dots">Punkte</option>
              </select></div>
              <p style="color:var(--text-muted);font-size:11px;margin-top:8px">
                <b>Alle Seiten:</b> Zeigt die gesamte Navigation<br>
                <b>Nur Hauptseiten:</b> Zeigt nur Seiten ohne Übergeordnete<br>
                <b>Gleiche Ebene:</b> Zeigt Seiten mit gleichem Parent<br>
                <b>Unterseiten:</b> Zeigt Kinder der aktuellen Seite + Zurück
              </p>`;
    }
    document.getElementById('visuWidgetFields').innerHTML=html;
}

function addVisuWidget(){
    const type=document.getElementById('visuWidgetType').value;
    const label=document.getElementById('visuWidgetLabel').value||'Widget';
    const widget={
        id:'w'+Date.now(),
        type:type,
        label:label,
        x:50,y:50
    };
    
    if(type==='switch'){
        widget.addr=document.getElementById('vwAddr1').value;
        widget.statusAddr=document.getElementById('vwAddr2').value||widget.addr;
        widget.icon=document.getElementById('vwIcon').value;
    }else if(type==='dimmer'){
        widget.addr=document.getElementById('vwAddr1').value;
        widget.icon=document.getElementById('vwIcon').value;
    }else if(type==='value'){
        widget.addr=document.getElementById('vwAddr1').value;
        widget.unit=document.getElementById('vwUnit').value;
        widget.subtype=document.getElementById('vwSubtype').value;
    }else if(type==='shutter'){
        widget.posAddr=document.getElementById('vwAddr1').value;
        widget.moveAddr=document.getElementById('vwAddr2').value;
    }else if(type==='scene'){
        widget.addr=document.getElementById('vwAddr1').value;
        widget.sceneNr=document.getElementById('vwSceneNr').value;
        widget.icon=document.getElementById('vwIcon').value;
    }else if(type==='label'){
        widget.text=document.getElementById('vwText')?.value||label;
        widget.fontSize=document.getElementById('vwFontSize')?.value||'14';
    }else if(type==='navlink'){
        widget.targetPage=document.getElementById('vwTargetPage')?.value||'default';
        widget.icon=document.getElementById('vwIcon')?.value||'arrow-right-circle';
        widget.style=document.getElementById('vwStyle')?.value||'button';
        widget.width=120;
        widget.height=40;
    }else if(type==='navmenu'){
        widget.navMode=document.getElementById('vwNavMode')?.value||'all';
        widget.position=document.getElementById('vwPosition')?.value||'bottom';
        widget.style=document.getElementById('vwStyle')?.value||'icons';
        widget.width=300;
        widget.height=60;
    }
    
    visuPages[currentVisuPage].widgets.push(widget);
    saveVisuConfig();
    renderVisuPage();
    hideModal('visuWidgetModal');
}

function renderVisuPage(){
    const page=visuPages[currentVisuPage];
    if(!page)return;
    
    const canvas=document.getElementById('visuCanvas');
    let html='';
    
    (page.widgets||[]).forEach(w=>{
        const editClass=visuEditMode?'editing':'';
        html+=`<div class="visu-element ${editClass}" id="ve-${w.id}" style="left:${w.x}px;top:${w.y}px" 
                    onmousedown="startVisuDrag(event,'${w.id}')" ondblclick="editVisuWidget('${w.id}')">
                    ${renderWidget(w)}
                    <div class="resize-handle"></div>
               </div>`;
    });
    
    canvas.innerHTML=html;
    updateVisuValues();
}

function renderWidget(w){
    if(w.type==='switch'){
        const statusAddr = w.statusAddr || w.addr;
        const switchAddr = w.addr;
        const val=getAddrValue(statusAddr);
        const on=val==='1'||val===true||val==='True'||val==='ON';
        return `<div class="ve-switch ${on?'on':''}" onclick="event.stopPropagation();toggleSwitch('${statusAddr}','${switchAddr}')">
                    <span class="icon">${w.icon||'💡'}</span>
                    <span class="label">${w.label}</span>
                </div>`;
    }else if(w.type==='dimmer'){
        const val=parseInt(getAddrValue(w.addr))||0;
        return `<div class="ve-dimmer">
                    <span class="icon">${w.icon||'💡'}</span>
                    <div class="slider-v" onclick="event.stopPropagation();setDimmer('${w.addr}',event)">
                        <div class="slider-fill" style="height:${val}%"></div>
                    </div>
                    <span class="value">${val}%</span>
                </div>`;
    }else if(w.type==='value'){
        const val=getAddrValue(w.addr);
        const numVal=parseFloat(val)||0;
        const display=numVal%1===0?numVal:numVal.toFixed(1);
        return `<div class="ve-value ${w.subtype||''}">
                    <span class="label">${w.label}</span>
                    <span><span class="number">${display}</span><span class="unit">${w.unit||''}</span></span>
                </div>`;
    }else if(w.type==='shutter'){
        const pos=parseInt(getAddrValue(w.posAddr))||0;
        return `<div class="ve-shutter">
                    <div class="preview"><div class="slats" style="height:${pos}%"></div></div>
                    <div class="btns">
                        <button onclick="event.stopPropagation();sendAddr('${w.moveAddr}',0)">▲</button>
                        <button onclick="event.stopPropagation();sendAddr('${w.moveAddr}',2)">◼</button>
                        <button onclick="event.stopPropagation();sendAddr('${w.moveAddr}',1)">▼</button>
                    </div>
                    <span class="label">${w.label}</span>
                </div>`;
    }else if(w.type==='scene'){
        return `<div class="ve-scene" onclick="event.stopPropagation();sendAddr('${w.addr}',${w.sceneNr||1})">
                    <span class="icon">${w.icon||'🎬'}</span>
                    <span class="label">${w.label}</span>
                </div>`;
    }else if(w.type==='clock'){
        return `<div class="ve-clock"><span class="time">${new Date().toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'})}</span></div>`;
    }else if(w.type==='label'){
        return `<div class="ve-label" style="font-size:${w.fontSize||14}px">${w.text||w.label}</div>`;
    }else if(w.type==='navlink'){
        const targetPage = visuPages[w.targetPage];
        const pageName = targetPage?.name || w.targetPage;
        const icon = w.icon || 'arrow-right-circle';
        const style = w.style || 'button';
        
        if(style === 'icon'){
            return `<div class="ve-navlink icon-only" onclick="event.stopPropagation();navigateToPage('${w.targetPage}')" title="${pageName}">
                        <span class="mdi mdi-${icon}"></span>
                    </div>`;
        }else if(style === 'text'){
            return `<div class="ve-navlink text-only" onclick="event.stopPropagation();navigateToPage('${w.targetPage}')">
                        ${w.label || pageName}
                    </div>`;
        }else if(style === 'card'){
            return `<div class="ve-navlink card" onclick="event.stopPropagation();navigateToPage('${w.targetPage}')">
                        <span class="mdi mdi-${icon}"></span>
                        <span class="name">${w.label || pageName}</span>
                    </div>`;
        }else{
            return `<div class="ve-navlink button" onclick="event.stopPropagation();navigateToPage('${w.targetPage}')">
                        <span class="mdi mdi-${icon}"></span>
                        <span>${w.label || pageName}</span>
                    </div>`;
        }
    }else if(w.type==='navmenu'){
        const style = w.style || 'icons';
        const position = w.position || 'bottom';
        const navMode = w.navMode || 'all'; // all, siblings, children, breadcrumb
        
        let pages = [];
        const currentPage = visuPages[currentVisuPage];
        
        if (navMode === 'siblings') {
            // Show pages with same parent
            const parentId = currentPage?.parentPage || '';
            pages = Object.values(visuPages).filter(p => (p.parentPage || '') === parentId);
        } else if (navMode === 'children') {
            // Show child pages of current
            pages = Object.values(visuPages).filter(p => p.parentPage === currentVisuPage);
            // If no children, show siblings instead
            if (pages.length === 0) {
                const parentId = currentPage?.parentPage || '';
                pages = Object.values(visuPages).filter(p => (p.parentPage || '') === parentId);
            }
        } else if (navMode === 'root') {
            // Show only root pages
            pages = Object.values(visuPages).filter(p => !p.parentPage);
        } else {
            // Show all pages
            pages = Object.values(visuPages);
        }
        
        // Add back button if not at root
        let backHtml = '';
        if (currentPage?.parentPage && visuPages[currentPage.parentPage]) {
            const parentPage = visuPages[currentPage.parentPage];
            backHtml = `<span class="nav-item nav-back" onclick="event.stopPropagation();navigateToPage('${currentPage.parentPage}')" title="Zurück zu ${parentPage.name}">
                            <span class="mdi mdi-arrow-left"></span>
                            <span class="name">Zurück</span>
                        </span>`;
        }
        
        let menuHtml = pages.map(p => {
            const isActive = p.id === currentVisuPage;
            const pageIcon = p.icon || 'file-document-outline';
            const hasChildren = Object.values(visuPages).some(c => c.parentPage === p.id);
            const childIndicator = hasChildren ? '<span class="mdi mdi-chevron-right" style="font-size:12px;margin-left:2px"></span>' : '';
            
            if(style === 'dots'){
                return `<span class="nav-dot ${isActive?'active':''}" onclick="event.stopPropagation();navigateToPage('${p.id}')" title="${p.name}"></span>`;
            }else if(style === 'text'){
                return `<span class="nav-item ${isActive?'active':''}" onclick="event.stopPropagation();navigateToPage('${p.id}')">${p.name}${childIndicator}</span>`;
            }else{
                return `<span class="nav-item ${isActive?'active':''}" onclick="event.stopPropagation();navigateToPage('${p.id}')">
                            <span class="mdi mdi-${pageIcon}"></span>
                            <span class="name">${p.name}</span>
                            ${childIndicator}
                        </span>`;
            }
        }).join('');
        
        return `<div class="ve-navmenu ${position} ${style}">${backHtml}${menuHtml}</div>`;
    }
    return `<div>${w.type}</div>`;
}

function getAddrValue(addr){
    if(!addr)return null;
    const a=allAddresses.find(x=>x.address===addr);
    return a?.last_value;
}

function navigateToPage(pageId){
    if(!visuPages[pageId]){
        showAlert('error', 'Seite nicht gefunden: ' + pageId);
        return;
    }
    // Update selector
    document.getElementById('visuPageSelect').value = pageId;
    // Load and render new page
    loadVisuPage(pageId);
    // Update tree view if open
    if(document.getElementById('visuTreePanel')?.classList.contains('show')) {
        renderVisuTree();
    }
}

async function toggleSwitch(statusAddr, switchAddr){
    // statusAddr = Rückmeldeadresse (KO1) - zum Status lesen
    // switchAddr = Schaltadresse (KO2) - zum Senden (optional, wenn nicht angegeben = statusAddr)
    if(!statusAddr) return;
    const sendAddr = switchAddr || statusAddr;
    
    // Lese aktuellen Status von der Rückmeldeadresse
    const addrObj = allAddresses.find(a => a.address === statusAddr);
    const current = addrObj?.last_value ?? addrObj?.value;
    const isCurrentlyOn = current === '1' || current === 1 || current === true || current === 'True' || parseFloat(current) > 0;
    
    // Sende invertierten Wert auf die Schaltadresse
    const newValue = isCurrentlyOn ? 0 : 1;
    console.log('Toggle: Status-Addr:', statusAddr, '=', current, '(isOn:', isCurrentlyOn, ') -> Sende', newValue, 'auf', sendAddr);
    
    // API uses query parameters, not JSON body!
    await fetch(`${API}/knx/send?group_address=${encodeURIComponent(sendAddr)}&value=${newValue}`,{method:'POST'});
    
    // Wait a bit for KNX to update, then reload addresses and update UI
    setTimeout(async ()=>{
        await loadAddresses();
        updateVisuValues();
    }, 500);
}

async function setDimmer(addr,event){
    if(!addr)return;
    const rect=event.currentTarget.getBoundingClientRect();
    const pct=Math.round(100-((event.clientY-rect.top)/rect.height*100));
    const val=Math.max(0,Math.min(100,pct));
    await fetch(`${API}/knx/send?group_address=${encodeURIComponent(addr)}&value=${val}`,{method:'POST'});
    setTimeout(()=>{loadAddresses();updateVisuValues();},500);
}

async function sendAddr(addr,value){
    if(!addr)return;
    await fetch(`${API}/knx/send?group_address=${encodeURIComponent(addr)}&value=${value}`,{method:'POST'});
}

function updateVisuValues(){
    const page=visuPages[currentVisuPage];
    if(!page)return;
    
    page.widgets.forEach(w=>{
        const el=document.getElementById('ve-'+w.id);
        if(!el) return;
        
        // Handle VSE widgets (switch card, sensor card)
        if(w.type === 'vse') {
            const addr = w.ko1 || w.addr;
            if(!addr) return;
            
            const newVal = getAddrValue(addr);
            const numVal = parseFloat(newVal) || 0;
            
            // Find the .vse-widget container
            const vseWidget = el.querySelector('.vse-widget');
            if(!vseWidget) return;
            
            // Check widget type
            const vseDef = vseElements.find(v => v.id === w.vseId);
            const name = (w.vseName || w.vseId || '').toLowerCase();
            const isSwitchCard = vseDef?.render === 'switchCard' || 
                                 name.includes('switch') || name.includes('light');
            const isSensorCard = vseDef?.render === 'sensorCard' || 
                                 name.includes('sensor') || name.includes('card');
            
            // Re-render the entire widget content for proper state updates
            if(isSwitchCard) {
                vseWidget.innerHTML = renderSwitchCard(w, newVal, numVal);
            } else if(isSensorCard) {
                vseWidget.innerHTML = renderSensorCard(w, numVal, vseDef);
            } else {
                // Generic VSE - try to update value element
                const valueEl = vseWidget.querySelector('[style*="margin-top:4px"]');
                if(valueEl) valueEl.textContent = numVal;
            }
            return;
        }
        
        // Handle old widget types (.ve-switch, .ve-dimmer, etc.)
        const inner=el.querySelector('.ve-switch,.ve-dimmer,.ve-value,.ve-shutter,.ve-clock');
        if(inner){
            const newContent=renderWidget(w);
            const temp=document.createElement('div');
            temp.innerHTML=newContent;
            inner.replaceWith(temp.firstChild);
        }
    });
}

function startVisuDrag(e,id){
    if(!visuEditMode)return;
    if(e.target.classList.contains('resize-handle'))return;
    e.preventDefault();
    const el=document.getElementById('ve-'+id);
    visuDragEl={el,id};
    visuDragOff={x:e.clientX-el.offsetLeft,y:e.clientY-el.offsetTop};
    document.addEventListener('mousemove',onVisuDrag);
    document.addEventListener('mouseup',stopVisuDrag);
}

function onVisuDrag(e){
    if(!visuDragEl)return;
    visuDragEl.el.style.left=(e.clientX-visuDragOff.x)+'px';
    visuDragEl.el.style.top=(e.clientY-visuDragOff.y)+'px';
}

function stopVisuDrag(){
    if(visuDragEl){
        const w=visuPages[currentVisuPage].widgets.find(x=>x.id===visuDragEl.id);
        if(w){
            w.x=parseInt(visuDragEl.el.style.left);
            w.y=parseInt(visuDragEl.el.style.top);
            saveVisuConfig();
        }
    }
    visuDragEl=null;
    document.removeEventListener('mousemove',onVisuDrag);
    document.removeEventListener('mouseup',stopVisuDrag);
}

// Resize functionality
let visuResizeEl = null;
let visuResizeStart = null;

function startVisuResize(e, id) {
    if (!visuEditMode) return;
    e.preventDefault();
    e.stopPropagation();
    
    const el = document.getElementById('ve-' + id);
    const w = visuPages[currentVisuPage].widgets.find(x => x.id === id);
    if (!el || !w) return;
    
    visuResizeEl = { el, id, w };
    visuResizeStart = {
        x: e.clientX,
        y: e.clientY,
        width: el.offsetWidth || w.width || 100,
        height: el.offsetHeight || w.height || 60
    };
    
    document.addEventListener('mousemove', onVisuResize);
    document.addEventListener('mouseup', stopVisuResize);
}

function onVisuResize(e) {
    if (!visuResizeEl) return;
    
    const deltaX = e.clientX - visuResizeStart.x;
    const deltaY = e.clientY - visuResizeStart.y;
    
    const newWidth = Math.max(50, visuResizeStart.width + deltaX);
    const newHeight = Math.max(30, visuResizeStart.height + deltaY);
    
    visuResizeEl.el.style.width = newWidth + 'px';
    visuResizeEl.el.style.height = newHeight + 'px';
}

function stopVisuResize() {
    if (visuResizeEl) {
        const w = visuResizeEl.w;
        w.width = parseInt(visuResizeEl.el.style.width);
        w.height = parseInt(visuResizeEl.el.style.height);
        saveVisuConfig();
    }
    visuResizeEl = null;
    document.removeEventListener('mousemove', onVisuResize);
    document.removeEventListener('mouseup', stopVisuResize);
}

function editVisuWidget(id){
    if(!visuEditMode)return;
    const w=visuPages[currentVisuPage].widgets.find(x=>x.id===id);
    if(!w)return;
    currentEditWidget=w;
    
    const addrOpts=allAddresses.map(a=>`<option value="${a.address}" ${a.address===(w.addr||w.ko1)?'selected':''}>${a.name||a.address}</option>`).join('');
    
    let html='';
    
    if(w.type==='vse'){
        // Detect VSE type
        const vseId = w.vseId || '';
        const vseName = (w.vseName || '').toLowerCase();
        
        // Initialize vars if not present
        if(!w.vars) w.vars = {};
        const v = w.vars;
        
        // Check if this is VSE template format (var1-var13) vs new format (icon, iconSize, etc.)
        const isVseTemplateFormat = v.hasOwnProperty('var1') || v.hasOwnProperty('var2') || v.hasOwnProperty('var3');
        
        // WICHTIG: Sensor Card IMMER mit dem schönen Editor, egal welches Format!
        const isSensorCard = (vseId.includes('sensor') || vseName.includes('sensor'));
        const isSwitchCard = (vseId.includes('switch') || vseName.toLowerCase().includes('switch'));
        
        if(isSwitchCard){
            // Helper to convert RGB string to hex
            const rgbToHex = (rgb) => {
                if (!rgb || rgb.startsWith('#')) return rgb || '#ffffff';
                const parts = rgb.split(',').map(x => parseInt(x.trim()));
                if (parts.length !== 3) return '#ffffff';
                return '#' + parts.map(x => x.toString(16).padStart(2, '0')).join('');
            };
            
            // Create separate addr options for KO2
            const addrOpts2 = allAddresses.map(a=>`<option value="${a.address}" ${a.address===w.ko2?'selected':''}>${a.name||a.address}</option>`).join('');
            
            // Map EDOMI format (var1-var20) to readable names for display
            const icon = v.icon || v.var1 || 'lightbulb';
            const badgeIcon = v.badgeIcon || v.var2 || 'power';
            const colorOn = v.colorOn || (v.var3 ? rgbToHex(v.var3) : '#ffc107');
            const colorOff = v.colorOff || (v.var4 ? rgbToHex(v.var4) : '#9e9e9e');
            const textOn = v.textOn || v.var5 || 'An';
            const textOff = v.textOff || v.var6 || 'Aus';
            const iconSize = v.iconSize || v.var7 || 40;
            const badgeSize = v.badgeSize || v.var8 || 18;
            const borderRadius = v.borderRadius || v.var9 || 12;
            const glowEnabled = v.var10 === '1' || v.var10 === true || v.glowEnabled === true || (v.var10 === undefined && v.glowEnabled === undefined);
            const hoverEnabled = v.var11 === '1' || v.var11 === true || v.hoverEnabled === true || (v.var11 === undefined && v.hoverEnabled === undefined);
            const badgePosition = v.badgePosition || v.var12 || 50;
            const badgeColorOn = v.badgeColorOn || (v.var13 ? rgbToHex(v.var13) : '#4caf50');
            const badgeColorOff = v.badgeColorOff || (v.var14 ? rgbToHex(v.var14) : '#f44336');
            const statusIconOn = v.statusIconOn || v.var15 || '';
            const statusIconOff = v.statusIconOff || v.var16 || '';
            // NEW: Border options (var17-var20)
            const borderColorOn = v.borderColorOn || (v.var17 ? rgbToHex(v.var17) : colorOn);
            const borderColorOff = v.borderColorOff || (v.var18 ? rgbToHex(v.var18) : colorOff);
            const borderWidth = v.borderWidth || v.var19 || 1.5;
            const borderOpacity = v.borderOpacity || v.var20 || 45;
            
            // Switch Card Editor
            html = `
            <div style="max-height:60vh;overflow-y:auto;padding-right:10px">
                <h4 style="margin:0 0 12px 0;color:var(--warning)"><i class="mdi mdi-light-switch"></i> Light Switch Card Einstellungen</h4>
                
                <!-- KO Adressen -->
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                    <div class="form-group"><label class="form-label">Status-Adresse (KO1)</label>
                        <select id="veAddr"><option value="">-- Keine --</option>${addrOpts}</select>
                    </div>
                    <div class="form-group"><label class="form-label">Schalt-Adresse (KO2)</label>
                        <select id="veAddr2"><option value="">-- Gleiche wie Status --</option>${addrOpts2}</select>
                    </div>
                </div>
                
                <div style="display:grid;grid-template-columns:2fr 1fr 1fr;gap:12px">
                    <div class="form-group"><label class="form-label">Bezeichnung</label><input id="veLabel" value="${v.label||w.label||'Licht'}"></div>
                    <div class="form-group"><label class="form-label">Breite</label><input type="number" id="veWidth" value="${w.width||160}"></div>
                    <div class="form-group"><label class="form-label">Höhe</label><input type="number" id="veHeight" value="${w.height||130}"></div>
                </div>
                
                <hr style="border:none;border-top:1px solid var(--border);margin:16px 0">
                <h4 style="margin:0 0 12px 0;color:var(--purple)"><i class="mdi mdi-palette"></i> Icons (MDI)</h4>
                
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:12px">
                    <div class="form-group"><label class="form-label">Haupt-Icon</label>
                        <div style="display:flex;gap:8px;align-items:center">
                            <span class="mdi mdi-${icon}" id="veSwitchIconPreview" style="font-size:24px;color:${colorOn}"></span>
                            <input id="veVar1" value="${icon}" oninput="document.getElementById('veSwitchIconPreview').className='mdi mdi-'+this.value" style="flex:1">
                        </div>
                    </div>
                    <div class="form-group"><label class="form-label">Badge-Icon</label><input id="veVar2" value="${badgeIcon}"></div>
                    <div class="form-group"><label class="form-label">Icon-Größe</label><input type="number" id="veVar7" value="${iconSize}"></div>
                    <div class="form-group"><label class="form-label">Badge-Größe</label><input type="number" id="veVar8" value="${badgeSize}"></div>
                </div>
                
                <hr style="border:none;border-top:1px solid var(--border);margin:16px 0">
                <h4 style="margin:0 0 12px 0;color:var(--success)"><i class="mdi mdi-invert-colors"></i> Icon/Rahmen Farben</h4>
                
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                    <div class="form-group"><label class="form-label">Farbe bei Ein (1)</label><input type="color" id="veVar3" value="${colorOn}" style="height:38px"></div>
                    <div class="form-group"><label class="form-label">Farbe bei Aus (0)</label><input type="color" id="veVar4" value="${colorOff}" style="height:38px"></div>
                </div>
                
                <h4 style="margin:12px 0;color:var(--success)"><i class="mdi mdi-circle"></i> Badge Farben</h4>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                    <div class="form-group"><label class="form-label">Badge bei Ein (1)</label><input type="color" id="veVar13" value="${badgeColorOn}" style="height:38px"></div>
                    <div class="form-group"><label class="form-label">Badge bei Aus (0)</label><input type="color" id="veVar14" value="${badgeColorOff}" style="height:38px"></div>
                </div>
                
                <hr style="border:none;border-top:1px solid var(--border);margin:16px 0">
                <h4 style="margin:0 0 12px 0;color:var(--accent)"><i class="mdi mdi-format-text"></i> Status-Text</h4>
                
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                    <div class="form-group"><label class="form-label">Text bei Ein (1)</label><input id="veVar5" value="${textOn}"></div>
                    <div class="form-group"><label class="form-label">Text bei Aus (0)</label><input id="veVar6" value="${textOff}"></div>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                    <div class="form-group"><label class="form-label">Status-Icon bei Ein</label><input id="veVar15" value="${statusIconOn === '-' ? '' : statusIconOn}" placeholder="z.B. check, power"></div>
                    <div class="form-group"><label class="form-label">Status-Icon bei Aus</label><input id="veVar16" value="${statusIconOff === '-' ? '' : statusIconOff}" placeholder="z.B. close, power-off"></div>
                </div>
                
                <hr style="border:none;border-top:1px solid var(--border);margin:16px 0">
                <h4 style="margin:0 0 12px 0;color:var(--text-muted)"><i class="mdi mdi-cog"></i> Design</h4>
                
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:12px">
                    <div class="form-group"><label class="form-label">Border-Radius</label><input type="number" id="veVar9" value="${borderRadius}"></div>
                    <div class="form-group"><label class="form-label">Badge-Position %</label><input type="number" id="veVar12" value="${badgePosition}" min="0" max="100"></div>
                    <div class="form-group"><label class="form-label" style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="veVar10" ${glowEnabled?'checked':''} style="width:auto"> Glow-Effekt</label></div>
                    <div class="form-group"><label class="form-label" style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="veVar11" ${hoverEnabled?'checked':''} style="width:auto"> Hover-Effekt</label></div>
                </div>
                
                <hr style="border:none;border-top:1px solid var(--border);margin:16px 0">
                <h4 style="margin:0 0 12px 0;color:var(--cyan)"><i class="mdi mdi-border-all-variant"></i> Rahmen</h4>
                
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                    <div class="form-group"><label class="form-label">Rahmenfarbe Ein</label><input type="color" id="veVar17" value="${borderColorOn}" style="height:38px"></div>
                    <div class="form-group"><label class="form-label">Rahmenfarbe Aus</label><input type="color" id="veVar18" value="${borderColorOff}" style="height:38px"></div>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                    <div class="form-group"><label class="form-label">Rahmenstärke (px)</label><input type="number" id="veVar19" value="${borderWidth}" min="0" max="10" step="0.5"></div>
                    <div class="form-group"><label class="form-label">Rahmen-Deckkraft %</label><input type="number" id="veVar20" value="${borderOpacity}" min="0" max="100"></div>
                </div>
            </div>`;
        } else if(isSensorCard){
            // Wenn im alten var1-var13 Format, mappe zu neuen Feldnamen
            if(isVseTemplateFormat){
                // Mapping: var1-var13 → neue Feldnamen
                const mapping = {
                    'var1': 'icon',           // Icon (MDI Name)
                    'var2': 'label',          // Bezeichnung  
                    'var3': 'unit',           // Einheit
                    'var4': 'iconSize',       // Icon-Größe (px)
                    'var5': 'labelSize',      // Label-Größe (px)
                    'var6': 'valueSize',      // Wert-Größe (px)
                    'var7': 'decimals',       // Dezimalstellen
                    'var8': 'labelColor',     // Label-Farbe
                    'var9': 'valueColor',     // Wert-Farbe
                    'var10': 'borderRadius',  // Rundung (px)
                    'var11': 'iconColor',     // Icon-Farbe
                    'var12': 'borderColor',   // Rahmenfarbe
                    'var13': 'glowColor'      // Glow-Farbe
                };
                // Mappe alte Werte zu neuen Feldnamen
                Object.entries(mapping).forEach(([oldKey, newKey]) => {
                    if(v[oldKey] !== undefined && v[newKey] === undefined){
                        v[newKey] = v[oldKey];
                    }
                });
            }
            
            // Comprehensive Sensor Card Editor (new format)
            html = `
            <div style="max-height:60vh;overflow-y:auto;padding-right:10px">
                <h4 style="margin:0 0 12px 0;color:var(--accent)"><i class="mdi mdi-card-outline"></i> Sensor Card Einstellungen</h4>
                
                <!-- Basic -->
                <div class="form-group"><label class="form-label">Wert-Adresse (KO)</label>
                    <select id="veAddr"><option value="">-- Keine --</option>${addrOpts}</select>
                </div>
                
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                    <div class="form-group"><label class="form-label">Bezeichnung</label><input id="veLabel" value="${v.label||w.label||''}"></div>
                    <div class="form-group"><label class="form-label">Einheit</label><input id="veUnit" value="${v.unit||''}" placeholder="z.B. °C, %, W"></div>
                </div>
                
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
                    <div class="form-group"><label class="form-label">Dezimalstellen</label><input type="number" id="veDecimals" value="${v.decimals||1}" min="0" max="5"></div>
                    <div class="form-group"><label class="form-label">Breite</label><input type="number" id="veWidth" value="${w.width||200}"></div>
                    <div class="form-group"><label class="form-label">Höhe</label><input type="number" id="veHeight" value="${w.height||120}"></div>
                </div>
                
                <hr style="border:none;border-top:1px solid var(--border);margin:16px 0">
                <h4 style="margin:0 0 12px 0;color:var(--warning)"><i class="mdi mdi-link"></i> Klick-Aktion (optional)</h4>
                
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                    <div class="form-group"><label class="form-label">Bei Klick zur Seite</label>
                        <select id="veNavTarget" onchange="toggleClickAction()">
                            <option value="">-- Keine Navigation --</option>
                            ${Object.values(visuPages).map(p=>`<option value="${p.id}" ${v.navTarget===p.id?'selected':''}>${p.name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group"><label class="form-label">Klick-Hinweis anzeigen</label>
                        <select id="veNavIndicator">
                            <option value="" ${!v.navIndicator?'selected':''}>Nein</option>
                            <option value="arrow" ${v.navIndicator==='arrow'?'selected':''}>Pfeil →</option>
                            <option value="chevron" ${v.navIndicator==='chevron'?'selected':''}>Chevron ›</option>
                            <option value="dots" ${v.navIndicator==='dots'?'selected':''}>Punkte ...</option>
                        </select>
                    </div>
                </div>
                
                <div id="clickActionGroup" style="display:${v.navTarget?'none':'grid'};grid-template-columns:1fr 1fr;gap:12px;margin-top:12px">
                    <div class="form-group"><label class="form-label">ODER: KO-Aktion bei Klick</label>
                        <select id="veClickAction">
                            <option value="" ${!v.clickAction?'selected':''}>-- Keine --</option>
                            <option value="toggle" ${v.clickAction==='toggle'?'selected':''}>Toggle (Ein/Aus)</option>
                            <option value="send" ${v.clickAction==='send'?'selected':''}>Wert senden</option>
                        </select>
                    </div>
                    <div class="form-group"><label class="form-label">Wert (bei "Wert senden")</label>
                        <input type="number" id="veClickValue" value="${v.clickValue!==undefined?v.clickValue:1}" step="any">
                    </div>
                </div>
                
                <hr style="border:none;border-top:1px solid var(--border);margin:16px 0">
                <h4 style="margin:0 0 12px 0;color:var(--purple)"><i class="mdi mdi-palette"></i> Icon</h4>
                
                <div style="display:grid;grid-template-columns:2fr 1fr 1fr 1fr;gap:12px">
                    <div class="form-group"><label class="form-label">Icon (MDI Name)</label>
                        <div style="display:flex;gap:8px">
                            <span class="mdi mdi-${v.icon||'thermometer'}" id="veIconPreview" style="font-size:24px;color:${v.iconColor||'#58a6ff'}"></span>
                            <input id="veIcon" value="${v.icon||'thermometer'}" placeholder="thermometer" oninput="document.getElementById('veIconPreview').className='mdi mdi-'+this.value">
                        </div>
                    </div>
                    <div class="form-group"><label class="form-label">Größe (px)</label><input type="number" id="veIconSize" value="${v.iconSize||28}"></div>
                    <div class="form-group"><label class="form-label">Farbe</label><input type="color" id="veIconColor" value="${v.iconColor||'#58a6ff'}" style="height:38px" oninput="document.getElementById('veIconPreview').style.color=this.value"></div>
                    <div class="form-group"><label class="form-label">Deckkraft %</label><input type="number" id="veIconOpacity" value="${v.iconOpacity||100}" min="0" max="100"></div>
                </div>
                
                <hr style="border:none;border-top:1px solid var(--border);margin:16px 0">
                <h4 style="margin:0 0 12px 0;color:var(--success)"><i class="mdi mdi-format-text"></i> Text-Styling</h4>
                
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
                    <div class="form-group"><label class="form-label">Label-Größe (px)</label><input type="number" id="veLabelSize" value="${v.labelSize||12}"></div>
                    <div class="form-group"><label class="form-label">Label-Farbe</label><input type="color" id="veLabelColor" value="${v.labelColor||'#888888'}" style="height:38px"></div>
                    <div class="form-group"><label class="form-label">Label-Deckkraft %</label><input type="number" id="veLabelOpacity" value="${v.labelOpacity||100}" min="0" max="100"></div>
                </div>
                
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
                    <div class="form-group"><label class="form-label">Wert-Größe (px)</label><input type="number" id="veValueSize" value="${v.valueSize||22}"></div>
                    <div class="form-group"><label class="form-label">Wert-Farbe</label><input type="color" id="veValueColor" value="${v.valueColor||'#ffffff'}" style="height:38px"></div>
                    <div class="form-group"><label class="form-label">Wert-Deckkraft %</label><input type="number" id="veValueOpacity" value="${v.valueOpacity||100}" min="0" max="100"></div>
                </div>
                
                <hr style="border:none;border-top:1px solid var(--border);margin:16px 0">
                <h4 style="margin:0 0 12px 0;color:var(--warning)"><i class="mdi mdi-card-multiple-outline"></i> Rahmen & Hintergrund</h4>
                
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:12px">
                    <div class="form-group"><label class="form-label">Hintergrund</label><input type="color" id="veBgColor" value="${rgbaToHex(v.bgColor)||'#1a1a2e'}" style="height:38px"></div>
                    <div class="form-group"><label class="form-label">BG Deckkraft</label><input type="number" id="veBgOpacity" value="${(v.bgOpacity!==undefined?v.bgOpacity:6)}" min="0" max="100" step="1"></div>
                    <div class="form-group"><label class="form-label">Rahmenfarbe</label><input type="color" id="veBorderColor" value="${rgbaToHex(v.borderColor)||'#58a6ff'}" style="height:38px"></div>
                    <div class="form-group"><label class="form-label">Rahmen Deckkraft</label><input type="number" id="veBorderOpacity" value="${(v.borderOpacity!==undefined?v.borderOpacity:40)}" min="0" max="100" step="1"></div>
                </div>
                
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                    <div class="form-group"><label class="form-label">Rundung (px)</label><input type="number" id="veBorderRadius" value="${v.borderRadius||12}"></div>
                    <div class="form-group"><label class="form-label">Rahmenbreite</label><input type="number" id="veBorderWidth" value="${v.borderWidth||1.5}" step="0.5"></div>
                </div>
                
                <div style="display:grid;grid-template-columns:auto 1fr 1fr;gap:12px;align-items:end">
                    <div class="form-group"><label class="form-label" style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="veGlowEnabled" ${v.glowEnabled!==false&&v.glowEnabled!=='false'?'checked':''} style="width:auto"> Glow-Effekt</label></div>
                    <div class="form-group"><label class="form-label">Glow-Farbe</label><input type="color" id="veGlowColor" value="${rgbaToHex(v.glowColor)||'#58a6ff'}" style="height:38px"></div>
                </div>
                
                <hr style="border:none;border-top:1px solid var(--border);margin:16px 0">
                <h4 style="margin:0 0 12px 0;color:var(--danger)"><i class="mdi mdi-code-braces"></i> Bedingte Formatierung</h4>
                <p style="font-size:11px;color:var(--text-muted);margin-bottom:12px">Ändert Icon/Farben basierend auf dem Wert. Bedingungen werden von oben nach unten geprüft.</p>
                
                ${[1,2,3].map(i=>`
                <div style="background:var(--sidebar);border-radius:8px;padding:12px;margin-bottom:10px">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
                        <input type="checkbox" id="veCond${i}Enabled" ${v['cond'+i+'_enabled']?'checked':''} style="width:auto">
                        <span style="font-weight:600">Bedingung ${i}</span>
                        <span style="color:var(--text-muted);font-size:11px">Wenn Wert</span>
                        <select id="veCond${i}Op" style="width:60px">
                            <option value=">=" ${(v['cond'+i+'_op']||'>=')==='>='?'selected':''}>>=</option>
                            <option value=">" ${v['cond'+i+'_op']==='>'?'selected':''}>&gt;</option>
                            <option value="<=" ${v['cond'+i+'_op']==='<='?'selected':''}>&lt;=</option>
                            <option value="<" ${v['cond'+i+'_op']==='<'?'selected':''}>&lt;</option>
                            <option value="==" ${v['cond'+i+'_op']==='=='?'selected':''}>==</option>
                        </select>
                        <input type="number" id="veCond${i}Value" value="${v['cond'+i+'_value']||0}" style="width:80px" step="any">
                    </div>
                    <div style="margin-bottom:8px;color:var(--accent);font-size:11px;font-weight:600">Icon</div>
                    <div style="display:grid;grid-template-columns:2fr 1fr 1fr;gap:8px;margin-bottom:12px">
                        <div class="form-group" style="margin:0"><label class="form-label" style="font-size:10px">Icon Name</label><input id="veCond${i}Icon" value="${v['cond'+i+'_icon']||''}" placeholder="(Standard)"></div>
                        <div class="form-group" style="margin:0"><label class="form-label" style="font-size:10px">Icon-Farbe</label><input type="color" id="veCond${i}IconColor" value="${v['cond'+i+'_iconColor']||'#4caf50'}" style="height:32px"></div>
                        <div class="form-group" style="margin:0"><label class="form-label" style="font-size:10px">Icon-Deckk. %</label><input type="number" id="veCond${i}IconOpacity" value="${v['cond'+i+'_iconOpacity']||100}" min="0" max="100" style="height:32px"></div>
                    </div>
                    <div style="margin-bottom:8px;color:var(--success);font-size:11px;font-weight:600">Text</div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px">
                        <div class="form-group" style="margin:0"><label class="form-label" style="font-size:10px">Label-Farbe</label><input type="color" id="veCond${i}LabelColor" value="${v['cond'+i+'_labelColor']||'#888888'}" style="height:32px"></div>
                        <div class="form-group" style="margin:0"><label class="form-label" style="font-size:10px">Wert-Farbe</label><input type="color" id="veCond${i}ValueColor" value="${v['cond'+i+'_valueColor']||'#ffffff'}" style="height:32px"></div>
                    </div>
                    <div style="margin-bottom:8px;color:var(--warning);font-size:11px;font-weight:600">Rahmen & Effekte</div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
                        <div class="form-group" style="margin:0"><label class="form-label" style="font-size:10px">Rahmen</label><input type="color" id="veCond${i}BorderColor" value="${rgbaToHex(v['cond'+i+'_borderColor'])||'#4caf50'}" style="height:32px"></div>
                        <div class="form-group" style="margin:0"><label class="form-label" style="font-size:10px">Glow</label><input type="color" id="veCond${i}GlowColor" value="${rgbaToHex(v['cond'+i+'_glowColor'])||'#4caf50'}" style="height:32px"></div>
                    </div>
                </div>
                `).join('')}
            </div>`;
        } else {
            // Generic VSE Editor with metadata from VSE definition
            html=`<div class="form-group"><label class="form-label">Bezeichnung</label><input id="veLabel" value="${w.label||''}"></div>`;
            html+=`<div class="form-group"><label class="form-label">Größe</label>
                <div style="display:flex;gap:8px;align-items:center">
                    <input type="number" id="veWidth" value="${w.width||100}" style="width:80px">
                    <span>×</span>
                    <input type="number" id="veHeight" value="${w.height||60}" style="width:80px">
                    <span style="color:var(--text-muted);font-size:11px">px</span>
                </div>
            </div>`;
            html+=`<div class="form-group"><label class="form-label">VSE Element</label><input value="${w.vseName||w.vseId||''}" disabled style="background:var(--sidebar)"></div>`;
            html+=`<div class="form-group"><label class="form-label">KO1 (Wert-Adresse)</label><select id="veAddr"><option value="">-- Keine --</option>${addrOpts}</select></div>`;
            
            // Find VSE definition to get metadata
            const vseDef = vseElements.find(vse => vse.id === w.vseId);
            const vseVars = vseDef?.vars || {};
            
            if(Object.keys(v).length > 0){
                // Check if this looks like VSE Template format (var1-var13)
                const hasVarFormat = Object.keys(v).some(k => k.match(/^var\d+$/));
                
                if(hasVarFormat && Object.keys(vseVars).length > 0){
                    // VSE Template Editor - simplified for performance
                    
                    // Icon vars
                    const iconVars = ['var1', 'var4', 'var11'];
                    if(iconVars.some(k => vseVars[k])){
                        html+=`<h4 style="margin:16px 0 8px;color:var(--purple);font-size:13px">Icon</h4>`;
                        iconVars.forEach(key => {
                            if(vseVars[key]){
                                const varDef = vseVars[key];
                                const label = varDef.name || key;
                                const val = v[key] || varDef.default || '';
                                html+=`<div class="form-group"><label class="form-label">${label}</label><input id="veVar_${key}" value="${val}"></div>`;
                            }
                        });
                    }
                    
                    // Label vars
                    const labelVars = ['var2', 'var5', 'var6', 'var7'];
                    if(labelVars.some(k => vseVars[k])){
                        html+=`<h4 style="margin:16px 0 8px;color:var(--success);font-size:13px">Label/Titel</h4>`;
                        labelVars.forEach(key => {
                            if(vseVars[key]){
                                const varDef = vseVars[key];
                                const label = varDef.name || key;
                                const val = v[key] || varDef.default || '';
                                if(varDef.type === 'select' && varDef.options){
                                    html+=`<div class="form-group"><label class="form-label">${label}</label><select id="veVar_${key}">`;
                                    varDef.options.forEach(opt => {
                                        html+=`<option value="${opt}" ${val==opt?'selected':''}>${opt}</option>`;
                                    });
                                    html+=`</select></div>`;
                                } else {
                                    html+=`<div class="form-group"><label class="form-label">${label}</label><input id="veVar_${key}" value="${val}"></div>`;
                                }
                            }
                        });
                    }
                    
                    // Value vars
                    const valueVars = ['var3', 'var8', 'var9', 'var10'];
                    if(valueVars.some(k => vseVars[k])){
                        html+=`<h4 style="margin:16px 0 8px;color:var(--accent);font-size:13px">Wert</h4>`;
                        valueVars.forEach(key => {
                            if(vseVars[key]){
                                const varDef = vseVars[key];
                                const label = varDef.name || key;
                                const val = v[key] || varDef.default || '';
                                if(varDef.type === 'select' && varDef.options){
                                    html+=`<div class="form-group"><label class="form-label">${label}</label><select id="veVar_${key}">`;
                                    varDef.options.forEach(opt => {
                                        html+=`<option value="${opt}" ${val==opt?'selected':''}>${opt}</option>`;
                                    });
                                    html+=`</select></div>`;
                                } else {
                                    html+=`<div class="form-group"><label class="form-label">${label}</label><input id="veVar_${key}" value="${val}"></div>`;
                                }
                            }
                        });
                    }
                    
                    // Border vars
                    const borderVars = ['var12', 'var13'];
                    if(borderVars.some(k => vseVars[k])){
                        html+=`<h4 style="margin:16px 0 8px;color:var(--warning);font-size:13px">Rahmen</h4>`;
                        borderVars.forEach(key => {
                            if(vseVars[key]){
                                const varDef = vseVars[key];
                                const label = varDef.name || key;
                                const val = v[key] || varDef.default || '';
                                html+=`<div class="form-group"><label class="form-label">${label}</label><input id="veVar_${key}" value="${val}"></div>`;
                            }
                        });
                    }
                    
                    // Other vars - OHNE Bedingungen!
                    const handledVars = [...iconVars, ...labelVars, ...valueVars, ...borderVars];
                    const remainingVars = Object.keys(v).filter(k => {
                        // Überspringe bereits behandelte Variablen
                        if(handledVars.includes(k)) return false;
                        // Überspringe ALLE Bedingungen (cond1_*, cond2_*, cond3_*)
                        if(k.startsWith('cond')) return false;
                        return true;
                    });
                    if(remainingVars.length > 0){
                        html+=`<h4 style="margin:16px 0 8px;font-size:13px">Weitere</h4>`;
                        remainingVars.forEach(key => {
                            const varDef = vseVars[key] || {};
                            const label = varDef.name || key;
                            const val = v[key] || varDef.default || '';
                            html+=`<div class="form-group"><label class="form-label">${label}</label><input id="veVar_${key}" value="${val}"></div>`;
                        });
                    }
                    
                    // Bedingte Formatierung mit Tabs
                    html+=`<h4 style="margin:16px 0 8px;color:var(--danger);font-size:13px">Bedingte Formatierung</h4>`;
                    html+=`<div style="display:flex;gap:4px;margin-bottom:8px;border-bottom:1px solid var(--border)">`;
                    [1,2,3].forEach(i => {
                        html+=`<button type="button" onclick="showCondTab(${i})" id="condTab${i}" style="padding:6px 12px;background:none;border:none;border-bottom:2px solid transparent;cursor:pointer;font-size:11px;color:var(--text-muted)" onmouseover="this.style.color='var(--text)'" onmouseout="if(!this.classList.contains('active'))this.style.color='var(--text-muted)'">Bedingung ${i}</button>`;
                    });
                    html+=`</div>`;
                    
                    [1,2,3].forEach(i => {
                        html+=`<div id="condPanel${i}" style="display:none">
                            <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px;padding:10px;background:var(--sidebar);border-radius:6px">
                                <input type="checkbox" id="veCond${i}Enabled" ${v['cond'+i+'_enabled']?'checked':''}>
                                <b style="font-size:12px">Aktiviert</b>
                                <span style="flex:1"></span>
                                <span style="font-size:11px">Wenn Wert</span>
                                <select id="veCond${i}Op" style="width:50px">
                                    <option value=">=" ${(v['cond'+i+'_op']||'>=')==='>='?'selected':''}>>=</option>
                                    <option value=">" ${v['cond'+i+'_op']==='>'?'selected':''}>&gt;</option>
                                    <option value="<=" ${v['cond'+i+'_op']==='<='?'selected':''}>&lt;=</option>
                                    <option value="<" ${v['cond'+i+'_op']==='<'?'selected':''}>&lt;</option>
                                    <option value="==" ${v['cond'+i+'_op']==='=='?'selected':''}>==</option>
                                </select>
                                <input type="number" id="veCond${i}Value" value="${v['cond'+i+'_value']||0}" style="width:80px" step="any">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Icon Name (MDI)</label>
                                <input id="veCond${i}Icon" value="${v['cond'+i+'_icon']||''}" placeholder="z.B. fire, snowflake (leer = Standard)">
                            </div>
                            
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                                <div class="form-group">
                                    <label class="form-label">Icon-Farbe</label>
                                    <input type="color" id="veCond${i}IconColor" value="${v['cond'+i+'_iconColor']||'#4caf50'}">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Icon-Deckkraft %</label>
                                    <input type="number" id="veCond${i}IconOpacity" value="${v['cond'+i+'_iconOpacity']||100}" min="0" max="100">
                                </div>
                            </div>
                            
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                                <div class="form-group">
                                    <label class="form-label">Label-Farbe</label>
                                    <input type="color" id="veCond${i}LabelColor" value="${v['cond'+i+'_labelColor']||'#888888'}">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Wert-Farbe</label>
                                    <input type="color" id="veCond${i}ValueColor" value="${v['cond'+i+'_valueColor']||'#ffffff'}">
                                </div>
                            </div>
                            
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                                <div class="form-group">
                                    <label class="form-label">Rahmen-Farbe</label>
                                    <input type="color" id="veCond${i}BorderColor" value="${rgbaToHex(v['cond'+i+'_borderColor'])||'#4caf50'}">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Glow-Farbe</label>
                                    <input type="color" id="veCond${i}GlowColor" value="${rgbaToHex(v['cond'+i+'_glowColor'])||'#4caf50'}">
                                </div>
                            </div>
                        </div>`;
                    });
                } else {
                    // Fallback: Simple variable list - OHNE Bedingungen
                    html+=`<div class="form-group"><label class="form-label">Variablen</label>`;
                    Object.entries(v).forEach(([key, val])=>{
                        // Überspringe alle Bedingungen - die werden separat angezeigt
                        if(key.startsWith('cond')) return;
                        
                        const varDef = vseVars[key] || {};
                        const label = varDef.name || key;
                        
                        html+=`<div style="display:flex;gap:8px;margin-bottom:4px">
                            <span style="min-width:120px;font-size:11px;color:var(--text-muted)">${label}:</span>
                            <input id="veVar_${key}" value="${val||''}" style="flex:1">
                        </div>`;
                    });
                    html+=`</div>`;
                }
                
                // IMMER die Bedingungen in Tabs anzeigen (auch im Fallback)
                if(Object.keys(v).some(k => k.startsWith('cond'))) {
                    html+=`<h4 style="margin:16px 0 8px;color:var(--danger);font-size:13px">Bedingte Formatierung</h4>`;
                    html+=`<div style="display:flex;gap:4px;margin-bottom:8px;border-bottom:1px solid var(--border)">`;
                    [1,2,3].forEach(i => {
                        html+=`<button type="button" onclick="showCondTab(${i})" id="condTab${i}" style="padding:6px 12px;background:none;border:none;border-bottom:2px solid transparent;cursor:pointer;font-size:11px;color:var(--text-muted)" onmouseover="this.style.color='var(--text)'" onmouseout="if(!this.classList.contains('active'))this.style.color='var(--text-muted)'">Bedingung ${i}</button>`;
                    });
                    html+=`</div>`;
                    
                    [1,2,3].forEach(i => {
                        html+=`<div id="condPanel${i}" style="display:none">
                            <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px;padding:10px;background:var(--sidebar);border-radius:6px">
                                <input type="checkbox" id="veCond${i}Enabled" ${v['cond'+i+'_enabled']?'checked':''}>
                                <b style="font-size:12px">Aktiviert</b>
                                <span style="flex:1"></span>
                                <span style="font-size:11px">Wenn Wert</span>
                                <select id="veCond${i}Op" style="width:50px">
                                    <option value=">=" ${(v['cond'+i+'_op']||'>=')==='>='?'selected':''}>>=</option>
                                    <option value=">" ${v['cond'+i+'_op']==='>'?'selected':''}>&gt;</option>
                                    <option value="<=" ${v['cond'+i+'_op']==='<='?'selected':''}>&lt;=</option>
                                    <option value="<" ${v['cond'+i+'_op']==='<'?'selected':''}>&lt;</option>
                                    <option value="==" ${v['cond'+i+'_op']==='=='?'selected':''}>==</option>
                                </select>
                                <input type="number" id="veCond${i}Value" value="${v['cond'+i+'_value']||0}" style="width:80px" step="any">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Icon Name (MDI)</label>
                                <input id="veCond${i}Icon" value="${v['cond'+i+'_icon']||''}" placeholder="z.B. fire, snowflake (leer = Standard)">
                            </div>
                            
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                                <div class="form-group">
                                    <label class="form-label">Icon-Farbe</label>
                                    <input type="color" id="veCond${i}IconColor" value="${v['cond'+i+'_iconColor']||'#4caf50'}">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Icon-Deckkraft %</label>
                                    <input type="number" id="veCond${i}IconOpacity" value="${v['cond'+i+'_iconOpacity']||100}" min="0" max="100">
                                </div>
                            </div>
                            
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                                <div class="form-group">
                                    <label class="form-label">Label-Farbe</label>
                                    <input type="color" id="veCond${i}LabelColor" value="${v['cond'+i+'_labelColor']||'#888888'}">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Wert-Farbe</label>
                                    <input type="color" id="veCond${i}ValueColor" value="${v['cond'+i+'_valueColor']||'#ffffff'}">
                                </div>
                            </div>
                            
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                                <div class="form-group">
                                    <label class="form-label">Rahmen-Farbe</label>
                                    <input type="color" id="veCond${i}BorderColor" value="${rgbaToHex(v['cond'+i+'_borderColor'])||'#4caf50'}">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Glow-Farbe</label>
                                    <input type="color" id="veCond${i}GlowColor" value="${rgbaToHex(v['cond'+i+'_glowColor'])||'#4caf50'}">
                                </div>
                            </div>
                        </div>`;
                    });
                }
            }
        }
    } else {
        // Standard widget types
        html=`<div class="form-group"><label class="form-label">Bezeichnung</label><input id="veLabel" value="${w.label||''}"></div>`;
        html+=`<div class="form-group"><label class="form-label">Größe</label>
            <div style="display:flex;gap:8px;align-items:center">
                <input type="number" id="veWidth" value="${w.width||100}" style="width:80px">
                <span>×</span>
                <input type="number" id="veHeight" value="${w.height||60}" style="width:80px">
                <span style="color:var(--text-muted);font-size:11px">px</span>
            </div>
        </div>`;
        
        if(w.type==='switch'||w.type==='dimmer'){
            html+=`<div class="form-group"><label class="form-label">Adresse</label><select id="veAddr">${addrOpts}</select></div>`;
        }else if(w.type==='value'){
            html+=`<div class="form-group"><label class="form-label">Adresse</label><select id="veAddr">${addrOpts}</select></div>`;
            html+=`<div class="form-group"><label class="form-label">Einheit</label><input id="veUnit" value="${w.unit||''}"></div>`;
        }
    }
    
    document.getElementById('visuEditFields').innerHTML=html;
    showModal('visuEditModal');
    // Initialize first condition tab if tabs exist
    setTimeout(() => {
        if(document.getElementById('condTab1')) {
            showCondTab(1);
        }
    }, 50);
}

function rgbaToHex(rgba) {
    if (!rgba) return null;
    if (rgba.startsWith('#')) return rgba;
    const match = rgba.match(/[\d.]+/g);
    if (!match || match.length < 3) return '#58a6ff';
    return '#' + match.slice(0,3).map(x => {
        const hex = Math.round(parseFloat(x)).toString(16);
        return hex.length === 1 ? '0' + hex : hex;
    }).join('');
}

function hexToRgba(hex, alpha = 0.4) {
    if (!hex) return null;
    const r = parseInt(hex.slice(1,3), 16);
    const g = parseInt(hex.slice(3,5), 16);
    const b = parseInt(hex.slice(5,7), 16);
    return `rgba(${r},${g},${b},${alpha})`;
}

function saveVisuWidget(){
    if(!currentEditWidget){
        console.log('No currentEditWidget!');
        return;
    }
    const w = currentEditWidget;
    console.log('Saving widget:', w.id, 'type:', w.type);
    
    // Common fields
    const isSensorCardWidget = ((w.vseId||'').includes('sensor') || (w.vseName||'').toLowerCase().includes('sensor'));
    const isSwitchCardWidget = ((w.vseId||'').includes('switch') || (w.vseName||'').toLowerCase().includes('switch'));
    
    // Für Sensor Card und Switch Card wird label in vars gespeichert, nicht in w.label
    if(!isSensorCardWidget && !isSwitchCardWidget && document.getElementById('veLabel')) {
        w.label = document.getElementById('veLabel').value;
    }
    
    if(document.getElementById('veWidth')) w.width = parseInt(document.getElementById('veWidth').value) || 100;
    if(document.getElementById('veHeight')) w.height = parseInt(document.getElementById('veHeight').value) || 60;
    if(document.getElementById('veAddr')) {
        w.addr = document.getElementById('veAddr').value;
        w.ko1 = document.getElementById('veAddr').value;
    }
    if(document.getElementById('veAddr2')) {
        w.ko2 = document.getElementById('veAddr2').value;
    }
    if(document.getElementById('veUnit')) w.unit = document.getElementById('veUnit').value;
    
    // VSE specific
    if(w.type === 'vse'){
        if(!w.vars) w.vars = {};
        const v = w.vars;
        
        // Check if this is VSE template format (var1-var13) vs new format
        const isVseTemplateFormat = v.hasOwnProperty('var1') || v.hasOwnProperty('var2') || v.hasOwnProperty('var3');
        // WICHTIG: Sensor Card IMMER mit dem schönen Editor, egal welches Format!
        const isSensorCard = ((w.vseId||'').includes('sensor') || (w.vseName||'').toLowerCase().includes('sensor'));
        const isSwitchCard = ((w.vseId||'').includes('switch') || (w.vseName||'').toLowerCase().includes('switch'));
        
        if(isSwitchCard){
            console.log('Saving Switch Card...');
            // Save all switch card options in EDOMI format (var1-var16)
            v.label = document.getElementById('veLabel')?.value || 'Licht';
            w.label = v.label;
            
            // Helper to convert hex to RGB string
            const hexToRgbStr = (hex) => {
                if (!hex || !hex.startsWith('#')) return hex || '255,255,255';
                const r = parseInt(hex.slice(1,3), 16);
                const g = parseInt(hex.slice(3,5), 16);
                const b = parseInt(hex.slice(5,7), 16);
                return `${r},${g},${b}`;
            };
            
            // Icons (var1, var2)
            v.var1 = document.getElementById('veVar1')?.value || 'lightbulb';
            v.var2 = document.getElementById('veVar2')?.value || 'power';
            
            // Colors as RGB (var3, var4, var13, var14)
            v.var3 = hexToRgbStr(document.getElementById('veVar3')?.value) || '255,193,7';
            v.var4 = hexToRgbStr(document.getElementById('veVar4')?.value) || '158,158,158';
            v.var13 = hexToRgbStr(document.getElementById('veVar13')?.value) || '76,175,80';
            v.var14 = hexToRgbStr(document.getElementById('veVar14')?.value) || '244,67,54';
            
            // Text (var5, var6)
            v.var5 = document.getElementById('veVar5')?.value || 'An';
            v.var6 = document.getElementById('veVar6')?.value || 'Aus';
            
            // Sizes (var7, var8, var9, var12)
            v.var7 = parseInt(document.getElementById('veVar7')?.value) || 40;
            v.var8 = parseInt(document.getElementById('veVar8')?.value) || 18;
            v.var9 = parseInt(document.getElementById('veVar9')?.value) || 12;
            v.var12 = parseInt(document.getElementById('veVar12')?.value) || 50;
            
            // Options (var10, var11)
            v.var10 = document.getElementById('veVar10')?.checked ? '1' : '0';
            v.var11 = document.getElementById('veVar11')?.checked ? '1' : '0';
            
            // Status icons (var15, var16)
            v.var15 = document.getElementById('veVar15')?.value || '-';
            v.var16 = document.getElementById('veVar16')?.value || '-';
            if (v.var15 === '') v.var15 = '-';
            if (v.var16 === '') v.var16 = '-';
            
            // Border options (var17, var18, var19, var20)
            v.var17 = hexToRgbStr(document.getElementById('veVar17')?.value) || v.var3;  // defaults to colorOn
            v.var18 = hexToRgbStr(document.getElementById('veVar18')?.value) || v.var4;  // defaults to colorOff
            v.var19 = parseFloat(document.getElementById('veVar19')?.value) || 1.5;
            v.var20 = parseInt(document.getElementById('veVar20')?.value) || 45;
            
            console.log('Switch Card saved:', v);
        } else if(isSensorCard){
            // Save all sensor card options (new format)
            const labelEl = document.getElementById('veLabel');
            console.log('veLabel element:', labelEl, 'value:', labelEl?.value);
            v.label = labelEl?.value || '';
            w.label = v.label; // Sync to widget too
            console.log('Saved label:', v.label);
            v.unit = document.getElementById('veUnit')?.value || '';
            v.decimals = parseInt(document.getElementById('veDecimals')?.value) || 1;
            
            v.icon = document.getElementById('veIcon')?.value || 'thermometer';
            v.iconSize = parseInt(document.getElementById('veIconSize')?.value) || 28;
            v.iconColor = document.getElementById('veIconColor')?.value || '#58a6ff';
            v.iconOpacity = parseInt(document.getElementById('veIconOpacity')?.value) || 100;
            
            v.labelSize = parseInt(document.getElementById('veLabelSize')?.value) || 12;
            v.labelColor = document.getElementById('veLabelColor')?.value || '#888888';
            v.labelOpacity = parseInt(document.getElementById('veLabelOpacity')?.value) || 100;
            v.valueSize = parseInt(document.getElementById('veValueSize')?.value) || 22;
            v.valueColor = document.getElementById('veValueColor')?.value || '#ffffff';
            v.valueOpacity = parseInt(document.getElementById('veValueOpacity')?.value) || 100;
            
            const bgOpacity = parseInt(document.getElementById('veBgOpacity')?.value) || 6;
            const borderOpacity = parseInt(document.getElementById('veBorderOpacity')?.value) || 40;
            v.bgOpacity = bgOpacity;
            v.borderOpacity = borderOpacity;
            v.bgColor = hexToRgba(document.getElementById('veBgColor')?.value, bgOpacity/100) || 'rgba(255,255,255,0.06)';
            v.borderColor = hexToRgba(document.getElementById('veBorderColor')?.value, borderOpacity/100) || 'rgba(88,166,255,0.4)';
            v.borderRadius = parseInt(document.getElementById('veBorderRadius')?.value) || 12;
            v.borderWidth = parseFloat(document.getElementById('veBorderWidth')?.value) || 1.5;
            v.glowEnabled = document.getElementById('veGlowEnabled')?.checked;
            v.glowColor = hexToRgba(document.getElementById('veGlowColor')?.value, 0.15) || 'rgba(88,166,255,0.15)';
            
            // Navigation settings
            v.navTarget = document.getElementById('veNavTarget')?.value || '';
            v.navIndicator = document.getElementById('veNavIndicator')?.value || '';
            
            // Click action settings (alternative to navigation)
            v.clickAction = document.getElementById('veClickAction')?.value || '';
            v.clickValue = parseFloat(document.getElementById('veClickValue')?.value) || 1;
            
            // Save conditions
            [1,2,3].forEach(i => {
                v['cond'+i+'_enabled'] = document.getElementById('veCond'+i+'Enabled')?.checked;
                v['cond'+i+'_op'] = document.getElementById('veCond'+i+'Op')?.value || '>=';
                v['cond'+i+'_value'] = parseFloat(document.getElementById('veCond'+i+'Value')?.value) || 0;
                v['cond'+i+'_icon'] = document.getElementById('veCond'+i+'Icon')?.value || '';
                v['cond'+i+'_iconColor'] = document.getElementById('veCond'+i+'IconColor')?.value || '#4caf50';
                v['cond'+i+'_iconOpacity'] = parseInt(document.getElementById('veCond'+i+'IconOpacity')?.value) || 100;
                v['cond'+i+'_labelColor'] = document.getElementById('veCond'+i+'LabelColor')?.value || '#888888';
                v['cond'+i+'_valueColor'] = document.getElementById('veCond'+i+'ValueColor')?.value || '#ffffff';
                v['cond'+i+'_borderColor'] = hexToRgba(document.getElementById('veCond'+i+'BorderColor')?.value, 0.45);
                v['cond'+i+'_glowColor'] = hexToRgba(document.getElementById('veCond'+i+'GlowColor')?.value, 0.15);
            });
        } else {
            // Generic VSE - save all veVar_ inputs
            document.querySelectorAll('[id^="veVar_"]').forEach(input => {
                const key = input.id.replace('veVar_', '');
                v[key] = input.value;
            });
            
            // Save conditions for VSE Template widgets
            [1,2,3].forEach(i => {
                const enabled = document.getElementById('veCond'+i+'Enabled');
                if(enabled){
                    v['cond'+i+'_enabled'] = enabled.checked;
                    v['cond'+i+'_op'] = document.getElementById('veCond'+i+'Op')?.value || '>=';
                    v['cond'+i+'_value'] = parseFloat(document.getElementById('veCond'+i+'Value')?.value) || 0;
                    v['cond'+i+'_icon'] = document.getElementById('veCond'+i+'Icon')?.value || '';
                    v['cond'+i+'_iconColor'] = document.getElementById('veCond'+i+'IconColor')?.value || '#4caf50';
                    v['cond'+i+'_iconOpacity'] = parseInt(document.getElementById('veCond'+i+'IconOpacity')?.value) || 100;
                    v['cond'+i+'_labelColor'] = document.getElementById('veCond'+i+'LabelColor')?.value || '#888888';
                    v['cond'+i+'_valueColor'] = document.getElementById('veCond'+i+'ValueColor')?.value || '#ffffff';
                    v['cond'+i+'_borderColor'] = hexToRgba(document.getElementById('veCond'+i+'BorderColor')?.value, 0.45);
                    v['cond'+i+'_glowColor'] = hexToRgba(document.getElementById('veCond'+i+'GlowColor')?.value, 0.15);
                }
            });
        }
    }
    
    saveVisuConfig();
    renderVisuPage();
    hideModal('visuEditModal');
}

function deleteVisuWidget(){
    if(!currentEditWidget)return;
    if(!confirm('Widget löschen?'))return;
    const page=visuPages[currentVisuPage];
    page.widgets=page.widgets.filter(w=>w.id!==currentEditWidget.id);
    saveVisuConfig();
    renderVisuPage();
    hideModal('visuEditModal');
}

function createVisuPage(){
    const name=document.getElementById('visuPageName').value;
    if(!name){showAlert('error','Name erforderlich');return;}
    const id='vp'+Date.now();
    const size=document.getElementById('visuPageSize').value;
    visuPages[id]={id,name,size,widgets:[]};
    saveVisuConfig();
    loadVisuPageSelect();
    document.getElementById('visuPageSelect').value=id;
    loadVisuPage(id);
    hideModal('visuPageModal');
}

function loadVisuPage(id){
    currentVisuPage=id;
    const page=visuPages[id];
    if(!page)return;
    
    const canvas=document.getElementById('visuCanvas');
    canvas.className='visu-canvas';
    
    // Apply size
    if(page.size==='phone'){
        canvas.classList.add('phone');
        canvas.style.width='375px';
        canvas.style.height='667px';
    }else if(page.size==='tablet'){
        canvas.classList.add('tablet');
        canvas.style.width='768px';
        canvas.style.height='1024px';
    }else if(page.size==='desktop'){
        canvas.classList.add('desktop');
        canvas.style.width='1920px';
        canvas.style.height='1080px';
    }else if(page.size==='custom'){
        canvas.style.width=(page.customWidth||1024)+'px';
        canvas.style.height=(page.customHeight||768)+'px';
    }else{
        canvas.classList.add('fullsize');
        canvas.style.width='';
        canvas.style.height='';
    }
    
    // Apply background image
    if(page.bgImage){
        canvas.style.backgroundImage=`url('${page.bgImage}')`;
        canvas.style.backgroundSize=page.bgSize||'cover';
        canvas.style.backgroundPosition='center';
        canvas.style.backgroundRepeat=page.bgSize==='repeat'?'repeat':'no-repeat';
    }else{
        canvas.style.backgroundImage='';
    }
    
    renderVisuPage();
    updateBreadcrumb();
}

function loadVisuPageSelect(){
    const sel=document.getElementById('visuPageSelect');
    
    // Build tree structure
    const sortedPages = getSortedPagesTree();
    sel.innerHTML = sortedPages.map(p => {
        const depth = getPageDepth(p.id);
        const indent = '│  '.repeat(depth);
        const prefix = depth > 0 ? '├─ ' : '';
        const icon = p.icon ? `<span class="mdi mdi-${p.icon}"></span> ` : '';
        return `<option value="${p.id}">${indent}${prefix}${p.name}</option>`;
    }).join('');
    
    // Update breadcrumb
    updateBreadcrumb();
}

// Get pages sorted by tree hierarchy
function getSortedPagesTree() {
    const result = [];
    const addChildren = (parentId) => {
        Object.values(visuPages)
            .filter(p => (p.parentPage || '') === parentId)
            .sort((a, b) => (a.name || '').localeCompare(b.name || ''))
            .forEach(p => {
                result.push(p);
                addChildren(p.id);
            });
    };
    addChildren(''); // Start with root pages
    return result;
}

// Update breadcrumb navigation
function updateBreadcrumb() {
    let breadcrumbEl = document.getElementById('visuBreadcrumb');
    if (!breadcrumbEl) return;
    
    const page = visuPages[currentVisuPage];
    if (!page) return;
    
    // Build breadcrumb path
    const path = [];
    let current = page;
    while (current) {
        path.unshift(current);
        current = current.parentPage ? visuPages[current.parentPage] : null;
    }
    
    breadcrumbEl.innerHTML = path.map((p, i) => {
        const isLast = i === path.length - 1;
        const icon = p.icon ? `<span class="mdi mdi-${p.icon}"></span>` : '';
        if (isLast) {
            return `<span class="breadcrumb-current">${icon}${p.name}</span>`;
        }
        return `<a href="#" class="breadcrumb-link" onclick="navigateToPage('${p.id}');return false;">${icon}${p.name}</a><span class="breadcrumb-sep">›</span>`;
    }).join('');
}

async function saveVisuConfig(){
    try{
        await fetch(`${API}/visu/config`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(visuPages)});
    }catch(e){console.error('Save visu config failed:',e);}
}

async function loadVisuConfig(){
    try{
        const r=await fetch(`${API}/visu/config`);
        if(r.ok){
            const data=await r.json();
            if(data&&Object.keys(data).length>0)visuPages=data;
        }
    }catch(e){console.error('Load visu config failed:',e);}
    loadVisuPageSelect();
    // Apply page size settings (not just render widgets)
    loadVisuPage(currentVisuPage);
}

// ========== VSE FUNCTIONS ==========
let vseElements = [];
let selectedVSE = null;

async function loadVSEElements() {
    try {
        const r = await fetch(`${API}/visu/vse`);
        vseElements = await r.json();
        renderVSEList();
        updateVSEStats();
    } catch(e) {
        console.error('Error loading VSE:', e);
    }
}

function updateVSEStats() {
    const countEl = document.getElementById('vseCount');
    if (countEl) countEl.textContent = vseElements.length;
}

function filterVSE() {
    const search = (document.getElementById('vseSearch')?.value || '').toLowerCase();
    const filter = document.getElementById('vseFilter')?.value || 'all';
    
    document.querySelectorAll('#vseList .vse-card').forEach(card => {
        const name = card.dataset.name?.toLowerCase() || '';
        const id = card.dataset.id?.toLowerCase() || '';
        const vse = vseElements.find(v => v.id === card.dataset.id);
        const category = vse?.category || 'other';
        
        let show = name.includes(search) || id.includes(search);
        if (filter !== 'all') {
            if (filter === 'other') {
                show = show && !['sensor', 'switch'].includes(category);
            } else {
                show = show && category === filter;
            }
        }
        
        card.style.display = show ? '' : 'none';
    });
}

function renderVSEList() {
    const container = document.getElementById('vseList');
    if (!container) return;
    
    if (vseElements.length === 0) {
        container.innerHTML = `<div class="empty" style="grid-column:1/-1;text-align:center;padding:40px;color:var(--text-muted)">
            <i class="mdi mdi-palette-outline" style="font-size:48px;display:block;margin-bottom:12px"></i>
            Keine Widgets vorhanden.<br>
            <button class="btn btn-primary" style="margin-top:12px" onclick="showVseCreateModal()"><i class="mdi mdi-plus"></i> Widget erstellen</button>
        </div>`;
        return;
    }
    
    container.innerHTML = vseElements.map(vse => {
        const catIcon = getCategoryIcon(vse.category);
        const renderType = vse.render || 'custom';
        const renderLabel = {sensorCard:'Sensor',switchCard:'Switch',titleCard:'Titel',custom:'Custom'}[renderType] || renderType;
        
        return `<div class="vse-card" data-id="${vse.id}" data-name="${vse.name}" onclick="editVSEElement('${vse.id}')">
            <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px">
                <span style="font-size:24px">${catIcon}</span>
                <span style="font-size:10px;padding:2px 6px;border-radius:4px;background:rgba(88,166,255,0.2);color:var(--accent)">${renderLabel}</span>
            </div>
            <div style="font-weight:600;font-size:13px;margin-bottom:4px">${vse.name}</div>
            <div style="font-size:11px;color:var(--text-muted);margin-bottom:2px">${vse.description || ''}</div>
            <div style="font-size:10px;color:var(--text-muted)">${vse.xsize||100} × ${vse.ysize||60} px</div>
            <div style="display:flex;gap:4px;margin-top:10px;padding-top:8px;border-top:1px solid var(--border)">
                <button class="btn btn-sm btn-primary" style="flex:1" onclick="event.stopPropagation();addVSEToVisu('${vse.id}')" title="Zur Visu hinzufügen"><i class="mdi mdi-plus"></i> Visu</button>
                <button class="btn btn-sm btn-secondary" style="flex:1" onclick="event.stopPropagation();editVSEElement('${vse.id}')" title="Bearbeiten"><i class="mdi mdi-pencil"></i></button>
                <button class="btn btn-sm btn-danger" onclick="event.stopPropagation();deleteVSE('${vse.id}')" title="Löschen"><i class="mdi mdi-delete"></i></button>
            </div>
        </div>`;
    }).join('');
}

function getCategoryIcon(cat) {
    const icons = {
        'sensor': '🌡️', 'switch': '🔘', 'slider': '🎚️', 
        'gauge': '📊', 'chart': '📈', 'media': '🖼️',
        'button': '⏺️', 'display': '📟', 'title': '📝', 'other': '📦'
    };
    return icons[cat] || '📦';
}

async function uploadVSE(file) {
    if (!file) return;
    
    const ext = file.name.split('.').pop().toLowerCase();
    if (!['json', 'yaml', 'yml'].includes(ext)) {
        showAlert('error', 'Unterstützte Formate: .json, .yaml');
        return;
    }
    
    const formData = new FormData();
    formData.append('file', file);
    
    try {
        showAlert('info', 'Wird hochgeladen...');
        const r = await fetch(`${API}/visu/vse/upload`, {method: 'POST', body: formData});
        if (r.ok) {
            const result = await r.json();
            showAlert('success', result.message || '✓ Widget hochgeladen');
            loadVSEElements();
        } else {
            const err = await r.json();
            showAlert('error', err.detail || 'Upload fehlgeschlagen');
        }
    } catch(e) {
        showAlert('error', 'Upload fehlgeschlagen');
    }
    
    document.getElementById('vseUploadInput').value = '';
}

async function deleteVSE(filename) {
    if (!confirm(`Widget "${filename}" löschen?`)) return;
    
    try {
        await fetch(`${API}/visu/vse/${filename}`, {method: 'DELETE'});
        showAlert('success', '✓ Gelöscht');
        loadVSEElements();
    } catch(e) {
        showAlert('error', 'Löschen fehlgeschlagen');
    }
}

async function showVSEDetails(id) {
    // Open edit modal for details view
    editVSEElement(id);
}

function escapeHtml(str) {
    return String(str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// VSE Variable management
let vseVarCounter = 0;

function showVseCreateModal() {
    document.getElementById('vseEditMode').value = '';
    document.getElementById('vseModalTitle').innerHTML = '<i class="mdi mdi-palette"></i> Neues Widget erstellen';
    document.getElementById('vseDeleteBtn').style.display = 'none';
    
    // Reset form
    document.getElementById('vseCreateName').value = '';
    document.getElementById('vseCreateId').value = '';
    document.getElementById('vseCreateCategory').value = 'sensor';
    document.getElementById('vseCreateRender').value = 'sensorCard';
    document.getElementById('vseCreateWidth').value = '200';
    document.getElementById('vseCreateHeight').value = '100';
    document.getElementById('vseCreateDesc').value = '';
    document.getElementById('vseCreateHtml').value = '';
    document.getElementById('vseCreateCss').value = '';
    
    // Clear variables
    vseVarCounter = 0;
    document.getElementById('vseVarList').innerHTML = '';
    document.getElementById('vseCondList').innerHTML = '';
    
    // Add default variables for sensorCard
    addVseVariable('label', 'text', 'Bezeichnung', 'Sensor');
    addVseVariable('unit', 'text', 'Einheit', '°C');
    addVseVariable('decimals', 'number', 'Dezimalstellen', '1');
    addVseVariable('icon', 'icon', 'Icon (MDI)', 'thermometer');
    addVseVariable('iconSize', 'number', 'Icon-Größe', '28');
    addVseVariable('iconColor', 'color', 'Icon-Farbe', '#58a6ff');
    addVseVariable('borderRadius', 'number', 'Rundung', '12');
    addVseVariable('glowEnabled', 'bool', 'Glow-Effekt', 'true');
    
    updateVseRenderHelp();
    showModal('vseCreateModal');
}

function editVSEElement(id) {
    const vse = vseElements.find(v => v.id === id);
    if (!vse) return;
    
    document.getElementById('vseEditMode').value = id;
    document.getElementById('vseModalTitle').innerHTML = '<i class="mdi mdi-pencil"></i> Widget bearbeiten';
    document.getElementById('vseDeleteBtn').style.display = '';
    
    document.getElementById('vseCreateName').value = vse.name || '';
    document.getElementById('vseCreateId').value = vse.id || '';
    document.getElementById('vseCreateCategory').value = vse.category || 'sensor';
    document.getElementById('vseCreateRender').value = vse.render || 'sensorCard';
    document.getElementById('vseCreateWidth').value = vse.xsize || 200;
    document.getElementById('vseCreateHeight').value = vse.ysize || 100;
    document.getElementById('vseCreateDesc').value = vse.description || '';
    document.getElementById('vseCreateHtml').value = vse.html || '';
    document.getElementById('vseCreateCss').value = vse.css || '';
    
    // Load variables
    vseVarCounter = 0;
    document.getElementById('vseVarList').innerHTML = '';
    if (vse.vars) {
        Object.entries(vse.vars).forEach(([key, def]) => {
            addVseVariable(key, def.type || 'text', def.name || key, def.default || '');
        });
    }
    
    // Load conditions
    document.getElementById('vseCondList').innerHTML = '';
    if (vse.conditions) {
        vse.conditions.forEach((cond, i) => {
            addVseCondition(cond);
        });
    }
    
    updateVseRenderHelp();
    showModal('vseCreateModal');
}

function addVseVariable(key, type, name, defaultVal) {
    const id = vseVarCounter++;
    const container = document.getElementById('vseVarList');
    
    const typeOptions = ['text', 'number', 'color', 'icon', 'bool', 'select'].map(t => 
        `<option value="${t}" ${t===type?'selected':''}>${t}</option>`
    ).join('');
    
    const html = `<div class="vse-var-row" id="vseVar${id}" style="display:grid;grid-template-columns:100px 80px 1fr 100px 30px;gap:8px;align-items:center;margin-bottom:8px;padding:8px;background:var(--sidebar);border-radius:6px">
        <input placeholder="key" value="${key||''}" class="vseVarKey">
        <select class="vseVarType">${typeOptions}</select>
        <input placeholder="Anzeigename" value="${name||''}" class="vseVarName">
        <input placeholder="Default" value="${defaultVal||''}" class="vseVarDefault">
        <button class="btn btn-sm btn-danger" onclick="this.parentElement.remove()"><i class="mdi mdi-close"></i></button>
    </div>`;
    
    container.insertAdjacentHTML('beforeend', html);
}

let vseCondCounter = 0;

function addVseCondition(existing) {
    const id = vseCondCounter++;
    const container = document.getElementById('vseCondList');
    
    const cond = existing || {
        enabled: { default: false },
        operator: { default: '>=' },
        value: { default: 0 },
        iconColor: { default: '#4caf50' },
        borderColor: { default: 'rgba(76,175,80,0.45)' },
        icon: { default: '' }
    };
    
    const html = `<div class="vse-cond-row" id="vseCond${id}" style="background:var(--sidebar);border-radius:8px;padding:12px;margin-bottom:10px">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
            <span style="font-weight:600">Wenn Wert</span>
            <select class="vseCondOp" style="width:60px">
                <option value=">=" ${cond.operator?.default==='>='?'selected':''}>>=</option>
                <option value=">" ${cond.operator?.default==='>'?'selected':''}>&gt;</option>
                <option value="<=" ${cond.operator?.default==='<='?'selected':''}>&lt;=</option>
                <option value="<" ${cond.operator?.default==='<'?'selected':''}>&lt;</option>
                <option value="==" ${cond.operator?.default==='=='?'selected':''}>==</option>
            </select>
            <input type="number" class="vseCondValue" value="${cond.value?.default||0}" style="width:80px" step="any">
            <span style="flex:1"></span>
            <button class="btn btn-sm btn-danger" onclick="this.parentElement.parentElement.remove()"><i class="mdi mdi-close"></i></button>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px">
            <div class="form-group" style="margin:0"><label class="form-label" style="font-size:10px">Icon (leer=Standard)</label><input class="vseCondIcon" value="${cond.icon?.default||''}" placeholder="mdi name"></div>
            <div class="form-group" style="margin:0"><label class="form-label" style="font-size:10px">Icon-Farbe</label><input type="color" class="vseCondIconColor" value="${rgbaToHex(cond.iconColor?.default)||'#4caf50'}" style="height:32px"></div>
            <div class="form-group" style="margin:0"><label class="form-label" style="font-size:10px">Rahmen-Farbe</label><input type="color" class="vseCondBorderColor" value="${rgbaToHex(cond.borderColor?.default)||'#4caf50'}" style="height:32px"></div>
        </div>
    </div>`;
    
    container.insertAdjacentHTML('beforeend', html);
}

function updateVseRenderHelp() {
    const render = document.getElementById('vseCreateRender').value;
    const help = document.getElementById('vseRenderHelp');
    const condSection = document.getElementById('vseConditionsSection');
    const customSection = document.getElementById('vseCustomSection');
    
    const helpTexts = {
        'sensorCard': 'Zeigt einen Wert mit Icon, Label und optionaler bedingter Formatierung',
        'switchCard': 'Schalter mit Icon und An/Aus Status',
        'titleCard': 'Überschrift oder Trenntext',
        'custom': 'Eigenes HTML/CSS Template mit Variablen-Ersetzung'
    };
    
    help.textContent = helpTexts[render] || '';
    condSection.style.display = render === 'sensorCard' ? '' : 'none';
    customSection.style.display = render === 'custom' ? '' : 'none';
}

function previewVSEElement() {
    const render = document.getElementById('vseCreateRender').value;
    const preview = document.getElementById('vsePreview');
    
    // Collect current settings
    const vars = collectVseVariables();
    
    if (render === 'sensorCard') {
        const v = vars;
        const icon = v.icon || 'thermometer';
        const iconColor = v.iconColor || '#58a6ff';
        const iconSize = v.iconSize || 28;
        const label = v.label || 'Sensor';
        const unit = v.unit || '';
        const borderRadius = v.borderRadius || 12;
        const glowEnabled = v.glowEnabled === 'true' || v.glowEnabled === true;
        const glowColor = hexToRgba(iconColor, 0.15);
        const borderColor = hexToRgba(iconColor, 0.4);
        
        preview.innerHTML = `<div style="
            display:flex;align-items:center;gap:12px;padding:10px 14px;
            background:rgba(255,255,255,0.06);
            border:1.5px solid ${borderColor};
            border-radius:${borderRadius}px;
            ${glowEnabled ? `box-shadow:0 8px 22px rgba(0,0,0,0.24), 0 0 18px ${glowColor};` : ''}
            min-width:180px;
        ">
            <span class="mdi mdi-${icon}" style="font-size:${iconSize}px;color:${iconColor}"></span>
            <div style="display:flex;flex-direction:column">
                <div style="font-size:12px;color:#888">${label}</div>
                <div style="font-size:22px;font-weight:600">23.5 ${unit}</div>
            </div>
        </div>`;
    } else if (render === 'switchCard') {
        const v = vars;
        const icon = v.icon || 'lightbulb';
        const colorOn = v.colorOn || '#ffc107';
        
        preview.innerHTML = `<div style="
            display:flex;flex-direction:column;align-items:center;justify-content:center;
            padding:16px;border-radius:12px;border:1.5px solid ${colorOn}66;
            background:rgba(255,255,255,0.06);min-width:100px;min-height:100px;
        ">
            <span class="mdi mdi-${icon}" style="font-size:40px;color:${colorOn}"></span>
            <div style="font-size:13px;margin-top:8px">${v.label || 'Schalter'}</div>
            <div style="font-size:14px;font-weight:600;color:${colorOn}">${v.textOn || 'An'}</div>
        </div>`;
    } else if (render === 'titleCard') {
        const v = vars;
        preview.innerHTML = `<div style="padding:12px">
            <div style="font-size:${v.fontSize || 18}px;font-weight:600;color:${v.color || '#fff'}">
                ${v.icon ? `<span class="mdi mdi-${v.icon}" style="margin-right:8px"></span>` : ''}${v.label || 'Überschrift'}
            </div>
            ${v.subtitle ? `<div style="font-size:12px;color:rgba(255,255,255,0.7);margin-top:4px">${v.subtitle}</div>` : ''}
        </div>`;
    } else {
        preview.innerHTML = '<span style="color:var(--text-muted)">Custom Template - Vorschau nicht verfügbar</span>';
    }
}

function collectVseVariables() {
    const vars = {};
    document.querySelectorAll('.vse-var-row').forEach(row => {
        const key = row.querySelector('.vseVarKey').value.trim();
        if (key) {
            vars[key] = row.querySelector('.vseVarDefault').value;
        }
    });
    return vars;
}

function collectVseVarDefinitions() {
    const vars = {};
    document.querySelectorAll('.vse-var-row').forEach(row => {
        const key = row.querySelector('.vseVarKey').value.trim();
        if (key) {
            vars[key] = {
                name: row.querySelector('.vseVarName').value || key,
                type: row.querySelector('.vseVarType').value || 'text',
                default: row.querySelector('.vseVarDefault').value || ''
            };
        }
    });
    return vars;
}

function collectVseConditions() {
    const conditions = [];
    document.querySelectorAll('.vse-cond-row').forEach(row => {
        conditions.push({
            enabled: { name: 'Aktiviert', type: 'bool', default: true },
            operator: { name: 'Operator', type: 'select', default: row.querySelector('.vseCondOp').value },
            value: { name: 'Wert', type: 'number', default: parseFloat(row.querySelector('.vseCondValue').value) || 0 },
            icon: { name: 'Icon', type: 'icon', default: row.querySelector('.vseCondIcon').value },
            iconColor: { name: 'Icon-Farbe', type: 'color', default: row.querySelector('.vseCondIconColor').value },
            borderColor: { name: 'Rahmen-Farbe', type: 'color', default: hexToRgba(row.querySelector('.vseCondBorderColor').value, 0.45) }
        });
    });
    return conditions;
}

async function saveVSEElement() {
    const name = document.getElementById('vseCreateName').value.trim();
    let id = document.getElementById('vseCreateId').value.trim();
    const category = document.getElementById('vseCreateCategory').value;
    const render = document.getElementById('vseCreateRender').value;
    const width = parseInt(document.getElementById('vseCreateWidth').value) || 200;
    const height = parseInt(document.getElementById('vseCreateHeight').value) || 100;
    const description = document.getElementById('vseCreateDesc').value.trim();
    const html = document.getElementById('vseCreateHtml').value;
    const css = document.getElementById('vseCreateCss').value;
    
    if (!name) {
        showAlert('error', 'Name ist erforderlich');
        return;
    }
    
    // Auto-generate ID if empty
    if (!id) {
        id = name.toLowerCase().replace(/[^a-z0-9]/g, '_').replace(/_+/g, '_');
    }
    
    const vars = collectVseVarDefinitions();
    const conditions = render === 'sensorCard' ? collectVseConditions() : [];
    
    const vse = {
        id, name, category, render,
        xsize: width, ysize: height,
        description,
        vars, 
        conditions: conditions.length > 0 ? conditions : undefined,
        html: render === 'custom' ? html : undefined,
        css: render === 'custom' ? css : undefined,
        format: 'json',
        version: '2.0'
    };
    
    try {
        const r = await fetch(`${API}/visu/vse`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(vse)
        });
        
        if (r.ok) {
            showAlert('success', '✓ Widget gespeichert');
            hideModal('vseCreateModal');
            loadVSEElements();
        } else {
            const err = await r.json();
            showAlert('error', err.detail || 'Speichern fehlgeschlagen');
        }
    } catch(e) {
        showAlert('error', 'Speichern fehlgeschlagen: ' + e.message);
    }
}

async function deleteVSEElement() {
    const id = document.getElementById('vseEditMode').value;
    if (!id) return;
    
    if (!confirm(`Widget "${id}" wirklich löschen?`)) return;
    
    try {
        await fetch(`${API}/visu/vse/${id}`, {method: 'DELETE'});
        showAlert('success', '✓ Gelöscht');
        hideModal('vseCreateModal');
        loadVSEElements();
    } catch(e) {
        showAlert('error', 'Löschen fehlgeschlagen');
    }
}

async function showAddVSEModal() {
    await loadVSEElements();
    
    const addrOpts = allAddresses.map(a => `<option value="${a.address}">${a.name || a.address}</option>`).join('');
    document.getElementById('vseConfigKO1').innerHTML = `<option value="">-- Keine --</option>${addrOpts}`;
    
    const grid = document.getElementById('vseSelectGrid');
    if (vseElements.length === 0) {
        grid.innerHTML = `<div class="empty" style="grid-column:1/-1;text-align:center;padding:30px;color:var(--text-muted)">
            Keine Widgets vorhanden.<br>
            <a href="#" onclick="hideModal('visuVSEModal');showPage('vse');showVseCreateModal();" style="color:var(--accent)">Widget erstellen</a>
        </div>`;
    } else {
        grid.innerHTML = vseElements.map(vse => {
            const catIcon = getCategoryIcon(vse.category);
            const renderLabel = {sensorCard:'Sensor',switchCard:'Switch',titleCard:'Titel',custom:'Custom'}[vse.render] || vse.render || 'Custom';
            return `<div class="vse-card" onclick="selectVSE('${vse.id}')" id="vse-select-${vse.id}" style="cursor:pointer">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
                    <span style="font-size:20px">${catIcon}</span>
                    <span style="font-size:9px;padding:2px 5px;border-radius:3px;background:rgba(88,166,255,0.2);color:var(--accent)">${renderLabel}</span>
                </div>
                <div style="font-weight:600;font-size:12px">${vse.name}</div>
                <div style="font-size:10px;color:var(--text-muted)">${vse.xsize||100} × ${vse.ysize||60} px</div>
            </div>`;
        }).join('');
    }
    
    document.getElementById('vseConfigPanel').style.display = 'none';
    document.getElementById('vseAddBtn').disabled = true;
    selectedVSE = null;
    
    showModal('visuVSEModal');
}

function selectVSE(id) {
    // Highlight selected
    document.querySelectorAll('#vseSelectGrid .vse-card').forEach(c => {
        c.style.borderColor = '';
        c.style.background = '';
    });
    const selected = document.getElementById('vse-select-' + id);
    if (selected) {
        selected.style.borderColor = 'var(--accent)';
        selected.style.background = 'rgba(88,166,255,0.1)';
    }
    
    // Find VSE in loaded elements
    const vse = vseElements.find(v => v.id === id);
    if (!vse) {
        console.error('VSE not found:', id);
        return;
    }
    
    selectedVSE = vse;
    
    document.getElementById('vseConfigName').textContent = vse.name;
    document.getElementById('vseConfigText').value = vse.vars?.label?.default || vse.name;
    
    // Build config fields for variables
    let varsHtml = '';
    if (vse.vars) {
        Object.entries(vse.vars).forEach(([key, def]) => {
            const defaultVal = def.default || '';
            const label = def.name || key;
            const type = def.type || 'text';
            
            if (type === 'bool') {
                const checked = defaultVal === 'true' || defaultVal === '1' || defaultVal === true ? 'checked' : '';
                varsHtml += `<div class="form-group"><label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="vseVar-${key}" ${checked} style="width:auto"> ${label}</label></div>`;
            } else if (type === 'color') {
                varsHtml += `<div class="form-group"><label class="form-label">${label}</label><input type="color" id="vseVar-${key}" value="${defaultVal || '#58a6ff'}" style="height:36px"></div>`;
            } else if (type === 'number') {
                varsHtml += `<div class="form-group"><label class="form-label">${label}</label><input type="number" id="vseVar-${key}" value="${defaultVal}" step="any"></div>`;
            } else if (type === 'icon') {
                varsHtml += `<div class="form-group"><label class="form-label">${label}</label><div style="display:flex;gap:6px;align-items:center"><span class="mdi mdi-${defaultVal||'help'}" style="font-size:20px"></span><input id="vseVar-${key}" value="${defaultVal}" placeholder="mdi name"></div></div>`;
            } else {
                varsHtml += `<div class="form-group"><label class="form-label">${label}</label><input id="vseVar-${key}" value="${defaultVal}"></div>`;
            }
        });
    }
    
    document.getElementById('vseConfigVars').innerHTML = varsHtml || '<div style="color:var(--text-muted);font-size:12px">Keine konfigurierbaren Variablen</div>';
    document.getElementById('vseConfigPanel').style.display = 'block';
    document.getElementById('vseAddBtn').disabled = false;
}

function addVSEWidget() {
    if (!selectedVSE) return;
    
    const vse = selectedVSE;
    
    const widget = {
        id: 'vse' + Date.now(),
        type: 'vse',
        vseId: vse.id,
        vseName: vse.name,
        label: document.getElementById('vseConfigText').value || vse.name,
        x: 50 + Math.floor(Math.random() * 100),
        y: 50 + Math.floor(Math.random() * 100),
        width: vse.xsize || 200,
        height: vse.ysize || 100,
        ko1: document.getElementById('vseConfigKO1').value,
        vars: {}
    };
    
    // Collect var values from the config form
    if (vse.vars) {
        Object.keys(vse.vars).forEach(key => {
            const el = document.getElementById('vseVar-' + key);
            if (el) {
                if (el.type === 'checkbox') {
                    widget.vars[key] = el.checked ? 'true' : 'false';
                } else {
                    widget.vars[key] = el.value;
                }
            } else {
                // Use default value
                widget.vars[key] = vse.vars[key].default || '';
            }
        });
    }
    
    visuPages[currentVisuPage].widgets.push(widget);
    saveVisuConfig();
    renderVisuPage();
    hideModal('visuVSEModal');
    
    // Enable edit mode if not already
    if (!visuEditMode) {
        toggleVisuEdit();
    }
}

function addVSEToVisu(id) {
    showPage('visu');
    setTimeout(() => {
        showAddVSEModal();
        setTimeout(() => selectVSE(id), 300);
    }, 100);
}

function addQuickSensorCard() {
    // Create a sensor card with default settings
    const widget = {
        id: 'vse' + Date.now(),
        type: 'vse',
        vseId: 'sensor_card',
        vseName: 'Sensor Card',
        label: 'Sensor',
        x: 50 + Math.floor(Math.random() * 100),
        y: 50 + Math.floor(Math.random() * 100),
        width: 200,
        height: 100,
        ko1: '',
        vars: {
            label: 'Sensor',
            unit: '°C',
            decimals: 1,
            icon: 'thermometer',
            iconSize: 28,
            iconColor: '#58a6ff',
            labelSize: 12,
            labelColor: '#888888',
            valueSize: 22,
            valueColor: '#ffffff',
            bgColor: 'rgba(255,255,255,0.06)',
            borderColor: 'rgba(88,166,255,0.4)',
            borderRadius: 12,
            borderWidth: 1.5,
            glowEnabled: true,
            glowColor: 'rgba(88,166,255,0.15)'
        }
    };
    
    visuPages[currentVisuPage].widgets.push(widget);
    saveVisuConfig();
    
    // Enable edit mode and open edit dialog
    if (!visuEditMode) {
        toggleVisuEdit();
    }
    renderVisuPage();
    
    // Open edit dialog for the new widget
    setTimeout(() => editVisuWidget(widget.id), 100);
}

// Page Settings
function showPageSettings() {
    const page = visuPages[currentVisuPage];
    if (!page) return;
    
    document.getElementById('pageSettingsName').value = page.name || '';
    document.getElementById('pageSettingsIcon').value = page.icon || 'home';
    document.getElementById('pageIconPreview').className = 'mdi mdi-' + (page.icon || 'home');
    
    // Populate parent page dropdown (exclude current page and its children to prevent circular references)
    const parentSelect = document.getElementById('pageSettingsParent');
    const childPages = getChildPages(currentVisuPage);
    parentSelect.innerHTML = '<option value="">-- Keine (Hauptseite) --</option>' +
        Object.values(visuPages)
            .filter(p => p.id !== currentVisuPage && !childPages.includes(p.id))
            .map(p => `<option value="${p.id}" ${page.parentPage === p.id ? 'selected' : ''}>${getPagePath(p.id)}</option>`)
            .join('');
    
    document.getElementById('pageSettingsBgColor').value = page.bgColor || '#1a1a2e';
    document.getElementById('pageSettingsBgColorText').value = page.bgColor || '#1a1a2e';
    document.getElementById('pageSettingsSize').value = page.size || 'full';
    document.getElementById('pageSettingsWidth').value = page.customWidth || 1024;
    document.getElementById('pageSettingsHeight').value = page.customHeight || 768;
    document.getElementById('pageSettingsBgImage').value = page.bgImage || '';
    document.getElementById('pageSettingsBgSize').value = page.bgSize || 'cover';
    
    toggleCustomSize();
    showModal('visuPageSettingsModal');
}

// Get all child pages (recursively)
function getChildPages(pageId) {
    const children = [];
    Object.values(visuPages).forEach(p => {
        if (p.parentPage === pageId) {
            children.push(p.id);
            children.push(...getChildPages(p.id));
        }
    });
    return children;
}

// Get page path (e.g., "Haus > Erdgeschoss > Wohnzimmer")
function getPagePath(pageId) {
    const page = visuPages[pageId];
    if (!page) return pageId;
    if (!page.parentPage || !visuPages[page.parentPage]) return page.name;
    return getPagePath(page.parentPage) + ' > ' + page.name;
}

// Get page depth in tree
function getPageDepth(pageId) {
    const page = visuPages[pageId];
    if (!page || !page.parentPage) return 0;
    return 1 + getPageDepth(page.parentPage);
}

function toggleCustomSize() {
    const size = document.getElementById('pageSettingsSize').value;
    document.getElementById('customSizeGroup').style.display = size === 'custom' ? 'block' : 'none';
}

function toggleClickAction() {
    const navTarget = document.getElementById('veNavTarget')?.value;
    const clickActionGroup = document.getElementById('clickActionGroup');
    if (clickActionGroup) {
        clickActionGroup.style.display = navTarget ? 'none' : 'grid';
    }
}

function toggleVisuTree() {
    const panel = document.getElementById('visuTreePanel');
    panel.classList.toggle('show');
    if (panel.classList.contains('show')) {
        renderVisuTree();
    }
}

function renderVisuTree() {
    const content = document.getElementById('visuTreeContent');
    if (!content) return;
    
    // Build tree HTML recursively
    const buildTreeHtml = (parentId, level = 0) => {
        const children = Object.values(visuPages).filter(p => (p.parentPage || '') === parentId);
        if (children.length === 0) return '';
        
        let html = level > 0 ? '<div class="visu-tree-group">' : '';
        children.forEach(page => {
            const isActive = page.id === currentVisuPage;
            const icon = page.icon || 'file-document-outline';
            const childCount = Object.values(visuPages).filter(p => p.parentPage === page.id).length;
            const childBadge = childCount > 0 ? `<span class="tree-children">${childCount}</span>` : '';
            
            html += `
                <div class="visu-tree-item ${isActive ? 'active' : ''}" onclick="navigateToPage('${page.id}')" title="${page.name}">
                    <span class="mdi mdi-${icon}"></span>
                    <span class="tree-name">${page.name}</span>
                    ${childBadge}
                </div>
                ${buildTreeHtml(page.id, level + 1)}
            `;
        });
        html += level > 0 ? '</div>' : '';
        return html;
    };
    
    content.innerHTML = buildTreeHtml('') || '<div style="padding:16px;color:var(--text-muted);text-align:center">Keine Seiten vorhanden</div>';
}

function setPageBgColor(color) {
    document.getElementById('pageSettingsBgColor').value = color;
    document.getElementById('pageSettingsBgColorText').value = color;
}

function savePageSettings() {
    const page = visuPages[currentVisuPage];
    if (!page) return;
    
    page.name = document.getElementById('pageSettingsName').value;
    page.icon = document.getElementById('pageSettingsIcon').value || 'home';
    page.parentPage = document.getElementById('pageSettingsParent').value || '';
    page.bgColor = document.getElementById('pageSettingsBgColor').value;
    page.size = document.getElementById('pageSettingsSize').value;
    page.customWidth = parseInt(document.getElementById('pageSettingsWidth').value) || 1024;
    page.customHeight = parseInt(document.getElementById('pageSettingsHeight').value) || 768;
    page.bgImage = document.getElementById('pageSettingsBgImage').value.trim();
    page.bgSize = document.getElementById('pageSettingsBgSize').value;
    
    saveVisuConfig();
    loadVisuPageSelect();
    loadVisuPage(currentVisuPage);
    hideModal('visuPageSettingsModal');
}

function deleteVisuPage() {
    if (currentVisuPage === 'default') {
        showAlert('error', 'Standard-Seite kann nicht gelöscht werden');
        return;
    }
    if (!confirm('Seite wirklich löschen?')) return;
    
    delete visuPages[currentVisuPage];
    saveVisuConfig();
    loadVisuPageSelect();
    loadVisuPage('default');
    hideModal('visuPageSettingsModal');
}

// Enhanced renderVisuPage to handle VSE elements
const originalRenderVisuPage = renderVisuPage;
renderVisuPage = function() {
    const page = visuPages[currentVisuPage];
    if (!page) return;
    
    const canvas = document.getElementById('visuCanvas');
    
    // Apply background color
    if (page.bgColor) {
        canvas.style.background = page.bgColor;
    }
    
    let html = '';
    
    (page.widgets || []).forEach(w => {
        const editClass = visuEditMode ? 'editing' : '';
        const widthStyle = w.width ? `width:${w.width}px;` : '';
        const heightStyle = w.height ? `height:${w.height}px;` : '';
        
        if (w.type === 'vse') {
            // VSE Widget
            html += `<div class="visu-element ${editClass}" id="ve-${w.id}" 
                        style="left:${w.x}px;top:${w.y}px;${widthStyle}${heightStyle}"
                        onmousedown="startVisuDrag(event,'${w.id}')" ondblclick="editVisuWidget('${w.id}')">
                        <div class="vse-widget" data-vseid="${w.vseId}" data-ko1="${w.ko1||''}" 
                             style="width:100%;height:100%"
                             ${Object.entries(w.vars||{}).map(([k,v])=>`data-${k}="${v}"`).join(' ')}>
                            ${renderVSEWidget(w)}
                        </div>
                        <div class="resize-handle" onmousedown="startVisuResize(event,'${w.id}')"></div>
                    </div>`;
        } else {
            // Standard widgets
            html += `<div class="visu-element ${editClass}" id="ve-${w.id}" 
                        style="left:${w.x}px;top:${w.y}px;${widthStyle}${heightStyle}" 
                        onmousedown="startVisuDrag(event,'${w.id}')" ondblclick="editVisuWidget('${w.id}')">
                        ${renderWidget(w)}
                        <div class="resize-handle" onmousedown="startVisuResize(event,'${w.id}')"></div>
                    </div>`;
        }
    });
    
    canvas.innerHTML = html;
    updateVisuValues();
};

function renderVSEWidget(w) {
    // Get current value for KO1
    const val = w.ko1 ? getAddrValue(w.ko1) : null;
    const numVal = parseFloat(val) || 0;
    
    // Get VSE definition if available
    const vseDef = vseElements.find(v => v.id === w.vseId);
    
    // Check for new JSON-based VSE (render type)
    if (vseDef?.render === 'switchCard') {
        return renderSwitchCard(w, val, numVal);
    }
    if (vseDef?.render === 'sensorCard' || w.vseId === 'sensor_card') {
        return renderSensorCard(w, numVal, vseDef);
    }
    
    // Legacy: Pattern-based rendering
    const name = (w.vseName || w.vseId || '').toLowerCase();
    
    // IMPORTANT: Check switch BEFORE card (since 'switch-card' contains 'card')
    if (name.includes('switch') || name.includes('light')) {
        return renderSwitchCard(w, val, numVal);
    } else if (name.includes('sensor') || name.includes('card')) {
        return renderSensorCard(w, numVal, vseDef);
    } else if (name.includes('markdown') || name.includes('title')) {
        return renderTitleCard(w);
    } else {
        // Generic VSE widget
        return `<div style="width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;
                    padding:8px;border:1px dashed rgba(255,255,255,0.3);border-radius:8px;font-size:12px">
            <div style="font-weight:600">${w.vseName || 'VSE'}</div>
            <div style="color:var(--text-muted)">${w.label}</div>
            ${w.ko1 ? `<div style="margin-top:4px">${numVal}</div>` : ''}
        </div>`;
    }
}

function renderSensorCard(w, numVal, vseDef) {
    const v = w.vars || {};
    
    // Support both new format (icon, iconSize, etc.) and VSE template format (var1-var13)
    // VSE Template mapping:
    // var1 = icon name, var2 = label, var3 = decimals, var4 = icon size
    // var5 = label size (em), var6 = label weight, var7 = label opacity (0-1)
    // var8 = value size (em), var9 = value weight, var10 = value opacity (0-1)
    // var11 = icon color RGB, var12 = border radius, var13 = border opacity (0-1)
    
    // Icon settings - prefer new format (v.icon) over old format (v.var1)
    let icon = v.icon || v.var1 || 'thermometer';
    let iconSize = parseInt(v.iconSize || v.var4) || 24;
    let iconColor = v.iconColor || (v.var11 ? `rgb(${v.var11})` : '#58a6ff');
    let iconOpacity = parseInt(v.iconOpacity) || 100;
    
    // Label/Text - prefer new format (v.label) over old format (v.var2)
    let label = v.label || v.var2 || w.label || 'Sensor';
    let unit = v.unit || '';
    let decimals = parseInt(v.decimals || v.var3) || 1;
    
    // Label styling - prefer new px format over old em format
    let labelSize = v.labelSize ? parseInt(v.labelSize) + 'px' : (v.var5 ? parseFloat(v.var5) + 'em' : '12px');
    let labelWeight = v.var6 || '500';
    let labelColor = v.labelColor || '#888888';
    let labelOpacity = v.var7 ? Math.round(parseFloat(v.var7) * 100) : (parseInt(v.labelOpacity) || 100);
    
    // Value styling - prefer new px format over old em format
    let valueSize = v.valueSize ? parseInt(v.valueSize) + 'px' : (v.var8 ? parseFloat(v.var8) + 'em' : '22px');
    let valueWeight = v.var9 || '600';
    let valueColor = v.valueColor || '#ffffff';
    let valueOpacity = v.valueOpacity !== undefined ? parseInt(v.valueOpacity) : (v.var10 ? Math.round(parseFloat(v.var10) * 100) : 100);
    
    // Background & Border - prefer new format
    let bgColor = v.bgColor || '#1a1a2e';
    let bgOpacity = parseInt(v.bgOpacity) || 60;
    let borderRadius = parseInt(v.borderRadius || v.var12) || 16;
    let borderWidth = parseFloat(v.borderWidth) || 1.5;
    let borderColor = v.borderColor || '#808080';
    let borderOpacity = v.borderOpacity !== undefined ? parseInt(v.borderOpacity) : (v.var13 ? Math.round(parseFloat(v.var13) * 100) : 30);
    
    // Glow effect
    let glowEnabled = v.glowEnabled !== false && v.glowEnabled !== 'false';
    let glowColor = v.glowColor || '#58a6ff';
    let glowOpacity = parseInt(v.glowOpacity) || 15;
    
    // Apply conditions (check from highest to lowest priority)
    const conditions = [
        { enabled: v.cond3_enabled, op: v.cond3_op, val: parseFloat(v.cond3_value), iconColor: v.cond3_iconColor, iconOpacity: v.cond3_iconOpacity, borderColor: v.cond3_borderColor, glowColor: v.cond3_glowColor, icon: v.cond3_icon, labelColor: v.cond3_labelColor, valueColor: v.cond3_valueColor },
        { enabled: v.cond2_enabled, op: v.cond2_op, val: parseFloat(v.cond2_value), iconColor: v.cond2_iconColor, iconOpacity: v.cond2_iconOpacity, borderColor: v.cond2_borderColor, glowColor: v.cond2_glowColor, icon: v.cond2_icon, labelColor: v.cond2_labelColor, valueColor: v.cond2_valueColor },
        { enabled: v.cond1_enabled, op: v.cond1_op, val: parseFloat(v.cond1_value), iconColor: v.cond1_iconColor, iconOpacity: v.cond1_iconOpacity, borderColor: v.cond1_borderColor, glowColor: v.cond1_glowColor, icon: v.cond1_icon, labelColor: v.cond1_labelColor, valueColor: v.cond1_valueColor }
    ];
    
    for (const cond of conditions) {
        if (cond.enabled === true || cond.enabled === 'true' || cond.enabled === '1') {
            const match = evaluateCondition(numVal, cond.op || '>=', cond.val || 0);
            if (match) {
                if (cond.iconColor) iconColor = cond.iconColor;
                if (cond.iconOpacity !== undefined) iconOpacity = parseInt(cond.iconOpacity);
                if (cond.borderColor) borderColor = cond.borderColor;
                if (cond.glowColor) glowColor = cond.glowColor;
                if (cond.icon) icon = cond.icon;
                if (cond.labelColor) labelColor = cond.labelColor;
                if (cond.valueColor) valueColor = cond.valueColor;
                break;
            }
        }
    }
    
    // Convert colors to rgba with opacity
    const bgRgba = hexToRgbaStr(bgColor, bgOpacity / 100);
    const borderRgba = hexToRgbaStr(borderColor, borderOpacity / 100);
    const glowRgba = hexToRgbaStr(glowColor, glowOpacity / 100);
    const iconStyle = iconOpacity < 100 ? `opacity:${iconOpacity/100};` : '';
    const labelStyle = labelOpacity < 100 ? `opacity:${labelOpacity/100};` : '';
    const valueStyle = valueOpacity < 100 ? `opacity:${valueOpacity/100};` : '';
    
    // Build shadow/glow effect
    let boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
    if (glowEnabled) {
        boxShadow = `0 8px 22px rgba(0,0,0,0.24), 0 0 0 1px ${hexToRgbaStr(borderColor, 0.2)}, 0 0 18px ${glowRgba}`;
    }
    
    // Ensure icon has mdi- prefix
    const mdiIcon = icon.startsWith('mdi-') ? icon : 'mdi-' + icon;
    
    // Navigation settings
    const navTarget = v.navTarget || '';
    const navIndicator = v.navIndicator || '';
    const isNavClickable = navTarget && visuPages[navTarget];
    
    // KO Click action (toggle or send value)
    const clickAction = v.clickAction || ''; // 'toggle', 'send', or ''
    const clickValue = v.clickValue !== undefined ? v.clickValue : 1;
    const clickAddr = w.addr || w.ko1 || '';
    
    // Build onclick handler - check visuEditMode to prevent action during editing
    let onClickAttr = '';
    let cursorStyle = '';
    if (isNavClickable || (clickAction && clickAddr)) {
        cursorStyle = 'cursor:pointer;';
        if (isNavClickable) {
            onClickAttr = `onclick="if(!visuEditMode){event.stopPropagation();navigateToPage('${navTarget}')}"`;
        } else if (clickAction === 'toggle') {
            // Sensor Card: gleiche Adresse für Status und Schalten
            onClickAttr = `onclick="if(!visuEditMode){event.stopPropagation();toggleSwitch('${clickAddr}','${clickAddr}')}"`;
        } else if (clickAction === 'send') {
            onClickAttr = `onclick="if(!visuEditMode){event.stopPropagation();sendAddr('${clickAddr}',${clickValue})}"`;
        }
    }
    
    // Navigation indicator
    let indicatorHtml = '';
    if (isNavClickable && navIndicator) {
        const indicatorIcon = navIndicator === 'arrow' ? 'arrow-right' : 
                             navIndicator === 'chevron' ? 'chevron-right' : 
                             navIndicator === 'dots' ? 'dots-horizontal' : '';
        if (indicatorIcon) {
            indicatorHtml = `<span class="mdi mdi-${indicatorIcon}" style="font-size:18px;color:${labelColor};opacity:0.6;flex-shrink:0"></span>`;
        }
    }
    
    return `<div ${onClickAttr} style="
        width:100%;height:100%;display:flex;align-items:center;gap:12px;padding:8px 14px;
        background:${bgRgba};
        border:${borderWidth}px solid ${borderRgba};
        border-radius:${borderRadius}px;
        box-shadow:${boxShadow};
        box-sizing:border-box;
        transition: all 0.3s ease;
        font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
        ${cursorStyle}
    ">
        <span class="mdi ${mdiIcon}" style="font-size:${iconSize}px;color:${iconColor};flex-shrink:0;line-height:1;${iconStyle}"></span>
        <div style="display:flex;flex-direction:column;justify-content:center;flex:1;min-width:0">
            <div style="font-size:${labelSize};font-weight:${labelWeight};color:${labelColor};white-space:nowrap;overflow:hidden;text-overflow:ellipsis;line-height:1.2;${labelStyle}">${label}</div>
            <div style="font-size:${valueSize};font-weight:${valueWeight};color:${valueColor};line-height:1.2;${valueStyle}">${numVal.toFixed(decimals)}${unit ? ' ' + unit : ''}</div>
        </div>
        ${indicatorHtml}
    </div>`;
}

function hexToRgbaStr(hex, alpha) {
    if (!hex) return `rgba(88,166,255,${alpha})`;
    if (hex.startsWith('rgba')) return hex;
    if (hex.startsWith('rgb')) return hex.replace('rgb', 'rgba').replace(')', `,${alpha})`);
    hex = hex.replace('#', '');
    if (hex.length === 3) hex = hex[0]+hex[0]+hex[1]+hex[1]+hex[2]+hex[2];
    const r = parseInt(hex.substring(0,2), 16);
    const g = parseInt(hex.substring(2,4), 16);
    const b = parseInt(hex.substring(4,6), 16);
    return `rgba(${r},${g},${b},${alpha})`;
}

function renderSwitchCard(w, val, numVal) {
    const v = w.vars || {};
    const isOn = val === '1' || val === true || val === 'True' || numVal > 0;
    
    // Support both new format (icon, colorOn) and EDOMI format (var1-var20)
    // Icons
    const mainIcon = v.icon || v.var1 || 'lightbulb';
    const badgeIcon = v.badgeIcon || v.var2 || 'power';
    const iconSize = parseInt(v.iconSize || v.var7) || 40;
    const badgeSize = parseInt(v.badgeSize || v.var8) || 18;
    const badgeIconSize = Math.round(badgeSize * 0.65);
    const badgePosition = parseInt(v.badgePosition || v.var12) || 50;
    const badgeOffset = Math.round((100 - badgePosition) / 100 * badgeSize);
    
    // Colors - support both hex (#ffc107) and RGB (255,193,7) format
    const parseColor = (color, fallback) => {
        if (!color) return fallback;
        if (color.startsWith('#')) return color;
        if (color.includes(',')) return 'rgb(' + color + ')';
        return fallback;
    };
    
    // Icon colors
    const colorOn = parseColor(v.colorOn || v.var3, '#ffc107');
    const colorOff = parseColor(v.colorOff || v.var4, '#9e9e9e');
    const color = isOn ? colorOn : colorOff;
    
    // Badge colors
    const badgeColorOn = parseColor(v.badgeColorOn || v.var13, '#4caf50');
    const badgeColorOff = parseColor(v.badgeColorOff || v.var14, '#f44336');
    const badgeColor = isOn ? badgeColorOn : badgeColorOff;
    
    // Border colors (var17, var18) - separate from icon color
    const borderColorOn = parseColor(v.borderColorOn || v.var17, colorOn);
    const borderColorOff = parseColor(v.borderColorOff || v.var18, colorOff);
    const borderBaseColor = isOn ? borderColorOn : borderColorOff;
    
    // Border style (var19, var20)
    const borderWidth = parseFloat(v.borderWidth || v.var19) || 1.5;
    const borderOpacity = parseFloat(v.borderOpacity || v.var20) || 45;
    
    // Text
    const textOn = v.textOn || v.var5 || 'An';
    const textOff = v.textOff || v.var6 || 'Aus';
    const statusText = isOn ? textOn : textOff;
    const label = v.label || w.label || 'Licht';
    
    // Status icons (var15/var16)
    const statusIconOn = v.statusIconOn || v.var15 || '';
    const statusIconOff = v.statusIconOff || v.var16 || '';
    let statusIcon = isOn ? statusIconOn : statusIconOff;
    if (statusIcon === '-' || statusIcon === '0') statusIcon = '';
    
    // Style
    const borderRadius = parseInt(v.borderRadius || v.var9) || 12;
    const glowEnabled = v.glowEnabled !== false && v.glowEnabled !== 'false' && v.var10 !== '0' && v.var10 !== false;
    const hoverEnabled = v.hoverEnabled !== false && v.hoverEnabled !== 'false' && v.var11 !== '0' && v.var11 !== false;
    
    // KO1 = Rückmeldeadresse (Status lesen)
    // KO2 = Schaltadresse (Wert senden) - falls nicht gesetzt, verwende KO1
    const statusAddr = w.ko1 || w.addr || '';
    const switchAddr = w.ko2 || w.ko1 || w.addr || '';
    let onClickHandler = '';
    if (statusAddr) {
        // toggleSwitch(statusAddr, switchAddr) - liest Status von statusAddr, sendet auf switchAddr
        onClickHandler = `onclick="if(!visuEditMode){event.stopPropagation();toggleSwitch('${statusAddr}','${switchAddr}')}"`;
    }
    
    // Extract RGB values for box-shadow
    const colorRgb = color.startsWith('rgb') ? color.replace('rgb(','').replace(')','') : '255,193,7';
    
    // Glow effect
    const boxShadow = (glowEnabled && isOn)
        ? `0 8px 22px rgba(0,0,0,0.24), 0 0 0 1px rgba(${colorRgb},0.20), 0 0 18px rgba(${colorRgb},0.14)`
        : '0 4px 12px rgba(0,0,0,0.2)';
    
    // Border color with opacity
    const borderRgb = borderBaseColor.startsWith('rgb') 
        ? borderBaseColor.replace('rgb(','').replace(')','') 
        : hexToRgb(borderBaseColor);
    const borderColor = `rgba(${borderRgb},${borderOpacity/100})`;
    
    // Status icon HTML
    let statusHtml = '';
    if (statusIcon) {
        const mdiIcon = statusIcon.startsWith('mdi-') ? statusIcon : 'mdi-' + statusIcon;
        statusHtml = `<span class="mdi ${mdiIcon}" style="font-size:14px;color:${color};margin-right:4px"></span>`;
    }
    
    return `<div ${onClickHandler} style="
        position:relative;width:100%;height:100%;
        display:flex;flex-direction:column;align-items:center;justify-content:center;
        padding:8px;border-radius:${borderRadius}px;
        border:${borderWidth}px solid ${borderColor};
        background:rgba(255,255,255,0.06);
        box-sizing:border-box;
        box-shadow:${boxShadow};
        transition:transform 0.2s ease, box-shadow 0.2s ease;
        cursor:${switchAddr ? 'pointer' : 'default'};
    ">
        <div style="position:relative;flex-shrink:0;margin-top:4px">
            <div style="width:${iconSize}px;height:${iconSize}px;display:flex;align-items:center;justify-content:center">
                <span class="mdi mdi-${mainIcon}" style="font-size:${iconSize}px;color:${color};line-height:1"></span>
            </div>
            <span style="
                position:absolute;top:${badgeOffset}px;right:${badgeOffset}px;
                width:${badgeSize}px;height:${badgeSize}px;
                background:rgba(30,30,30,0.9);border-radius:50%;
                display:flex;align-items:center;justify-content:center;
                border:2px solid ${badgeColor};
                box-shadow:0 2px 4px rgba(0,0,0,0.3);
            ">
                <span class="mdi mdi-${badgeIcon}" style="font-size:${badgeIconSize}px;color:${badgeColor};line-height:1"></span>
            </span>
        </div>
        <div style="font-size:13px;font-weight:500;color:rgba(255,255,255,0.9);margin-top:6px;text-align:center;line-height:1.2">${label}</div>
        <div style="font-size:14px;font-weight:600;color:${color};margin-top:2px;display:flex;align-items:center;gap:4px">${statusHtml}${statusText}</div>
    </div>`;
}

// Helper: Hex to RGB string
function hexToRgb(hex) {
    if (!hex) return '255,255,255';
    hex = hex.replace('#', '');
    if (hex.length === 3) hex = hex[0]+hex[0]+hex[1]+hex[1]+hex[2]+hex[2];
    const r = parseInt(hex.substring(0,2), 16) || 0;
    const g = parseInt(hex.substring(2,4), 16) || 0;
    const b = parseInt(hex.substring(4,6), 16) || 0;
    return `${r},${g},${b}`;
}

function renderTitleCard(w) {
    const v = w.vars || {};
    const icon = v.icon || '';
    const subtitle = v.subtitle || '';
    const fontSize = parseInt(v.fontSize) || 18;
    const color = v.color || '#ffffff';
    
    return `<div style="width:100%;height:100%;display:flex;flex-direction:column;justify-content:center;padding:12px 10px">
        <div style="font-size:${fontSize}px;font-weight:600;color:${color}">${icon ? `<span class="mdi mdi-${icon}" style="margin-right:8px"></span>` : ''}${w.label}</div>
        ${subtitle ? `<div style="font-size:${fontSize * 0.7}px;color:rgba(255,255,255,0.7);margin-top:4px">${subtitle}</div>` : ''}
    </div>`;
}

function evaluateCondition(value, operator, threshold) {
    switch(operator) {
        case '>=': return value >= threshold;
        case '>': return value > threshold;
        case '<=': return value <= threshold;
        case '<': return value < threshold;
        case '==': return value == threshold;
        case '!=': return value != threshold;
        default: return false;
    }
}

// Load MDI font for VSE elements
(function loadMDIFont() {
    if (document.getElementById('mdi-font-css')) return;
    const link = document.createElement('link');
    link.id = 'mdi-font-css';
    link.rel = 'stylesheet';
    link.href = 'https://cdn.jsdelivr.net/npm/@mdi/font@7.4.47/css/materialdesignicons.min.css';
    document.head.appendChild(link);
})();

// Update clock every minute
setInterval(()=>{
    document.querySelectorAll('.ve-clock .time').forEach(el=>{
        el.textContent=new Date().toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'});
    });
},10000);
</script>
</body>
</html>
